<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Vault OS | Titanium</title>
    
    <!-- [1] CORE DEPENDENCIES -->
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons+Round" rel="stylesheet">

    <!-- [2] STYLESHEET (GPU ACCELERATED) -->
    <style>
        :root {
            --primary: #2563eb;
            --primary-dark: #1e40af;
            --bg-body: #f8fafc;
            --surface: #ffffff;
            --text-main: #0f172a;
            --text-sub: #64748b;
            --border: #e2e8f0;
            --success: #10b981;
            --danger: #ef4444;
            --radius: 12px;
            --shadow: 0 4px 6px -1px rgba(0,0,0,0.1), 0 2px 4px -1px rgba(0,0,0,0.06);
            --sidebar-w: 260px;
        }

        /* --- RESET & BASE --- */
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; outline: none; user-select: none; }
        body {
            margin: 0; font-family: 'Inter', sans-serif; background: var(--bg-body); color: var(--text-main);
            height: 100vh; overflow: hidden; display: flex; opacity: 0; transition: opacity 0.4s ease;
        }
        body.loaded { opacity: 1; }

        /* --- LAYOUT --- */
        .app-container { display: flex; width: 100%; height: 100%; }

        /* Sidebar */
        .sidebar {
            width: var(--sidebar-w); background: var(--surface); border-right: 1px solid var(--border);
            display: flex; flex-direction: column; padding: 20px 15px; z-index: 50;
            transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        .brand {
            font-size: 20px; font-weight: 700; color: var(--text-main); display: flex; align-items: center; gap: 10px;
            padding: 0 10px 30px 10px; letter-spacing: -0.5px;
        }
        .nav-item {
            display: flex; align-items: center; gap: 12px; padding: 12px 16px; border-radius: var(--radius);
            color: var(--text-sub); cursor: pointer; transition: all 0.2s; font-weight: 500; font-size: 14px;
        }
        .nav-item:hover { background: #f1f5f9; color: var(--text-main); }
        .nav-item.active { background: #eff6ff; color: var(--primary); }

        /* Storage Widget */
        .storage-widget {
            margin-top: auto; padding: 16px; background: #f8fafc; border-radius: var(--radius); border: 1px solid var(--border);
        }
        .storage-header { display: flex; justify-content: space-between; font-size: 12px; font-weight: 600; margin-bottom: 8px; }
        .progress-track { height: 6px; background: #e2e8f0; border-radius: 3px; overflow: hidden; }
        .progress-fill { height: 100%; background: var(--primary); width: 0%; transition: width 1s ease; }

        /* Main Content */
        .main-view { flex: 1; display: flex; flex-direction: column; position: relative; background: var(--bg-body); }
        
        /* Header */
        .header {
            height: 64px; border-bottom: 1px solid var(--border); background: var(--surface);
            display: flex; align-items: center; justify-content: space-between; padding: 0 24px;
        }
        .search-container {
            flex: 1; max-width: 600px; position: relative; margin: 0 20px;
        }
        .search-input {
            width: 100%; padding: 10px 40px 10px 15px; border-radius: 8px; border: 1px solid var(--border);
            background: #f8fafc; font-size: 14px; transition: 0.2s;
        }
        .search-input:focus { border-color: var(--primary); background: #fff; box-shadow: 0 0 0 3px rgba(37,99,235,0.1); }
        
        /* Browser Area */
        .browser-toolbar {
            padding: 15px 24px; display: flex; justify-content: space-between; align-items: center;
        }
        .breadcrumbs { display: flex; align-items: center; gap: 8px; font-size: 14px; color: var(--text-sub); }
        .crumb-active { color: var(--text-main); font-weight: 600; }
        
        .file-container {
            flex: 1; overflow-y: auto; padding: 0 24px 20px 24px;
            display: grid; grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); gap: 16px;
            align-content: start; contain: content;
        }
        
        /* File Card (Optimized) */
        .file-card {
            background: var(--surface); border: 1px solid var(--border); border-radius: var(--radius);
            padding: 12px; display: flex; flex-direction: column; align-items: center; text-align: center;
            cursor: pointer; transition: transform 0.1s, box-shadow 0.1s;
            will-change: transform;
        }
        .file-card:hover { transform: translateY(-2px); box-shadow: var(--shadow); border-color: #cbd5e1; }
        .file-thumb {
            width: 100%; height: 90px; border-radius: 8px; background: #f1f5f9;
            display: flex; align-items: center; justify-content: center; margin-bottom: 10px; overflow: hidden;
        }
        .file-thumb img { width: 100%; height: 100%; object-fit: cover; opacity: 0; transition: opacity 0.3s; }
        .file-thumb img.loaded { opacity: 1; }
        .file-info { width: 100%; }
        .file-name { font-size: 13px; font-weight: 500; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; margin-bottom: 4px; }
        .file-meta { font-size: 11px; color: var(--text-sub); }

        /* SCREENS (Lock & Auth) */
        .overlay-screen {
            position: fixed; inset: 0; background: #fff; z-index: 200;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            transition: opacity 0.3s;
        }
        .hidden { display: none !important; opacity: 0; pointer-events: none; }
        
        /* PIN Pad */
        .pin-wrapper { text-align: center; animation: slideUp 0.4s ease; }
        .pin-display { display: flex; gap: 15px; justify-content: center; margin-bottom: 30px; }
        .pin-dot { width: 16px; height: 16px; border-radius: 50%; border: 2px solid #cbd5e1; transition: 0.2s; }
        .pin-dot.filled { background: var(--primary); border-color: var(--primary); }
        .numpad { display: grid; grid-template-columns: repeat(3, 80px); gap: 15px; }
        .num-btn {
            height: 80px; border-radius: 50%; background: #f8fafc; font-size: 24px; font-weight: 500;
            display: flex; align-items: center; justify-content: center; cursor: pointer; transition: 0.1s;
        }
        .num-btn:active { background: #e2e8f0; transform: scale(0.95); }

        /* Upload Progress (Bottom Right) */
        .upload-panel {
            position: fixed; bottom: 30px; right: 30px; width: 320px;
            background: var(--surface); border-radius: var(--radius); box-shadow: 0 10px 25px -5px rgba(0,0,0,0.1);
            border: 1px solid var(--border); z-index: 100; overflow: hidden; display: none;
            animation: slideIn 0.3s cubic-bezier(0.16, 1, 0.3, 1);
        }
        .up-header { padding: 12px 16px; background: #f8fafc; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; font-size: 13px; font-weight: 600; }
        .up-body { padding: 16px; }
        .up-info { display: flex; justify-content: space-between; font-size: 12px; color: var(--text-sub); margin-bottom: 6px; }
        .up-speed { font-family: 'JetBrains Mono', monospace; font-size: 11px; color: var(--primary); }

        /* Media Viewer */
        .viewer-modal {
            position: fixed; inset: 0; background: rgba(0,0,0,0.95); z-index: 1000;
            display: none; flex-direction: column;
        }
        .view-head { height: 60px; display: flex; align-items: center; justify-content: space-between; padding: 0 24px; color: #fff; background: rgba(255,255,255,0.1); backdrop-filter: blur(10px); }
        .view-body { flex: 1; display: flex; justify-content: center; align-items: center; padding: 20px; }
        iframe { width: 100%; height: 100%; border: none; background: #fff; border-radius: 8px; }

        /* Context Menu */
        .ctx-menu {
            position: fixed; background: #fff; border-radius: 8px; box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1);
            border: 1px solid var(--border); width: 220px; z-index: 500; display: none; padding: 5px;
        }
        .ctx-item { padding: 10px 15px; display: flex; align-items: center; gap: 10px; font-size: 14px; cursor: pointer; border-radius: 4px; }
        .ctx-item:hover { background: #f1f5f9; }
        .ctx-danger { color: var(--danger); } .ctx-danger:hover { background: #fef2f2; }

        @keyframes slideUp { from { transform: translateY(20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        @keyframes slideIn { from { transform: translateX(100%); } to { transform: translateX(0); } }
    </style>
</head>
<body onload="App.init()">

    <!-- [1] LOCK SCREEN -->
    <div id="screen-lock" class="overlay-screen">
        <div class="pin-wrapper">
            <div class="brand" style="justify-content:center; margin-bottom:20px;">
                <span class="material-icons-round" style="color:var(--primary); font-size:32px">verified_user</span>
                <span style="font-size:24px">Vault OS</span>
            </div>
            <div style="margin-bottom:30px; color:var(--text-sub)">Enterprise Grade Security</div>
            
            <div class="pin-display">
                <div class="pin-dot"></div><div class="pin-dot"></div><div class="pin-dot"></div><div class="pin-dot"></div>
            </div>

            <div class="numpad">
                <div class="num-btn" onclick="Pin.input(1)">1</div>
                <div class="num-btn" onclick="Pin.input(2)">2</div>
                <div class="num-btn" onclick="Pin.input(3)">3</div>
                <div class="num-btn" onclick="Pin.input(4)">4</div>
                <div class="num-btn" onclick="Pin.input(5)">5</div>
                <div class="num-btn" onclick="Pin.input(6)">6</div>
                <div class="num-btn" onclick="Pin.input(7)">7</div>
                <div class="num-btn" onclick="Pin.input(8)">8</div>
                <div class="num-btn" onclick="Pin.input(9)">9</div>
                <div class="num-btn" style="font-size:14px; font-weight:600" onclick="Pin.reset()">CLR</div>
                <div class="num-btn" onclick="Pin.input(0)">0</div>
                <div class="num-btn" style="color:var(--primary)" onclick="Pin.verify()">âž”</div>
            </div>
        </div>
    </div>

    <!-- [2] AUTH SCREEN -->
    <div id="screen-auth" class="overlay-screen hidden">
        <div class="pin-wrapper">
            <span class="material-icons-round" style="font-size:64px; color:var(--primary); margin-bottom:20px">cloud_sync</span>
            <h2 style="margin:0 0 10px 0">Connect Workspace</h2>
            <p style="color:var(--text-sub); margin-bottom:30px">Secure Google Drive Access</p>
            <button onclick="Auth.signIn()" style="background:#fff; border:1px solid var(--border); padding:12px 24px; border-radius:50px; display:flex; align-items:center; gap:10px; font-weight:500; cursor:pointer; box-shadow:0 2px 5px rgba(0,0,0,0.05);">
                <img src="https://upload.wikimedia.org/wikipedia/commons/5/53/Google_%22G%22_Logo.svg" width="20">
                Sign in with Google
            </button>
        </div>
    </div>

    <!-- [3] MAIN APP INTERFACE -->
    <div id="screen-app" class="app-container hidden">
        
        <!-- Sidebar -->
        <div class="sidebar">
            <div class="brand">
                <span class="material-icons-round" style="color:var(--primary)">token</span> Vault OS
            </div>
            
            <div class="nav-item active" onclick="Nav.switch('user', this)">
                <span class="material-icons-round">person</span> My Drive
            </div>
            <div class="nav-item" onclick="Nav.switch('vault', this)">
                <span class="material-icons-round">security</span> Vault Drive
            </div>
            <div class="nav-item" onclick="Nav.switch('shared', this)">
                <span class="material-icons-round">folder_shared</span> Shared
            </div>
            
            <div class="storage-widget">
                <div class="storage-header">
                    <span>Storage</span>
                    <span id="store-pct">0%</span>
                </div>
                <div class="progress-track"><div id="store-bar" class="progress-fill"></div></div>
                <div id="store-val" style="font-size:11px; color:var(--text-sub); margin-top:6px;">Checking...</div>
            </div>

            <div class="nav-item" onclick="Auth.logout()" style="margin-top:auto; color:var(--danger)">
                <span class="material-icons-round">logout</span> Sign Out
            </div>
        </div>

        <!-- Main View -->
        <div class="main-view">
            <div class="header">
                <span class="material-icons-round" style="color:var(--text-sub)">menu</span>
                <div class="search-container">
                    <input type="text" class="search-input" placeholder="Search files, folders..." oninput="Drive.search(this.value)">
                </div>
                <img id="user-pfp" src="" style="width:32px; height:32px; border-radius:50%; background:#e2e8f0">
            </div>

            <div class="browser-toolbar">
                <div class="breadcrumbs">
                    <span style="cursor:pointer" onclick="Drive.goHome()">Home</span>
                    <span class="material-icons-round" style="font-size:16px; color:var(--border)">chevron_right</span>
                    <span class="crumb-active" id="crumb-curr">Root</span>
                </div>
                <div style="display:flex; gap:10px">
                    <button onclick="Drive.refresh()" style="border:none; background:transparent; cursor:pointer; color:var(--text-sub)"><span class="material-icons-round">refresh</span></button>
                    <button onclick="Ops.newFolder()" style="border:none; background:transparent; cursor:pointer; color:var(--primary)"><span class="material-icons-round">create_new_folder</span></button>
                    <button onclick="document.getElementById('up-file').click()" style="border:none; background:transparent; cursor:pointer; color:var(--primary)"><span class="material-icons-round">upload_file</span></button>
                </div>
            </div>

            <!-- Virtual File Grid -->
            <div id="file-grid" class="file-container"></div>
        </div>
    </div>

    <!-- [4] OVERLAYS & MODALS -->
    
    <!-- Upload Panel -->
    <div id="up-panel" class="upload-panel">
        <div class="up-header">
            <span id="up-title">Uploading...</span>
            <span id="up-pct">0%</span>
        </div>
        <div class="up-body">
            <div class="up-info">
                <span id="up-file-name">filename.ext</span>
                <span class="up-speed" id="up-speed">0 MB/s</span>
            </div>
            <div class="progress-track"><div id="up-bar" class="progress-fill"></div></div>
        </div>
    </div>

    <!-- Context Menu -->
    <div id="ctx-menu" class="ctx-menu">
        <div class="ctx-item" onclick="Ops.preview()"><span class="material-icons-round">visibility</span> Preview</div>
        <div class="ctx-item" onclick="Ops.download()"><span class="material-icons-round">download</span> Download</div>
        <div class="ctx-item" onclick="Ops.copyLink()"><span class="material-icons-round">link</span> Copy Link</div>
        <div class="ctx-item" onclick="Ops.info()"><span class="material-icons-round">info</span> Info</div>
        <div style="border-top:1px solid var(--border); margin:5px 0"></div>
        <div class="ctx-item ctx-danger" onclick="Ops.delete()"><span class="material-icons-round">delete</span> Delete</div>
    </div>

    <!-- Universal Viewer -->
    <div id="viewer" class="viewer-modal">
        <div class="view-head">
            <span id="view-name" style="font-weight:600">Preview</span>
            <div style="display:flex; gap:15px">
                <span class="material-icons-round" style="cursor:pointer" onclick="Ops.openExternal()">open_in_new</span>
                <span class="material-icons-round" style="cursor:pointer" onclick="UI.closeViewer()">close</span>
            </div>
        </div>
        <div id="view-body" class="view-body"></div>
    </div>

    <!-- Hidden Inputs -->
    <input type="file" id="up-file" multiple hidden onchange="Upload.handle(this.files)">
    <input type="file" id="up-folder" webkitdirectory hidden onchange="Upload.handle(this.files)">

    <!-- [5] LOGIC ENGINE -->
    <script>
        // --- CONFIGURATION ---
        const CFG = {
            clientId: '318681315152-65e9kofptt4c3bk3kmlj9gmksnasu347.apps.googleusercontent.com',
            scopes: 'https://www.googleapis.com/auth/drive https://www.googleapis.com/auth/userinfo.email',
            vaultId: '1zIyinAqjQv96QBSuanFS2F0USaG66GPn'
        };

        // --- GLOBAL STATE ---
        const S = {
            token: localStorage.getItem('v_tok'),
            mode: 'user', // 'user' or 'vault'
            curr: 'root',
            history: [],
            files: [], // Cache
            sel: null, // Selected file
            lastTime: 0,
            lastLoaded: 0
        };

        // --- 1. BOOT & SECURITY ---
        const App = {
            init: () => {
                document.body.classList.add('loaded');
                if(!localStorage.getItem('v_pin')) {
                    // First run, implicit setup
                    alert("Welcome! Please set your PIN.");
                }
                Auth.initClient();
            }
        };

        const Pin = {
            buffer: [],
            input: (n) => {
                if(Pin.buffer.length < 4) {
                    Pin.buffer.push(n);
                    Pin.render();
                }
            },
            reset: () => {
                Pin.buffer = [];
                Pin.render();
            },
            render: () => {
                document.querySelectorAll('.pin-dot').forEach((d, i) => {
                    d.classList.toggle('filled', i < Pin.buffer.length);
                });
            },
            verify: async () => {
                if(Pin.buffer.length !== 4) return;
                const input = Pin.buffer.join('');
                
                // SHA-256 Hashing for security
                const encoder = new TextEncoder();
                const data = encoder.encode(input);
                const hashBuffer = await crypto.subtle.digest('SHA-256', data);
                const hashArray = Array.from(new Uint8Array(hashBuffer));
                const hashHex = hashArray.map(b => b.toString(16).padStart(2, '0')).join('');

                const stored = localStorage.getItem('v_pin');
                
                if(!stored) {
                    localStorage.setItem('v_pin', hashHex);
                    alert("PIN Set Successfully!");
                    Auth.check();
                } else if(stored === hashHex) {
                    Auth.check();
                } else {
                    alert("Incorrect PIN");
                    Pin.reset();
                }
            }
        };

        // --- 2. AUTHENTICATION ---
        let tokenClient;
        const Auth = {
            initClient: () => {
                tokenClient = google.accounts.oauth2.initTokenClient({
                    client_id: CFG.clientId,
                    scope: CFG.scopes,
                    callback: (resp) => {
                        if(resp.error) return alert("Auth Failed");
                        S.token = resp.access_token;
                        localStorage.setItem('v_tok', S.token);
                        localStorage.setItem('v_exp', Date.now() + 3500000); // 1hr
                        UI.showApp();
                        Drive.init();
                    }
                });
            },
            check: () => {
                const exp = localStorage.getItem('v_exp');
                if(S.token && exp && Date.now() < exp) {
                    UI.showApp();
                    Drive.init();
                } else {
                    UI.switch('screen-lock', 'screen-auth');
                }
            },
            signIn: () => tokenClient.requestAccessToken(),
            logout: () => {
                localStorage.clear();
                location.reload();
            }
        };

        // --- 3. DRIVE ENGINE (PERFORMANCE OPTIMIZED) ---
        const Drive = {
            init: async () => {
                Drive.load('root');
                // Fetch User Profile
                let r = await fetch('https://www.googleapis.com/oauth2/v3/userinfo', {headers:{'Authorization':`Bearer ${S.token}`}});
                let d = await r.json();
                document.getElementById('user-pfp').src = d.picture;
            },
            load: async (id) => {
                S.curr = id;
                document.getElementById('crumb-curr').innerText = (id === 'root' || id === CFG.vaultId) ? 'Root' : '...';
                document.getElementById('file-grid').innerHTML = '<div style="grid-column:1/-1;text-align:center;padding:50px;color:#94a3b8">Loading...</div>';
                
                Drive.storage();
                
                // Back Button Support (History API)
                history.pushState({id: id}, null, '');

                const q = `'${id}' in parents and trashed = false`;
                const f = "files(id,name,mimeType,size,thumbnailLink,iconLink,webViewLink,webContentLink)";
                const url = `https://www.googleapis.com/drive/v3/files?q=${encodeURIComponent(q)}&fields=${encodeURIComponent(f)}&orderBy=folder,name&pageSize=1000`;

                try {
                    let res = await fetch(url, { headers: { 'Authorization': `Bearer ${S.token}` } });
                    let data = await res.json();
                    S.files = data.files || [];
 