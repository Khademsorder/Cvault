<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Drive OS | Jarvis Edition</title>
    
    <!-- Core Libraries -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons+Round" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    <script src="https://apis.google.com/js/api.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.5/gsap.min.js"></script>
    <!-- PDF.js for Reading PDFs -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script>pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';</script>

    <style>
        :root { --glass: rgba(10, 10, 20, 0.8); --neon: #00f3ff; --accent: #7000ff; }
        body { font-family: 'Space Grotesk', sans-serif; background: #050505; color: #e0e0e0; overflow: hidden; height: 100vh; font-size: 14px; }
        .glass { background: var(--glass); backdrop-filter: blur(30px); border: 1px solid rgba(255,255,255,0.05); }
        .neon-text { text-shadow: 0 0 10px rgba(0, 243, 255, 0.5); }
        .custom-scroll::-webkit-scrollbar { width: 4px; }
        .custom-scroll::-webkit-scrollbar-thumb { background: #333; border-radius: 10px; }
        
        /* Animations */
        @keyframes scan { 0% { top: 0%; opacity: 0; } 50% { opacity: 1; } 100% { top: 100%; opacity: 0; } }
        .scan-laser { position: absolute; width: 100%; height: 2px; background: var(--neon); box-shadow: 0 0 15px var(--neon); animation: scan 2s infinite linear; }
        .loader { width: 30px; height: 30px; border: 2px solid #333; border-top-color: var(--neon); border-radius: 50%; animation: spin 1s infinite linear; }
        @keyframes spin { to { transform: rotate(360deg); } }

        /* Floating Chat */
        .chat-ui { position: fixed; bottom: 90px; right: 20px; width: 350px; height: 500px; z-index: 100; transform: translateY(120%); transition: 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        .chat-ui.active { transform: translateY(0); }
        
        /* File Card Hover */
        .file-card { transition: all 0.2s; }
        .file-card:hover { transform: translateY(-3px); background: rgba(255,255,255,0.05); border-color: var(--neon); box-shadow: 0 5px 20px rgba(0, 243, 255, 0.1); }
    </style>
</head>
<body class="selection:bg-cyan-500/30">

    <!-- Auth Screen -->
    <div id="auth-screen" class="fixed inset-0 z-[100] bg-black flex items-center justify-center">
        <div class="glass p-12 rounded-3xl text-center relative overflow-hidden group">
            <div class="absolute inset-0 bg-gradient-to-tr from-cyan-500/10 to-purple-500/10 opacity-50"></div>
            <div class="relative z-10">
                <div class="w-20 h-20 mx-auto bg-gradient-to-r from-cyan-500 to-blue-600 rounded-full flex items-center justify-center mb-6 shadow-[0_0_30px_rgba(6,182,212,0.5)]">
                    <span class="material-icons-round text-4xl text-white">dns</span>
                </div>
                <h1 class="text-4xl font-bold text-white mb-2 neon-text">Drive OS <span class="text-xs align-top opacity-70">ULTRA</span></h1>
                <p class="text-gray-400 mb-8 font-light tracking-widest">NEXT GEN AI WORKSPACE</p>
                <button onclick="Auth.signIn()" class="w-full py-3 bg-white text-black font-bold rounded-xl hover:scale-105 transition-transform flex items-center justify-center gap-2">
                    <img src="https://upload.wikimedia.org/wikipedia/commons/5/53/Google_%22G%22_Logo.svg" class="w-5 h-5"> Initialize System
                </button>
            </div>
        </div>
    </div>

    <!-- Main UI -->
    <div id="app-ui" class="hidden h-full flex flex-col opacity-0 transition-opacity duration-1000 bg-[url('https://assets.codepen.io/1462889/pat-back.svg')]">
        
        <!-- Navbar -->
        <nav class="h-16 glass flex items-center justify-between px-6 z-20 shrink-0">
            <div class="flex items-center gap-3">
                <span class="material-icons-round text-cyan-400 text-2xl">dns</span>
                <span class="font-bold text-lg tracking-wider text-white">DRIVE <span class="text-cyan-400">OS</span></span>
            </div>
            
            <div class="flex-1 max-w-2xl mx-8 relative group">
                <div class="absolute inset-0 bg-cyan-500/20 rounded-lg blur-lg opacity-0 group-focus-within:opacity-100 transition-opacity"></div>
                <input type="text" id="search-box" placeholder="Search files or Ask AI..." class="relative w-full bg-black/50 border border-white/10 rounded-lg py-2.5 pl-10 pr-4 text-white focus:outline-none focus:border-cyan-400 transition-colors">
                <span class="material-icons-round absolute left-3 top-2.5 text-gray-500">search</span>
            </div>

            <div class="flex items-center gap-4">
                <button onclick="Tools.findDuplicates()" class="p-2 text-pink-400 hover:bg-pink-500/10 rounded-lg" title="Find Duplicates"><span class="material-icons-round">content_copy</span></button>
                <div class="h-8 w-[1px] bg-white/10"></div>
                <img id="user-avatar" src="" class="w-9 h-9 rounded-full border border-cyan-500/50 p-0.5">
            </div>
        </nav>

        <div class="flex flex-1 overflow-hidden">
            <!-- Sidebar -->
            <aside class="w-20 lg:w-64 glass border-r-0 border-t-0 flex flex-col shrink-0 z-10">
                <div class="p-4 space-y-2 flex-1">
                    <button onclick="Drive.load('root')" class="w-full flex items-center gap-4 p-3 rounded-xl bg-cyan-500/10 text-cyan-400 border border-cyan-500/20 hover:bg-cyan-500/20 transition-all">
                        <span class="material-icons-round">dashboard</span> <span class="hidden lg:block font-medium">Dashboard</span>
                    </button>
                    <button onclick="Drive.load('starred')" class="w-full flex items-center gap-4 p-3 rounded-xl text-gray-400 hover:bg-white/5 hover:text-white transition-all">
                        <span class="material-icons-round">star</span> <span class="hidden lg:block">Starred</span>
                    </button>
                    <button onclick="Drive.load('trash')" class="w-full flex items-center gap-4 p-3 rounded-xl text-gray-400 hover:bg-white/5 hover:text-white transition-all">
                        <span class="material-icons-round">delete</span> <span class="hidden lg:block">Recycle Bin</span>
                    </button>
                </div>
                
                <div class="p-6 hidden lg:block">
                    <div class="flex justify-between text-xs text-cyan-300 mb-2 font-mono"><span id="storage-used">-- GB</span> <span id="storage-total">/ -- GB</span></div>
                    <div class="h-1 bg-gray-800 rounded-full overflow-hidden"><div id="storage-bar" class="h-full bg-gradient-to-r from-cyan-500 to-purple-600 w-0 transition-all duration-1000"></div></div>
                    <button onclick="Auth.logout()" class="mt-4 w-full py-2 border border-red-500/30 text-red-400 rounded-lg text-xs hover:bg-red-500/10">TERMINATE SESSION</button>
                </div>
            </aside>

            <!-- Main Content -->
            <main class="flex-1 flex flex-col min-w-0 bg-black/40 relative">
                <!-- Toolbar -->
                <div class="h-12 border-b border-white/5 flex items-center justify-between px-6 bg-black/20">
                    <div class="flex items-center gap-2 text-gray-400 text-sm">
                        <span class="material-icons-round text-base">folder_open</span>
                        <span class="text-cyan-400 font-mono" id="current-path">root/</span>
                    </div>
                    <div class="flex gap-2">
                        <button onclick="UI.view('grid')" class="p-1.5 hover:text-white transition-colors"><span class="material-icons-round text-sm">grid_view</span></button>
                        <button onclick="UI.view('list')" class="p-1.5 hover:text-white transition-colors"><span class="material-icons-round text-sm">view_list</span></button>
                    </div>
                </div>

                <!-- Grid -->
                <div id="file-grid" class="flex-1 overflow-y-auto p-6 grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 xl:grid-cols-6 2xl:grid-cols-8 gap-4 content-start custom-scroll">
                    <!-- Files injected here -->
                </div>

                <!-- FAB -->
                <button onclick="document.getElementById('upload-input').click()" class="absolute bottom-8 right-8 w-14 h-14 bg-cyan-600 hover:bg-cyan-500 rounded-2xl flex items-center justify-center shadow-lg shadow-cyan-500/30 transition-transform hover:scale-110 active:scale-95 z-30">
                    <span class="material-icons-round text-3xl text-white">add</span>
                </button>
                <input type="file" id="upload-input" class="hidden" multiple onchange="Upload.handle(this.files)">
            </main>
        </div>
    </div>

    <!-- Viewer & AI Overlay -->
    <div id="viewer-modal" class="fixed inset-0 z-50 bg-black/95 backdrop-blur-xl hidden flex flex-col">
        <div class="h-14 flex items-center justify-between px-6 border-b border-white/10 bg-black/50">
            <h2 id="viewer-filename" class="text-white font-mono text-sm truncate max-w-md">filename.ext</h2>
            <div class="flex gap-3">
                <button onclick="AI.visionAnalyze()" class="flex items-center gap-2 px-3 py-1.5 bg-purple-600/20 text-purple-400 border border-purple-500/30 rounded-lg hover:bg-purple-600/40 transition-all text-xs font-bold tracking-wider">
                    <span class="material-icons-round text-sm">visibility</span> VISION SCAN
                </button>
                <button onclick="Viewer.close()" class="w-8 h-8 flex items-center justify-center rounded-full bg-white/10 hover:bg-white/20"><span class="material-icons-round text-sm">close</span></button>
            </div>
        </div>
        <div class="flex-1 flex relative overflow-hidden">
            <div id="viewer-body" class="flex-1 flex items-center justify-center p-8"></div>
            <!-- AI Panel -->
            <div id="ai-panel" class="w-96 bg-[#0a0a0a] border-l border-white/10 absolute right-0 top-0 bottom-0 transform translate-x-full transition-transform duration-300 z-10 flex flex-col">
                <div class="p-4 border-b border-white/10 flex justify-between items-center">
                    <span class="text-purple-400 font-bold text-sm tracking-wider flex items-center gap-2"><span class="material-icons-round text-sm">auto_awesome</span> NEURAL ENGINE</span>
                    <button onclick="document.getElementById('ai-panel').classList.add('translate-x-full')" class="text-gray-500 hover:text-white"><span class="material-icons-round">close</span></button>
                </div>
                <div id="ai-output" class="flex-1 p-5 overflow-y-auto text-gray-300 text-sm font-mono whitespace-pre-wrap custom-scroll"></div>
            </div>
        </div>
    </div>

    <!-- Jarvis Chat -->
    <div id="chat-ui" class="chat-ui glass rounded-2xl flex flex-col overflow-hidden border border-cyan-500/20 shadow-[0_0_50px_rgba(0,0,0,0.5)]">
        <div class="p-4 bg-gradient-to-r from-cyan-900/50 to-blue-900/50 flex justify-between items-center cursor-pointer border-b border-white/10" onclick="Chat.toggle()">
            <div class="flex items-center gap-2 font-bold text-cyan-400 tracking-wider">
                <div class="w-2 h-2 bg-cyan-400 rounded-full animate-pulse"></div> SYSTEM AI
            </div>
            <span class="material-icons-round text-gray-400" id="chat-icon">expand_less</span>
        </div>
        <div id="chat-history" class="flex-1 overflow-y-auto p-4 space-y-4 custom-scroll bg-black/80">
            <div class="text-center text-xs text-gray-600 font-mono mt-4">AI AGENT ONLINE<br>Accessing File Index...</div>
        </div>
        <div class="p-3 bg-black border-t border-white/10 flex gap-2">
            <button onclick="Voice.start()" class="p-2 text-cyan-400 hover:bg-cyan-500/10 rounded-lg transition-colors"><span class="material-icons-round">mic</span></button>
            <input type="text" id="chat-input" placeholder="Command..." class="flex-1 bg-gray-900 border border-gray-800 rounded-lg px-3 text-sm text-white focus:outline-none focus:border-cyan-500 font-mono" onkeydown="if(event.key==='Enter') Chat.send()">
        </div>
    </div>

    <script>
        const Config = {
            clientId: '318681315152-65e9kofptt4c3bk3kmlj9gmksnasu347.apps.googleusercontent.com',
            scope: 'https://www.googleapis.com/auth/drive', // Full scope for creating folders
            discovery: ['https://www.googleapis.com/discovery/v1/apis/drive/v3/rest'],
            geminiKey: 'AIzaSyD0hkckrFjwctBCvbWjYYRxTfYkoAbPf4A'
        };

        const State = { token: null, folder: 'root', files: [], active: null, view: 'grid' };

        // --- AUTH ---
        const Auth = {
            init() {
                const client = google.accounts.oauth2.initTokenClient({
                    client_id: Config.clientId, scope: Config.scope,
                    callback: (r) => {
                        if(r.error) return Swal.fire('Error', r.error, 'error');
                        State.token = r.access_token;
                        localStorage.setItem('drive_token', State.token);
                        gapi.client.setToken({ access_token: State.token });
                        Auth.loadApp();
                    }
                });
                window.AuthClient = client;
                
                gapi.load('client', async () => {
                    await gapi.client.init({ discoveryDocs: Config.discovery });
                    const saved = localStorage.getItem('drive_token');
                    if(saved) {
                        State.token = saved;
                        gapi.client.setToken({ access_token: saved });
                        try { await gapi.client.drive.about.get({ fields: 'user' }); Auth.loadApp(); }
                        catch { localStorage.removeItem('drive_token'); }
                    }
                });
            },
            signIn: () => window.AuthClient.requestAccessToken(),
            logout: () => { google.accounts.oauth2.revoke(State.token, () => { localStorage.removeItem('drive_token'); location.reload(); }); },
            loadApp: async () => {
                document.getElementById('auth-screen').style.display = 'none';
                document.getElementById('app-ui').classList.remove('hidden');
                setTimeout(() => document.getElementById('app-ui').classList.remove('opacity-0'), 100);
                
                // Load User
                const { result: { user, storageQuota } } = await gapi.client.drive.about.get({ fields: 'user,storageQuota' });
                document.getElementById('user-avatar').src = user.photoLink;
                document.getElementById('storage-used').innerText = (storageQuota.usage/1e9).toFixed(1) + ' GB';
                document.getElementById('storage-total').innerText = '/ ' + (storageQuota.limit/1e9).toFixed(0) + ' GB';
                document.getElementById('storage-bar').style.width = (storageQuota.usage/storageQuota.limit*100) + '%';
                
                Drive.load('root');
            }
        };

        // --- DRIVE OS ---
        const Drive = {
            async load(folderId) {
                State.folder = folderId;
                document.getElementById('file-grid').innerHTML = '<div class="col-span-full flex justify-center mt-20"><div class="loader"></div></div>';
                
                let q = `'${folderId}' in parents and trashed = false`;
                if(folderId === 'starred') q = 'starred = true and trashed = false';
                if(folderId === 'trash') q = 'trashed = true';

                // Get Folder Name
                if(folderId !== 'root' && folderId !== 'starred' && folderId !== 'trash') {
                     try { const r = await gapi.client.drive.files.get({ fileId: folderId, fields: 'name' }); document.getElementById('current-path').innerText = r.result.name + '/'; } catch{}
                } else { document.getElementById('current-path').innerText = folderId + '/'; }

                try {
                    const res = await gapi.client.drive.files.list({
                        q: q, pageSize: 100,
                        fields: 'files(id, name, mimeType, iconLink, thumbnailLink, size)',
                        orderBy: 'folder,modifiedTime desc'
                    });
                    State.files = res.result.files || [];
                    UI.render(State.files);
                } catch(e) { console.error(e); }
            },
            
            // Secure fetch for Images/Text (Bypasses CORS)
            async getBlob(id) {
                const r = await fetch(`https://www.googleapis.com/drive/v3/files/${id}?alt=media`, { headers: { 'Authorization': `Bearer ${State.token}` }});
                if(!r.ok) throw new Error('Fetch failed');
                return await r.blob();
            }
        };

        // --- UI RENDERER ---
        const UI = {
            view: (mode) => { State.view = mode; UI.render(State.files); },
            render(files) {
                const grid = document.getElementById('file-grid');
                if(!files.length) return grid.innerHTML = '<div class="col-span-full text-center text-gray-600 font-mono mt-10">NO DATA FOUND</div>';
                
                grid.innerHTML = files.map((f, i) => {
                    const isDir = f.mimeType.includes('folder');
                    const icon = isDir ? 'folder' : (f.mimeType.includes('image') ? 'image' : 'description');
                    const color = isDir ? 'text-yellow-400' : (f.mimeType.includes('image') ? 'text-cyan-400' : 'text-purple-400');
                    const thumb = f.thumbnailLink && !isDir ? f.thumbnailLink.replace('=s220', '=s400') : null;
                    const size = f.size ? (f.size/1e6).toFixed(1)+'MB' : '';

                    if(State.view === 'grid') {
                        return `<div onclick="UI.click('${f.id}','${f.mimeType}')" class="file-card glass rounded-xl cursor-pointer overflow-hidden flex flex-col h-40 animate-fade-up group relative">
                            <div class="h-24 bg-black/40 flex items-center justify-center relative overflow-hidden">
                                ${thumb ? `<img src="${thumb}" class="w-full h-full object-cover opacity-70 group-hover:opacity-100 transition-opacity">` : `<span class="material-icons-round ${color} text-4xl">${icon}</span>`}
                            </div>
                            <div class="p-3 flex-1 flex flex-col justify-center bg-black/60">
                                <div class="text-xs text-gray-200 truncate font-medium">${f.name}</div>
                                <div class="text-[10px] text-gray-500 font-mono flex justify-between mt-1"><span>${size}</span> <span class="material-icons-round text-sm hover:text-white" onclick="event.stopPropagation(); Context.show('${f.id}')">more_vert</span></div>
                            </div>
                        </div>`;
                    } else {
                        return `<div onclick="UI.click('${f.id}','${f.mimeType}')" class="col-span-full file-card glass p-2 flex items-center gap-4 rounded-lg cursor-pointer">
                            <span class="material-icons-round ${color} text-xl">${icon}</span>
                            <div class="flex-1 text-sm text-gray-300 truncate">${f.name}</div>
                            <div class="text-xs text-gray-500 font-mono">${size}</div>
                            <span class="material-icons-round text-gray-500 hover:text-white" onclick="event.stopPropagation(); Context.show('${f.id}')">more_vert</span>
                        </div>`;
                    }
                }).join('');
            },
            click: (id, mime) => mime.includes('folder') ? Drive.load(id) : Viewer.open(State.files.find(f=>f.id===id))
        };

        // --- VIEWER & VISION AI ---
        const Viewer = {
            open(file) {
                State.active = file;
                const body = document.getElementById('viewer-body');
                document.getElementById('viewer-modal').classList.remove('hidden');
                document.getElementById('viewer-filename').innerText = file.name;
                document.getElementById('ai-panel').classList.add('translate-x-full'); // hide AI
                body.innerHTML = '<div class="loader"></div>';

                const mime = file.mimeType;
                if(mime.includes('image')) {
                    // High Res Secure Image
                    Drive.getBlob(file.id).then(blob => {
                        const url = URL.createObjectURL(blob);
                        body.innerHTML = `<img src="${url}" class="max-w-full max-h-full object-contain shadow-2xl border border-white/10 rounded-lg">`;
                    });
                } else if(mime === 'application/pdf') {
                    body.innerHTML = `<iframe src="https://drive.google.com/file/d/${file.id}/preview" class="w-full h-full border-0 bg-black rounded-lg"></iframe>`;
                } else if(mime.includes('video')) {
                    body.innerHTML = `<iframe src="https://drive.google.com/file/d/${file.id}/preview" class="w-full h-full border-0 bg-black rounded-lg"></iframe>`;
                } else {
                    body.innerHTML = `<div class="text-gray-500 flex flex-col items-center"><span class="material-icons-round text-6xl mb-4">description</span>Preview not available</div>`;
                }
            },
            close: () => { document.getElementById('viewer-modal').classList.add('hidden'); document.getElementById('viewer-body').innerHTML = ''; State.active = null; }
        };

        const AI = {
            // VISION CAPABILITY (No Tesseract, pure Gemini Vision)
            async visionAnalyze() {
                if(!State.active) return;
                const panel = document.getElementById('ai-panel');
                const out = document.getElementById('ai-output');
                panel.classList.remove('translate-x-full');
                out.innerHTML = '<div class="flex flex-col items-center mt-10 text-purple-400 gap-3"><div class="loader"></div><div>SCANNING NEURAL DATA...</div></div>';

                try {
                    const fileId = State.active.id;
                    const mime = State.active.mimeType;
                    
                    let parts = [];
                    
                    // 1. IMAGE HANDLING (Base64 for Vision)
                    if(mime.includes('image')) {
                        const blob = await Drive.getBlob(fileId);
                        const base64 = await new Promise((r) => { const req = new FileReader(); req.onload = () => r(req.result.split(',')[1]); req.readAsDataURL(blob); });
                        
                        parts = [
                            { text: "Describe this image in extreme detail. Identify objects, text, colors, and data. If it's a document, transcribe it." },
                            { inline_data: { mime_type: "image/jpeg", data: base64 } }
                        ];
                    }
                    // 2. TEXT/CODE HANDLING
                    else if(mime.includes('text') || mime.includes('javascript') || mime.includes('json') || mime.includes('html')) {
                        const blob = await Drive.getBlob(fileId);
                        const text = await blob.text();
                        parts = [{ text: "Analyze this code/text and summarize it:\n\n" + text.substring(0, 15000) }];
                    }
                    // 3. PDF HANDLING (Text Extraction)
                    else if(mime === 'application/pdf') {
                         const blob = await Drive.getBlob(fileId);
                         const arrayBuffer = await blob.arrayBuffer();
                         const pdf = await pdfjsLib.getDocument(arrayBuffer).promise;
                         let fullText = "";
                         for(let i=1; i<=Math.min(pdf.numPages, 4); i++) {
                             const p = await pdf.getPage(i);
                             const tc = await p.getTextContent();
                             fullText += tc.items.map(s => s.str).join(' ') + "\n";
                         }
                         parts = [{ text: "Analyze this PDF content:\n\n" + fullText }];
                    } else {
                        throw new Error("This file type is not supported for AI Vision yet.");
                    }

                    // Call Gemini
                    const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${Config.geminiKey}`, {
                        method: 'POST', headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ contents: [{ parts: parts }] })
                    });
                    
                    const data = await response.json();
                    const reply = data.candidates?.[0]?.content?.parts?.[0]?.text || "Neural Link Failed.";
                    
                    out.innerHTML = reply.replace(/\*\*(.*?)\*\*/g, '<span class="text-cyan-400 font-bold">$1</span>');

                } catch(e) { out.innerHTML = `<span class="text-red-500">Error: ${e.message}</span>`; }
            }
        };

        // --- CHAT AGENT (Context Aware) ---
        const Chat = {
            toggle: () => { document.getElementById('chat-ui').classList.toggle('active'); document.getElementById('chat-icon').innerText = document.getElementById('chat-ui').classList.contains('active') ? 'expand_more' : 'expand_less'; },
            async send() {
                const input = document.getElementById('chat-input');
                const msg = input.value.trim();
                if(!msg) return;
                
                const box = document.getElementById('chat-history');
                box.innerHTML += `<div class="text-right mb-2"><span class="bg-cyan-900/50 border border-cyan-500/30 text-cyan-100 py-1 px-3 rounded-lg inline-block text-sm">${msg}</span></div>`;
                input.value = '';
                box.scrollTop = box.scrollHeight;

                // CONTEXT: Give AI the list of files in current folder
                const fileContext = State.files.map(f => `- ${f.name} (ID: ${f.id}, Type: ${f.mimeType})`).join('\n');
                
                const prompt = `
                You are Jarvis, an AI OS Assistant.
                Current Folder Files:
                ${fileContext}
                
                User: ${msg}
                
                If the user asks to create a folder, reply with JSON ONLY: {"action": "create_folder", "name": "folder_name"}
                Otherwise, answer helpfully.
                `;

                try {
                    const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${Config.geminiKey}`, {
                        method: 'POST', headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
                    });
                    const data = await res.json();
                    let reply = data.candidates?.[0]?.content?.parts?.[0]?.text;

                    // CHECK FOR ACTIONS (JSON)
                    try {
                        const cmd = JSON.parse(reply.trim()); // Try parsing JSON
                        if(cmd.action === 'create_folder') {
                            await gapi.client.drive.files.create({ resource: { name: cmd.name, mimeType: 'application/vnd.google-apps.folder', parents: [State.folder] } });
                            reply = `âœ… Operation Complete: Created folder "${cmd.name}"`;
                            Drive.load(State.folder); // Refresh
                        }
                    } catch(e) { 
                        // Not JSON, just normal text
                    }

                    box.innerHTML += `<div class="text-left mb-2"><span class="text-gray-300 text-sm">${reply.replace(/\*\*(.*?)\*\*/g, '<b>$1</b>')}</span></div>`;

                } catch(e) { box.innerHTML += `<div class="text-red-500 text-xs">Connection Lost.</div>`; }
                box.scrollTop = box.scrollHeight;
            }
        };
        
        // --- VOICE ---
        const Voice = {
            start() {
                const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
                if(!SpeechRecognition) return Swal.fire('Error', 'Browser does not support Voice.', 'error');
                
                const r = new SpeechRecognition();
                r.lang = 'en-US';
                r.start();
                document.getElementById('chat-input').placeholder = "Listening...";
                
                r.onresult = (e) => {
                    const txt = e.results[0][0].transcript;
                    document.getElementById('chat-input').value = txt;
                    Chat.send();
                    document.getElementById('chat-input').placeholder = "Command...";
                };
            }
        };

        const Context = {
            show(id) {
                const f = State.files.find(x=>x.id===id);
                Swal.fire({
                    title: f.name,
                    background: '#000', color: '#fff',
                    html: `<div class="flex flex-col gap-2">
                        <button onclick="Swal.clickConfirm(); UI.click('${f.id}','${f.mimeType}')" class="btn-action">OPEN</button>
                        <button onclick="Tools.delete('${f.id}')" class="btn-action text-red-400 border-red-900">DELETE</button>
                    </div>`,
                    showConfirmButton: false
                });
            }
        };

        const Tools = {
            findDuplicates() {
                const map = new Map();
                const dups = [];
                State.files.forEach(f => {
                    const k = f.name + f.size;
                    if(map.has(k)) dups.push(f); else map.set(k, f);
                });
                if(!dups.length) return Swal.fire('Clean', 'No duplicates visible.', 'success');
                Swal.fire({ title: `Found ${dups.length} Duplicates`, text: 'Check console for list or implement delete logic.', icon: 'warning' });
            },
            delete: async (id) => { await gapi.client.drive.files.delete({ fileId: id }); Drive.load(State.folder); }
        };

        window.onload = Auth.init;
        document.getElementById('search-box').addEventListener('keyup', (e) => {
             // Basic filter
             const term = e.target.value.toLowerCase();
             const filtered = State.files.filter(f => f.name.toLowerCase().includes(term));
             UI.render(filtered);
        });
    </script>
</body>
</html>
