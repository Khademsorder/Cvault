<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Drive OS Pro+ | Gemini AI</title>
    
    <!-- Libraries -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons+Round" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    <script src="https://apis.google.com/js/api.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.5/gsap.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>
    <link rel="stylesheet" href="https://cdn.plyr.io/3.7.8/plyr.css" />
    <script src="https://cdn.plyr.io/3.7.8/plyr.js"></script>

    <style>
        :root {
            --glass-bg: rgba(15, 23, 42, 0.75);
            --neon-blue: #3b82f6;
            --neon-purple: #8b5cf6;
        }
        body {
            font-family: 'Outfit', sans-serif;
            background: #020617; /* Slate 950 */
            color: #e2e8f0;
            overflow: hidden;
            margin: 0; padding: 0;
            height: 100vh; width: 100vw;
            font-size: 14px; /* Standardize font size */
        }

        /* Background Effects */
        .ambient-glow {
            position: absolute;
            width: 800px; height: 800px;
            background: radial-gradient(circle, rgba(59,130,246,0.1) 0%, transparent 70%);
            border-radius: 50%;
            pointer-events: none;
            z-index: 0;
            animation: breathe 10s infinite ease-in-out;
        }
        @keyframes breathe { 0%,100%{transform:scale(1);opacity:0.4} 50%{transform:scale(1.1);opacity:0.7} }

        /* UI Components */
        .glass {
            background: var(--glass-bg);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid rgba(255,255,255,0.08);
        }
        
        /* Scrollbars */
        .custom-scrollbar::-webkit-scrollbar { width: 5px; height: 5px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: transparent; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.15); border-radius: 10px; }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: rgba(255,255,255,0.3); }

        /* Loader */
        .loader-spinner {
            width: 40px; height: 40px;
            border: 3px solid rgba(255,255,255,0.1);
            border-radius: 50%;
            border-top-color: var(--neon-blue);
            animation: spin 0.8s linear infinite;
        }
        @keyframes spin { to { transform: rotate(360deg); } }

        /* Grid Animations */
        @keyframes slideUp { from { transform: translateY(20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        .animate-slideUp { animation: slideUp 0.4s cubic-bezier(0.16, 1, 0.3, 1) forwards; }

        /* File Card */
        .file-card { transition: all 0.2s ease-out; }
        .file-card:hover {
            transform: translateY(-2px);
            background: rgba(30, 41, 59, 0.9);
            border-color: rgba(59, 130, 246, 0.5);
        }

        /* Chat Window */
        .chat-window {
            position: fixed; bottom: 85px; right: 24px; width: 340px; height: 450px;
            background: rgba(15, 23, 42, 0.95); backdrop-filter: blur(16px);
            border: 1px solid rgba(255,255,255,0.15); border-radius: 16px;
            display: flex; flex-direction: column; overflow: hidden;
            box-shadow: 0 25px 50px -12px rgba(0,0,0,0.5); z-index: 50;
            transform: translateY(120%); transition: transform 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
        }
        .chat-window.open { transform: translateY(0); }
        @media (max-width: 640px) {
            .chat-window { width: calc(100vw - 32px); right: 16px; bottom: 80px; height: 50vh; }
        }

        /* Scanning Animation */
        .scan-line {
            width: 100%; height: 2px; background: #8b5cf6;
            box-shadow: 0 0 10px #8b5cf6;
            animation: scanMove 2s infinite linear;
        }
        @keyframes scanMove { 0%{transform:translateY(0)} 100%{transform:translateY(160px)} }
    </style>
</head>
<body class="h-screen w-screen relative overflow-hidden text-sm">

    <!-- Background Elements -->
    <div class="ambient-glow" style="top:-30%; left:-10%; background: radial-gradient(circle, rgba(59,130,246,0.15) 0%, transparent 60%);"></div>
    <div class="ambient-glow" style="bottom:-30%; right:-10%; background: radial-gradient(circle, rgba(139,92,246,0.15) 0%, transparent 60%); animation-delay: -5s;"></div>

    <!-- AUTH SCREEN -->
    <div id="auth-screen" class="fixed inset-0 z-[100] bg-slate-950 flex items-center justify-center">
        <div class="glass p-8 sm:p-12 rounded-3xl max-w-sm w-full text-center relative overflow-hidden group mx-4 border border-white/10 shadow-2xl">
            <div class="w-16 h-16 mx-auto bg-gradient-to-tr from-blue-600 to-purple-600 rounded-2xl flex items-center justify-center shadow-lg shadow-blue-500/20 mb-6">
                <span class="material-icons-round text-3xl text-white">cloud_queue</span>
            </div>
            <h1 class="text-2xl font-bold text-white mb-2 tracking-tight">Drive OS Pro+</h1>
            <p class="text-slate-400 mb-8 text-sm">Gemini AI Workspace</p>
            <button onclick="Auth.signIn()" class="w-full py-3 bg-white hover:bg-slate-50 text-slate-900 rounded-xl font-semibold transition-all active:scale-95 flex items-center justify-center gap-3">
                <img src="https://upload.wikimedia.org/wikipedia/commons/5/53/Google_%22G%22_Logo.svg" class="w-5 h-5">
                <span>Sign in with Google</span>
            </button>
        </div>
    </div>

    <!-- MAIN APP -->
    <div id="app-ui" class="hidden flex-1 h-full opacity-0 transition-opacity duration-700">
        <div class="flex h-full">
            
            <!-- SIDEBAR -->
            <aside class="w-20 md:w-64 glass h-full border-r border-white/5 flex flex-col z-20 flex-shrink-0">
                <div class="h-16 flex items-center justify-center md:justify-start px-0 md:px-6 border-b border-white/5 shrink-0">
                    <span class="material-icons-round text-blue-500 text-2xl md:mr-3">dns</span>
                    <span class="hidden md:inline text-lg font-bold tracking-tight">Drive<span class="text-blue-400">OS</span></span>
                </div>
                
                <nav class="flex-1 p-3 space-y-1 overflow-y-auto custom-scrollbar">
                    <button onclick="Drive.loadFiles('root')" class="w-full flex items-center justify-center md:justify-start gap-3 px-0 md:px-4 py-2.5 rounded-xl bg-blue-500/10 text-blue-400 border border-blue-500/20">
                        <span class="material-icons-round text-xl">dashboard</span>
                        <span class="hidden md:inline font-medium text-sm">My Drive</span>
                    </button>
                    <button onclick="Drive.loadFiles('starred')" class="w-full flex items-center justify-center md:justify-start gap-3 px-0 md:px-4 py-2.5 rounded-xl text-slate-400 hover:bg-white/5 hover:text-white transition-colors">
                        <span class="material-icons-round text-xl">star</span>
                        <span class="hidden md:inline text-sm">Starred</span>
                    </button>
                    <button onclick="Drive.loadFiles('trash')" class="w-full flex items-center justify-center md:justify-start gap-3 px-0 md:px-4 py-2.5 rounded-xl text-slate-400 hover:bg-white/5 hover:text-white transition-colors">
                        <span class="material-icons-round text-xl">delete</span>
                        <span class="hidden md:inline text-sm">Trash</span>
                    </button>
                    <button onclick="Drive.loadFiles('1zIyinAqjQv96QBSuanFS2F0USaG66GPn')" class="w-full flex items-center justify-center md:justify-start gap-3 px-0 md:px-4 py-2.5 rounded-xl text-purple-400 hover:bg-purple-500/10 transition-colors">
                        <span class="material-icons-round text-xl">vpn_lock</span>
                        <span class="hidden md:inline text-sm">Vault</span>
                    </button>
                </nav>

                <div class="p-4 border-t border-white/5 bg-slate-900/40 hidden md:block shrink-0">
                    <div class="flex justify-between text-[11px] mb-2 font-mono text-blue-300">
                        <span id="storage-used">0 GB</span>
                        <span id="storage-total">/ 0 GB</span>
                    </div>
                    <div class="w-full h-1.5 bg-slate-700 rounded-full overflow-hidden">
                        <div id="storage-bar" class="h-full bg-blue-500 w-0 transition-all duration-1000"></div>
                    </div>
                    <button onclick="Auth.signOut()" class="mt-4 w-full py-2 border border-red-500/20 text-red-400 rounded hover:bg-red-500/10 transition-colors text-[10px] uppercase tracking-wider font-semibold">Log Out</button>
                </div>
                <!-- Mobile Logout -->
                <button onclick="Auth.signOut()" class="md:hidden p-4 text-red-400 border-t border-white/5"><span class="material-icons-round">logout</span></button>
            </aside>

            <!-- CONTENT AREA -->
            <main class="flex-1 flex flex-col relative min-w-0 bg-slate-900/30">
                
                <!-- HEADER -->
                <header class="h-16 border-b border-white/5 flex items-center justify-between px-4 md:px-8 glass z-10 shrink-0">
                    <div class="flex-1 max-w-xl relative group">
                        <span class="material-icons-round absolute left-3 top-1/2 -translate-y-1/2 text-slate-500 text-lg group-focus-within:text-blue-400 transition-colors">search</span>
                        <input type="text" id="search-box" placeholder="Search files..." 
                               class="w-full bg-slate-800/50 border border-white/10 rounded-lg py-2 pl-10 pr-4 text-white text-sm focus:outline-none focus:ring-1 focus:ring-blue-500 focus:border-blue-500 transition-all placeholder-slate-500">
                    </div>
                    
                    <div class="flex items-center gap-4 ml-4">
                        <button onclick="Chat.toggle()" class="w-9 h-9 rounded-full bg-gradient-to-br from-purple-500/20 to-blue-500/20 border border-white/10 flex items-center justify-center hover:border-purple-400/50 transition-colors group">
                            <span class="material-icons-round text-purple-400 group-hover:text-purple-300 text-lg">auto_awesome</span>
                        </button>
                        <div class="flex items-center gap-3 pl-4 border-l border-white/5">
                            <div class="text-right hidden sm:block leading-tight">
                                <div class="font-bold text-white text-sm" id="user-name">Guest</div>
                                <div class="text-[10px] text-slate-400 font-mono" id="user-email">@google</div>
                            </div>
                            <img id="user-avatar" src="https://via.placeholder.com/40" class="w-8 h-8 rounded-full ring-2 ring-white/10">
                        </div>
                    </div>
                </header>

                <!-- BREADCRUMBS / TOOLBAR -->
                <div class="h-12 flex items-center justify-between px-4 md:px-8 border-b border-white/5 bg-slate-900/30 shrink-0">
                    <div class="flex items-center gap-1 text-slate-400 text-xs md:text-sm overflow-hidden whitespace-nowrap">
                        <button class="hover:text-white transition-colors" onclick="Drive.loadFiles('root')">Drive</button>
                        <span class="material-icons-round text-[14px] text-slate-600">chevron_right</span>
                        <span class="text-blue-400 font-medium truncate max-w-[150px] md:max-w-none" id="folder-name">Home</span>
                    </div>
                    <div class="flex gap-1 bg-slate-800/50 p-1 rounded-lg">
                        <button class="p-1.5 rounded hover:bg-white/10 text-white" onclick="UI.setView('grid')"><span class="material-icons-round text-sm">grid_view</span></button>
                        <button class="p-1.5 rounded hover:bg-white/10 text-slate-400 hover:text-white" onclick="UI.setView('list')"><span class="material-icons-round text-sm">view_list</span></button>
                    </div>
                </div>

                <!-- MAIN FILE GRID -->
                <!-- FIXED: Added more grid columns (grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 xl:grid-cols-7) and reduced gap -->
                <div id="file-grid" class="flex-1 overflow-y-auto p-4 md:p-6 grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 xl:grid-cols-7 2xl:grid-cols-8 gap-3 content-start custom-scrollbar">
                    <!-- Files injected here -->
                </div>

                <!-- FAB -->
                <div class="absolute bottom-6 right-6 z-40">
                    <button onclick="document.getElementById('upload-input').click()" class="w-12 h-12 md:w-14 md:h-14 rounded-2xl bg-gradient-to-r from-blue-600 to-purple-600 shadow-lg shadow-blue-600/30 flex items-center justify-center text-white hover:scale-105 active:scale-95 transition-all">
                        <span class="material-icons-round text-2xl md:text-3xl">add</span>
                    </button>
                    <input type="file" id="upload-input" class="hidden" multiple onchange="Upload.handle(this.files)">
                </div>
            </main>
        </div>
    </div>

    <!-- VIEWER OVERLAY -->
    <div id="viewer" class="fixed inset-0 z-[60] bg-slate-950/95 backdrop-blur-xl hidden flex flex-col animate-fadeIn">
        <div class="h-14 flex items-center justify-between px-4 border-b border-white/10 bg-slate-900/80">
            <h2 id="viewer-title" class="text-white font-medium truncate flex-1 text-sm">Preview</h2>
            <div class="flex gap-3">
                <button onclick="AI.scanCurrent()" class="flex items-center gap-2 px-3 py-1.5 bg-purple-500/10 text-purple-400 border border-purple-500/30 rounded-lg hover:bg-purple-500/20 transition-all text-xs font-medium uppercase tracking-wide">
                    <span class="material-icons-round text-sm">psychology</span>
                    <span class="hidden sm:inline">AI Extract</span>
                </button>
                <button onclick="Viewer.close()" class="w-8 h-8 rounded-full bg-white/5 flex items-center justify-center hover:bg-red-500/20 hover:text-red-400 transition-all">
                    <span class="material-icons-round text-lg">close</span>
                </button>
            </div>
        </div>
        
        <div class="flex-1 flex relative overflow-hidden">
            <!-- Content -->
            <div class="flex-1 flex items-center justify-center p-4 bg-[url('https://www.transparenttextures.com/patterns/dark-matter.png')]">
                <div id="viewer-content" class="relative max-w-full max-h-full flex items-center justify-center"></div>
            </div>
            
            <!-- AI Sidebar -->
            <div id="ai-sidebar" class="absolute right-0 top-0 bottom-0 w-80 bg-slate-900 border-l border-white/10 transform translate-x-full transition-transform duration-300 z-10 flex flex-col shadow-2xl">
                <div class="p-4 border-b border-white/5 flex justify-between items-center bg-slate-800/50">
                    <span class="font-bold text-transparent bg-clip-text bg-gradient-to-r from-purple-400 to-pink-400 text-sm">Analysis Results</span>
                    <button onclick="document.getElementById('ai-sidebar').classList.add('translate-x-full')" class="text-slate-500 hover:text-white"><span class="material-icons-round">close</span></button>
                </div>
                <div id="ai-results" class="flex-1 p-4 overflow-y-auto text-slate-300 text-xs custom-scrollbar"></div>
            </div>
        </div>
    </div>

    <!-- CHAT WINDOW -->
    <div id="chat-window" class="chat-window">
        <div class="h-12 bg-gradient-to-r from-blue-600 to-purple-600 p-3 flex justify-between items-center cursor-pointer shadow-lg" onclick="Chat.toggle()">
            <div class="flex items-center gap-2 text-white font-bold text-sm">
                <span class="material-icons-round text-sm">auto_awesome</span> Gemini Assistant
            </div>
            <span class="material-icons-round text-white/80" id="chat-toggle-icon">expand_more</span>
        </div>
        <div class="flex-1 overflow-y-auto p-4 space-y-4 bg-slate-900/50 custom-scrollbar" id="chat-messages">
            <div class="text-xs text-slate-500 text-center mt-4">Ask about your files or general questions.</div>
        </div>
        <div class="p-3 border-t border-white/10 bg-slate-900 flex gap-2">
            <input type="text" id="chat-input" placeholder="Type a message..." class="flex-1 bg-slate-800 border border-white/10 rounded-lg px-3 py-2 text-white text-xs focus:outline-none focus:border-blue-500" onkeydown="if(event.key==='Enter') Chat.send()">
            <button onclick="Chat.send()" class="bg-blue-600 text-white p-2 rounded-lg hover:bg-blue-500 transition-colors"><span class="material-icons-round text-sm">send</span></button>
        </div>
    </div>

    <!-- UPLOAD TOAST -->
    <div id="upload-manager" class="fixed bottom-4 right-4 sm:bottom-6 sm:right-24 w-64 bg-slate-900 border border-white/10 rounded-xl shadow-2xl overflow-hidden transform translate-y-[150%] transition-transform duration-300 z-50">
        <div class="bg-slate-800 p-2.5 flex justify-between items-center cursor-pointer border-b border-white/5" onclick="this.parentElement.classList.toggle('translate-y-[85%]')">
            <span class="text-xs font-bold text-white flex items-center gap-2">
                <span class="material-icons-round text-xs text-blue-400 animate-spin">sync</span> Uploading...
            </span>
            <span class="material-icons-round text-sm text-slate-400">expand_less</span>
        </div>
        <div id="upload-list" class="p-2 space-y-2 max-h-40 overflow-y-auto custom-scrollbar"></div>
    </div>

    <script>
        // ================= CONFIGURATION =================
        const AppConfig = {
            clientId: '318681315152-65e9kofptt4c3bk3kmlj9gmksnasu347.apps.googleusercontent.com',
            scope: 'https://www.googleapis.com/auth/drive.file https://www.googleapis.com/auth/drive.metadata.readonly https://www.googleapis.com/auth/drive.readonly https://www.googleapis.com/auth/userinfo.profile',
            discoveryDocs: ['https://www.googleapis.com/discovery/v1/apis/drive/v3/rest'],
            geminiKey: 'AIzaSyD0hkckrFjwctBCvbWjYYRxTfYkoAbPf4A',
            vaultId: '1zIyinAqjQv96QBSuanFS2F0USaG66GPn'
        };

        const State = {
            token: null,
            currentFolder: 'root',
            files: [],
            activeFile: null,
            viewMode: 'grid',
            isUploading: false
        };

        let searchTimeout;

        // ================= AUTHENTICATION =================
        const Auth = {
            client: null,
            init() {
                Auth.client = google.accounts.oauth2.initTokenClient({
                    client_id: AppConfig.clientId,
                    scope: AppConfig.scope,
                    callback: (response) => {
                        if (response.error) {
                            console.error(response);
                            Swal.fire({ icon: 'error', title: 'Login Failed', text: response.error_description, background: '#0f172a', color: '#fff' });
                            return;
                        }
                        State.token = response.access_token;
                        localStorage.setItem('g_token', State.token);
                        gapi.client.setToken({ access_token: State.token });
                        Auth.onSuccess();
                    }
                });

                gapi.load('client', async () => {
                    await gapi.client.init({ discoveryDocs: AppConfig.discoveryDocs });
                    // Silent login check
                    const saved = localStorage.getItem('g_token');
                    if (saved) {
                        State.token = saved;
                        gapi.client.setToken({ access_token: saved });
                        // Verify token validity by making a small call
                        try {
                            await gapi.client.drive.about.get({ fields: 'user' });
                            Auth.onSuccess();
                        } catch (e) {
                            localStorage.removeItem('g_token'); // Invalid token
                        }
                    }
                });
            },
            signIn() { Auth.client.requestAccessToken(); },
            signOut() {
                if (State.token) {
                    google.accounts.oauth2.revoke(State.token, () => {
                        localStorage.removeItem('g_token');
                        location.reload();
                    });
                } else {
                    location.reload();
                }
            },
            async onSuccess() {
                // UI Transition
                gsap.to('#auth-screen', { opacity: 0, duration: 0.5, onComplete: () => {
                    document.getElementById('auth-screen').style.display = 'none';
                    document.getElementById('app-ui').classList.remove('hidden');
                    gsap.to('#app-ui', { opacity: 1, duration: 0.5 });
                }});

                // Fetch User Info
                try {
                    const res = await fetch(`https://www.googleapis.com/oauth2/v1/userinfo?alt=json&access_token=${State.token}`);
                    const user = await res.json();
                    document.getElementById('user-name').innerText = user.name || 'User';
                    document.getElementById('user-email').innerText = user.email || '';
                    document.getElementById('user-avatar').src = user.picture || 'https://via.placeholder.com/40';
                } catch (e) { console.warn('User info fetch failed', e); }

                // Fetch Storage
                Auth.updateStorage();
                
                // Load Root
                Drive.loadFiles('root');
            },
            async updateStorage() {
                try {
                    const about = await gapi.client.drive.about.get({ fields: 'storageQuota' });
                    const quota = about.result.storageQuota;
                    const used = (quota.usage / 1024 / 1024 / 1024).toFixed(2);
                    const total = (quota.limit / 1024 / 1024 / 1024).toFixed(0);
                    document.getElementById('storage-used').innerText = `${used} GB`;
                    document.getElementById('storage-total').innerText = `/ ${total} GB`;
                    document.getElementById('storage-bar').style.width = `${(quota.usage / quota.limit) * 100}%`;
                } catch (e) {}
            }
        };

        // ================= DRIVE LOGIC =================
        const Drive = {
            async call(fn, ...args) {
                try {
                    return await fn(...args);
                } catch (err) {
                    if (err.status === 401) {
                        // Token refresh mechanism
                        return new Promise((resolve) => {
                            Auth.client.requestAccessToken({ prompt: '', callback: async (resp) => {
                                if (resp.error) { Auth.signIn(); return; }
                                State.token = resp.access_token;
                                localStorage.setItem('g_token', State.token);
                                gapi.client.setToken({ access_token: State.token });
                                resolve(await fn(...args));
                            }});
                        });
                    }
                    throw err;
                }
            },
            async loadFiles(folderId) {
                State.currentFolder = folderId;
                UI.showLoader();
                
                let query = `'${folderId}' in parents and trashed = false`;
                let folderName = 'Folder';

                if (folderId === 'starred') { query = 'starred = true and trashed = false'; folderName = 'Starred'; }
                else if (folderId === 'trash') { query = 'trashed = true'; folderName = 'Trash'; }
                else if (folderId === 'root') { folderName = 'My Drive'; }
                else if (folderId === AppConfig.vaultId) { folderName = 'Vault'; }
                else {
                    // Fetch folder name if it's a generic ID
                    try {
                        const meta = await Drive.call(() => gapi.client.drive.files.get({ fileId: folderId, fields: 'name' }));
                        folderName = meta.result.name;
                    } catch (e) {}
                }

                document.getElementById('folder-name').innerText = folderName;

                try {
                    const response = await Drive.call(() => gapi.client.drive.files.list({
                        q: query,
                        pageSize: 100,
                        fields: 'files(id, name, mimeType, iconLink, thumbnailLink, size, modifiedTime, hasThumbnail)',
                        orderBy: 'folder,modifiedTime desc'
                    }));
                    State.files = response.result.files || [];
                    UI.renderGrid(State.files);
                } catch (e) {
                    Swal.fire({ icon: 'error', title: 'Drive Error', text: e.message, background: '#0f172a', color: '#fff' });
                }
            },
            search(term) {
                clearTimeout(searchTimeout);
                searchTimeout = setTimeout(async () => {
                    if (!term.trim()) { Drive.loadFiles(State.currentFolder); return; }
                    UI.showLoader();
                    try {
                        const response = await Drive.call(() => gapi.client.drive.files.list({
                            q: `name contains '${term}' and trashed = false`,
                            fields: 'files(id, name, mimeType, iconLink, thumbnailLink, size, modifiedTime, hasThumbnail)'
                        }));
                        State.files = response.result.files || [];
                        UI.renderGrid(State.files);
                        document.getElementById('folder-name').innerText = `Search: "${term}"`;
                    } catch (e) {
                        console.error(e);
                    }
                }, 500);
            },
            // Securely fetch file content (Blob) to bypass CORS for Images/AI
            async getFileBlob(fileId) {
                const response = await fetch(`https://www.googleapis.com/drive/v3/files/${fileId}?alt=media`, {
                    headers: { 'Authorization': `Bearer ${State.token}` }
                });
                if (!response.ok) throw new Error('Fetch failed');
                return await response.blob();
            }
        };

        // ================= UI RENDERER =================
        const UI = {
            showLoader() {
                document.getElementById('file-grid').innerHTML = '<div class="col-span-full flex justify-center mt-20"><div class="loader-spinner"></div></div>';
            },
            setView(mode) {
                State.viewMode = mode;
                UI.renderGrid(State.files);
            },
            renderGrid(files) {
                const grid = document.getElementById('file-grid');
                if (!files || files.length === 0) {
                    grid.innerHTML = '<div class="col-span-full text-center text-slate-500 mt-20 flex flex-col items-center"><span class="material-icons-round text-4xl mb-2 opacity-50">folder_off</span>Empty folder</div>';
                    return;
                }
                
                grid.innerHTML = files.map((file, index) => {
                    const isFolder = file.mimeType === 'application/vnd.google-apps.folder';
                    const icon = isFolder ? 'folder' : (file.mimeType.includes('image') ? 'image' : 'description');
                    const color = isFolder ? 'text-yellow-400' : (file.mimeType.includes('image') ? 'text-purple-400' : 'text-blue-400');
                    const size = file.size ? (file.size / 1024 / 1024).toFixed(1) + ' MB' : '';
                    
                    // Use a higher res thumbnail if available
                    let thumb = null;
                    if (file.thumbnailLink && !isFolder) {
                        thumb = file.thumbnailLink.replace('=s220', '=s400'); // Request larger thumb
                    }

                    if (State.viewMode === 'grid') {
                        // FIXED: Reduced height to h-36, smaller icon text-4xl
                        return `
                            <div class="file-card glass rounded-xl overflow-hidden cursor-pointer flex flex-col h-36 animate-slideUp relative group" 
                                 style="animation-delay:${index*0.03}s" 
                                 onclick="UI.handleClick('${file.id}', '${file.mimeType}')">
                                <div class="h-20 bg-slate-800/50 flex items-center justify-center relative overflow-hidden">
                                    ${thumb ? 
                                        `<img src="${thumb}" class="w-full h-full object-cover opacity-80 group-hover:opacity-100 transition-opacity" loading="lazy" referrerpolicy="no-referrer">` : 
                                        `<span class="material-icons-round ${color} text-4xl opacity-80 group-hover:scale-110 transition-transform">${icon}</span>`
                                    }
                                </div>
                                <div class="p-2.5 flex-1 flex flex-col justify-center min-w-0">
                                    <h3 class="text-xs font-medium text-slate-200 truncate leading-tight">${file.name}</h3>
                                    <div class="flex justify-between items-center mt-1">
                                        <span class="text-[9px] text-slate-500 font-mono">${size}</span>
                                        <button class="text-slate-500 hover:text-white" onclick="event.stopPropagation(); ContextMenu.show('${file.id}')"><span class="material-icons-round text-base">more_vert</span></button>
                                    </div>
                                </div>
                            </div>
                        `;
                    } else {
                        return `
                            <div class="col-span-full file-card glass rounded-lg p-2.5 flex items-center gap-3 animate-slideUp cursor-pointer hover:bg-white/5" 
                                 style="animation-delay:${index*0.02}s"
                                 onclick="UI.handleClick('${file.id}', '${file.mimeType}')">
                                <span class="material-icons-round ${color} text-xl">${icon}</span>
                                <div class="flex-1 min-w-0">
                                    <h3 class="text-sm font-medium text-slate-200 truncate">${file.name}</h3>
                                    <span class="text-[10px] text-slate-500">${size}</span>
                                </div>
                                <button class="text-slate-500 hover:text-white" onclick="event.stopPropagation(); ContextMenu.show('${file.id}')"><span class="material-icons-round text-base">more_vert</span></button>
                            </div>
                        `;
                    }
                }).join('');
            },
            handleClick(id, mime) {
                const file = State.files.find(f => f.id === id);
                if (mime === 'application/vnd.google-apps.folder') {
                    Drive.loadFiles(id);
                } else {
                    Viewer.open(file);
                }
            }
        };

        // ================= VIEWER & AI =================
        const Viewer = {
            async open(file) {
                State.activeFile = file;
                const modal = document.getElementById('viewer');
                const content = document.getElementById('viewer-content');
                document.getElementById('viewer-title').innerText = file.name;
                
                modal.classList.remove('hidden');
                content.innerHTML = '<div class="loader-spinner"></div>';
                document.getElementById('ai-sidebar').classList.add('translate-x-full'); // Reset sidebar

                const mime = file.mimeType;
                
                try {
                    if (mime.includes('image')) {
                        // Secure fetch for image to handle CORS/Auth
                        const blob = await Drive.getFileBlob(file.id);
                        const url = URL.createObjectURL(blob);
                        content.innerHTML = `<img src="${url}" class="max-h-full max-w-full rounded-lg shadow-2xl object-contain">`;
                    } 
                    else if (mime.includes('video')) {
                        // Fetch video as blob (heavy but works securely) or try webContentLink
                        // For large videos, webContentLink is better but might require cookie auth.
                        // We will try a direct iframe embed for preview
                         content.innerHTML = `<iframe src="https://drive.google.com/file/d/${file.id}/preview" class="w-full h-full rounded-lg border-0" allowfullscreen></iframe>`;
                    }
                    else if (mime.includes('pdf')) {
                         content.innerHTML = `<iframe src="https://drive.google.com/file/d/${file.id}/preview" class="w-full h-full rounded-lg border-0"></iframe>`;
                    }
                    else if (mime.includes('text') || mime.includes('json') || mime.includes('javascript') || mime.includes('html')) {
                        const blob = await Drive.getFileBlob(file.id);
                        const text = await blob.text();
                        content.innerHTML = `<div class="bg-slate-900 p-6 rounded-lg overflow-auto w-full h-full text-xs font-mono border border-white/10 whitespace-pre-wrap">${text.replace(/</g, '&lt;')}</div>`;
                    }
                    else {
                        content.innerHTML = `<div class="text-center"><span class="material-icons-round text-6xl text-slate-500 mb-4">description</span><p>Preview not available</p></div>`;
                    }
                } catch (e) {
                    content.innerHTML = `<div class="text-red-400">Error loading file: ${e.message}</div>`;
                }
            },
            close() {
                document.getElementById('viewer').classList.add('hidden');
                document.getElementById('viewer-content').innerHTML = ''; // Clear memory
                State.activeFile = null;
            }
        };

        const AI = {
            async scanCurrent() {
                const sidebar = document.getElementById('ai-sidebar');
                const results = document.getElementById('ai-results');
                sidebar.classList.remove('translate-x-full');
                
                if (!State.activeFile) return;

                results.innerHTML = `
                    <div class="relative h-32 bg-slate-800 rounded-lg overflow-hidden border border-blue-500/30 mb-4">
                        <div class="scan-line"></div>
                        <div class="absolute inset-0 flex items-center justify-center text-blue-300 text-xs font-mono">
                            Processing Neural Network...
                        </div>
                    </div>
                `;

                try {
                    if (State.activeFile.mimeType.includes('image')) {
                        const blob = await Drive.getFileBlob(State.activeFile.id);
                        const url = URL.createObjectURL(blob);
                        
                        const { data: { text } } = await Tesseract.recognize(url, 'eng');
                        
                        results.innerHTML = `
                            <h4 class="text-xs font-bold text-slate-500 uppercase mb-2">Extracted Text</h4>
                            <div class="bg-black/40 p-3 rounded border border-white/10 select-all font-mono text-xs whitespace-pre-wrap">${text || 'No text found.'}</div>
                            <button class="mt-3 w-full py-2 bg-blue-600/20 text-blue-400 text-xs rounded hover:bg-blue-600 hover:text-white transition-colors" onclick="navigator.clipboard.writeText(\`${text.replace(/`/g, '\\`')}\`)">Copy Text</button>
                        `;
                    } else {
                        results.innerHTML = `<div class="text-orange-400 p-2 text-center">AI Vision currently supports Image files only.</div>`;
                    }
                } catch (e) {
                    results.innerHTML = `<div class="text-red-400 p-2">Analysis Failed: ${e.message}</div>`;
                }
            }
        };

        // ================= GEMINI CHAT =================
        const Chat = {
            toggle() {
                document.getElementById('chat-window').classList.toggle('open');
                const isOpen = document.getElementById('chat-window').classList.contains('open');
                document.getElementById('chat-toggle-icon').innerText = isOpen ? 'expand_more' : 'expand_less';
            },
            async send() {
                const input = document.getElementById('chat-input');
                const msg = input.value.trim();
                const container = document.getElementById('chat-messages');
                
                if (!msg) return;
                
                // Add User Message
                container.innerHTML += `<div class="text-right mb-3"><span class="bg-blue-600 text-white py-1.5 px-3 rounded-lg rounded-tr-none inline-block max-w-[85%]">${msg}</span></div>`;
                input.value = '';
                container.scrollTop = container.scrollHeight;

                // Add Loader
                const loadId = 'load-' + Date.now();
                container.innerHTML += `<div id="${loadId}" class="text-left mb-3"><span class="bg-slate-700 text-slate-300 py-1.5 px-3 rounded-lg rounded-tl-none inline-block text-xs italic">Thinking...</span></div>`;
                container.scrollTop = container.scrollHeight;

                // Build Context
                let context = "";
                if (State.activeFile) {
                    try {
                        if (State.activeFile.mimeType.includes('text') || State.activeFile.mimeType.includes('json') || State.activeFile.mimeType.includes('javascript')) {
                            const blob = await Drive.getFileBlob(State.activeFile.id);
                            let text = await blob.text();
                            text = text.substring(0, 15000); // Limit context size
                            context = `Context from currently open file (${State.activeFile.name}):\n${text}\n\n`;
                        }
                    } catch (e) { console.log("Context fetch failed", e); }
                }

                const prompt = `${context}User: ${msg}`;

                try {
                    const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${AppConfig.geminiKey}`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
                    });
                    
                    const data = await response.json();
                    let reply = data.candidates?.[0]?.content?.parts?.[0]?.text;
                    
                    if (!reply) reply = "I couldn't process that request.";
                    
                    // Remove Loader and Add Reply
                    document.getElementById(loadId).remove();
                    
                    // Simple Markdown formatting
                    reply = reply.replace(/\*\*(.*?)\*\*/g, '<b>$1</b>').replace(/\n/g, '<br>');
                    
                    container.innerHTML += `<div class="text-left mb-3"><span class="bg-slate-800 border border-white/5 text-slate-200 py-2 px-3 rounded-lg rounded-tl-none inline-block max-w-[90%] shadow-sm">${reply}</span></div>`;
                } catch (e) {
                    document.getElementById(loadId).innerHTML = `<span class="text-red-400">Error connecting to AI.</span>`;
                }
                container.scrollTop = container.scrollHeight;
            }
        };

        // ================= UPLOAD MANAGER =================
        const Upload = {
            handle(files) {
                const manager = document.getElementById('upload-manager');
                const list = document.getElementById('upload-list');
                manager.classList.remove('translate-y-[150%]');
                
                Array.from(files).forEach(file => {
                    const id = Math.random().toString(36).substr(2, 9);
                    const el = document.createElement('div');
                    el.className = 'bg-slate-800/50 p-2 rounded border border-white/5 flex items-center gap-2';
                    el.innerHTML = `
                        <span class="material-icons-round text-slate-400 text-sm">description</span>
                        <div class="flex-1 min-w-0">
                            <div class="flex justify-between text-[10px] text-slate-300 mb-1">
                                <span class="truncate max-w-[100px]">${file.name}</span>
                                <span id="prog-${id}">0%</span>
                            </div>
                            <div class="h-1 bg-slate-700 rounded-full overflow-hidden">
                                <div id="bar-${id}" class="h-full bg-blue-500 w-0 transition-all"></div>
                            </div>
                        </div>
                    `;
                    list.appendChild(el);
                    Upload.process(file, id);
                });
            },
            process(file, id) {
                const metadata = { name: file.name, mimeType: file.type, parents: [State.currentFolder] };
                const form = new FormData();
                form.append('metadata', new Blob([JSON.stringify(metadata)], { type: 'application/json' }));
                form.append('file', file);

                const xhr = new XMLHttpRequest();
                xhr.open('POST', 'https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart');
                xhr.setRequestHeader('Authorization', `Bearer ${State.token}`);
                
                xhr.upload.onprogress = (e) => {
                    if (e.lengthComputable) {
                        const p = (e.loaded / e.total) * 100;
                        document.getElementById(`bar-${id}`).style.width = p + '%';
                        document.getElementById(`prog-${id}`).innerText = Math.round(p) + '%';
                    }
                };
                
                xhr.onload = () => {
                    const bar = document.getElementById(`bar-${id}`);
                    const prog = document.getElementById(`prog-${id}`);
                    if (xhr.status === 200) {
                        bar.className = 'h-full bg-green-500 w-full';
                        prog.innerHTML = '<span class="text-green-400">Done</span>';
                        Drive.loadFiles(State.currentFolder);
                        Auth.updateStorage();
                    } else {
                        bar.className = 'h-full bg-red-500 w-full';
                        prog.innerHTML = '<span class="text-red-400">Error</span>';
                    }
                };
                xhr.send(form);
            }
        };

        // ================= CONTEXT MENU =================
        const ContextMenu = {
            show(fileId) {
                const file = State.files.find(f => f.id === fileId);
                Swal.fire({
                    title: `<span class="text-sm truncate block w-full">${file.name}</span>`,
                    html: `
                        <div class="flex flex-col gap-2 mt-2">
                            <button onclick="Swal.clickConfirm(); Viewer.open(State.files.find(f=>f.id=='${fileId}'))" class="p-2 bg-slate-700 rounded text-sm hover:bg-slate-600 text-white">Open / Preview</button>
                            <button onclick="Swal.clickDeny()" class="p-2 bg-red-500/20 text-red-400 rounded text-sm hover:bg-red-500/30">Delete</button>
                            <a href="${file.webContentLink}" target="_blank" class="p-2 bg-blue-500/20 text-blue-400 rounded text-sm hover:bg-blue-500/30">Download</a>
                        </div>
                    `,
                    showConfirmButton: false,
                    showDenyButton: false,
                    showCloseButton: true,
                    background: '#1e293b',
                    color: '#fff',
                    customClass: { popup: 'rounded-xl border border-white/10' }
                }).then((result) => {
                    if (result.isDenied) {
                        Drive.call(() => gapi.client.drive.files.delete({ fileId: file.id })).then(() => Drive.loadFiles(State.currentFolder));
                    }
                });
            }
        };

        // Initialize
        document.getElementById('search-box').addEventListener('keyup', (e) => Drive.search(e.target.value));
        window.onload = Auth.init;

    </script>
</body>
</html>
