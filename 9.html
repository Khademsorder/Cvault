<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Drive OS Pro+ | Ultimate Edition</title>
    
    <!-- CORE LIBRARIES -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons+Round" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- GOOGLE SCRIPTS -->
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    <script src="https://apis.google.com/js/api.js"></script>
    
    <!-- UTILITIES -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism-tomorrow.min.css" />

    <style>
        :root {
            --bg-dark: #0f172a;
            --glass-panel: rgba(30, 41, 59, 0.75);
            --glass-border: rgba(255, 255, 255, 0.08);
            --accent: #3b82f6;
        }
        body { font-family: 'Outfit', sans-serif; background-color: var(--bg-dark); color: #e2e8f0; overflow: hidden; user-select: none; }
        .glass { background: var(--glass-panel); backdrop-filter: blur(16px); -webkit-backdrop-filter: blur(16px); border: 1px solid var(--glass-border); }
        .custom-scroll::-webkit-scrollbar { width: 6px; }
        .custom-scroll::-webkit-scrollbar-track { background: transparent; }
        .custom-scroll::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.15); border-radius: 10px; }
        .custom-scroll::-webkit-scrollbar-thumb:hover { background: rgba(255,255,255,0.3); }
        @keyframes spin { to { transform: rotate(360deg); } }
        .spinner { animation: spin 1s linear infinite; }
        .file-card { transition: all 0.2s ease; }
        .file-card:hover { background: rgba(255,255,255,0.08); transform: translateY(-2px); border-color: rgba(255,255,255,0.2); }
        .file-card.selected { border: 2px solid var(--accent); background: rgba(59, 130, 246, 0.15); }
        #chat-window { transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1); }
        #chat-window.closed { transform: translateY(110%); }
    </style>
</head>
<body>

    <!-- AUTH SCREEN -->
    <div id="auth-screen" class="fixed inset-0 z-50 flex items-center justify-center bg-slate-950">
        <div class="glass p-10 rounded-3xl max-w-sm w-full text-center border border-white/10 shadow-2xl relative overflow-hidden">
            <div class="absolute top-0 left-0 w-full h-1 bg-gradient-to-r from-blue-500 to-purple-600"></div>
            <div class="w-20 h-20 mx-auto bg-blue-600/20 rounded-2xl flex items-center justify-center mb-6 text-blue-400 border border-blue-500/30">
                <span class="material-icons-round text-5xl">cloud_sync</span>
            </div>
            <h1 class="text-3xl font-bold text-white mb-2">Drive OS Pro+</h1>
            <p class="text-slate-400 mb-8 text-sm">Ultimate AI Cloud Manager</p>
            <button onclick="App.Auth.signIn()" class="w-full py-3 bg-white text-slate-900 rounded-xl font-bold hover:bg-slate-100 transition-all flex items-center justify-center gap-3 shadow-lg hover:scale-[1.02]">
                <img src="https://upload.wikimedia.org/wikipedia/commons/5/53/Google_%22G%22_Logo.svg" class="w-5 h-5"> 
                Sign in with Google
            </button>
        </div>
    </div>

    <!-- MAIN APP -->
    <div id="app-ui" class="hidden h-screen flex flex-col md:flex-row overflow-hidden bg-slate-900">
        
        <!-- SIDEBAR -->
        <aside class="w-20 md:w-64 glass border-r border-white/5 flex flex-col shrink-0 z-20">
            <div class="h-16 flex items-center justify-center md:justify-start md:px-6 border-b border-white/5">
                <span class="material-icons-round text-blue-500 md:mr-2 text-2xl">dns</span>
                <span class="font-bold text-lg hidden md:block">Drive<span class="text-blue-400">OS</span></span>
            </div>
            <nav class="flex-1 p-3 space-y-2 overflow-y-auto custom-scroll">
                <button onclick="App.Drive.loadFiles('root')" class="w-full flex items-center justify-center md:justify-start gap-3 px-0 md:px-4 py-3 rounded-xl bg-blue-500/10 text-blue-400 border border-blue-500/20 hover:bg-blue-500/20 transition group" title="My Drive">
                    <span class="material-icons-round">dashboard</span> <span class="hidden md:inline">My Drive</span>
                </button>
                <button onclick="App.Drive.loadFiles(App.Config.vaultId)" class="w-full flex items-center justify-center md:justify-start gap-3 px-0 md:px-4 py-3 rounded-xl text-purple-400 hover:bg-purple-500/10 transition group" title="Vault">
                    <span class="material-icons-round">vpn_lock</span> <span class="hidden md:inline">Vault</span>
                </button>
                <button onclick="App.Drive.loadFiles('starred')" class="w-full flex items-center justify-center md:justify-start gap-3 px-0 md:px-4 py-3 rounded-xl text-yellow-400 hover:bg-yellow-500/10 transition group" title="Starred">
                    <span class="material-icons-round">star</span> <span class="hidden md:inline">Starred</span>
                </button>
            </nav>
            <div class="p-4 border-t border-white/5 hidden md:block">
                <div class="flex justify-between text-xs text-slate-400 mb-2"><span>Storage</span><span id="storage-text">--</span></div>
                <div class="w-full h-1.5 bg-slate-700 rounded-full overflow-hidden"><div id="storage-bar" class="h-full bg-blue-500 w-0 transition-all duration-1000"></div></div>
                <button onclick="App.Auth.signOut()" class="mt-4 w-full py-2 text-xs text-red-400 border border-red-500/20 rounded hover:bg-red-500/10 transition">Disconnect</button>
            </div>
        </aside>

        <!-- CONTENT -->
        <main class="flex-1 flex flex-col min-w-0 relative bg-[url('https://grainy-gradients.vercel.app/noise.svg')]">
            
            <!-- HEADER -->
            <header class="h-16 glass border-b border-white/5 flex items-center justify-between px-4 z-10">
                <div class="flex items-center gap-3 flex-1">
                    <button id="btn-back" onclick="App.State.goBack()" class="w-8 h-8 rounded-full hover:bg-white/10 flex items-center justify-center text-slate-400 transition disabled:opacity-30 disabled:pointer-events-none">
                        <span class="material-icons-round text-lg">arrow_back</span>
                    </button>
                    <div class="relative max-w-xl w-full">
                        <span class="material-icons-round absolute left-3 top-1/2 -translate-y-1/2 text-slate-500 text-sm">search</span>
                        <input type="text" placeholder="Search files... (Ctrl+K)" class="w-full bg-slate-800/80 border border-white/10 rounded-lg py-2 pl-9 pr-4 text-sm text-white focus:outline-none focus:border-blue-500 transition" oninput="App.Utils.debounce(App.Drive.search, 500)(this.value)">
                    </div>
                </div>
                <div class="flex items-center gap-3 pl-4">
                    <button onclick="App.UI.createFolder()" class="p-2 text-yellow-400 hover:bg-yellow-500/10 rounded-lg transition"><span class="material-icons-round">create_new_folder</span></button>
                    <button onclick="App.Chat.toggle()" class="w-9 h-9 rounded-full bg-gradient-to-br from-purple-500 to-indigo-600 text-white flex items-center justify-center shadow-lg hover:scale-105 transition"><span class="material-icons-round text-lg">auto_awesome</span></button>
                </div>
            </header>

            <!-- BREADCRUMBS -->
            <div class="h-10 flex items-center justify-between px-4 bg-slate-900/40 border-b border-white/5 backdrop-blur-sm">
                <div class="flex items-center gap-1 text-sm text-slate-400">
                    <span class="material-icons-round text-base text-blue-500">folder</span>
                    <span id="folder-title" class="font-medium text-slate-200">Loading...</span>
                </div>
                <select onchange="App.Drive.sort(this.value)" class="bg-transparent text-xs text-slate-400 border-none focus:ring-0 cursor-pointer outline-none">
                    <option value="folder,modifiedTime desc" class="bg-slate-800">Date (Newest)</option>
                    <option value="folder,name" class="bg-slate-800">Name (A-Z)</option>
                    <option value="folder,quotaBytesUsed desc" class="bg-slate-800">Size (Largest)</option>
                </select>
            </div>

            <!-- FILE GRID -->
            <div id="file-container" class="flex-1 overflow-y-auto p-4 custom-scroll relative">
                <div id="file-grid" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 xl:grid-cols-6 gap-3 pb-24"></div>
                <div id="empty-state" class="hidden absolute inset-0 flex flex-col items-center justify-center text-slate-500">
                    <span class="material-icons-round text-6xl mb-2 opacity-50">folder_open</span>
                    <p>Folder is empty</p>
                </div>
                <div id="loader" class="absolute inset-0 flex items-center justify-center bg-slate-900/50 z-10 hidden">
                    <div class="spinner w-8 h-8 border-2 border-blue-500 border-t-transparent rounded-full"></div>
                </div>
            </div>

            <!-- FAB UPLOAD -->
            <div class="absolute bottom-6 right-6 z-30 flex flex-col gap-3 items-end">
                <input type="file" id="file-upload" class="hidden" multiple onchange="App.Drive.uploadFiles(this.files)">
                <button onclick="document.getElementById('file-upload').click()" class="w-14 h-14 bg-blue-600 hover:bg-blue-500 text-white rounded-2xl shadow-xl shadow-blue-600/30 flex items-center justify-center transition-all hover:scale-105 group">
                    <span class="material-icons-round text-3xl group-hover:rotate-90 transition-transform">add</span>
                </button>
            </div>
        </main>
    </div>

    <!-- VIEWER MODAL -->
    <div id="viewer" class="fixed inset-0 z-[60] bg-black/95 hidden flex flex-col animate-fade">
        <div class="h-14 flex items-center justify-between px-4 bg-slate-900 border-b border-white/10">
            <h2 id="viewer-filename" class="text-white text-sm truncate max-w-md font-mono">Preview</h2>
            <div class="flex gap-2">
                <button onclick="App.AI.analyzeFile()" class="px-3 py-1 bg-purple-600/20 text-purple-400 border border-purple-500/30 rounded text-xs flex items-center gap-1 hover:bg-purple-600 hover:text-white transition">
                    <span class="material-icons-round text-sm">psychology</span> Analyze
                </button>
                <button onclick="App.Viewer.download()" class="w-8 h-8 rounded bg-white/10 text-white flex items-center justify-center hover:bg-white/20"><span class="material-icons-round text-sm">download</span></button>
                <button onclick="App.Viewer.close()" class="w-8 h-8 rounded bg-red-500/20 text-red-400 flex items-center justify-center hover:bg-red-500 hover:text-white"><span class="material-icons-round text-sm">close</span></button>
            </div>
        </div>
        <div class="flex-1 flex relative overflow-hidden">
            <div id="viewer-content" class="flex-1 flex items-center justify-center p-4"></div>
            <!-- AI Sidebar -->
            <div id="ai-panel" class="w-80 bg-slate-900 border-l border-white/10 absolute right-0 top-0 bottom-0 transform translate-x-full transition-transform duration-300 z-10 flex flex-col">
                <div class="p-3 border-b border-white/10 flex justify-between items-center bg-slate-800">
                    <span class="text-xs font-bold text-white uppercase tracking-wider">AI Insights</span>
                    <button onclick="document.getElementById('ai-panel').classList.add('translate-x-full')" class="text-slate-400 hover:text-white"><span class="material-icons-round text-sm">close</span></button>
                </div>
                <div id="ai-result" class="flex-1 p-4 overflow-y-auto text-xs text-slate-300 font-mono custom-scroll"></div>
            </div>
        </div>
    </div>

    <!-- CHAT WINDOW -->
    <div id="chat-window" class="fixed bottom-0 right-4 w-96 h-[500px] bg-slate-900 border border-white/10 rounded-t-xl shadow-2xl z-40 flex flex-col closed">
        <div class="p-3 bg-gradient-to-r from-blue-600 to-indigo-600 rounded-t-xl flex justify-between items-center cursor-pointer" onclick="App.Chat.toggle()">
            <span class="text-white font-bold text-sm flex items-center gap-2"><span class="material-icons-round text-sm">auto_awesome</span> Gemini Assistant</span>
            <span class="material-icons-round text-white">expand_more</span>
        </div>
        <div id="chat-messages" class="flex-1 overflow-y-auto p-4 space-y-3 custom-scroll text-xs"></div>
        <div class="p-3 border-t border-white/10 bg-slate-800/50 flex gap-2">
            <input id="chat-input" type="text" placeholder="Ask about files or generate images..." class="flex-1 bg-slate-900 border border-white/10 rounded px-3 py-2 text-white text-xs focus:border-blue-500 outline-none" onkeypress="if(event.key==='Enter') App.Chat.send()">
            <button onclick="App.Chat.send()" class="p-2 bg-blue-600 rounded text-white hover:bg-blue-500"><span class="material-icons-round text-sm">send</span></button>
        </div>
    </div>

    <!-- UPLOAD PROGRESS -->
    <div id="upload-toast" class="fixed bottom-24 left-1/2 -translate-x-1/2 bg-slate-800 border border-white/10 px-4 py-2 rounded-full shadow-xl z-50 flex items-center gap-3 hidden">
        <div class="spinner w-4 h-4 border-2 border-blue-500 border-t-transparent rounded-full"></div>
        <span class="text-xs text-white" id="upload-status">Uploading...</span>
    </div>

    <script>
        // ========== APP LOGIC ==========
        window.App = {
            Config: {
                clientId: '318681315152-65e9kofptt4c3bk3kmlj9gmksnasu347.apps.googleusercontent.com',
                scope: 'https://www.googleapis.com/auth/drive.file https://www.googleapis.com/auth/drive.metadata.readonly https://www.googleapis.com/auth/drive.readonly https://www.googleapis.com/auth/userinfo.profile',
                discoveryDocs: ['https://www.googleapis.com/discovery/v1/apis/drive/v3/rest'],
                geminiKey: 'AIzaSyD0hkckrFjwctBCvbWjYYRxTfYkoAbPf4A',
                hfToken: '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',
                vaultId: '1zIyinAqjQv96QBSuanFS2F0USaG66GPn'
            },

            State: {
                token: null,
                currentFolder: 'root',
                files: [],
                history: [],
                nextPageToken: null,
                activeFile: null,
                blobCache: [],
                
                goBack: () => {
                    if (App.State.history.length > 0) {
                        App.Drive.loadFiles(App.State.history.pop(), false);
                    }
                }
            },

            Auth: {
                tokenClient: null,
                init: () => {
                    App.Auth.tokenClient = google.accounts.oauth2.initTokenClient({
                        client_id: App.Config.clientId,
                        scope: App.Config.scope,
                        callback: (resp) => {
                            if (resp.error) return console.error(resp);
                            App.State.token = resp.access_token;
                            localStorage.setItem('g_token', resp.access_token);
                            App.Auth.onSuccess();
                        }
                    });

                    gapi.load('client', async () => {
                        await gapi.client.init({ discoveryDocs: App.Config.discoveryDocs });
                        const savedToken = localStorage.getItem('g_token');
                        if (savedToken) {
                            App.State.token = savedToken;
                            gapi.client.setToken({ access_token: savedToken });
                            // Verify validity by making a small call
                            try {
                                await gapi.client.drive.about.get({ fields: 'user' });
                                App.Auth.onSuccess();
                            } catch (e) {
                                localStorage.removeItem('g_token'); // Token expired
                            }
                        }
                    });
                },
                signIn: () => App.Auth.tokenClient.requestAccessToken(),
                signOut: () => {
                    const token = gapi.client.getToken();
                    if (token !== null) {
                        google.accounts.oauth2.revoke(token.access_token);
                        gapi.client.setToken('');
                        localStorage.removeItem('g_token');
                        location.reload();
                    }
                },
                onSuccess: () => {
                    document.getElementById('auth-screen').style.display = 'none';
                    document.getElementById('app-ui').classList.remove('hidden');
                    App.Drive.loadFiles('root');
                    App.Drive.updateStorage();
                }
            },

            Drive: {
                loadFiles: async (folderId, pushHistory = true) => {
                    if (pushHistory && folderId !== App.State.currentFolder) {
                        App.State.history.push(App.State.currentFolder);
                        document.getElementById('btn-back').disabled = false;
                    } else if (App.State.history.length === 0) {
                        document.getElementById('btn-back').disabled = true;
                    }

                    App.State.currentFolder = folderId;
                    document.getElementById('loader').classList.remove('hidden');
                    document.getElementById('file-grid').innerHTML = '';
                    
                    let query = `'${folderId}' in parents and trashed = false`;
                    let title = "Folder";

                    if (folderId === 'root') title = "My Drive";
                    else if (folderId === 'starred') { query = "starred = true and trashed = false"; title = "Starred"; }
                    else if (folderId === App.Config.vaultId) title = "Vault";
                    else {
                        try {
                            const meta = await gapi.client.drive.files.get({ fileId: folderId, fields: 'name' });
                            title = meta.result.name;
                        } catch(e){}
                    }
                    
                    document.getElementById('folder-title').innerText = title;

                    try {
                        const res = await gapi.client.drive.files.list({
                            q: query,
                            pageSize: 50,
                            fields: 'nextPageToken, files(id, name, mimeType, iconLink, thumbnailLink, size)',
                            orderBy: document.querySelector('select').value
                        });

                        App.State.files = res.result.files;
                        App.State.nextPageToken = res.result.nextPageToken;
                        App.UI.renderFiles(App.State.files);
                    } catch (e) {
                        console.error(e);
                        if(e.status === 401) App.Auth.signIn();
                    } finally {
                        document.getElementById('loader').classList.add('hidden');
                    }
                },

                search: async (term) => {
                    if (!term) return App.Drive.loadFiles(App.State.currentFolder, false);
                    const q = `name contains '${term}' and trashed = false`;
                    const res = await gapi.client.drive.files.list({ q: q, fields: 'files(id, name, mimeType, iconLink, thumbnailLink, size)' });
                    App.UI.renderFiles(res.result.files);
                    document.getElementById('folder-title').innerText = `Search: "${term}"`;
                },

                sort: (val) => App.Drive.loadFiles(App.State.currentFolder, false),

                uploadFiles: (files) => {
                    if (!files.length) return;
                    const toast = document.getElementById('upload-toast');
                    const status = document.getElementById('upload-status');
                    toast.classList.remove('hidden');

                    Array.from(files).forEach((file, i) => {
                        status.innerText = `Uploading ${i+1}/${files.length}: ${file.name}`;
                        const metadata = { name: file.name, parents: [App.State.currentFolder] };
                        const form = new FormData();
                        form.append('metadata', new Blob([JSON.stringify(metadata)], { type: 'application/json' }));
                        form.append('file', file);

                        fetch('https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart', {
                            method: 'POST',
                            headers: new Headers({ 'Authorization': 'Bearer ' + App.State.token }),
                            body: form
                        }).then(() => {
                            if (i === files.length - 1) {
                                toast.classList.add('hidden');
                                App.Drive.loadFiles(App.State.currentFolder, false);
                                App.Utils.showToast("Upload Complete");
                            }
                        });
                    });
                },

                updateStorage: async () => {
                    try {
                        const res = await gapi.client.drive.about.get({ fields: 'storageQuota' });
                        const q = res.result.storageQuota;
                        const used = (q.usage / 1024 / 1024 / 1024).toFixed(1);
                        const total = (q.limit / 1024 / 1024 / 1024).toFixed(0);
                        document.getElementById('storage-text').innerText = `${used} GB / ${total} GB`;
                        document.getElementById('storage-bar').style.width = `${(q.usage / q.limit) * 100}%`;
                    } catch(e){}
                }
            },

            UI: {
                renderFiles: (files) => {
                    const grid = document.getElementById('file-grid');
                    grid.innerHTML = '';
                    const empty = document.getElementById('empty-state');
                    
                    if (!files || files.length === 0) {
                        empty.classList.remove('hidden');
                        return;
                    }
                    empty.classList.add('hidden');

                    files.forEach((f, i) => {
                        const isFolder = f.mimeType.includes('folder');
                        const card = document.createElement('div');
                        card.className = 'file-card glass p-3 rounded-xl cursor-pointer flex flex-col group animate-fade';
                        card.style.animationDelay = `${i * 0.05}s`;
                        
                        let thumb = '';
                        if (f.thumbnailLink && !isFolder) {
                            const hdThumb = f.thumbnailLink.replace('=s220', '=s600');
                            thumb = `<div class="h-24 rounded-lg bg-slate-800 mb-2 overflow-hidden relative"><img src="${hdThumb}" class="w-full h-full object-cover opacity-90 group-hover:opacity-100 transition" loading="lazy"></div>`;
                        } else {
                            const icon = isFolder ? 'folder' : 'description';
                            const color = isFolder ? 'text-yellow-400' : 'text-blue-400';
                            thumb = `<div class="h-24 rounded-lg bg-slate-800/50 mb-2 flex items-center justify-center"><span class="material-icons-round ${color} text-4xl">${icon}</span></div>`;
                        }

                        card.innerHTML = `
                            ${thumb}
                            <div class="flex items-start justify-between">
                                <span class="text-xs text-slate-300 font-medium truncate w-full">${f.name}</span>
                            </div>
                        `;
                        
                        card.onclick = () => {
                            if (isFolder) App.Drive.loadFiles(f.id);
                            else App.Viewer.open(f);
                        };
                        grid.appendChild(card);
                    });
                },
                createFolder: async () => {
                    const { value: name } = await Swal.fire({
                        title: 'New Folder',
                        input: 'text',
                        background: '#1e293b',
                        color: '#fff',
                        showCancelButton: true
                    });
                    if (name) {
                        await gapi.client.drive.files.create({
                            resource: { name: name, mimeType: 'application/vnd.google-apps.folder', parents: [App.State.currentFolder] }
                        });
                        App.Drive.loadFiles(App.State.currentFolder, false);
                    }
                }
            },

            Viewer: {
                open: async (file) => {
                    App.State.activeFile = file;
                    document.getElementById('viewer').classList.remove('hidden');
                    document.getElementById('viewer-filename').innerText = file.name;
                    const container = document.getElementById('viewer-content');
                    container.innerHTML = '<div class="spinner w-8 h-8 border-2 border-blue-500 border-t-transparent rounded-full"></div>';
                    
                    try {
                        const headers = { 'Authorization': 'Bearer ' + App.State.token };
                        let content = '';

                        if (file.mimeType.includes('image')) {
                            const res = await fetch(`https://www.googleapis.com/drive/v3/files/${file.id}?alt=media`, { headers });
                            const blob = await res.blob();
                            const url = URL.createObjectURL(blob);
                            App.State.blobCache.push(url);
                            content = `<img src="${url}" class="max-h-full max-w-full rounded shadow-lg">`;
                        } else if (file.mimeType.includes('video')) {
                            content = `<iframe src="https://drive.google.com/file/d/${file.id}/preview" class="w-full h-full border-0 rounded bg-black"></iframe>`;
                        } else if (file.mimeType.includes('text') || file.mimeType.includes('json') || file.mimeType.includes('javascript')) {
                            const res = await fetch(`https://www.googleapis.com/drive/v3/files/${file.id}?alt=media`, { headers });
                            const text = await res.text();
                            content = `<pre class="text-xs text-slate-300 font-mono bg-slate-900 p-4 rounded overflow-auto h-full w-full max-w-4xl border border-white/10">${text.replace(/</g, '&lt;')}</pre>`;
                        } else {
                            content = `<div class="text-center"><span class="material-icons-round text-6xl text-slate-600">visibility_off</span><p class="mt-4 text-slate-400">Preview not supported</p></div>`;
                        }
                        container.innerHTML = content;
                    } catch (e) {
                        container.innerHTML = '<p class="text-red-400">Error loading preview</p>';
                    }
                },
                close: () => {
                    document.getElementById('viewer').classList.add('hidden');
                    document.getElementById('ai-panel').classList.add('translate-x-full');
                    App.State.blobCache.forEach(url => URL.revokeObjectURL(url));
                    App.State.blobCache = [];
                },
                download: async () => {
                    const f = App.State.activeFile;
                    const url = `https://www.googleapis.com/drive/v3/files/${f.id}?alt=media`;
                    const res = await fetch(url, { headers: { 'Authorization': `Bearer ${App.State.token}` } });
                    const blob = await res.blob();
                    const a = document.createElement('a');
                    a.href = URL.createObjectURL(blob);
                    a.download = f.name;
                    a.click();
                }
            },

            AI: {
                analyzeFile: async () => {
                    if (!App.State.activeFile) return;
                    const panel = document.getElementById('ai-panel');
                    const resDiv = document.getElementById('ai-result');
                    panel.classList.remove('translate-x-full');
                    resDiv.innerHTML = '<div class="text-center mt-10"><div class="spinner w-6 h-6 border-2 border-purple-500 border-t-transparent rounded-full mx-auto"></div><p class="mt-2 text-purple-400">Analyzing...</p></div>';

                    try {
                        // 1. Get text content
                        let textContext = "";
                        const headers = { 'Authorization': 'Bearer ' + App.State.token };
                        
                        if (App.State.activeFile.mimeType.includes('text') || App.State.activeFile.mimeType.includes('code')) {
                            const r = await fetch(`https://www.googleapis.com/drive/v3/files/${App.State.activeFile.id}?alt=media`, { headers });
                            textContext = (await r.text()).slice(0, 10000); // Limit context
                        } else {
                            textContext = `File Name: ${App.State.activeFile.name} (MIME: ${App.State.activeFile.mimeType}). I cannot read the binary content directly, so infer from name.`;
                        }

                        // 2. Call Gemini
                        const prompt = `Analyze this file content briefly:\n\n${textContext}`;
                        const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${App.Config.geminiKey}`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
                        });
                        
                        const data = await response.json();
                        const md = data.candidates?.[0]?.content?.parts?.[0]?.text || "No insights available.";
                        resDiv.innerHTML = marked.parse(md);
                    } catch (e) {
                        resDiv.innerHTML = `<p class="text-red-400">Analysis failed: ${e.message}</p>`;
                    }
                }
            },

            Chat: {
                toggle: () => document.getElementById('chat-window').classList.toggle('closed'),
                send: async () => {
                    const input = document.getElementById('chat-input');
                    const msg = input.value.trim();
                    if (!msg) return;
                    
                    const box = document.getElementById('chat-messages');
                    box.innerHTML += `<div class="text-right mb-2"><span class="bg-blue-600 text-white px-3 py-1 rounded-lg inline-block">${msg}</span></div>`;
                    input.value = '';
                    box.scrollTop = box.scrollHeight;

                    // Image Generation Check
                    if (msg.toLowerCase().startsWith('generate image')) {
                        const prompt = msg.replace(/generate image/i, '').trim();
                        box.innerHTML += `<div class="text-left mb-2 text-xs text-slate-400">ðŸŽ¨ Generating...</div>`;
                        try {
                            const res = await fetch("https://api-inference.huggingface.co/models/prompthero/openjourney", {
                                method: "POST",
                                headers: { Authorization: `Bearer ${App.Config.hfToken}` },
                                body: JSON.stringify({ inputs: prompt })
                            });
                            const blob = await res.blob();
                            const url = URL.createObjectURL(blob);
                            box.innerHTML += `<div class="text-left mb-2"><img src="${url}" class="rounded-lg w-48 border border-white/10"></div>`;
                        } catch(e) {
                            box.innerHTML += `<div class="text-left text-red-400 text-xs">Gen failed</div>`;
                        }
                        box.scrollTop = box.scrollHeight;
                        return;
                    }

                    // Regular Chat
                    try {
                        const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${App.Config.geminiKey}`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ contents: [{ parts: [{ text: `User: ${msg}\nContext: File Manager Assistant.` }] }] })
                        });
                        const data = await response.json();
                        const reply = data.candidates?.[0]?.content?.parts?.[0]?.text || "Error";
                        box.innerHTML += `<div class="text-left mb-2"><span class="bg-slate-700 text-slate-200 px-3 py-1 rounded-lg inline-block">${marked.parseInline(reply)}</span></div>`;
                    } catch (e) {
                        box.innerHTML += `<div class="text-left text-red-400">AI Error</div>`;
                    }
                    box.scrollTop = box.scrollHeight;
                }
            },

            Utils: {
                debounce: (func, wait) => {
                    let timeout;
                    return (...args) => {
                        clearTimeout(timeout);
                        timeout = setTimeout(() => func.apply(this, args), wait);
                    };
                },
                showToast: (msg) => {
                    const t = document.createElement('div');
                    t.className = 'fixed bottom-5 left-1/2 -translate-x-1/2 bg-slate-800 text-white px-4 py-2 rounded-full border border-white/10 shadow-lg text-xs z-50 animate-fade';
                    t.innerText = msg;
                    document.body.appendChild(t);
                    setTimeout(() => t.remove(), 2000);
                }
            }
        };

        // Initialize
        window.onload = App.Auth.init;
    </script>
</body>
</html>
