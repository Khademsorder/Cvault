<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Drive OS Pro+ | Ultra</title>
    
    <!-- Libraries -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons+Round" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    <script src="https://apis.google.com/js/api.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.5/gsap.min.js"></script>
    <!-- OCR & PDF Reading -->
    <script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script>pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';</script>

    <style>
        :root { --glass-bg: rgba(15, 23, 42, 0.85); --neon-blue: #3b82f6; }
        body { font-family: 'Outfit', sans-serif; background: #020617; color: #e2e8f0; overflow: hidden; height: 100vh; font-size: 14px; }
        .glass { background: var(--glass-bg); backdrop-filter: blur(24px); border: 1px solid rgba(255,255,255,0.08); }
        .custom-scrollbar::-webkit-scrollbar { width: 5px; height: 5px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: transparent; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.15); border-radius: 10px; }
        .loader-spinner { width: 40px; height: 40px; border: 3px solid rgba(255,255,255,0.1); border-radius: 50%; border-top-color: var(--neon-blue); animation: spin 0.8s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
        @keyframes slideUp { from { transform: translateY(20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        .animate-slideUp { animation: slideUp 0.3s cubic-bezier(0.16, 1, 0.3, 1) forwards; }
        .file-card:hover { transform: translateY(-2px); background: rgba(30, 41, 59, 0.95); border-color: #3b82f6; }
        
        /* Chat & Viewers */
        .chat-window { position: fixed; bottom: 85px; right: 24px; width: 360px; height: 500px; background: #0f172a; border: 1px solid #334155; border-radius: 16px; display: flex; flex-direction: column; z-index: 50; transform: translateY(120%); transition: transform 0.3s; box-shadow: 0 20px 40px rgba(0,0,0,0.5); }
        .chat-window.open { transform: translateY(0); }
        .scan-line { width: 100%; height: 2px; background: #8b5cf6; box-shadow: 0 0 10px #8b5cf6; animation: scanMove 2s infinite linear; }
        @keyframes scanMove { 0%{transform:translateY(0)} 100%{transform:translateY(128px)} }
        .ai-summary-tooltip { position: absolute; background: rgba(0,0,0,0.9); color: white; padding: 4px 8px; border-radius: 4px; font-size: 10px; max-width: 200px; z-index: 100; pointer-events: none; }
    </style>
</head>
<body class="h-screen w-screen relative overflow-hidden">

    <!-- Auth Screen -->
    <div id="auth-screen" class="fixed inset-0 z-[100] bg-slate-950 flex items-center justify-center">
        <div class="glass p-10 rounded-3xl max-w-sm w-full text-center border border-white/10">
            <div class="w-16 h-16 mx-auto bg-blue-600 rounded-2xl flex items-center justify-center mb-6 shadow-lg shadow-blue-500/20">
                <span class="material-icons-round text-3xl text-white">cloud_upload</span>
            </div>
            <h1 class="text-2xl font-bold text-white mb-2">Drive OS Pro+</h1>
            <p class="text-slate-400 mb-8 text-sm">Secure. AI-Powered. Unlimited.</p>
            <button onclick="Auth.signIn()" class="w-full py-3 bg-white text-slate-900 rounded-xl font-bold hover:bg-slate-100 transition-all flex items-center justify-center gap-3">
                <img src="https://upload.wikimedia.org/wikipedia/commons/5/53/Google_%22G%22_Logo.svg" class="w-5 h-5"> Sign in with Google
            </button>
        </div>
    </div>

    <!-- Main UI -->
    <div id="app-ui" class="hidden flex-1 h-full opacity-0 transition-opacity duration-700">
        <div class="flex h-full">
            
            <!-- Sidebar -->
            <aside class="w-20 md:w-64 glass h-full border-r border-white/5 flex flex-col z-20 shrink-0">
                <div class="h-16 flex items-center justify-center md:justify-start px-0 md:px-6 border-b border-white/5">
                    <span class="material-icons-round text-blue-500 text-2xl md:mr-3">dns</span>
                    <span class="hidden md:inline text-lg font-bold">Drive<span class="text-blue-400">OS</span></span>
                </div>
                <nav class="flex-1 p-3 space-y-1 overflow-y-auto custom-scrollbar">
                    <button onclick="Drive.loadFiles('root')" class="w-full flex items-center gap-3 px-4 py-3 rounded-xl bg-blue-500/10 text-blue-400 border border-blue-500/20">
                        <span class="material-icons-round">dashboard</span> <span class="hidden md:inline">My Drive</span>
                    </button>
                    <!-- VAULT BUTTON -->
                    <button onclick="Drive.loadFiles('1zIyinAqjQv96QBSuanFS2F0USaG66GPn')" class="w-full flex items-center gap-3 px-4 py-3 rounded-xl text-purple-400 hover:bg-purple-500/10">
                        <span class="material-icons-round">vpn_lock</span> <span class="hidden md:inline">Vault</span>
                    </button>
                    <button onclick="Drive.loadFiles('starred')" class="w-full flex items-center gap-3 px-4 py-3 rounded-xl text-slate-400 hover:bg-white/5 hover:text-white">
                        <span class="material-icons-round">star</span> <span class="hidden md:inline">Starred</span>
                    </button>
                    <button onclick="Tools.findDuplicates()" class="w-full flex items-center gap-3 px-4 py-3 rounded-xl text-pink-400 hover:bg-pink-500/10">
                        <span class="material-icons-round">content_copy</span> <span class="hidden md:inline">Find Duplicates</span>
                    </button>
                </nav>
                <div class="p-4 border-t border-white/5 hidden md:block">
                    <div class="flex justify-between text-xs text-blue-300 mb-2"><span id="storage-used">--</span> <span id="storage-total">--</span></div>
                    <div class="w-full h-1 bg-slate-700 rounded-full"><div id="storage-bar" class="h-full bg-blue-500 w-0 transition-all"></div></div>
                    <button onclick="Auth.signOut()" class="mt-4 w-full py-2 text-xs text-red-400 border border-red-500/20 rounded hover:bg-red-500/10">LOGOUT</button>
                </div>
            </aside>

            <!-- Content -->
            <main class="flex-1 flex flex-col min-w-0 bg-slate-900/50">
                <header class="h-16 border-b border-white/5 flex items-center justify-between px-4 glass z-10">
                    <div class="flex items-center gap-2">
                        <!-- BACK BUTTON -->
                        <button id="back-button" onclick="History.goBack()" class="w-8 h-8 rounded-full bg-white/5 hover:bg-white/10 flex items-center justify-center text-slate-400 hover:text-white transition-colors disabled:opacity-30 disabled:pointer-events-none" disabled>
                            <span class="material-icons-round text-lg">arrow_back</span>
                        </button>
                        <div class="flex-1 max-w-xl relative ml-2">
                            <span class="material-icons-round absolute left-3 top-1/2 -translate-y-1/2 text-slate-500">search</span>
                            <input type="text" id="search-box" placeholder="Search files..." class="w-full bg-slate-800/50 border border-white/10 rounded-lg py-2 pl-10 pr-10 text-white text-sm focus:outline-none focus:border-blue-500">
                            <span onclick="Drive.clearSearch()" id="clear-search" class="material-icons-round absolute right-3 top-1/2 -translate-y-1/2 text-slate-500 cursor-pointer hidden text-sm hover:text-white">close</span>
                        </div>
                    </div>
                    <div class="flex items-center gap-4 ml-4">
                        <select id="sort-select" onchange="Drive.sort(this.value)" class="bg-slate-800 border border-white/10 text-xs text-slate-300 rounded px-2 py-1.5 focus:outline-none">
                            <option value="folder,modifiedTime desc">Sort: Date (New)</option>
                            <option value="folder,modifiedTime asc">Sort: Date (Old)</option>
                            <option value="folder,name">Sort: Name (A-Z)</option>
                            <option value="folder,quotaBytesUsed desc">Sort: Size (Big)</option>
                        </select>
                        <button onclick="Chat.toggle()" class="w-9 h-9 rounded-full bg-gradient-to-br from-purple-500 to-blue-600 flex items-center justify-center text-white shadow-lg"><span class="material-icons-round text-lg">auto_awesome</span></button>
                    </div>
                </header>

                <div class="h-10 flex items-center justify-between px-4 border-b border-white/5 bg-slate-900/30">
                    <div class="flex items-center gap-1 text-xs text-slate-400">
                        <button onclick="Drive.loadFiles('root')" class="hover:text-white">Drive</button>
                        <span class="material-icons-round text-[14px]">chevron_right</span>
                        <span class="text-blue-400 font-medium truncate max-w-[200px]" id="folder-name">Home</span>
                    </div>
                    <div class="flex gap-1">
                        <button onclick="UI.setView('grid')" class="p-1 text-white"><span class="material-icons-round text-sm">grid_view</span></button>
                        <button onclick="UI.setView('list')" class="p-1 text-slate-500 hover:text-white"><span class="material-icons-round text-sm">view_list</span></button>
                    </div>
                </div>

                <div id="file-grid" class="flex-1 overflow-y-auto p-4 grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 xl:grid-cols-7 gap-3 content-start custom-scrollbar"></div>

                <div class="absolute bottom-6 right-6 z-40">
                    <button onclick="document.getElementById('upload-input').click()" class="w-14 h-14 rounded-2xl bg-blue-600 text-white shadow-lg shadow-blue-600/30 flex items-center justify-center hover:scale-105 transition-all"><span class="material-icons-round text-3xl">add</span></button>
                    <input type="file" id="upload-input" class="hidden" multiple onchange="Upload.handle(this.files)">
                </div>
            </main>
        </div>
    </div>

    <!-- Viewer -->
    <div id="viewer" class="fixed inset-0 z-[60] bg-black/95 hidden flex flex-col">
        <div class="h-14 flex items-center justify-between px-4 bg-slate-900 border-b border-white/10">
            <h2 id="viewer-title" class="text-white text-sm truncate max-w-md">Preview</h2>
            <div class="flex gap-3">
                <button onclick="AI.analyzeCurrentFile()" class="flex items-center gap-2 px-3 py-1 bg-purple-600/20 text-purple-400 border border-purple-500/30 rounded hover:bg-purple-600 hover:text-white text-xs">
                    <span class="material-icons-round text-sm">psychology</span> AI Analyze
                </button>
                <!-- Background Removal Button (visible only for images) -->
                <button id="remove-bg-btn" onclick="ImageTools.removeBackground()" class="flex items-center gap-2 px-3 py-1 bg-green-600/20 text-green-400 border border-green-500/30 rounded hover:bg-green-600 hover:text-white text-xs hidden">
                    <span class="material-icons-round text-sm">auto_awesome</span> Remove BG
                </button>
                <button onclick="Viewer.downloadCurrent()" class="w-8 h-8 flex items-center justify-center rounded bg-white/10 hover:bg-white/20 text-white"><span class="material-icons-round text-sm">download</span></button>
                <button onclick="Viewer.close()" class="w-8 h-8 flex items-center justify-center rounded bg-red-500/20 text-red-400 hover:bg-red-500 hover:text-white"><span class="material-icons-round text-sm">close</span></button>
            </div>
        </div>
        <div class="flex-1 flex relative overflow-hidden">
            <div id="viewer-content" class="flex-1 flex items-center justify-center p-4"></div>
            <!-- AI Sidebar -->
            <div id="ai-sidebar" class="w-80 bg-slate-900 border-l border-white/10 absolute right-0 top-0 bottom-0 transform translate-x-full transition-transform duration-300 z-10 flex flex-col">
                <div class="p-3 border-b border-white/10 flex justify-between items-center text-white font-bold text-xs bg-slate-800">
                    <span>AI Analysis</span>
                    <button onclick="document.getElementById('ai-sidebar').classList.add('translate-x-full')" class="text-slate-400"><span class="material-icons-round">close</span></button>
                </div>
                <div id="ai-results" class="flex-1 p-4 overflow-y-auto text-slate-300 text-xs whitespace-pre-wrap font-mono custom-scrollbar"></div>
            </div>
        </div>
    </div>

    <!-- Chat -->
    <div id="chat-window" class="chat-window">
        <div class="p-3 bg-gradient-to-r from-blue-600 to-purple-600 text-white font-bold text-sm flex justify-between cursor-pointer rounded-t-xl" onclick="Chat.toggle()">
            <span class="flex items-center gap-2"><span class="material-icons-round text-sm">auto_awesome</span> Gemini AI</span>
            <span class="material-icons-round text-sm">expand_more</span>
        </div>
        <div id="chat-messages" class="flex-1 overflow-y-auto p-4 space-y-3 custom-scrollbar text-xs">
            <div class="text-slate-500 text-center italic">Ask about your files...</div>
        </div>
        <!-- Updated Chat Input with Mic Button -->
        <div class="p-3 border-t border-white/10 flex gap-2 items-center bg-slate-900/50 relative">
            <button id="mic-btn" onclick="Voice.toggle()" class="w-9 h-9 rounded-full bg-slate-700 hover:bg-slate-600 flex items-center justify-center transition-all group relative shrink-0">
                <span id="mic-icon" class="material-icons-round text-white text-sm relative z-10">mic</span>
                <span id="mic-pulse" class="absolute inset-0 rounded-full bg-red-500/50 animate-ping hidden"></span>
            </button>
            
            <input id="chat-input" type="text" placeholder="Command Jarvis..." class="flex-1 bg-slate-800 border border-white/10 rounded px-3 py-2 text-white text-xs focus:outline-none focus:border-blue-500">
            
            <button onclick="Chat.sendFromInput()" class="w-9 h-9 rounded bg-blue-600 hover:bg-blue-500 flex items-center justify-center shrink-0">
                <span class="material-icons-round text-white text-sm">send</span>
            </button>
        </div>
    </div>

    <script>
        const AppConfig = {
            clientId: '318681315152-65e9kofptt4c3bk3kmlj9gmksnasu347.apps.googleusercontent.com',
            scope: 'https://www.googleapis.com/auth/drive.file https://www.googleapis.com/auth/drive.metadata.readonly https://www.googleapis.com/auth/drive.readonly https://www.googleapis.com/auth/userinfo.profile',
            discoveryDocs: ['https://www.googleapis.com/discovery/v1/apis/drive/v3/rest'],
            geminiKey: 'AIzaSyD0hkckrFjwctBCvbWjYYRxTfYkoAbPf4A', // Your key
            hfToken: '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', // Hugging Face token
            vaultId: '1zIyinAqjQv96QBSuanFS2F0USaG66GPn' // Admin Vault
        };

        const State = {
            token: null,
            currentFolder: 'root',
            files: [],
            originalFiles: [],
            activeFile: null,
            viewMode: 'grid',
            sortOrder: 'folder,modifiedTime desc',
            history: [] // for back navigation
        };
        let searchTimeout;

        // --- AUTH with token refresh ---
        const Auth = {
            client: null,
            init() {
                Auth.client = google.accounts.oauth2.initTokenClient({
                    client_id: AppConfig.clientId, scope: AppConfig.scope,
                    callback: (resp) => {
                        if (resp.error) return Swal.fire('Error', resp.error_description, 'error');
                        State.token = resp.access_token;
                        localStorage.setItem('g_token', State.token);
                        gapi.client.setToken({ access_token: State.token });
                        Auth.onSuccess();
                    }
                });
                gapi.load('client', async () => {
                    await gapi.client.init({ discoveryDocs: AppConfig.discoveryDocs });
                    const saved = localStorage.getItem('g_token');
                    if (saved) {
                        State.token = saved;
                        gapi.client.setToken({ access_token: saved });
                        try { await gapi.client.drive.about.get({ fields: 'user' }); Auth.onSuccess(); } 
                        catch { localStorage.removeItem('g_token'); }
                    }
                });
            },
            signIn: () => Auth.client.requestAccessToken(),
            signOut: () => { google.accounts.oauth2.revoke(State.token, () => { localStorage.removeItem('g_token'); location.reload(); }); },
            async refreshToken() {
                return new Promise((resolve, reject) => {
                    Auth.client.requestAccessToken({ prompt: '', callback: (resp) => {
                        if (resp.error) reject(resp);
                        else {
                            State.token = resp.access_token;
                            localStorage.setItem('g_token', State.token);
                            gapi.client.setToken({ access_token: State.token });
                            resolve();
                        }
                    }});
                });
            },
            onSuccess: async () => {
                document.getElementById('auth-screen').style.display = 'none';
                document.getElementById('app-ui').classList.remove('hidden');
                gsap.to('#app-ui', { opacity: 1, duration: 0.5 });
                Drive.loadFiles('root');
                Auth.updateStorage();
            },
            updateStorage: async () => {
                try {
                    const { result: { storageQuota: q } } = await gapi.client.drive.about.get({ fields: 'storageQuota' });
                    document.getElementById('storage-used').innerText = (q.usage/1e9).toFixed(2) + ' GB';
                    document.getElementById('storage-total').innerText = '/ ' + (q.limit/1e9).toFixed(0) + ' GB';
                    document.getElementById('storage-bar').style.width = (q.usage/q.limit)*100 + '%';
                } catch(e){}
            }
        };

        // --- DRIVE with token refresh wrapper ---
        const Drive = {
            async call(fn, ...args) {
                try {
                    return await fn(...args);
                } catch (err) {
                    if (err.status === 401) {
                        // Token expired â€“ refresh and retry
                        await Auth.refreshToken();
                        return await fn(...args);
                    }
                    throw err;
                }
            },
            async loadFiles(folderId, addToHistory = true) {
                if (addToHistory && folderId !== State.currentFolder) {
                    State.history.push(State.currentFolder);
                    History.updateBackButton();
                }
                State.currentFolder = folderId;
                UI.showLoader();
                
                let q = `'${folderId}' in parents and trashed = false`;
                let name = "Folder";
                if(folderId === 'starred') { q = 'starred = true and trashed = false'; name = "Starred"; }
                else if(folderId === 'root') { name = "My Drive"; }
                else if(folderId === AppConfig.vaultId) { name = "Vault"; }
                else { try { const r = await Drive.call(() => gapi.client.drive.files.get({ fileId: folderId, fields: 'name' })); name = r.result.name; } catch(e){} }
                
                document.getElementById('folder-name').innerText = name;

                try {
                    const res = await Drive.call(() => gapi.client.drive.files.list({
                        q: q, pageSize: 100, fields: 'files(id, name, mimeType, iconLink, thumbnailLink, size, md5Checksum, webContentLink)',
                        orderBy: State.sortOrder
                    }));
                    State.files = res.result.files || [];
                    State.originalFiles = State.files;
                    UI.renderGrid(State.files);
                } catch(e) { Swal.fire('Error', e.message, 'error'); }
            },
            search(term) {
                clearTimeout(searchTimeout);
                document.getElementById('clear-search').style.display = term ? 'block' : 'none';
                searchTimeout = setTimeout(async () => {
                    if(!term.trim()) return Drive.loadFiles(State.currentFolder, false);
                    UI.showLoader();
                    try {
                        const res = await Drive.call(() => gapi.client.drive.files.list({
                            q: `name contains '${term}' and trashed = false`,
                            fields: 'files(id, name, mimeType, iconLink, thumbnailLink, size)',
                        }));
                        State.files = res.result.files || [];
                        UI.renderGrid(State.files);
                        document.getElementById('folder-name').innerText = `Search: "${term}"`;
                    } catch(e) {}
                }, 500);
            },
            clearSearch() {
                document.getElementById('search-box').value = '';
                document.getElementById('clear-search').style.display = 'none';
                Drive.loadFiles(State.currentFolder, false);
            },
            sort(val) {
                State.sortOrder = val;
                Drive.loadFiles(State.currentFolder, false);
            },
            // ULTIMATE DOWNLOAD with export for Google Docs
            async download(fileId, fileName) {
                const file = State.files.find(f => f.id === fileId) || State.activeFile;
                if (!file) return Swal.fire('Error', 'File not found', 'error');

                const Toast = Swal.mixin({ toast: true, position: 'bottom-end', showConfirmButton: false, timer: 3000 });
                Toast.fire({ icon: 'info', title: `Downloading ${fileName}...`, background: '#1e293b', color: '#fff' });

                try {
                    let url;
                    if (file.mimeType.includes('application/vnd.google-apps.')) {
                        let exportMime = 'application/pdf';
                        if (file.mimeType.includes('document')) exportMime = 'application/vnd.openxmlformats-officedocument.wordprocessingml.document';
                        if (file.mimeType.includes('spreadsheet')) exportMime = 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet';
                        if (file.mimeType.includes('presentation')) exportMime = 'application/vnd.openxmlformats-officedocument.presentationml.presentation';
                        url = `https://www.googleapis.com/drive/v3/files/${fileId}/export?mimeType=${encodeURIComponent(exportMime)}`;
                        fileName += exportMime === 'application/pdf' ? '.pdf' : 
                                    exportMime.includes('word') ? '.docx' : 
                                    exportMime.includes('sheet') ? '.xlsx' : '.pptx';
                    } else {
                        url = `https://www.googleapis.com/drive/v3/files/${fileId}?alt=media`;
                    }

                    const response = await fetch(url, { headers: { 'Authorization': `Bearer ${State.token}` } });
                    if (!response.ok) throw new Error("API Error");

                    const blob = await response.blob();
                    const blobUrl = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = blobUrl;
                    a.download = fileName;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    window.URL.revokeObjectURL(blobUrl);
                } catch (e) {
                    Swal.fire('Download Failed', 'File is too large or access is restricted.', 'error');
                }
            },
            async deleteFile(fileId) {
                try {
                    await Drive.call(() => gapi.client.drive.files.delete({ fileId }));
                    return true;
                } catch(e) { return false; }
            },
            async renameFile(fileId, newName) {
                try {
                    await Drive.call(() => gapi.client.drive.files.update({ fileId, resource: { name: newName } }));
                    return true;
                } catch(e) { return false; }
            },
            async moveFile(fileId, newParentId) {
                try {
                    const file = await Drive.call(() => gapi.client.drive.files.get({ fileId, fields: 'parents' }));
                    const oldParents = file.result.parents.join(',');
                    await Drive.call(() => gapi.client.drive.files.update({
                        fileId,
                        addParents: newParentId,
                        removeParents: oldParents,
                        fields: 'id, parents'
                    }));
                    return true;
                } catch(e) { return false; }
            }
        };

        // --- HISTORY / BACK BUTTON ---
        const History = {
            goBack() {
                if (State.history.length === 0) return;
                const prevId = State.history.pop();
                History.updateBackButton();
                Drive.loadFiles(prevId, false);
            },
            updateBackButton() {
                const btn = document.getElementById('back-button');
                if (State.history.length > 0) {
                    btn.disabled = false;
                } else {
                    btn.disabled = true;
                }
            }
        };

        // --- TOOLS (Duplicate Finder & Rename UI) ---
        const Tools = {
            findDuplicates() {
                const map = new Map();
                const duplicates = [];
                State.files.forEach(f => {
                    if(f.mimeType === 'application/vnd.google-apps.folder') return;
                    const key = `${f.name}-${f.size}`;
                    if(map.has(key)) duplicates.push(f);
                    else map.set(key, f);
                });

                if(duplicates.length === 0) return Swal.fire('Clean', 'No duplicates found in this folder list.', 'success');

                let html = `<div class="text-left max-h-60 overflow-y-auto">`;
                duplicates.forEach(f => {
                    html += `<div class="flex justify-between items-center p-2 border-b border-gray-700">
                        <span class="truncate w-40 text-xs">${f.name}</span>
                        <button onclick="Tools.deleteFile('${f.id}')" class="text-red-400 text-xs hover:underline">Delete</button>
                    </div>`;
                });
                html += `</div>`;

                Swal.fire({
                    title: `Found ${duplicates.length} Duplicates`,
                    html: html,
                    background: '#1e293b', color: '#fff'
                });
            },
            async deleteFile(id) {
                try {
                    await Drive.deleteFile(id);
                    Swal.fire('Deleted', 'File removed.', 'success');
                    Drive.loadFiles(State.currentFolder, false);
                } catch(e) { Swal.fire('Error', 'Could not delete.', 'error'); }
            },
            async renameUI(id, oldName) {
                const { value: newName } = await Swal.fire({
                    title: 'Rename File',
                    input: 'text',
                    inputValue: oldName,
                    background: '#1e293b', color: '#fff',
                    showCancelButton: true,
                    inputValidator: (value) => !value && 'You need to write something!'
                });
                if (newName && newName !== oldName) {
                    try {
                        await Drive.renameFile(id, newName);
                        Drive.loadFiles(State.currentFolder, false);
                        Swal.fire({icon: 'success', title: 'Renamed', background: '#1e293b', color: '#fff', timer: 1500, showConfirmButton: false});
                    } catch(e) { Swal.fire('Error', 'Failed to rename', 'error'); }
                }
            }
        };

        // --- UI ---
        const UI = {
            showLoader: () => document.getElementById('file-grid').innerHTML = '<div class="col-span-full flex justify-center mt-20"><div class="loader-spinner"></div></div>',
            setView: (m) => { State.viewMode = m; UI.renderGrid(State.files); },
            renderGrid(files) {
                const grid = document.getElementById('file-grid');
                if(!files.length) return grid.innerHTML = '<div class="col-span-full text-center text-slate-500 mt-20">Empty Folder</div>';
                
                grid.innerHTML = files.map((f, i) => {
                    const isFolder = f.mimeType.includes('folder');
                    const icon = isFolder ? 'folder' : (f.mimeType.includes('image') ? 'image' : 'description');
                    const color = isFolder ? 'text-yellow-400' : 'text-blue-400';
                    const thumb = f.thumbnailLink ? f.thumbnailLink.replace('=s220', '=s400') : null;
                    const size = f.size ? (f.size/1024/1024).toFixed(1)+' MB' : '';
                    
                    if(State.viewMode === 'grid') {
                        return `<div class="file-card glass rounded-xl overflow-hidden cursor-pointer flex flex-col h-36 animate-slideUp group" style="animation-delay:${i*0.02}s" onclick="UI.click('${f.id}','${f.mimeType}')">
                            <div class="h-20 bg-slate-800/50 flex items-center justify-center relative overflow-hidden">
                                ${thumb && !isFolder ? `<img src="${thumb}" class="w-full h-full object-cover opacity-80 group-hover:opacity-100 transition-opacity" loading="lazy">` : `<span class="material-icons-round ${color} text-4xl">${icon}</span>`}
                            </div>
                            <div class="p-2 flex-1 flex flex-col justify-center min-w-0">
                                <div class="text-xs text-slate-200 truncate font-medium">${f.name}</div>
                                <div class="flex justify-between items-center mt-1">
                                    <span class="text-[9px] text-slate-500">${size}</span>
                                    <button class="text-slate-500 hover:text-white" onclick="event.stopPropagation(); ContextMenu.show('${f.id}')"><span class="material-icons-round text-base">more_vert</span></button>
                                </div>
                            </div>
                        </div>`;
                    } else {
                        return `<div class="col-span-full file-card glass rounded-lg p-2 flex items-center gap-3 animate-slideUp cursor-pointer hover:bg-white/5" style="animation-delay:${i*0.01}s" onclick="UI.click('${f.id}','${f.mimeType}')">
                            <span class="material-icons-round ${color} text-xl">${icon}</span>
                            <div class="flex-1 min-w-0"><div class="text-sm text-slate-200 truncate">${f.name}</div><div class="text-[10px] text-slate-500">${size}</div></div>
                            <button class="text-slate-500 hover:text-white" onclick="event.stopPropagation(); ContextMenu.show('${f.id}')"><span class="material-icons-round text-base">more_vert</span></button>
                        </div>`;
                    }
                }).join('');
            },
            click(id, mime) { mime.includes('folder') ? Drive.loadFiles(id) : Viewer.open(State.files.find(f=>f.id===id)); }
        };

        // --- VIEWER & AI ---
        const Viewer = {
            open(file) {
                State.activeFile = file;
                const content = document.getElementById('viewer-content');
                document.getElementById('viewer-title').innerText = file.name;
                document.getElementById('viewer').classList.remove('hidden');
                document.getElementById('ai-sidebar').classList.add('translate-x-full');
                content.innerHTML = '<div class="loader-spinner"></div>';
                
                const mime = file.mimeType;
                
                const removeBgBtn = document.getElementById('remove-bg-btn');
                if (mime.includes('image')) {
                    removeBgBtn.classList.remove('hidden');
                } else {
                    removeBgBtn.classList.add('hidden');
                }
                
                if(mime.includes('image')) {
                    const url = file.thumbnailLink.replace('=s220', '=s1600');
                    content.innerHTML = `<img src="${url}" class="max-w-full max-h-full object-contain shadow-2xl rounded">`;
                } 
                else if(mime.includes('video') || mime === 'application/pdf') {
                    content.innerHTML = `<iframe src="https://drive.google.com/file/d/${file.id}/preview" class="w-full h-full border-0 rounded bg-black"></iframe>`;
                }
                else if(mime.includes('text') || mime.includes('json') || mime.includes('javascript') || mime.includes('html')) {
                     // Use Range header to fetch only first 15KB
                     fetch(`https://www.googleapis.com/drive/v3/files/${file.id}?alt=media`, { 
                         headers: {
                             'Authorization': `Bearer ${State.token}`,
                             'Range': 'bytes=0-15000'
                         }
                     })
                        .then(r => r.text())
                        .then(t => content.innerHTML = `<div class="bg-slate-900 p-4 rounded w-full h-full overflow-auto text-xs font-mono text-slate-300 border border-white/10 whitespace-pre-wrap">${t.replace(/</g, '&lt;')}</div>`)
                        .catch(() => content.innerHTML = '<div class="text-red-500">Failed to load text</div>');
                }
                else {
                    content.innerHTML = `<div class="text-center"><span class="material-icons-round text-6xl text-slate-600 mb-4">description</span><p class="text-slate-400">Preview not supported</p></div>`;
                }
            },
            close: () => { document.getElementById('viewer').classList.add('hidden'); document.getElementById('viewer-content').innerHTML = ''; },
            downloadCurrent: () => Drive.download(State.activeFile.id, State.activeFile.name)
        };

        const AI = {
            async analyzeCurrentFile() {
                const sidebar = document.getElementById('ai-sidebar');
                const results = document.getElementById('ai-results');
                sidebar.classList.remove('translate-x-full');
                if(!State.activeFile) return;

                results.innerHTML = `<div class="relative h-24 bg-slate-800 rounded border border-purple-500/30 mb-4"><div class="scan-line"></div><div class="absolute inset-0 flex items-center justify-center text-purple-300 text-xs">AI Processing...</div></div>`;

                try {
                    let text = "";
                    const fileId = State.activeFile.id;
                    
                    if(State.activeFile.mimeType.includes('image')) {
                        const r = await fetch(`https://www.googleapis.com/drive/v3/files/${fileId}?alt=media`, { headers: {'Authorization': `Bearer ${State.token}`} });
                        const blob = await r.blob();
                        const { data } = await Tesseract.recognize(blob, 'eng');
                        text = data.text;
                    } 
                    else if (State.activeFile.mimeType === 'application/pdf') {
                        const r = await fetch(`https://www.googleapis.com/drive/v3/files/${fileId}?alt=media`, { headers: {'Authorization': `Bearer ${State.token}`} });
                        const arrayBuffer = await r.arrayBuffer();
                        const pdf = await pdfjsLib.getDocument(arrayBuffer).promise;
                        let fullText = "";
                        const maxPages = Math.min(pdf.numPages, 5); 
                        for(let i=1; i<=maxPages; i++) {
                            const page = await pdf.getPage(i);
                            const tc = await page.getTextContent();
                            fullText += tc.items.map(item => item.str).join(' ') + "\n";
                        }
                        text = fullText;
                    }
                    else if (State.activeFile.mimeType.includes('text') || State.activeFile.mimeType.includes('json') || State.activeFile.mimeType.includes('javascript') || State.activeFile.mimeType.includes('html')) {
                         // Use Range header to avoid large files
                         const r = await fetch(`https://www.googleapis.com/drive/v3/files/${fileId}?alt=media`, { 
                             headers: {
                                 'Authorization': `Bearer ${State.token}`,
                                 'Range': 'bytes=0-15000'
                             } 
                         });
                         text = await r.text();
                    }

                    if(!text) throw new Error("Could not extract text from this file format.");

                    text = text.substring(0, 10000); // Additional limit
                    const prompt = `Analyze this file content and give a summary:\n\n${text}`;
                    
                    const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${AppConfig.geminiKey}`, {
                        method: 'POST', headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
                    });
                    const data = await response.json();
                    const reply = data.candidates?.[0]?.content?.parts?.[0]?.text || "AI Error";
                    
                    results.innerHTML = `<h3 class="text-purple-400 font-bold mb-2">Analysis:</h3>${reply.replace(/\*\*(.*?)\*\*/g, '<b>$1</b>')}`;

                } catch(e) {
                    results.innerHTML = `<div class="text-red-400">Analysis Failed: ${e.message}</div>`;
                }
            }
        };

        // --- UPLOAD with abort capability ---
        const Upload = {
            activeUploads: {},
            handle(files) {
                let manager = document.getElementById('upload-manager');
                if (!manager) {
                    const div = document.createElement('div');
                    div.id = 'upload-manager';
                    div.className = 'fixed bottom-24 right-8 w-80 bg-black/90 backdrop-blur-xl border border-white/10 rounded-xl shadow-2xl overflow-hidden transform translate-y-[120%] transition-transform duration-300 z-40';
                    div.innerHTML = `
                        <div class="bg-cyan-900/30 p-3 flex justify-between items-center cursor-pointer" onclick="this.parentElement.classList.toggle('translate-y-[85%]')">
                            <span class="text-xs font-bold text-white flex items-center gap-2"><span class="material-icons-round text-sm text-cyan-400 animate-spin">sync</span> <span id="upload-title">Upload Queue</span></span>
                            <span class="material-icons-round text-sm text-gray-400">expand_less</span>
                        </div>
                        <div id="upload-list" class="p-2 space-y-2 max-h-60 overflow-y-auto custom-scrollbar"></div>
                    `;
                    document.body.appendChild(div);
                }
                const managerEl = document.getElementById('upload-manager');
                const listEl = document.getElementById('upload-list');
                managerEl.classList.remove('translate-y-[120%]');
                document.getElementById('upload-title').innerText = `Uploading ${files.length} item(s)`;

                Array.from(files).forEach(file => {
                    const id = Math.random().toString(36).substr(2, 9);
                    const item = document.createElement('div');
                    item.className = 'upload-item bg-gray-900/50 p-2 rounded flex items-center gap-3';
                    item.setAttribute('data-id', id);
                    item.innerHTML = `
                        <span class="material-icons-round text-cyan-400">insert_drive_file</span>
                        <div class="flex-1 min-w-0">
                            <div class="flex justify-between text-xs text-gray-300 mb-1">
                                <span class="truncate">${file.name}</span>
                                <span id="prog-${id}">0%</span>
                            </div>
                            <div class="h-1 bg-gray-800 rounded-full overflow-hidden">
                                <div id="bar-${id}" class="progress-bar" style="width:0%"></div>
                            </div>
                        </div>
                        <button class="text-gray-500 hover:text-red-400" onclick="Upload.cancel('${id}')"><span class="material-icons-round text-sm">close</span></button>
                    `;
                    listEl.appendChild(item);
                    Upload.uploadFile(file, id);
                });
            },
            uploadFile(file, id) {
                const metadata = { name: file.name, mimeType: file.type, parents: [State.currentFolder] };
                const form = new FormData();
                form.append('metadata', new Blob([JSON.stringify(metadata)], { type: 'application/json' }));
                form.append('file', file);

                const xhr = new XMLHttpRequest();
                this.activeUploads[id] = xhr;

                xhr.open('POST', 'https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart');
                xhr.setRequestHeader('Authorization', `Bearer ${State.token}`);

                xhr.upload.onprogress = (e) => {
                    if (e.lengthComputable) {
                        const percent = (e.loaded / e.total) * 100;
                        const bar = document.getElementById(`bar-${id}`);
                        if (bar) bar.style.width = percent + '%';
                        const prog = document.getElementById(`prog-${id}`);
                        if (prog) prog.innerText = Math.round(percent) + '%';
                    }
                };

                xhr.onload = () => {
                    delete Upload.activeUploads[id];
                    if (xhr.status === 200) {
                        const prog = document.getElementById(`prog-${id}`);
                        if (prog) prog.innerHTML = '<span class="text-green-400">Done</span>';
                        const bar = document.getElementById(`bar-${id}`);
                        if (bar) bar.className = 'h-full bg-green-500';
                        setTimeout(() => {
                            const item = document.querySelector(`[data-id="${id}"]`);
                            if (item) item.remove();
                            if (!document.getElementById('upload-list').children.length) {
                                document.getElementById('upload-manager').classList.add('translate-y-[120%]');
                            }
                        }, 2000);
                        Drive.loadFiles(State.currentFolder, false); // refresh
                    } else {
                        const prog = document.getElementById(`prog-${id}`);
                        if (prog) prog.innerHTML = '<span class="text-red-400">Failed</span>';
                    }
                };
                xhr.onerror = () => {
                    delete Upload.activeUploads[id];
                    const prog = document.getElementById(`prog-${id}`);
                    if (prog) prog.innerHTML = '<span class="text-red-400">Error</span>';
                };
                xhr.send(form);
            },
            cancel(id) {
                if (this.activeUploads[id]) {
                    this.activeUploads[id].abort();
                    delete this.activeUploads[id];
                }
                const item = document.querySelector(`[data-id="${id}"]`);
                if (item) item.remove();
                if (!document.getElementById('upload-list').children.length) {
                    document.getElementById('upload-manager').classList.add('translate-y-[120%]');
                }
            }
        };

        // --- CHAT & VOICE ---
        const Chat = {
            toggle: () => document.getElementById('chat-window').classList.toggle('open'),
            send: async (msg) => {
                if (!msg) return;
                const div = document.getElementById('chat-messages');
                div.innerHTML += `<div class="text-right"><span class="bg-blue-600 text-white px-3 py-1.5 rounded-lg inline-block">${msg}</span></div>`;
                div.scrollTop = div.scrollHeight;

                const lowerMsg = msg.toLowerCase();
                if (lowerMsg.startsWith('generate image') || lowerMsg.startsWith('draw')) {
                    const prompt = msg.replace(/generate image|draw/i, '').trim();
                    const loaderId = 'img-' + Date.now();
                    div.innerHTML += `<div class="text-left"><span class="bg-slate-700 text-slate-300 px-3 py-1.5 rounded-lg inline-block text-xs" id="${loaderId}">ðŸŽ¨ Generating: ${prompt}...</span></div>`;
                    div.scrollTop = div.scrollHeight;

                    try {
                        const response = await fetch("https://api-inference.huggingface.co/models/prompthero/openjourney", {
                            headers: { Authorization: `Bearer ${AppConfig.hfToken}` },
                            method: "POST",
                            body: JSON.stringify({ inputs: prompt }),
                        });
                        if (!response.ok) throw new Error("API Limit or Error");
                        const blob = await response.blob();
                        const url = URL.createObjectURL(blob);
                        document.getElementById(loaderId).innerHTML = `Here is your image for "${prompt}":<br><img src="${url}" class="mt-2 rounded-lg max-w-[220px] border border-white/10 shadow-lg cursor-pointer hover:scale-105 transition-transform" onclick="window.open('${url}')">`;
                    } catch(e) {
                        document.getElementById(loaderId).innerHTML = `âŒ Image generation failed: ${e.message}`;
                    }
                    div.scrollTop = div.scrollHeight;
                    return;
                }

                let fileContext = "";
                const mentionedFile = State.files.find(f => msg.toLowerCase().includes(f.name.toLowerCase()));
                if (mentionedFile) {
                    try {
                        if (mentionedFile.mimeType.includes('text') || mentionedFile.mimeType.includes('json')) {
                            const r = await fetch(`https://www.googleapis.com/drive/v3/files/${mentionedFile.id}?alt=media`, { 
                                headers: {
                                    'Authorization': `Bearer ${State.token}`,
                                    'Range': 'bytes=0-2000'
                                }
                            });
                            const text = await r.text();
                            fileContext = `\nContent of file "${mentionedFile.name}":\n${text}...\n`;
                        } else if (mentionedFile.mimeType.includes('image')) {
                            fileContext = `\nThe user mentioned an image file "${mentionedFile.name}". You can suggest analyzing it.`;
                        }
                    } catch(e) {}
                }

                const prompt = `
You are Jarvis, an AI OS Assistant.
Current folder: ${State.currentFolder}
Files in this folder:
${State.files.map(f => `- ${f.name} (ID: ${f.id}, Type: ${f.mimeType})`).join('\n')}
${fileContext}

User: ${msg}

If the user asks to perform an action, reply with JSON ONLY in this format:
- For creating folder: {"action": "create_folder", "name": "folder_name"}
- For deleting file: {"action": "delete_file", "id": "file_id"}
- For renaming file: {"action": "rename_file", "id": "file_id", "newName": "new_name"}
- For moving file: {"action": "move_file", "id": "file_id", "parentId": "destination_folder_id"}

Otherwise, answer helpfully.
`;

                try {
                    const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${AppConfig.geminiKey}`, {
                        method: 'POST', headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
                    });
                    const data = await response.json();
                    let reply = data.candidates?.[0]?.content?.parts?.[0]?.text || "Error";

                    try {
                        const cmd = JSON.parse(reply.trim());
                        if (cmd.action === 'create_folder') {
                            await gapi.client.drive.files.create({ resource: { name: cmd.name, mimeType: 'application/vnd.google-apps.folder', parents: [State.currentFolder] } });
                            reply = `âœ… Created folder "${cmd.name}"`;
                            Drive.loadFiles(State.currentFolder, false);
                        } else if (cmd.action === 'delete_file') {
                            const ok = await Drive.deleteFile(cmd.id);
                            reply = ok ? `âœ… Deleted file` : `âŒ Failed to delete`;
                            if (ok) Drive.loadFiles(State.currentFolder, false);
                        } else if (cmd.action === 'rename_file') {
                            const ok = await Drive.renameFile(cmd.id, cmd.newName);
                            reply = ok ? `âœ… Renamed to "${cmd.newName}"` : `âŒ Rename failed`;
                            if (ok) Drive.loadFiles(State.currentFolder, false);
                        } else if (cmd.action === 'move_file') {
                            const ok = await Drive.moveFile(cmd.id, cmd.parentId);
                            reply = ok ? `âœ… Moved file` : `âŒ Move failed`;
                            if (ok) Drive.loadFiles(State.currentFolder, false);
                        }
                    } catch(e) {}

                    div.innerHTML += `<div class="text-left"><span class="bg-slate-700 text-slate-200 px-3 py-1.5 rounded-lg inline-block">${reply.replace(/\*\*(.*?)\*\*/g, '<b>$1</b>')}</span></div>`;
                    
                    const utterance = new SpeechSynthesisUtterance(reply.replace(/<[^>]*>/g, ''));
                    utterance.lang = 'en-US';
                    window.speechSynthesis.speak(utterance);

                } catch(e) { 
                    div.innerHTML += `<div class="text-red-400 text-xs">Error connecting.</div>`;
                }
                div.scrollTop = div.scrollHeight;
            },
            sendFromInput() {
                const input = document.getElementById('chat-input');
                const msg = input.value.trim();
                if (msg) {
                    Chat.send(msg);
                    input.value = '';
                }
            }
        };

        // --- VOICE (append, not overwrite) ---
        const Voice = {
            recognition: null,
            isListening: false,
            
            init() {
                const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
                if (!SpeechRecognition) {
                    Swal.fire('Error', 'Voice recognition not supported in this browser.', 'error');
                    return null;
                }
                
                const rec = new SpeechRecognition();
                rec.lang = 'en-US';
                rec.interimResults = false;
                rec.continuous = false;

                rec.onstart = () => {
                    Voice.isListening = true;
                    document.getElementById('mic-icon').innerText = 'mic_off';
                    document.getElementById('mic-btn').classList.add('bg-red-500');
                    document.getElementById('mic-pulse').classList.remove('hidden');
                    document.getElementById('chat-input').placeholder = "Listening...";
                };

                rec.onend = () => {
                    Voice.isListening = false;
                    document.getElementById('mic-icon').innerText = 'mic';
                    document.getElementById('mic-btn').classList.remove('bg-red-500');
                    document.getElementById('mic-btn').classList.add('bg-slate-700');
                    document.getElementById('mic-pulse').classList.add('hidden');
                    document.getElementById('chat-input').placeholder = "Command Jarvis...";
                };

                rec.onresult = (e) => {
                    const txt = e.results[0][0].transcript;
                    const input = document.getElementById('chat-input');
                    // Append to existing text
                    input.value = input.value ? input.value + ' ' + txt : txt;
                    Chat.sendFromInput();
                };

                return rec;
            },

            toggle() {
                if (!this.recognition) this.recognition = this.init();
                if (!this.recognition) return;

                if (this.isListening) {
                    this.recognition.stop();
                } else {
                    this.recognition.start();
                }
            }
        };

        // --- IMAGE TOOLS (Background Removal) ---
        const ImageTools = {
            async removeBackground() {
                if (!State.activeFile || !State.activeFile.mimeType.includes('image')) return;
                const btn = document.getElementById('remove-bg-btn');
                const originalText = btn.innerHTML;
                btn.innerHTML = '<span class="material-icons-round text-sm animate-spin">refresh</span> Removing...';
                try {
                    const response = await fetch(`https://www.googleapis.com/drive/v3/files/${State.activeFile.id}?alt=media`, {
                        headers: { 'Authorization': `Bearer ${State.token}` }
                    });
                    const blob = await response.blob();
                    
                    const hfResponse = await fetch("https://api-inference.huggingface.co/models/briaai/RMBG-1.4", {
                        headers: { Authorization: `Bearer ${AppConfig.hfToken}` },
                        method: "POST",
                        body: blob
                    });
                    if (!hfResponse.ok) throw new Error("Background removal failed");
                    
                    const resultBlob = await hfResponse.blob();
                    const url = URL.createObjectURL(resultBlob);
                    
                    const content = document.getElementById('viewer-content');
                    content.innerHTML = `
                        <img src="${url}" class="max-w-full max-h-full object-contain shadow-2xl rounded animate-slideUp">
                        <button onclick="const a = document.createElement('a'); a.href='${url}'; a.download='bg_removed_${State.activeFile.name}.png'; a.click();" 
                                class="absolute bottom-10 px-6 py-3 bg-green-500 text-white rounded-full shadow-[0_0_20px_rgba(34,197,94,0.4)] hover:scale-105 transition-transform flex items-center gap-2 font-bold z-50">
                            <span class="material-icons-round">download</span> Save Result
                        </button>
                    `;
                    
                    Swal.fire({
                        title: 'Background Removed',
                        text: 'Click the download button to save the image.',
                        icon: 'success',
                        background: '#1e293b'
                    });
                } catch (e) {
                    Swal.fire('Error', e.message, 'error');
                } finally {
                    btn.innerHTML = originalText;
                }
            }
        };

        // --- CONTEXT MENU with Rename ---
        const ContextMenu = {
            show(id) {
                const f = State.files.find(x => x.id === id);
                Swal.fire({
                    title: f.name,
                    html: `<div class="flex flex-col gap-2 mt-2">
                        <button onclick="Swal.clickConfirm(); UI.click('${f.id}','${f.mimeType}')" class="p-2 bg-slate-700 rounded text-sm text-white">Open</button>
                        <button onclick="Swal.close(); Tools.renameUI('${f.id}', '${f.name}')" class="p-2 bg-yellow-600/20 text-yellow-400 rounded text-sm hover:bg-yellow-600 hover:text-white border border-yellow-500/20 transition-colors">Rename</button>
                        <button onclick="Drive.download('${f.id}', '${f.name}')" class="p-2 bg-blue-600 rounded text-sm text-white">Download</button>
                        <button onclick="Tools.deleteFile('${f.id}')" class="p-2 bg-red-900/50 text-red-400 rounded text-sm">Delete</button>
                    </div>`,
                    showConfirmButton: false, background: '#1e293b', color: '#fff'
                });
            }
        };

        // Search listener
        document.getElementById('search-box').addEventListener('keyup', (e) => Drive.search(e.target.value));

        window.onload = Auth.init;
    </script>
</body>
</html>
