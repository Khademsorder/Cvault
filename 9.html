<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Drive OS Pro+ | ULTIMATE STABLE</title>
    <!-- ========== CORE LIBRARIES ========== -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons+Round" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    <script src="https://apis.google.com/js/api.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.5/gsap.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script>pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';</script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://unpkg.com/dexie@3.2.3/dist/dexie.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism-tomorrow.min.css" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js"></script>
    <style>
        /* ========== CUSTOM STYLES ========== */
        :root {
            --glass-bg: rgba(15, 23, 42, 0.85);
            --neon-blue: #3b82f6;
            --bg-primary: #020617;
            --text-primary: #e2e8f0;
            --accent: #3b82f6;
            --spacing-xs: 4px;
            --spacing-sm: 8px;
            --spacing-md: 16px;
            --spacing-lg: 24px;
            --spacing-xl: 32px;
            transition: background-color 0.3s, color 0.3s;
        }
        body.theme-dark { --glass-bg: rgba(15,23,42,0.85); --bg-primary:#020617; --text-primary:#e2e8f0; --accent:#3b82f6; }
        body.theme-glass { --glass-bg: rgba(255,255,255,0.1); --bg-primary:#0a0a0f; --text-primary:#f0f0f0; --accent:#00f3ff; }
        body.theme-midnight { --glass-bg: rgba(0,0,0,0.7); --bg-primary:#0b0b1a; --text-primary:#cfd9ff; --accent:#7b2eda; }
        body.theme-oled { --glass-bg: rgba(0,0,0,0.9); --bg-primary:#000; --text-primary:#ccc; --accent:#00ff99; }
        body.theme-softgray { --glass-bg: rgba(245,245,245,0.8); --bg-primary:#f0f4f8; --text-primary:#1e293b; --accent:#2563eb; }
        body {
            font-family: 'Outfit', sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            overflow: hidden;
            height: 100vh;
            font-size: 14px;
            line-height: 1.5;
            transition: background 0.3s, color 0.3s;
        }
        h1 { font-size: 24px; font-weight: 600; }
        h2 { font-size: 20px; font-weight: 500; }
        h3 { font-size: 16px; font-weight: 500; }
        .glass { background: var(--glass-bg); backdrop-filter: blur(24px); border: 1px solid rgba(255,255,255,0.08); }
        .custom-scrollbar::-webkit-scrollbar { width: 6px; height: 6px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: transparent; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.2); border-radius: 10px; }
        .loader-spinner { width: 40px; height: 40px; border: 3px solid rgba(255,255,255,0.1); border-top-color: var(--accent); border-radius: 50%; animation: spin 0.8s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
        @keyframes slideUp { from { transform: translateY(20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        .animate-slideUp { animation: slideUp 0.3s cubic-bezier(0.16,1,0.3,1) forwards; }
        .file-card {
            padding: var(--spacing-sm);
            border-radius: 12px;
            transition: transform 0.15s ease, box-shadow 0.15s;
            cursor: pointer;
            background: rgba(30,41,59,0.4);
            border: 1px solid rgba(255,255,255,0.05);
        }
        .file-card:hover { transform: translateY(-2px); background: rgba(30,41,59,0.95); border-color: var(--accent); }
        .file-card.selected { border: 2px solid var(--accent); transform: scale(1.02); }
        .chat-window {
            position: fixed; bottom: 85px; right: 24px; width: 360px; height: 500px;
            background: #0f172a; border: 1px solid #334155; border-radius: 16px;
            display: flex; flex-direction: column; z-index: 50;
            transform: translateY(120%); transition: transform 0.3s;
            box-shadow: 0 20px 40px rgba(0,0,0,0.5);
        }
        .chat-window.open { transform: translateY(0); }
        .scan-line { width: 100%; height: 2px; background: #8b5cf6; box-shadow: 0 0 10px #8b5cf6; animation: scanMove 2s infinite linear; }
        @keyframes scanMove { 0% { transform: translateY(0); } 100% { transform: translateY(128px); } }
        .progress-bar { height: 4px; background: linear-gradient(90deg, #00f3ff, #7000ff); transition: width 0.2s; }
        /* Command palette */
        #command-palette {
            position: fixed; top: 20%; left: 50%; transform: translateX(-50%);
            width: 500px; max-width: 90%; background: rgba(0,0,0,0.95); backdrop-filter: blur(20px);
            border: 1px solid #333; border-radius: 16px; z-index: 200; display: none;
            box-shadow: 0 20px 40px rgba(0,0,0,0.5);
        }
        #command-palette input { width: 100%; padding: 16px; background: transparent; border: none; color: white; font-size: 16px; outline: none; }
        #command-palette .results { max-height: 300px; overflow-y: auto; border-top: 1px solid #222; }
        #command-palette .result-item { padding: 10px 16px; cursor: pointer; display: flex; align-items: center; gap: 10px; }
        #command-palette .result-item:hover { background: #1e293b; }
        /* Bulk dock */
        #bulk-dock {
            position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%);
            background: rgba(0,0,0,0.9); backdrop-filter: blur(10px);
            border: 1px solid #333; border-radius: 40px; padding: 8px 16px;
            display: flex; gap: 16px; z-index: 100; transition: opacity 0.2s;
            opacity: 0; pointer-events: none;
        }
        #bulk-dock.visible { opacity: 1; pointer-events: auto; }
        .bulk-btn { background: transparent; border: none; color: white; padding: 8px; border-radius: 50%; cursor: pointer; transition: background 0.2s; }
        .bulk-btn:hover { background: var(--accent); }
        /* Context menu */
        #context-menu {
            position: fixed; background: #1e293b; border: 1px solid #334155; border-radius: 12px;
            padding: 8px 0; min-width: 160px; z-index: 1000; display: none;
            box-shadow: 0 10px 20px rgba(0,0,0,0.3); transform-origin: top left;
            animation: menuScale 0.1s ease;
        }
        @keyframes menuScale { from { transform: scale(0.9); opacity: 0; } to { transform: scale(1); opacity: 1; } }
        #context-menu .ctx-item {
            padding: 8px 16px; cursor: pointer; display: flex; align-items: center; gap: 12px;
            color: #e2e8f0; font-size: 13px; transition: background 0.2s;
        }
        #context-menu .ctx-item:hover { background: var(--accent); color: white; }
        #context-menu hr { margin: 4px 0; border-color: #334155; }
        /* Theme switcher */
        #theme-switcher {
            position: fixed; top: 70px; right: 20px; background: #1e293b; border-radius: 40px;
            padding: 4px; z-index: 150; display: flex; gap: 4px;
        }
        .theme-dot {
            width: 30px; height: 30px; border-radius: 50%; cursor: pointer; transition: transform 0.2s;
            border: 2px solid transparent;
        }
        .theme-dot.active { transform: scale(1.2); border-color: white; }
        .magnetic { transition: transform 0.2s; }
        .particle {
            position: absolute; width: 2px; height: 2px; background: rgba(255,255,255,0.5);
            border-radius: 50%; pointer-events: none; z-index: 0;
        }
        /* AI panel sections */
        .ai-section {
            background: rgba(0,0,0,0.3); border-radius: 8px; padding: 8px; margin-bottom: 12px;
        }
        .ai-section h4 { font-size: 11px; color: #aaa; margin-bottom: 4px; text-transform: uppercase; }
        /* Skeleton */
        .skeleton { background: linear-gradient(90deg, #1e293b 25%, #334155 50%, #1e293b 75%); background-size: 200% 100%; animation: shimmer 1.5s infinite; }
        @keyframes shimmer { 0% { background-position: 200% 0; } 100% { background-position: -200% 0; } }
        /* Toast */
        .toast {
            position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%);
            padding: 8px 16px; border-radius: 40px; background: rgba(0,0,0,0.8); color: white; font-size: 12px;
            z-index: 300; animation: toastFade 2s ease; display: flex; align-items: center; gap: 6px;
        }
        @keyframes toastFade {
            0% { opacity: 0; transform: translateX(-50%) translateY(20px); }
            10% { opacity: 1; transform: translateX(-50%) translateY(0); }
            90% { opacity: 1; }
            100% { opacity: 0; transform: translateX(-50%) translateY(-20px); }
        }
    </style>
</head>
<body class="theme-dark">
    <!-- Global error shield -->
    <script>
        window.onerror = function(msg, src, line, col, err) {
            console.error("Global Error:", err || msg);
            const toast = document.createElement('div');
            toast.className = 'toast';
            toast.innerHTML = '<span class="material-icons-round text-sm text-red-400">error</span> Unexpected error';
            document.body.appendChild(toast);
            setTimeout(() => toast.remove(), 2000);
            return true;
        };
        window.onunhandledrejection = function(e) {
            console.error("Unhandled Promise:", e.reason);
            const toast = document.createElement('div');
            toast.className = 'toast';
            toast.innerHTML = '<span class="material-icons-round text-sm text-red-400">error</span> Async error';
            document.body.appendChild(toast);
            setTimeout(() => toast.remove(), 2000);
        };
    </script>

    <!-- Particle background -->
    <div id="particle-container" class="fixed inset-0 pointer-events-none z-0"></div>
    <!-- Theme switcher -->
    <div id="theme-switcher" class="glass">
        <div class="theme-dot active" style="background:#020617;" data-theme="theme-dark" title="Dark Pro"></div>
        <div class="theme-dot" style="background:linear-gradient(135deg,#0a0a0f,#2a2a3a);" data-theme="theme-glass" title="Glass Neon"></div>
        <div class="theme-dot" style="background:#0b0b1a;" data-theme="theme-midnight" title="Midnight"></div>
        <div class="theme-dot" style="background:#000;" data-theme="theme-oled" title="OLED Pure"></div>
        <div class="theme-dot" style="background:#f0f4f8;" data-theme="theme-softgray" title="Soft Gray"></div>
    </div>
    <!-- Auth Screen -->
    <div id="auth-screen" class="fixed inset-0 z-[100] bg-slate-950 flex items-center justify-center">
        <div class="glass p-10 rounded-3xl max-w-sm w-full text-center border border-white/10">
            <div class="w-16 h-16 mx-auto bg-blue-600 rounded-2xl flex items-center justify-center mb-6 shadow-lg shadow-blue-500/20">
                <span class="material-icons-round text-3xl text-white">cloud_upload</span>
            </div>
            <h1 class="text-2xl font-bold text-white mb-2">Drive OS Pro+</h1>
            <p class="text-slate-400 mb-8 text-sm">Ultimate AI Cloud</p>
            <button onclick="Auth.signIn()" class="w-full py-3 bg-white text-slate-900 rounded-xl font-bold hover:bg-slate-100 transition-all flex items-center justify-center gap-3">
                <img src="https://upload.wikimedia.org/wikipedia/commons/5/53/Google_%22G%22_Logo.svg" class="w-5 h-5"> Sign in with Google
            </button>
        </div>
    </div>
    <!-- Main UI -->
    <div id="app-ui" class="hidden flex-1 h-full opacity-0 transition-opacity duration-700">
        <div class="flex h-full">
            <!-- Sidebar -->
            <aside class="w-20 md:w-64 glass h-full border-r border-white/5 flex flex-col z-20 shrink-0">
                <div class="h-16 flex items-center justify-center md:justify-start px-0 md:px-6 border-b border-white/5">
                    <span class="material-icons-round text-blue-500 text-2xl md:mr-3">dns</span>
                    <span class="hidden md:inline text-lg font-bold">Drive<span class="text-blue-400">OS</span></span>
                </div>
                <nav class="flex-1 p-3 space-y-1 overflow-y-auto custom-scrollbar">
                    <button onclick="Drive.loadFiles('root')" class="w-full flex items-center gap-3 px-4 py-3 rounded-xl bg-blue-500/10 text-blue-400 border border-blue-500/20">
                        <span class="material-icons-round">dashboard</span> <span class="sidebar-text hidden md:inline">My Drive</span>
                    </button>
                    <button onclick="Drive.loadFiles('1zIyinAqjQv96QBSuanFS2F0USaG66GPn')" class="w-full flex items-center gap-3 px-4 py-3 rounded-xl text-purple-400 hover:bg-purple-500/10">
                        <span class="material-icons-round">vpn_lock</span> <span class="sidebar-text hidden md:inline">Vault</span>
                    </button>
                    <button onclick="Drive.loadFiles('starred')" class="w-full flex items-center gap-3 px-4 py-3 rounded-xl text-slate-400 hover:bg-white/5 hover:text-white">
                        <span class="material-icons-round">star</span> <span class="sidebar-text hidden md:inline">Starred</span>
                    </button>
                </nav>
                <!-- Storage Chart -->
                <div class="p-4 border-t border-white/5 hidden md:block storage-analyser">
                    <canvas id="storageChart" width="200" height="200" class="mb-2"></canvas>
                    <div class="flex justify-between text-xs text-blue-300 mb-1"><span id="storage-used">--</span> <span id="storage-total">--</span></div>
                    <div class="w-full h-1 bg-slate-700 rounded-full"><div id="storage-bar" class="h-full bg-blue-500 w-0 transition-all"></div></div>
                    <button onclick="Auth.signOut()" class="mt-4 w-full py-2 text-xs text-red-400 border border-red-500/20 rounded hover:bg-red-500/10">LOGOUT</button>
                </div>
            </aside>
            <!-- Content -->
            <main class="flex-1 flex flex-col min-w-0 bg-slate-900/50">
                <header class="h-16 border-b border-white/5 flex items-center justify-between px-4 glass z-10">
                    <div class="flex items-center gap-2">
                        <button id="back-button" onclick="History.goBack()" class="w-8 h-8 rounded-full bg-white/5 hover:bg-white/10 flex items-center justify-center text-slate-400 hover:text-white transition-colors disabled:opacity-30 disabled:pointer-events-none" disabled>
                            <span class="material-icons-round text-lg">arrow_back</span>
                        </button>
                        <div class="flex-1 max-w-xl relative ml-2">
                            <span class="material-icons-round absolute left-3 top-1/2 -translate-y-1/2 text-slate-500">search</span>
                            <input type="text" id="search-box" placeholder="Search files... (Ctrl+K)" class="w-full bg-slate-800/50 border border-white/10 rounded-lg py-2 pl-10 pr-10 text-white text-sm focus:outline-none focus:border-blue-500">
                            <span onclick="Drive.clearSearch()" id="clear-search" class="material-icons-round absolute right-3 top-1/2 -translate-y-1/2 text-slate-500 cursor-pointer hidden text-sm hover:text-white">close</span>
                        </div>
                    </div>
                    <div class="flex items-center gap-4 ml-4">
                        <button onclick="Tools.createFolderUI()" class="p-2 text-yellow-400 hover:bg-yellow-500/10 rounded" title="New Folder"><span class="material-icons-round">create_new_folder</span></button>
                        <select id="sort-select" onchange="Drive.sort(this.value)" class="bg-slate-800 border border-white/10 text-xs text-slate-300 rounded px-2 py-1.5 focus:outline-none">
                            <option value="folder,modifiedTime desc">Date (New)</option>
                            <option value="folder,modifiedTime asc">Date (Old)</option>
                            <option value="folder,name">Name (A-Z)</option>
                            <option value="folder,quotaBytesUsed desc">Size (Big)</option>
                        </select>
                        <button onclick="Chat.toggle()" class="w-9 h-9 rounded-full bg-gradient-to-br from-purple-500 to-blue-600 flex items-center justify-center text-white shadow-lg"><span class="material-icons-round text-lg">auto_awesome</span></button>
                    </div>
                </header>
                <div class="h-10 flex items-center justify-between px-4 border-b border-white/5 bg-slate-900/30">
                    <div class="flex items-center gap-1 text-xs text-slate-400">
                        <button onclick="Drive.loadFiles('root')" class="hover:text-white">Drive</button>
                        <span class="material-icons-round text-[14px]">chevron_right</span>
                        <span class="text-blue-400 font-medium truncate max-w-[200px]" id="folder-name">Home</span>
                    </div>
                    <div class="flex gap-1">
                        <button onclick="UI.setView('grid')" class="p-1 text-white"><span class="material-icons-round text-sm">grid_view</span></button>
                        <button onclick="UI.setView('list')" class="p-1 text-slate-500 hover:text-white"><span class="material-icons-round text-sm">view_list</span></button>
                    </div>
                </div>
                <!-- File grid -->
                <div id="file-grid" class="flex-1 overflow-y-auto p-4 grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 xl:grid-cols-7 gap-3 content-start custom-scrollbar"></div>
                <!-- FAB -->
                <div class="absolute bottom-6 right-6 z-40 flex flex-col items-end gap-2">
                    <button onclick="document.getElementById('folder-upload-input').click()" class="w-14 h-14 rounded-2xl bg-purple-600 text-white shadow-lg shadow-purple-600/30 flex items-center justify-center hover:scale-105 transition-all magnetic" title="Upload Folder">
                        <span class="material-icons-round text-3xl">create_new_folder</span>
                    </button>
                    <input type="file" id="folder-upload-input" class="hidden" webkitdirectory directory multiple onchange="Upload.handle(this.files)">
                    <button onclick="document.getElementById('upload-input').click()" class="w-14 h-14 rounded-2xl bg-blue-600 text-white shadow-lg shadow-blue-600/30 flex items-center justify-center hover:scale-105 transition-all magnetic" title="Upload Files">
                        <span class="material-icons-round text-3xl">add</span>
                    </button>
                    <input type="file" id="upload-input" class="hidden" multiple onchange="Upload.handle(this.files)">
                </div>
            </main>
        </div>
    </div>
    <!-- Viewer -->
    <div id="viewer" class="fixed inset-0 z-[60] bg-black/95 hidden flex flex-col">
        <div class="h-14 flex items-center justify-between px-4 bg-slate-900 border-b border-white/10">
            <h2 id="viewer-title" class="text-white text-sm truncate max-w-md">Preview</h2>
            <div class="flex gap-3">
                <button onclick="AI.analyzeCurrentFile()" class="flex items-center gap-2 px-3 py-1 bg-purple-600/20 text-purple-400 border border-purple-500/30 rounded hover:bg-purple-600 hover:text-white text-xs" id="ai-analyze-btn">
                    <span class="material-icons-round text-sm">psychology</span> AI Analyze
                </button>
                <select id="ocr-lang" class="bg-slate-800 text-xs text-white border border-white/10 rounded px-1">
                    <option value="eng">English</option>
                    <option value="ben">বাংলা</option>
                </select>
                <button id="remove-bg-btn" onclick="ImageTools.removeBackground()" class="flex items-center gap-2 px-3 py-1 bg-green-600/20 text-green-400 border border-green-500/30 rounded hover:bg-green-600 hover:text-white text-xs hidden">
                    <span class="material-icons-round text-sm">auto_awesome</span> Remove BG
                </button>
                <button onclick="Viewer.downloadCurrent()" class="w-8 h-8 flex items-center justify-center rounded bg-white/10 hover:bg-white/20 text-white"><span class="material-icons-round text-sm">download</span></button>
                <button onclick="Viewer.close()" class="w-8 h-8 flex items-center justify-center rounded bg-red-500/20 text-red-400 hover:bg-red-500 hover:text-white"><span class="material-icons-round text-sm">close</span></button>
            </div>
        </div>
        <div class="flex-1 flex relative overflow-hidden">
            <div id="viewer-content" class="flex-1 flex items-center justify-center p-4"></div>
            <div id="ai-sidebar" class="w-80 bg-slate-900 border-l border-white/10 absolute right-0 top-0 bottom-0 transform translate-x-full transition-transform duration-300 z-10 flex flex-col">
                <div class="p-3 border-b border-white/10 flex justify-between items-center text-white font-bold text-xs bg-slate-800">
                    <span>AI Analysis</span>
                    <button onclick="document.getElementById('ai-sidebar').classList.add('translate-x-full')" class="text-slate-400"><span class="material-icons-round">close</span></button>
                </div>
                <div id="ai-results" class="flex-1 p-4 overflow-y-auto text-slate-300 text-xs whitespace-pre-wrap font-mono custom-scrollbar"></div>
            </div>
        </div>
    </div>
    <!-- Chat -->
    <div id="chat-window" class="chat-window">
        <div class="p-3 bg-gradient-to-r from-blue-600 to-purple-600 text-white font-bold text-sm flex justify-between cursor-pointer rounded-t-xl" onclick="Chat.toggle()">
            <span class="flex items-center gap-2"><span class="material-icons-round text-sm">auto_awesome</span> Gemini AI</span>
            <span class="material-icons-round text-sm">expand_more</span>
        </div>
        <div id="chat-messages" class="flex-1 overflow-y-auto p-4 space-y-3 custom-scrollbar text-xs">
            <div class="text-slate-500 text-center italic">Ask about your files...</div>
        </div>
        <div class="p-3 border-t border-white/10 flex gap-2 items-center bg-slate-900/50 relative">
            <button id="mic-btn" onclick="Voice.toggle()" class="w-9 h-9 rounded-full bg-slate-700 hover:bg-slate-600 flex items-center justify-center transition-all group relative shrink-0">
                <span id="mic-icon" class="material-icons-round text-white text-sm relative z-10">mic</span>
                <span id="mic-pulse" class="absolute inset-0 rounded-full bg-red-500/50 animate-ping hidden"></span>
            </button>
            <input id="chat-input" type="text" placeholder="Command Jarvis..." class="flex-1 bg-slate-800 border border-white/10 rounded px-3 py-2 text-white text-xs focus:outline-none focus:border-blue-500">
            <button onclick="Chat.sendFromInput()" class="w-9 h-9 rounded bg-blue-600 hover:bg-blue-500 flex items-center justify-center shrink-0">
                <span class="material-icons-round text-white text-sm">send</span>
            </button>
        </div>
    </div>
    <!-- Upload Manager -->
    <div id="upload-manager" class="fixed bottom-24 right-8 w-80 bg-black/90 backdrop-blur-xl border border-white/10 rounded-xl shadow-2xl overflow-hidden transform translate-y-[120%] transition-transform duration-300 z-40">
        <div class="bg-cyan-900/30 p-3 flex justify-between items-center cursor-pointer" onclick="this.parentElement.classList.toggle('translate-y-[85%]')">
            <span class="text-xs font-bold text-white flex items-center gap-2"><span class="material-icons-round text-sm text-cyan-400 animate-spin">sync</span> <span id="upload-title">Upload Queue</span></span>
            <span class="material-icons-round text-sm text-gray-400">expand_less</span>
        </div>
        <div id="upload-list" class="p-2 space-y-2 max-h-60 overflow-y-auto custom-scrollbar"></div>
        <div class="p-2 text-[10px] text-cyan-300 font-mono flex justify-between" id="upload-stats">
            <span id="upload-speed">0 KB/s</span>
            <span id="upload-eta">--:--</span>
        </div>
    </div>
    <!-- Bulk Action Dock -->
    <div id="bulk-dock">
        <button class="bulk-btn" onclick="BulkActions.deleteSelected()" title="Delete"><span class="material-icons-round">delete</span></button>
        <button class="bulk-btn" onclick="BulkActions.moveSelected()" title="Move"><span class="material-icons-round">drive_file_move</span></button>
        <button class="bulk-btn" onclick="BulkActions.starSelected()" title="Star"><span class="material-icons-round">star</span></button>
        <button class="bulk-btn" onclick="BulkActions.zipSelected()" title="Download ZIP"><span class="material-icons-round">archive</span></button>
        <button class="bulk-btn" onclick="BulkActions.analyzeSelected()" title="Analyze"><span class="material-icons-round">auto_awesome</span></button>
        <button class="bulk-btn" onclick="BulkActions.shareSelected()" title="Share"><span class="material-icons-round">share</span></button>
    </div>
    <!-- Context Menu -->
    <div id="context-menu" class="glass"></div>
    <!-- Command Palette -->
    <div id="command-palette" class="glass">
        <input type="text" id="command-input" placeholder="Search files, folders, actions..." autocomplete="off">
        <div class="results" id="command-results"></div>
    </div>

    <script>
        (function() {
            "use strict";

            // ========== GLOBAL ERROR HANDLING (already above) ==========

            // ========== UTILITY FUNCTIONS ==========
            const $ = (id) => document.getElementById(id);
            const showToast = (msg, icon = 'info') => {
                const t = document.createElement('div');
                t.className = 'toast';
                t.innerHTML = `<span class="material-icons-round text-sm">${icon}</span> ${msg}`;
                document.body.appendChild(t);
                setTimeout(() => t.remove(), 2000);
            };
            const safeJSON = (str) => { try { return JSON.parse(str); } catch { return null; } };
            const escapeQuery = (str) => str.replace(/['"\\]/g, '');
            const debounce = (fn, delay = 400) => {
                let t;
                return (...args) => {
                    clearTimeout(t);
                    t = setTimeout(() => fn(...args), delay);
                };
            };

            // ========== CONFIG & STATE ==========
            const AppConfig = {
                clientId: '318681315152-65e9kofptt4c3bk3kmlj9gmksnasu347.apps.googleusercontent.com',
                scope: 'https://www.googleapis.com/auth/drive.file https://www.googleapis.com/auth/drive.metadata.readonly https://www.googleapis.com/auth/drive.readonly https://www.googleapis.com/auth/userinfo.profile',
                discoveryDocs: ['https://www.googleapis.com/discovery/v1/apis/drive/v3/rest'],
                geminiKey: 'AIzaSyD0hkckrFjwctBCvbWjYYRxTfYkoAbPf4A',
                hfToken: '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',
                vaultId: '1zIyinAqjQv96QBSuanFS2F0USaG66GPn'
            };

            const State = {
                token: null,
                user: null,
                currentFolder: 'root',
                files: [],
                originalFiles: [],
                selected: new Set(),
                activeFile: null,
                viewMode: 'grid',
                sortOrder: 'folder,modifiedTime desc',
                history: [],
                aiMemory: [],
                loading: false,
                aiRunning: false,
                abortController: null,
                blobUrls: [],
                nextPageToken: null,
                pageSize: 100,
                loadingMore: false
            };

            // ========== INDEXEDDB CACHE ==========
            const db = new Dexie('DriveOSCache');
            db.version(1).stores({ files: 'id, name, mimeType, size, modifiedTime' });

            // ========== AUTH ==========
            const Auth = {
                client: null,
                init() {
                    Auth.client = google.accounts.oauth2.initTokenClient({
                        client_id: AppConfig.clientId,
                        scope: AppConfig.scope,
                        callback: (resp) => {
                            if (resp.error) {
                                Swal.fire({ icon: 'error', title: 'Auth Failed', text: resp.error_description, background: '#1e293b' });
                                return;
                            }
                            State.token = resp.access_token;
                            localStorage.setItem('g_token', State.token);
                            gapi.client.setToken({ access_token: State.token });
                            Auth.onSuccess();
                        }
                    });
                    gapi.load('client', async () => {
                        await gapi.client.init({ discoveryDocs: AppConfig.discoveryDocs });
                        const saved = localStorage.getItem('g_token');
                        if (saved) {
                            State.token = saved;
                            gapi.client.setToken({ access_token: saved });
                            try {
                                await gapi.client.drive.about.get({ fields: 'user' });
                                Auth.onSuccess();
                            } catch {
                                localStorage.removeItem('g_token');
                            }
                        }
                    });
                },
                signIn: () => Auth.client.requestAccessToken(),
                signOut: () => {
                    google.accounts.oauth2.revoke(State.token, () => {
                        localStorage.removeItem('g_token');
                        location.reload();
                    });
                },
                async refreshToken() {
                    return new Promise((resolve, reject) => {
                        Auth.client.requestAccessToken({
                            prompt: '',
                            callback: (resp) => {
                                if (resp.error) reject(resp);
                                else {
                                    State.token = resp.access_token;
                                    localStorage.setItem('g_token', State.token);
                                    gapi.client.setToken({ access_token: State.token });
                                    resolve();
                                }
                            }
                        });
                    });
                },
                onSuccess: async () => {
                    const auth = $('auth-screen');
                    if (auth) auth.style.display = 'none';
                    const ui = $('app-ui');
                    if (ui) {
                        ui.classList.remove('hidden');
                        gsap.to(ui, { opacity: 1, duration: 0.5 });
                    }
                    Drive.loadFiles('root');
                    Auth.updateStorage();
                    Auth.updateStorageChart();
                },
                updateStorage: async () => {
                    try {
                        const { result: { storageQuota: q } } = await gapi.client.drive.about.get({ fields: 'storageQuota' });
                        $('storage-used').innerText = (q.usage / 1e9).toFixed(2) + ' GB';
                        $('storage-total').innerText = '/ ' + (q.limit / 1e9).toFixed(0) + ' GB';
                        $('storage-bar').style.width = (q.usage / q.limit) * 100 + '%';
                    } catch (e) {
                        console.warn('Storage update failed', e);
                    }
                },
                updateStorageChart: async () => {
                    const canvas = $('storageChart');
                    if (!canvas) return;
                    if (window.storageChartInstance) window.storageChartInstance.destroy();
                    try {
                        const q = await gapi.client.drive.about.get({ fields: 'storageQuota' });
                        const used = q.result.storageQuota.usage / 1e9;
                        const total = q.result.storageQuota.limit / 1e9;
                        window.storageChartInstance = new Chart(canvas, {
                            type: 'doughnut',
                            data: {
                                labels: ['Used', 'Free'],
                                datasets: [{
                                    data: [used, total - used],
                                    backgroundColor: ['#3b82f6', '#334155']
                                }]
                            },
                            options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } } }
                        });
                    } catch (e) { console.warn('Chart error', e); }
                }
            };

            // ========== DRIVE with abort & double-click protection ==========
            const Drive = {
                async call(fn, ...args) {
                    if (State.loading) return;
                    State.loading = true;
                    if (State.abortController) State.abortController.abort();
                    State.abortController = new AbortController();
                    const signal = State.abortController.signal;

                    try {
                        const result = await fn(...args, { signal });
                        State.loading = false;
                        return result;
                    } catch (err) {
                        State.loading = false;
                        if (err.name === 'AbortError') {
                            console.log('Request aborted');
                            return;
                        }
                        if (err.status === 401) {
                            try {
                                await Auth.refreshToken();
                                return await fn(...args, { signal });
                            } catch (e) {
                                showToast('Authentication failed', 'error');
                                throw e;
                            }
                        }
                        showToast('API error', 'error');
                        throw err;
                    }
                },
                async loadFiles(folderId, addToHistory = true) {
                    if (State.loading) return;
                    State.loading = true;
                    if (addToHistory && folderId !== State.currentFolder) {
                        State.history.push(State.currentFolder);
                        History.updateBackButton();
                    }
                    State.currentFolder = folderId;
                    State.selected.clear();
                    BulkActions.updateDock();
                    UI.showLoader();

                    let q = `'${folderId}' in parents and trashed = false`;
                    let name = "Folder";
                    if (folderId === 'starred') { q = 'starred = true and trashed = false'; name = "Starred"; }
                    else if (folderId === 'root') { name = "My Drive"; }
                    else if (folderId === AppConfig.vaultId) { name = "Vault"; }
                    else {
                        try {
                            const r = await Drive.call(() => gapi.client.drive.files.get({ fileId: folderId, fields: 'name' }));
                            if (r && r.result) name = r.result.name;
                        } catch (e) { /* ignore */ }
                    }
                    $('folder-name').innerText = name;

                    try {
                        const res = await Drive.call(() => gapi.client.drive.files.list({
                            q: q,
                            pageSize: State.pageSize,
                            fields: 'files(id, name, mimeType, iconLink, thumbnailLink, size, md5Checksum, webContentLink), nextPageToken',
                            orderBy: State.sortOrder
                        }));
                        if (!res || !res.result || !res.result.files) throw new Error('Invalid response');
                        State.files = res.result.files || [];
                        State.originalFiles = State.files;
                        State.nextPageToken = res.result.nextPageToken || null;
                        // Cache files
                        State.files.forEach(f => db.files.put(f));
                        UI.renderGrid(State.files);
                    } catch (e) {
                        if (e.name !== 'AbortError') {
                            console.error(e);
                            showToast('Failed to load files', 'error');
                        }
                    } finally {
                        State.loading = false;
                    }
                },
                async loadMore() {
                    if (State.loadingMore || !State.nextPageToken) return;
                    State.loadingMore = true;
                    try {
                        const res = await Drive.call(() => gapi.client.drive.files.list({
                            q: `'${State.currentFolder}' in parents and trashed = false`,
                            pageSize: State.pageSize,
                            pageToken: State.nextPageToken,
                            fields: 'files(id, name, mimeType, iconLink, thumbnailLink, size), nextPageToken',
                            orderBy: State.sortOrder
                        }));
                        if (res && res.result && res.result.files) {
                            State.files = [...State.files, ...res.result.files];
                            State.nextPageToken = res.result.nextPageToken || null;
                            UI.renderGrid(State.files);
                        }
                    } catch (e) { /* ignore */ } finally { State.loadingMore = false; }
                },
                search: debounce(async (term) => {
                    if (!term.trim()) return Drive.loadFiles(State.currentFolder, false);
                    UI.showLoader();
                    try {
                        const safeTerm = escapeQuery(term);
                        const res = await Drive.call(() => gapi.client.drive.files.list({
                            q: `name contains '${safeTerm}' and trashed = false`,
                            fields: 'files(id, name, mimeType, iconLink, thumbnailLink, size)',
                        }));
                        if (res && res.result && res.result.files) {
                            State.files = res.result.files;
                            UI.renderGrid(State.files);
                            $('folder-name').innerText = `Search: "${term}"`;
                        }
                    } catch (e) { /* ignore */ }
                }, 400),
                clearSearch() {
                    const sb = $('search-box');
                    if (sb) sb.value = '';
                    const clear = $('clear-search');
                    if (clear) clear.style.display = 'none';
                    Drive.loadFiles(State.currentFolder, false);
                },
                sort(val) {
                    State.sortOrder = val;
                    Drive.loadFiles(State.currentFolder, false);
                },
                async download(fileId, fileName) {
                    const file = State.files.find(f => f.id === fileId) || State.activeFile;
                    if (!file) return Swal.fire('Error', 'File not found', 'error');
                    const Toast = Swal.mixin({ toast: true, position: 'bottom-end', showConfirmButton: false, timer: 3000 });
                    Toast.fire({ icon: 'info', title: `Downloading ${fileName}...`, background: '#1e293b', color: '#fff' });
                    try {
                        let url;
                        if (file.mimeType.includes('application/vnd.google-apps.')) {
                            let exportMime = 'application/pdf';
                            if (file.mimeType.includes('document')) exportMime = 'application/vnd.openxmlformats-officedocument.wordprocessingml.document';
                            if (file.mimeType.includes('spreadsheet')) exportMime = 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet';
                            if (file.mimeType.includes('presentation')) exportMime = 'application/vnd.openxmlformats-officedocument.presentationml.presentation';
                            url = `https://www.googleapis.com/drive/v3/files/${fileId}/export?mimeType=${encodeURIComponent(exportMime)}`;
                            fileName += exportMime === 'application/pdf' ? '.pdf' :
                                exportMime.includes('word') ? '.docx' :
                                    exportMime.includes('sheet') ? '.xlsx' : '.pptx';
                        } else {
                            url = `https://www.googleapis.com/drive/v3/files/${fileId}?alt=media`;
                        }
                        const response = await fetch(url, { headers: { 'Authorization': `Bearer ${State.token}` } });
                        if (!response.ok) throw new Error('API Error');
                        const blob = await response.blob();
                        const blobUrl = URL.createObjectURL(blob);
                        State.blobUrls.push(blobUrl);
                        const a = document.createElement('a');
                        a.href = blobUrl; a.download = fileName; a.click();
                    } catch (e) {
                        Swal.fire('Download Failed', e.message, 'error');
                    }
                },
                async deleteFile(fileId) {
                    try {
                        await Drive.call(() => gapi.client.drive.files.delete({ fileId }));
                        return true;
                    } catch (e) { return false; }
                },
                async renameFile(fileId, newName) {
                    try {
                        await Drive.call(() => gapi.client.drive.files.update({ fileId, resource: { name: newName } }));
                        return true;
                    } catch (e) { return false; }
                }
            };

            // ========== HISTORY ==========
            const History = {
                goBack() {
                    if (State.history.length === 0) return;
                    const prevId = State.history.pop();
                    History.updateBackButton();
                    Drive.loadFiles(prevId, false);
                },
                updateBackButton() {
                    const btn = $('back-button');
                    if (btn) btn.disabled = State.history.length === 0;
                }
            };

            // ========== UI ==========
            const UI = {
                showLoader() {
                    const grid = $('file-grid');
                    if (!grid) return;
                    grid.innerHTML = '';
                    for (let i = 0; i < 6; i++) {
                        const card = document.createElement('div');
                        card.className = 'file-card skeleton h-36 rounded-lg';
                        grid.appendChild(card);
                    }
                },
                setView(mode) { State.viewMode = mode; UI.renderGrid(State.files); },
                renderGrid(files) {
                    const grid = $('file-grid');
                    if (!grid) return;
                    if (!files || files.length === 0) {
                        grid.innerHTML = `<div class="col-span-full text-center py-20">
                            <span class="material-icons-round text-6xl text-slate-600">folder_open</span>
                            <p class="text-slate-400 mt-2">Empty Folder</p>
                            <button onclick="Tools.createFolderUI()" class="mt-4 px-4 py-2 bg-blue-600 rounded-lg text-white text-sm">New Folder</button>
                        </div>`;
                        return;
                    }
                    // Limit to 100 for performance
                    const displayFiles = files.slice(0, 100);
                    const fragment = document.createDocumentFragment();
                    displayFiles.forEach((f, i) => {
                        const isFolder = f.mimeType.includes('folder');
                        const icon = isFolder ? 'folder' : (f.mimeType.includes('image') ? 'image' : 'description');
                        const color = isFolder ? 'text-yellow-400' : 'text-blue-400';
                        const thumb = f.thumbnailLink ? f.thumbnailLink.replace('=s220', '=s400') : null;
                        const size = f.size ? (f.size / 1024 / 1024).toFixed(1) + ' MB' : '';
                        const selected = State.selected.has(f.id) ? 'selected' : '';
                        const card = document.createElement('div');
                        card.className = `file-card ${selected} animate-slideUp group`;
                        card.style.animationDelay = (i * 0.02) + 's';
                        card.dataset.id = f.id;
                        card.dataset.mime = f.mimeType;
                        if (State.viewMode === 'grid') {
                            card.innerHTML = `
                                <div class="h-20 bg-slate-800/50 flex items-center justify-center relative overflow-hidden">
                                    ${thumb && !isFolder ? `<img data-src="${thumb}" src="data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20width%3D%2240%22%20height%3D%2240%22%20viewBox%3D%220%200%2040%2040%22%3E%3Crect%20width%3D%2240%22%20height%3D%2240%22%20fill%3D%22%23334155%22%2F%3E%3C%2Fsvg%3E" class="w-full h-full object-cover opacity-80 group-hover:opacity-100 transition-opacity" loading="lazy">` : `<span class="material-icons-round ${color} text-4xl">${icon}</span>`}
                                </div>
                                <div class="p-2 flex-1 flex flex-col justify-center min-w-0">
                                    <div class="text-xs text-slate-200 truncate font-medium">${f.name}</div>
                                    <div class="flex justify-between items-center mt-1">
                                        <span class="text-[9px] text-slate-500">${size}</span>
                                        <button class="text-slate-500 hover:text-white select-btn" data-id="${f.id}" onclick="event.stopPropagation(); Tools.toggleSelect('${f.id}')"><span class="material-icons-round text-base">${State.selected.has(f.id) ? 'check_circle' : 'check_circle_outline'}</span></button>
                                    </div>
                                </div>
                            `;
                        } else {
                            card.innerHTML = `
                                <span class="material-icons-round ${color} text-xl">${icon}</span>
                                <div class="flex-1 min-w-0"><div class="text-sm text-slate-200 truncate">${f.name}</div><div class="text-[10px] text-slate-500">${size}</div></div>
                                <button class="text-slate-500 hover:text-white select-btn" data-id="${f.id}" onclick="event.stopPropagation(); Tools.toggleSelect('${f.id}')"><span class="material-icons-round text-base">${State.selected.has(f.id) ? 'check_circle' : 'check_circle_outline'}</span></button>
                            `;
                        }
                        fragment.appendChild(card);
                    });
                    grid.innerHTML = '';
                    grid.appendChild(fragment);
                    // Lazy load images
                    const observer = new IntersectionObserver((entries) => {
                        entries.forEach(e => {
                            if (e.isIntersecting) {
                                const img = e.target.querySelector('img');
                                if (img && img.dataset.src) img.src = img.dataset.src;
                                observer.unobserve(e.target);
                            }
                        });
                    });
                    grid.querySelectorAll('img').forEach(img => observer.observe(img));
                    // Infinite scroll
                    grid.addEventListener('scroll', () => {
                        if (grid.scrollTop + grid.clientHeight >= grid.scrollHeight - 100) Drive.loadMore();
                    }, { passive: true });
                },
                click(id, mime) {
                    if (mime.includes('folder')) Drive.loadFiles(id);
                    else Viewer.open(State.files.find(f => f.id === id));
                }
            };

            // ========== VIEWER ==========
            const Viewer = {
                open(file) {
                    if (!file) return;
                    State.activeFile = file;
                    const content = $('viewer-content');
                    if (!content) return;
                    $('viewer-title').innerText = file.name;
                    $('viewer').classList.remove('hidden');
                    $('ai-sidebar').classList.add('translate-x-full');
                    content.innerHTML = '<div class="loader-spinner"></div>';
                    const mime = file.mimeType;
                    const removeBtn = $('remove-bg-btn');
                    if (removeBtn) removeBtn.classList.toggle('hidden', !mime.includes('image'));
                    if (mime.includes('image')) {
                        const url = file.thumbnailLink ? file.thumbnailLink.replace('=s220', '=s1600') : '';
                        content.innerHTML = `<img src="${url}" class="max-w-full max-h-full object-contain shadow-2xl rounded">`;
                    } else if (mime.includes('video') || mime === 'application/pdf') {
                        content.innerHTML = `<iframe src="https://drive.google.com/file/d/${file.id}/preview" class="w-full h-full border-0 rounded bg-black"></iframe>`;
                    } else if (mime === 'application/zip' || mime.includes('compressed')) {
                        fetch(`https://www.googleapis.com/drive/v3/files/${file.id}?alt=media`, {
                            headers: { 'Authorization': `Bearer ${State.token}` }
                        })
                            .then(r => r.blob())
                            .then(blob => JSZip.loadAsync(blob))
                            .then(zip => {
                                const files = Object.keys(zip.files).slice(0, 50);
                                content.innerHTML = `<div class="bg-slate-900 p-4 rounded w-full max-w-md overflow-auto text-xs font-mono text-slate-300 border border-white/10">ZIP Contents:<br>${files.map(f => '📄 ' + f).join('<br>')}</div>`;
                            })
                            .catch(() => content.innerHTML = '<div class="text-red-500">Failed to read ZIP</div>');
                    } else if (mime.includes('text') || mime.includes('json') || mime.includes('javascript') || mime.includes('html')) {
                        fetch(`https://www.googleapis.com/drive/v3/files/${file.id}?alt=media`, {
                            headers: { 'Authorization': `Bearer ${State.token}`, 'Range': 'bytes=0-15000' }
                        })
                            .then(r => r.text())
                            .then(t => content.innerHTML = `<pre class="bg-slate-900 p-4 rounded w-full h-full overflow-auto text-xs font-mono text-slate-300 border border-white/10 whitespace-pre-wrap">${t.replace(/</g, '&lt;')}</pre>`)
                            .catch(() => content.innerHTML = '<div class="text-red-500">Failed to load text</div>');
                    } else {
                        content.innerHTML = `<div class="text-center"><span class="material-icons-round text-6xl text-slate-600 mb-4">description</span><p class="text-slate-400">Preview not supported</p></div>`;
                    }
                },
                close() {
                    $('viewer').classList.add('hidden');
                    $('viewer-content').innerHTML = '';
                    State.blobUrls.forEach(url => URL.revokeObjectURL(url));
                    State.blobUrls = [];
                },
                downloadCurrent: () => Drive.download(State.activeFile.id, State.activeFile.name)
            };

            // ========== AI ==========
            const AI = {
                async analyzeCurrentFile() {
                    if (!State.activeFile) return;
                    await this.analyze([State.activeFile]);
                },
                async analyze(files) {
                    if (State.aiRunning) return;
                    State.aiRunning = true;
                    const btn = $('ai-analyze-btn');
                    if (btn) btn.disabled = true;

                    const sidebar = $('ai-sidebar');
                    const results = $('ai-results');
                    if (!sidebar || !results) return;
                    sidebar.classList.remove('translate-x-full');
                    results.innerHTML = `<div class="relative h-24 bg-slate-800 rounded border border-purple-500/30 mb-4"><div class="scan-line"></div><div class="absolute inset-0 flex items-center justify-center text-purple-300 text-xs">AI Processing...</div></div>`;

                    try {
                        let combinedText = "";
                        for (const file of files.slice(0, 3)) {
                            if (file.mimeType.includes('image')) {
                                const r = await fetch(`https://www.googleapis.com/drive/v3/files/${file.id}?alt=media`, { headers: { 'Authorization': `Bearer ${State.token}` } });
                                const blob = await r.blob();
                                // FIX: Use selected OCR language
                                const ocrLang = $('ocr-lang') ? $('ocr-lang').value : 'eng';
                                const { data } = await Tesseract.recognize(blob, ocrLang);
                                combinedText += `\n--- ${file.name} ---\n${data.text}`;
                            } else if (file.mimeType === 'application/pdf') {
                                const r = await fetch(`https://www.googleapis.com/drive/v3/files/${file.id}?alt=media`, { headers: { 'Authorization': `Bearer ${State.token}` } });
                                const arrayBuffer = await r.arrayBuffer();
                                const pdf = await pdfjsLib.getDocument(arrayBuffer).promise;
                                let fullText = "";
                                const maxPages = Math.min(pdf.numPages, 2);
                                for (let i = 1; i <= maxPages; i++) {
                                    const page = await pdf.getPage(i);
                                    const tc = await page.getTextContent();
                                    fullText += tc.items.map(item => item.str).join(' ') + "\n";
                                }
                                combinedText += `\n--- ${file.name} ---\n${fullText}`;
                            } else if (file.mimeType.includes('text')) {
                                const r = await fetch(`https://www.googleapis.com/drive/v3/files/${file.id}?alt=media`, { headers: { 'Authorization': `Bearer ${State.token}`, 'Range': 'bytes=0-2000' } });
                                combinedText += `\n--- ${file.name} ---\n${await r.text()}`;
                            }
                        }
                        // Truncate if too long
                        if (combinedText.length > 10000) {
                            combinedText = combinedText.slice(0, 8000) + ' ... ' + combinedText.slice(-2000);
                        }
                        const prompt = `Respond strictly in sections with headings:
Overview:
Key Insights:
Detailed Analysis:
Recommendations:
Risk Assessment:

Files content:
${combinedText}`;

                        const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${AppConfig.geminiKey}`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
                        });
                        const data = await response.json();
                        let reply = data.candidates?.[0]?.content?.parts?.[0]?.text || "AI Error";
                        State.aiMemory.unshift({ query: `Analyzed ${files.length} files`, response: reply });
                        if (State.aiMemory.length > 5) State.aiMemory.pop();
                        const html = marked.parse(reply);
                        results.innerHTML = `<div class="markdown-body">${html}</div>`;
                        Prism.highlightAllUnder(results);
                    } catch (e) {
                        results.innerHTML = `<div class="text-red-400">Analysis Failed: ${e.message}<br><button onclick="AI.analyzeCurrentFile()" class="mt-2 px-3 py-1 bg-blue-600 rounded text-white">Retry</button></div>`;
                    } finally {
                        State.aiRunning = false;
                        if (btn) btn.disabled = false;
                    }
                }
            };

            // ========== UPLOAD ==========
            const Upload = {
                activeUploads: {},
                totalBytes: 0,
                loadedBytes: 0,
                startTime: null,
                speedInterval: null,
                lastLoaded: {},
                handle(files) {
                    if (!files || files.length === 0) return;
                    const manager = $('upload-manager');
                    if (!manager) return;
                    manager.classList.remove('translate-y-[120%]');
                    $('upload-title').innerText = `Uploading ${files.length} item(s)`;
                    this.totalBytes = Array.from(files).reduce((acc, f) => acc + f.size, 0);
                    this.loadedBytes = 0;
                    this.startTime = Date.now();
                    this.speedInterval = setInterval(() => this.updateStats(), 500);
                    Array.from(files).forEach(file => {
                        const id = Math.random().toString(36).substr(2, 9);
                        const item = document.createElement('div');
                        item.className = 'upload-item bg-gray-900/50 p-2 rounded flex items-center gap-3';
                        item.setAttribute('data-id', id);
                        item.innerHTML = `
                            <span class="material-icons-round text-cyan-400">insert_drive_file</span>
                            <div class="flex-1 min-w-0">
                                <div class="flex justify-between text-xs text-gray-300 mb-1">
                                    <span class="truncate">${file.name}</span>
                                    <span id="prog-${id}">0%</span>
                                </div>
                                <div class="h-1 bg-gray-800 rounded-full overflow-hidden">
                                    <div id="bar-${id}" class="progress-bar" style="width:0%"></div>
                                </div>
                            </div>
                            <button class="text-gray-500 hover:text-red-400" onclick="Upload.cancel('${id}')"><span class="material-icons-round text-sm">close</span></button>
                        `;
                        $('upload-list').appendChild(item);
                        this.uploadFile(file, id);
                    });
                },
                uploadFile(file, id) {
                    const metadata = { name: file.name, mimeType: file.type, parents: [State.currentFolder] };
                    const form = new FormData();
                    form.append('metadata', new Blob([JSON.stringify(metadata)], { type: 'application/json' }));
                    form.append('file', file);
                    const xhr = new XMLHttpRequest();
                    this.activeUploads[id] = xhr;
                    xhr.upload.onprogress = (e) => {
                        if (e.lengthComputable) {
                            const percent = (e.loaded / e.total) * 100;
                            const bar = $(`bar-${id}`); if (bar) bar.style.width = percent + '%';
                            const prog = $(`prog-${id}`); if (prog) prog.innerText = Math.round(percent) + '%';
                            Upload.loadedBytes += e.loaded - (Upload.lastLoaded[id] || 0);
                            Upload.lastLoaded[id] = e.loaded;
                        }
                    };
                    xhr.onload = () => {
                        delete Upload.activeUploads[id];
                        if (xhr.status === 200) {
                            const prog = $(`prog-${id}`); if (prog) prog.innerHTML = '<span class="text-green-400">Done</span>';
                            const bar = $(`bar-${id}`); if (bar) bar.className = 'h-full bg-green-500';
                            setTimeout(() => {
                                const item = document.querySelector(`[data-id="${id}"]`);
                                if (item) item.remove();
                                if (!$('upload-list').children.length) {
                                    $('upload-manager').classList.add('translate-y-[120%]');
                                    clearInterval(Upload.speedInterval);
                                }
                            }, 2000);
                            Drive.loadFiles(State.currentFolder, false);
                        } else {
                            const prog = $(`prog-${id}`); if (prog) prog.innerHTML = '<span class="text-red-400">Failed</span>';
                        }
                    };
                    xhr.onerror = () => {
                        delete Upload.activeUploads[id];
                        const prog = $(`prog-${id}`); if (prog) prog.innerHTML = '<span class="text-red-400">Error</span>';
                    };
                    xhr.open('POST', 'https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart');
                    xhr.setRequestHeader('Authorization', `Bearer ${State.token}`);
                    xhr.send(form);
                },
                cancel(id) {
                    if (this.activeUploads[id]) {
                        this.activeUploads[id].abort();
                        delete this.activeUploads[id];
                    }
                    const item = document.querySelector(`[data-id="${id}"]`);
                    if (item) item.remove();
                    if (!$('upload-list').children.length) {
                        $('upload-manager').classList.add('translate-y-[120%]');
                        clearInterval(this.speedInterval);
                    }
                },
                updateStats() {
                    const elapsed = (Date.now() - this.startTime) / 1000;
                    const speed = this.loadedBytes / elapsed;
                    const remaining = this.totalBytes - this.loadedBytes;
                    const eta = remaining / speed;
                    $('upload-speed').innerText = this.formatSpeed(speed);
                    $('upload-eta').innerText = this.formatTime(eta);
                },
                formatSpeed(bps) {
                    if (bps < 1024) return bps.toFixed(0) + ' B/s';
                    if (bps < 1048576) return (bps / 1024).toFixed(1) + ' KB/s';
                    return (bps / 1048576).toFixed(1) + ' MB/s';
                },
                formatTime(sec) {
                    if (sec < 0 || !isFinite(sec)) return '--:--';
                    const mins = Math.floor(sec / 60);
                    const secs = Math.floor(sec % 60);
                    return `${mins}:${secs.toString().padStart(2, '0')}`;
                }
            };

            // ========== CHAT ==========
            const Chat = {
                toggle() { $('chat-window').classList.toggle('open'); },
                async send(msg) {
                    if (!msg) return;
                    const div = $('chat-messages');
                    div.innerHTML += `<div class="text-right"><span class="bg-blue-600 text-white px-3 py-1.5 rounded-lg inline-block">${msg}</span></div>`;
                    div.scrollTop = div.scrollHeight;
                    const lowerMsg = msg.toLowerCase();
                    if (lowerMsg.startsWith('generate image') || lowerMsg.startsWith('draw')) {
                        const prompt = msg.replace(/generate image|draw/i, '').trim();
                        const loaderId = 'img-' + Date.now();
                        div.innerHTML += `<div class="text-left"><span class="bg-slate-700 text-slate-300 px-3 py-1.5 rounded-lg inline-block text-xs" id="${loaderId}">🎨 Generating: ${prompt}...</span></div>`;
                        div.scrollTop = div.scrollHeight;
                        try {
                            const response = await fetch("https://api-inference.huggingface.co/models/prompthero/openjourney", {
                                headers: { Authorization: `Bearer ${AppConfig.hfToken}` },
                                method: "POST",
                                body: JSON.stringify({ inputs: prompt })
                            });
                            if (!response.ok) throw new Error("API Limit");
                            const blob = await response.blob();
                            const url = URL.createObjectURL(blob);
                            State.blobUrls.push(url);
                            $(loaderId).innerHTML = `Here is your image for "${prompt}":<br><img src="${url}" class="mt-2 rounded-lg max-w-[220px] border border-white/10 shadow-lg cursor-pointer hover:scale-105 transition-transform" onclick="window.open('${url}')">`;
                        } catch (e) {
                            $(loaderId).innerHTML = `❌ Image generation failed: ${e.message}`;
                        }
                        div.scrollTop = div.scrollHeight;
                        return;
                    }
                    let fileContext = "";
                    const mentionedFile = State.files.find(f => msg.toLowerCase().includes(f.name.toLowerCase()));
                    if (mentionedFile) {
                        try {
                            if (mentionedFile.mimeType.includes('text') || mentionedFile.mimeType.includes('json')) {
                                const r = await fetch(`https://www.googleapis.com/drive/v3/files/${mentionedFile.id}?alt=media`, {
                                    headers: { 'Authorization': `Bearer ${State.token}`, 'Range': 'bytes=0-2000' }
                                });
                                const text = await r.text();
                                fileContext = `\nContent of file "${mentionedFile.name}":\n${text}...\n`;
                            } else if (mentionedFile.mimeType.includes('image')) {
                                fileContext = `\nThe user mentioned an image file "${mentionedFile.name}". You can suggest analyzing it.`;
                            }
                        } catch (e) { }
                    }
                    const memoryContext = State.aiMemory.slice(0, 3).map(m => `Previous: ${m.query}`).join('\n');
                    const prompt = `You are Jarvis, an AI OS Assistant.
Current folder: ${State.currentFolder}
Files: ${State.files.map(f => f.name).join(', ')}
${fileContext}
${memoryContext}
User: ${msg}
If action, respond JSON: {"action":"create_folder","name":"..."} or {"action":"delete_file","id":"..."} etc. Otherwise, answer helpfully.`;
                    try {
                        const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${AppConfig.geminiKey}`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
                        });
                        const data = await response.json();
                        let reply = data.candidates?.[0]?.content?.parts?.[0]?.text || "Error";
                        const cmd = safeJSON(reply);
                        if (cmd) {
                            if (cmd.action === 'create_folder') {
                                await gapi.client.drive.files.create({ resource: { name: cmd.name, mimeType: 'application/vnd.google-apps.folder', parents: [State.currentFolder] } });
                                reply = `✅ Created folder "${cmd.name}"`;
                                Drive.loadFiles(State.currentFolder, false);
                            } else if (cmd.action === 'delete_file') {
                                const ok = await Drive.deleteFile(cmd.id);
                                reply = ok ? `✅ Deleted file` : `❌ Failed`;
                                if (ok) Drive.loadFiles(State.currentFolder, false);
                            }
                        }
                        State.aiMemory.unshift({ query: msg, response: reply });
                        if (State.aiMemory.length > 5) State.aiMemory.pop();
                        const paragraphs = reply.split('\n\n');
                        let idx = 0;
                        const stream = setInterval(() => {
                            if (idx < paragraphs.length) {
                                div.innerHTML += `<div class="text-left"><span class="bg-slate-700 text-slate-200 px-3 py-1.5 rounded-lg inline-block">${marked.parseInline(paragraphs[idx])}</span></div>`;
                                div.scrollTop = div.scrollHeight;
                                idx++;
                            } else clearInterval(stream);
                        }, 300);
                        const utterance = new SpeechSynthesisUtterance(reply.replace(/<[^>]*>/g, ''));
                        window.speechSynthesis.speak(utterance);
                    } catch (e) {
                        div.innerHTML += `<div class="text-red-400">Error: ${e.message}</div>`;
                    }
                },
                sendFromInput() {
                    const input = $('chat-input');
                    const msg = input.value.trim();
                    if (msg) {
                        Chat.send(msg);
                        input.value = '';
                    }
                }
            };

            // ========== VOICE ==========
            const Voice = {
                recognition: null,
                isListening: false,
                init() {
                    const SpeechRec = window.SpeechRecognition || window.webkitSpeechRecognition;
                    if (!SpeechRec) {
                        Swal.fire('Error', 'Voice not supported', 'error');
                        return null;
                    }
                    const rec = new SpeechRec();
                    rec.lang = 'en-US';
                    rec.interimResults = false;
                    rec.continuous = false;
                    rec.onstart = () => {
                        this.isListening = true;
                        $('mic-icon').innerText = 'mic_off';
                        $('mic-btn').classList.add('bg-red-500');
                        $('mic-pulse').classList.remove('hidden');
                        $('chat-input').placeholder = "Listening...";
                    };
                    rec.onend = () => {
                        this.isListening = false;
                        $('mic-icon').innerText = 'mic';
                        $('mic-btn').classList.remove('bg-red-500');
                        $('mic-pulse').classList.add('hidden');
                        $('chat-input').placeholder = "Command Jarvis...";
                    };
                    rec.onresult = (e) => {
                        const txt = e.results[0][0].transcript;
                        const inp = $('chat-input');
                        inp.value = inp.value ? inp.value + ' ' + txt : txt;
                        Chat.sendFromInput();
                    };
                    return rec;
                },
                toggle() {
                    if (!this.recognition) this.recognition = this.init();
                    if (!this.recognition) return;
                    if (this.isListening) this.recognition.stop();
                    else this.recognition.start();
                }
            };

            // ========== IMAGE TOOLS ==========
            const ImageTools = {
                async removeBackground() {
                    if (!State.activeFile || !State.activeFile.mimeType.includes('image')) return;
                    const btn = $('remove-bg-btn');
                    if (!btn) return;
                    const original = btn.innerHTML;
                    btn.innerHTML = '<span class="material-icons-round text-sm animate-spin">refresh</span> Removing...';
                    try {
                        const resp = await fetch(`https://www.googleapis.com/drive/v3/files/${State.activeFile.id}?alt=media`, { headers: { 'Authorization': `Bearer ${State.token}` } });
                        const blob = await resp.blob();
                        const hf = await fetch("https://api-inference.huggingface.co/models/briaai/RMBG-1.4", {
                            headers: { Authorization: `Bearer ${AppConfig.hfToken}` },
                            method: "POST",
                            body: blob
                        });
                        if (!hf.ok) throw new Error("Failed");
                        const result = await hf.blob();
                        const url = URL.createObjectURL(result);
                        State.blobUrls.push(url);
                        $('viewer-content').innerHTML = `
                            <img src="${url}" class="max-w-full max-h-full object-contain shadow-2xl rounded animate-slideUp">
                            <button onclick="const a = document.createElement('a'); a.href='${url}'; a.download='bg_removed_${State.activeFile.name}.png'; a.click();" 
                                    class="absolute bottom-10 px-6 py-3 bg-green-500 text-white rounded-full shadow-[0_0_20px_rgba(34,197,94,0.4)] hover:scale-105 transition-transform flex items-center gap-2 font-bold z-50">
                                <span class="material-icons-round">download</span> Save Result
                            </button>
                        `;
                        Swal.fire('Background Removed', 'Click the download button to save.', 'success');
                    } catch (e) {
                        Swal.fire('Error', e.message, 'error');
                    } finally {
                        btn.innerHTML = original;
                    }
                }
            };

            // ========== TOOLS ==========
            const Tools = {
                async createFolderUI() {
                    const { value: name } = await Swal.fire({
                        title: 'New Folder',
                        input: 'text',
                        inputPlaceholder: 'Folder name',
                        background: '#1e293b',
                        color: '#fff',
                        showCancelButton: true,
                        inputValidator: v => !v ? 'Required' : null
                    });
                    if (!name) return;
                    try {
                        await gapi.client.drive.files.create({
                            resource: { name: name.trim(), mimeType: 'application/vnd.google-apps.folder', parents: [State.currentFolder] }
                        });
                        Drive.loadFiles(State.currentFolder, false);
                        showToast('Folder created', 'check_circle');
                    } catch (e) {
                        Swal.fire('Error', 'Could not create folder', 'error');
                    }
                },
                async renameUI(id, oldName) {
                    const { value: newName } = await Swal.fire({
                        title: 'Rename',
                        input: 'text',
                        inputValue: oldName,
                        background: '#1e293b',
                        color: '#fff',
                        showCancelButton: true,
                        inputValidator: v => !v && 'Required'
                    });
                    if (newName && newName.trim() !== oldName.trim()) {
                        if (await Drive.renameFile(id, newName.trim())) {
                            Drive.loadFiles(State.currentFolder, false);
                            showToast('Renamed', 'check_circle');
                        } else Swal.fire('Error', 'Rename failed', 'error');
                    }
                },
                toggleSelect(id) {
                    if (State.selected.has(id)) State.selected.delete(id);
                    else State.selected.add(id);
                    UI.renderGrid(State.files);
                    BulkActions.updateDock();
                }
            };

            // ========== BULK ACTIONS ==========
            const BulkActions = {
                updateDock() {
                    const dock = $('bulk-dock');
                    if (dock) dock.classList.toggle('visible', State.selected.size > 0);
                },
                async deleteSelected() {
                    if (State.selected.size === 0) return;
                    const confirm = await Swal.fire({
                        title: `Delete ${State.selected.size} items?`,
                        showCancelButton: true,
                        background: '#1e293b'
                    });
                    if (!confirm.isConfirmed) return;
                    for (const id of State.selected) await Drive.deleteFile(id);
                    State.selected.clear();
                    Drive.loadFiles(State.currentFolder, false);
                },
                moveSelected() { Swal.fire('Move', 'Not implemented', 'info'); },
                starSelected() { Swal.fire('Star', 'Not implemented', 'info'); },
                async zipSelected() {
                    if (State.selected.size === 0) return;
                    const zip = new JSZip();
                    showToast('Creating archive...', 'archive');
                    for (const id of State.selected) {
                        const f = State.files.find(f => f.id === id);
                        if (!f || f.mimeType.includes('folder')) continue;
                        try {
                            const r = await fetch(`https://www.googleapis.com/drive/v3/files/${id}?alt=media`, { headers: { 'Authorization': `Bearer ${State.token}` } });
                            const blob = await r.blob();
                            zip.file(f.name, blob);
                        } catch (e) { }
                    }
                    const content = await zip.generateAsync({ type: 'blob' });
                    const url = URL.createObjectURL(content);
                    State.blobUrls.push(url);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = 'archive.zip';
                    a.click();
                },
                analyzeSelected() {
                    const files = Array.from(State.selected).map(id => State.files.find(f => f.id === id)).filter(Boolean);
                    AI.analyze(files);
                },
                shareSelected() { Swal.fire('Share', 'Not implemented', 'info'); }
            };

            // ========== CONTEXT MENU ==========
            const ContextMenu = {
                show(e, id, name) {
                    e.preventDefault();
                    const menu = $('context-menu');
                    if (!menu) return;
                    const file = State.files.find(f => f.id === id);
                    if (!file) return;
                    menu.innerHTML = `
                        <div class="ctx-item" onclick="UI.click('${id}', '${file.mimeType}'); menu.style.display='none'"><span class="material-icons-round">visibility</span> Open</div>
                        <div class="ctx-item" onclick="Tools.renameUI('${id}', '${name}'); menu.style.display='none'"><span class="material-icons-round">edit</span> Rename</div>
                        <div class="ctx-item" onclick="Drive.download('${id}', '${name}'); menu.style.display='none'"><span class="material-icons-round">download</span> Download</div>
                        <hr>
                        <div class="ctx-item" onclick="Tools.toggleSelect('${id}'); menu.style.display='none'"><span class="material-icons-round">check_circle</span> Select</div>
                        <div class="ctx-item" onclick="BulkActions.analyzeSelected(); menu.style.display='none'"><span class="material-icons-round">auto_awesome</span> Analyze</div>
                        <div class="ctx-item text-red-400" onclick="(async()=>{ if(await Drive.deleteFile('${id}')) { Drive.loadFiles(State.currentFolder, false); menu.style.display='none'; } })()"><span class="material-icons-round">delete</span> Delete</div>
                    `;
                    menu.style.display = 'block';
                    menu.style.left = e.clientX + 'px';
                    menu.style.top = e.clientY + 'px';
                    document.addEventListener('click', () => menu.style.display = 'none', { once: true });
                    document.addEventListener('keydown', (esc) => { if (esc.key === 'Escape') menu.style.display = 'none'; }, { once: true });
                }
            };

            // ========== COMMAND PALETTE ==========
            const CommandPalette = {
                init() {
                    document.addEventListener('keydown', (e) => {
                        if (e.ctrlKey && e.key === 'k') {
                            e.preventDefault();
                            this.toggle();
                        }
                        if (e.ctrlKey && e.key === 'a') {
                            e.preventDefault();
                            State.selected = new Set(State.files.map(f => f.id));
                            UI.renderGrid(State.files);
                            BulkActions.updateDock();
                        }
                        if (e.key === 'Delete' && State.selected.size) {
                            e.preventDefault();
                            BulkActions.deleteSelected();
                        }
                    });
                    $('command-input').addEventListener('input', (e) => this.search(e.target.value));
                    $('command-palette').addEventListener('click', (e) => e.stopPropagation());
                },
                toggle() {
                    const pal = $('command-palette');
                    if (pal.style.display === 'block') {
                        pal.style.display = 'none';
                    } else {
                        pal.style.display = 'block';
                        $('command-input').focus();
                        this.search('');
                    }
                },
                search(term) {
                    const results = $('command-results');
                    if (!results) return;
                    const files = State.files.filter(f => f.name.toLowerCase().includes(term.toLowerCase()));
                    const actions = [
                        { name: 'New Folder', icon: 'create_new_folder', action: Tools.createFolderUI },
                        { name: 'Upload Files', icon: 'upload_file', action: () => $('upload-input').click() },
                        { name: 'Upload Folder', icon: 'create_new_folder', action: () => $('folder-upload-input').click() },
                        { name: 'Toggle Theme', icon: 'palette', action: () => document.querySelector('.theme-dot.active').click() }
                    ];
                    results.innerHTML = '';
                    files.slice(0, 5).forEach(f => {
                        const div = document.createElement('div');
                        div.className = 'result-item';
                        div.innerHTML = `<span class="material-icons-round text-blue-400">${f.mimeType.includes('folder') ? 'folder' : 'description'}</span> ${f.name}`;
                        div.onclick = () => {
                            if (f.mimeType.includes('folder')) Drive.loadFiles(f.id);
                            else Viewer.open(f);
                            CommandPalette.toggle();
                        };
                        results.appendChild(div);
                    });
                    if (files.length < 5) {
                        actions.forEach(a => {
                            const div = document.createElement('div');
                            div.className = 'result-item';
                            div.innerHTML = `<span class="material-icons-round text-purple-400">${a.icon}</span> ${a.name}`;
                            div.onclick = () => { a.action(); CommandPalette.toggle(); };
                            results.appendChild(div);
                        });
                    }
                }
            };

            // ========== THEME SWITCHER ==========
            document.querySelectorAll('.theme-dot').forEach(dot => {
                dot.addEventListener('click', () => {
                    document.body.className = dot.dataset.theme;
                    document.querySelectorAll('.theme-dot').forEach(d => d.classList.remove('active'));
                    dot.classList.add('active');
                });
            });

            // ========== PARTICLES ==========
            (function initParticles() {
                const container = $('particle-container');
                if (!container) return;
                for (let i = 0; i < 30; i++) {
                    const p = document.createElement('div');
                    p.className = 'particle';
                    p.style.left = Math.random() * 100 + '%';
                    p.style.top = Math.random() * 100 + '%';
                    p.style.animation = `float ${5 + Math.random() * 10}s linear infinite`;
                    container.appendChild(p);
                }
            })();

            // ========== MAGNETIC ==========
            document.querySelectorAll('.magnetic').forEach(btn => {
                btn.addEventListener('mousemove', (e) => {
                    const rect = btn.getBoundingClientRect();
                    const x = e.clientX - rect.left - rect.width / 2;
                    const y = e.clientY - rect.top - rect.height / 2;
                    btn.style.transform = `translate(${x * 0.1}px, ${y * 0.1}px)`;
                });
                btn.addEventListener('mouseleave', () => btn.style.transform = '');
            });

            // ========== EVENT DELEGATION ==========
            const grid = $('file-grid');
            if (grid) {
                grid.addEventListener('click', (e) => {
                    const card = e.target.closest('.file-card');
                    if (!card) return;
                    const id = card.dataset.id;
                    const mime = card.dataset.mime;
                    if (e.target.closest('.select-btn')) return;
                    UI.click(id, mime);
                });
                grid.addEventListener('contextmenu', (e) => {
                    const card = e.target.closest('.file-card');
                    if (!card) return;
                    e.preventDefault();
                    const id = card.dataset.id;
                    const name = card.querySelector('.font-medium')?.innerText || '';
                    ContextMenu.show(e, id, name);
                });
            }

            // ========== SEARCH DEBOUNCE ==========
            $('search-box').addEventListener('input', (e) => Drive.search(e.target.value));

            // ========== EXPOSE TO GLOBAL (FIX IIFE SCOPE) ==========
            window.Auth = Auth;
            window.Drive = Drive;
            window.UI = UI;
            window.Viewer = Viewer;
            window.AI = AI;
            window.Upload = Upload;
            window.Chat = Chat;
            window.Voice = Voice;
            window.ImageTools = ImageTools;
            window.Tools = Tools;
            window.BulkActions = BulkActions;
            window.ContextMenu = ContextMenu;
            window.History = History;
            window.CommandPalette = CommandPalette;

            // ========== INIT ==========
            window.onload = () => {
                Auth.init();
                CommandPalette.init(); // FIX: command palette was never started
            };
            window.State = State; // for debugging
        })();
    </script>
</body>
</html>
