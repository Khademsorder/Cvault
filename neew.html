<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>VAULT DRIVE · NEBULA</title>
    
    <!-- Google Identity -->
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    
    <!-- Fonts & Icons -->
    <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@300;400;500;600;700&family=Outfit:wght@300;400;500;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons+Round" rel="stylesheet">

    <!-- GSAP -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/gsap.min.js"></script>

    <style>
        /* ----- MODERN GLASS & NEBULA THEME (merged with 111.html structure) ----- */
        :root {
            --primary: #1a73e8;
            --primary-dark: #0d47a1;
            --secondary: #34a853;
            --surface: #ffffff;
            --bg: #f8f9fa;
            --text-main: #202124;
            --text-sec: #5f6368;
            --border: #dadce0;
            --hover: #f1f3f4;
            --shadow: 0 1px 2px 0 rgba(60,64,67,0.3), 0 1px 3px 1px rgba(60,64,67,0.15);
            --radius: 8px;
            --radius-lg: 12px;
            --radius-xl: 16px;
            --neon-blue: #00f0ff;
            --neon-purple: #b300ff;
            --neon-pink: #ff2b9e;
            --neon-green: #00ffaa;
        }

        .dark-theme {
            --primary: #8ab4f8;
            --primary-dark: #669df6;
            --secondary: #81c995;
            --surface: #202124;
            --bg: #121212;
            --text-main: #e8eaed;
            --text-sec: #9aa0a6;
            --border: #3c4043;
            --hover: #2d2e30;
            --shadow: 0 1px 2px 0 rgba(0,0,0,0.6), 0 1px 3px 1px rgba(0,0,0,0.302);
        }

        * { 
            box-sizing: border-box; 
            -webkit-tap-highlight-color: transparent; 
            outline: none; 
            user-select: none; 
        }
        
        body {
            margin: 0; padding: 0;
            font-family: 'Outfit', sans-serif;
            background: var(--bg); color: var(--text-main);
            height: 100vh; display: flex; flex-direction: column; overflow: hidden;
            transition: background-color 0.3s, color 0.3s;
        }

        /* Premium glassmorphism */
        .ultra-glass {
            background: rgba(12, 15, 25, 0.65);
            backdrop-filter: blur(32px) saturate(200%);
            -webkit-backdrop-filter: blur(32px) saturate(200%);
            border: 1px solid rgba(255, 255, 255, 0.08);
            box-shadow: 0 30px 60px -20px rgba(0, 0, 0, 0.8), inset 0 0 30px rgba(0, 240, 255, 0.05);
            transition: border-color 0.3s, box-shadow 0.4s;
        }
        .ultra-glass:hover {
            border-color: rgba(0, 240, 255, 0.3);
            box-shadow: 0 30px 60px -20px #000, inset 0 0 40px rgba(0, 240, 255, 0.1);
        }

        /* Screens */
        .screen {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            display: none; flex-direction: column; background: var(--bg); z-index: 10;
        }
        .screen.active { display: flex; animation: fade 0.2s ease; }
        @keyframes fade { from { opacity: 0; } to { opacity: 1; } }

        /* --- LOCK SCREEN (with neon dots) --- */
        #lock-screen {
            justify-content: center; align-items: center; background: var(--surface);
        }
        .pin-container {
            text-align: center; width: 100%; max-width: 320px; padding: 20px;
        }
        .logo-area { 
            font-family: 'Space Grotesk', monospace; 
            font-size: 24px; 
            color: var(--text-main); 
            margin-bottom: 10px; 
            text-shadow: 0 0 10px var(--neon-blue);
        }
        .logo-subtitle {
            font-size: 14px; color: var(--text-sec); margin-bottom: 30px;
        }
        .pin-dots {
            display: flex; justify-content: center; gap: 15px; margin-bottom: 40px;
        }
        .dot {
            width: 15px; height: 15px; border-radius: 50%;
            border: 2px solid var(--text-sec); transition: 0.2s;
        }
        .dot.filled { background: var(--neon-blue); border-color: var(--neon-blue); box-shadow: 0 0 10px var(--neon-blue); }
        .keypad {
            display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px;
            padding: 0 20px;
        }
        .key {
            width: 65px; height: 65px; border-radius: 50%;
            background: var(--hover); color: var(--text-main);
            font-size: 22px; display: flex; align-items: center; justify-content: center;
            margin: auto; cursor: pointer; transition: 0.1s;
            border: 1px solid var(--border);
            touch-action: manipulation;
        }
        .key:active { background: var(--border); transform: scale(0.95); }
        .key.clear, .key.backspace { background: transparent; font-size: 13px; color: var(--text-sec); border: none; }
        .biometric-btn {
            margin-top: 20px; padding: 10px 20px;
            background: transparent; border: 1px solid var(--border);
            border-radius: 20px; color: var(--text-sec); cursor: pointer;
            display: flex; align-items: center; gap: 8px; justify-content: center;
            font-size: 14px;
        }

        /* --- AUTH SCREEN --- */
        #auth-screen { justify-content: center; align-items: center; text-align: center; background: var(--surface); }
        .auth-card {
            background: var(--surface); padding: 30px; border-radius: var(--radius-xl);
            box-shadow: var(--shadow); width: 90%; max-width: 400px;
            border: 1px solid var(--border);
        }
        .auth-btn {
            background: var(--surface); border: 1px solid var(--border); padding: 12px 24px;
            border-radius: 24px; font-family: 'Outfit'; font-weight: 500;
            display: flex; align-items: center; gap: 10px; cursor: pointer;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1); margin-bottom: 15px;
            width: 100%; justify-content: center; transition: 0.2s;
        }
        .auth-btn:hover { background: var(--hover); }

        /* --- MAIN APP UI (based on 111.html but with glass) --- */
        .app-header {
            background: var(--surface); padding: 10px 15px; height: 60px;
            display: flex; align-items: center; justify-content: space-between;
            box-shadow: 0 1px 0 var(--border); z-index: 20;
            flex-shrink: 0;
        }
        .search-bar {
            flex: 1; background: var(--hover); border-radius: var(--radius-lg); margin: 0 15px;
            padding: 8px 12px; display: flex; align-items: center; color: var(--text-sec);
            border: 1px solid transparent; transition: 0.2s;
            min-width: 0;
        }
        .search-bar:focus-within { border-color: var(--neon-blue); background: var(--surface); }
        .search-input {
            border: none; background: transparent; margin-left: 10px; width: 100%; font-size: 16px;
            color: var(--text-main);
        }

        .toolbar {
            padding: 10px 15px; display: flex; justify-content: space-between; align-items: center;
            font-size: 14px; color: var(--text-sec); border-bottom: 1px solid var(--border);
            background: var(--surface);
            flex-shrink: 0;
        }
        .breadcrumb { 
            display: flex; align-items: center; overflow-x: auto; white-space: nowrap; flex: 1;
            min-width: 0; scrollbar-width: none; 
        }
        .breadcrumb::-webkit-scrollbar { display: none; }
        .back-btn {
            background: var(--hover); border: 1px solid var(--border); border-radius: var(--radius);
            width: 36px; height: 36px; display: flex; align-items: center; justify-content: center;
            cursor: pointer; margin-right: 10px; flex-shrink: 0;
        }
        .crumb-item { 
            color: var(--text-main); font-weight: 500; padding: 4px 8px; border-radius: var(--radius);
            cursor: pointer; transition: 0.2s; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
            max-width: 200px;
        }
        .crumb-item:hover { background: var(--hover); }
        .crumb-sep { margin: 0 5px; color: var(--text-sec); flex-shrink: 0; }
        .toolbar-actions { display: flex; gap: 10px; align-items: center; flex-shrink: 0; }
        
        .view-switcher {
            display: flex; background: var(--hover); border-radius: var(--radius);
            padding: 2px; border: 1px solid var(--border);
        }
        .view-btn {
            padding: 6px 10px; border-radius: 6px; cursor: pointer; font-size: 13px;
            display: flex; align-items: center; gap: 4px; min-width: 36px; justify-content: center;
        }
        .view-btn.active { background: var(--surface); }

        .file-viewer { flex: 1; overflow-y: auto; padding: 10px; min-height: 0; }
        .file-list-view { display: flex; flex-direction: column; gap: 2px; }
        .file-grid-view { display: grid; grid-template-columns: repeat(auto-fill, minmax(120px, 1fr)); gap: 12px; }
        
        .list-item {
            display: flex; align-items: center; padding: 12px 15px;
            border-bottom: 1px solid var(--border); cursor: pointer;
            border-radius: var(--radius); margin-bottom: 2px;
            background: var(--surface); transition: 0.2s;
            min-height: 64px; position: relative; overflow: hidden;
        }
        .list-item:hover { background: var(--hover); }
        
        .grid-item {
            background: var(--surface); border: 1px solid var(--border); border-radius: var(--radius);
            padding: 12px; display: flex; flex-direction: column; align-items: center; 
            text-align: center; cursor: pointer; transition: 0.2s;
            height: 140px; overflow: hidden; position: relative;
        }
        .grid-item:hover { transform: translateY(-2px); box-shadow: var(--shadow); }
        
        .item-icon { font-size: 24px; color: var(--text-sec); margin-right: 15px; flex-shrink: 0; }
        .folder-icon { color: #fbbc04; }
        .pdf-icon { color: #d93025; }
        .image-icon { color: #34a853; }
        .video-icon { color: #ea4335; }
        .grid-item .item-icon { font-size: 40px; margin: 0 0 8px 0; }
        
        .item-text { flex: 1; overflow: hidden; min-width: 0; }
        .item-name { 
            display: block; font-size: 14px; color: var(--text-main); 
            white-space: nowrap; overflow: hidden; text-overflow: ellipsis; 
            font-weight: 500; line-height: 1.4; margin-bottom: 2px;
        }
        .item-meta { 
            display: block; font-size: 11px; color: var(--text-sec); line-height: 1.3;
        }
        .file-actions { display: flex; gap: 5px; flex-shrink: 0; }
        .action-btn {
            width: 32px; height: 32px; border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            cursor: pointer; color: var(--text-sec); transition: 0.2s;
        }
        .action-btn:hover { background: var(--hover); }

        /* Sidebar */
        .sidebar {
            position: fixed; top: 0; left: -280px; width: 280px; height: 100%;
            background: var(--surface); box-shadow: 2px 0 10px rgba(0,0,0,0.1);
            z-index: 1000; transition: left 0.3s ease;
            display: flex; flex-direction: column;
            border-right: 1px solid var(--border);
        }
        .sidebar.active { left: 0; }
        .sidebar-header {
            padding: 20px; border-bottom: 1px solid var(--border);
            display: flex; justify-content: space-between; align-items: center;
        }
        .sidebar-user {
            display: flex; align-items: center; gap: 10px;
            padding: 15px 20px; border-bottom: 1px solid var(--border);
        }
        .user-avatar { width: 40px; height: 40px; border-radius: 50%; }
        .user-info h3 { margin: 0; font-size: 16px; }
        .user-info p { margin: 2px 0 0; font-size: 12px; color: var(--text-sec); }
        
        .sidebar-nav { flex: 1; padding: 15px 0; overflow-y: auto; }
        .nav-section { padding: 10px 0; }
        .nav-title {
            padding: 0 20px; font-size: 12px; color: var(--text-sec); 
            text-transform: uppercase; letter-spacing: 1px; margin-bottom: 10px;
        }
        .nav-item {
            display: flex; align-items: center; gap: 15px; padding: 12px 20px;
            color: var(--text-main); text-decoration: none; transition: 0.2s; cursor: pointer;
        }
        .nav-item:hover { background: var(--hover); }
        .nav-item.active { background: #e8f0fe; color: var(--primary); border-left: 3px solid var(--primary); }
        .nav-badge { margin-left: auto; background: var(--primary); color: white; font-size: 11px; padding: 2px 6px; border-radius: 10px; }

        /* Bottom Nav */
        .bottom-nav {
            height: 60px; background: var(--surface); border-top: 1px solid var(--border);
            display: flex; justify-content: space-around; align-items: center;
            position: relative; z-index: 20; flex-shrink: 0;
        }
        .nav-item-b { 
            display: flex; flex-direction: column; align-items: center; 
            color: var(--text-sec); font-size: 11px; padding: 5px; cursor: pointer;
            transition: 0.2s; flex: 1; min-width: 0;
        }
        .nav-item-b.active { color: var(--primary); }
        .nav-item-b .material-icons-round { font-size: 20px; margin-bottom: 2px; transition: 0.2s; }
        .nav-item-b.active .material-icons-round { background: #e8f0fe; padding: 6px; border-radius: 50%; }

        /* FAB */
        .fab-container { position: fixed; bottom: 80px; right: 20px; z-index: 50; }
        .fab-main {
            width: 56px; height: 56px; border-radius: 50%; background: var(--primary);
            box-shadow: var(--shadow); display: flex; align-items: center; justify-content: center;
            cursor: pointer; color: white; font-size: 28px; transition: 0.2s;
        }
        .fab-main:hover { background: var(--primary-dark); }
        .fab-menu {
            position: absolute; bottom: 70px; right: 0; background: var(--surface);
            border-radius: var(--radius-lg); box-shadow: var(--shadow); width: 200px;
            display: none; flex-direction: column; overflow: hidden; border: 1px solid var(--border);
        }
        .fab-item { 
            padding: 12px 15px; display: flex; align-items: center; gap: 10px; 
            font-size: 14px; cursor: pointer; color: var(--text-main); transition: 0.2s;
        }
        .fab-item:hover { background: var(--hover); }

        /* Modals */
        .modal-mask {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.6); z-index: 1000; display: none;
            justify-content: center; align-items: flex-end;
            backdrop-filter: blur(5px);
        }
        .modal-sheet {
            background: var(--surface); width: 100%; max-width: 600px;
            border-radius: 16px 16px 0 0; padding: 20px;
            animation: slideUp 0.2s ease-out; max-height: 80vh; overflow-y: auto;
            color: var(--text-main);
        }
        @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }
        
        .sheet-head { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; padding-bottom: 15px; border-bottom: 1px solid var(--border); }
        .sheet-title { font-family: 'Outfit'; font-size: 18px; font-weight: 500; }
        .action-list div { 
            padding: 15px 0; display: flex; align-items: center; gap: 15px; 
            border-bottom: 1px solid var(--border); cursor: pointer; color: var(--text-main);
        }
        .action-list div:last-child { border: none; }
        .action-list div:hover { background: var(--hover); }

        /* Progress box */
        .progress-box {
            background: var(--surface); padding: 20px; border-radius: var(--radius-lg); 
            width: 90%; max-width: 400px; margin: auto; box-shadow: var(--shadow); 
            display: none; position: fixed; top: 50%; left: 50%; 
            transform: translate(-50%, -50%); z-index: 2000; border: 1px solid var(--border);
        }
        .progress-header { display:flex; justify-content:space-between; margin-bottom:5px; }
        .progress-details { font-size:12px; color:var(--text-sec); margin-bottom:10px; }
        .progress-bar { height: 6px; background: var(--hover); border-radius: 3px; margin-top: 10px; overflow: hidden; }
        .progress-fill { height: 100%; background: linear-gradient(90deg, var(--primary), var(--secondary)); width: 0%; transition: width 0.3s; border-radius: 3px; }
        .progress-stats { display: flex; justify-content: space-between; margin-top: 8px; font-size: 11px; color: var(--text-sec); }

        /* Media viewer */
        .media-viewer {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: #000; z-index: 2500; display: none; flex-direction: column;
        }
        .media-header { 
            padding: 15px; color: #fff; display: flex; justify-content: space-between; 
            align-items: center; background: rgba(0,0,0,0.7); backdrop-filter: blur(10px); flex-shrink: 0;
        }
        .media-iframe { flex: 1; border: none; background: #fff; min-height: 0; }

        /* Cancel button */
        .cancel-btn {
            position: absolute; top: 15px; right: 15px; z-index: 3000;
            background: rgba(0,0,0,0.5); color: white; border: none;
            width: 40px; height: 40px; border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            cursor: pointer; font-size: 20px;
        }

        /* Empty state */
        .empty-state { text-align: center; padding: 50px 20px; color: var(--text-sec); }
        .empty-icon { font-size: 64px; margin-bottom: 20px; opacity: 0.5; }

        /* Loading */
        .loading { display: flex; justify-content: center; align-items: center; height: 100%; color: var(--text-sec); }

        /* Sort options */
        .sort-options { display: flex; flex-direction: column; gap: 10px; padding: 15px 0; }
        .sort-option { display: flex; justify-content: space-between; align-items: center; padding: 12px 0; border-bottom: 1px solid var(--border); cursor: pointer; }
        .sort-option.active { color: var(--primary); }
        .sort-option:hover { background: var(--hover); }

        /* File info */
        .file-info { padding: 15px 0; }
        .info-row { display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid var(--border); }
        .info-label { color: var(--text-sec); }
        .info-value { font-weight: 500; }

        /* Photo gallery */
        .photo-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); gap: 10px; padding: 10px; }
        .photo-item { position: relative; cursor: pointer; }
        .photo-thumb { width: 100%; height: 150px; object-fit: cover; border-radius: var(--radius); }
        .photo-overlay {
            position: absolute; bottom: 0; left: 0; right: 0;
            background: linear-gradient(transparent, rgba(0,0,0,0.7));
            color: white; padding: 10px; font-size: 12px;
            border-radius: 0 0 var(--radius) var(--radius);
        }

        /* Switch */
        .switch { position: relative; display: inline-block; width: 44px; height: 24px; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider { 
            position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; 
            background-color: #ccc; transition: .4s; border-radius: 24px; 
        }
        .slider:before { 
            position: absolute; content: ""; height: 18px; width: 18px; left: 3px; bottom: 3px; 
            background-color: white; transition: .4s; border-radius: 50%; 
        }
        input:checked + .slider { background-color: var(--primary); }
        input:checked + .slider:before { transform: translateX(20px); }
    </style>
</head>
<body>
    <!-- Sidebar -->
    <div class="sidebar" id="sidebar">
        <div class="sidebar-header">
            <h3 style="margin: 0;">VAULT DRIVE</h3>
            <span class="material-icons-round" onclick="UI.toggleSidebar()" style="cursor: pointer;">close</span>
        </div>
        <div class="sidebar-user">
            <img id="sidebar-avatar" class="user-avatar" src="" alt="User">
            <div class="user-info">
                <h3 id="sidebar-name">User</h3>
                <p id="sidebar-email">user@example.com</p>
            </div>
        </div>
        <div class="sidebar-nav">
            <div class="nav-section">
                <div class="nav-title">Storage</div>
                <div class="nav-item" onclick="Nav.switchTab('storage', this)">
                    <span class="material-icons-round">storage</span> Storage Usage
                    <span class="nav-badge" id="storage-badge">15 GB</span>
                </div>
            </div>
            <div class="nav-section">
                <div class="nav-title">Views</div>
                <div class="nav-item" onclick="UI.switchView('list')"><span class="material-icons-round">view_list</span> List View</div>
                <div class="nav-item" onclick="UI.switchView('grid')"><span class="material-icons-round">grid_view</span> Grid View</div>
                <div class="nav-item" onclick="UI.switchView('gallery')"><span class="material-icons-round">collections</span> Gallery View</div>
            </div>
            <div class="nav-section">
                <div class="nav-title">Sort By</div>
                <div class="nav-item" onclick="Drive.sort('name', 'asc')"><span class="material-icons-round">sort_by_alpha</span> Name (A-Z)</div>
                <div class="nav-item" onclick="Drive.sort('name', 'desc')"><span class="material-icons-round">sort_by_alpha</span> Name (Z-A)</div>
                <div class="nav-item" onclick="Drive.sort('size', 'asc')"><span class="material-icons-round">arrow_upward</span> Size (Small-Large)</div>
                <div class="nav-item" onclick="Drive.sort('size', 'desc')"><span class="material-icons-round">arrow_downward</span> Size (Large-Small)</div>
                <div class="nav-item" onclick="Drive.sort('date', 'desc')"><span class="material-icons-round">schedule</span> Date (Newest)</div>
                <div class="nav-item" onclick="Drive.sort('date', 'asc')"><span class="material-icons-round">schedule</span> Date (Oldest)</div>
            </div>
            <div class="nav-section">
                <div class="nav-title">Settings</div>
                <div class="nav-item" onclick="Settings.open()"><span class="material-icons-round">settings</span> App Settings</div>
                <div class="nav-item" onclick="Settings.security()"><span class="material-icons-round">security</span> Security</div>
                <div class="nav-item" onclick="Settings.about()"><span class="material-icons-round">info</span> About</div>
            </div>
        </div>
        <div style="padding: 20px; border-top: 1px solid var(--border);">
            <button onclick="Auth.logout()" style="background: transparent; border: 1px solid var(--border); color: var(--text-main); padding: 10px; border-radius: var(--radius); width: 100%; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 10px;">
                <span class="material-icons-round">logout</span> Sign Out
            </button>
        </div>
    </div>

    <!-- LOCK SCREEN -->
    <div id="lock-screen" class="screen active">
        <div class="pin-container">
            <div class="logo-area">VAULT DRIVE NEBULA</div>
            <div class="logo-subtitle">Enter your PIN to continue</div>
            <div class="pin-dots" id="pin-dots">
                <div class="dot"></div><div class="dot"></div><div class="dot"></div><div class="dot"></div>
            </div>
            <div class="keypad">
                <div class="key" onclick="Keypad.press(1)">1</div>
                <div class="key" onclick="Keypad.press(2)">2</div>
                <div class="key" onclick="Keypad.press(3)">3</div>
                <div class="key" onclick="Keypad.press(4)">4</div>
                <div class="key" onclick="Keypad.press(5)">5</div>
                <div class="key" onclick="Keypad.press(6)">6</div>
                <div class="key" onclick="Keypad.press(7)">7</div>
                <div class="key" onclick="Keypad.press(8)">8</div>
                <div class="key" onclick="Keypad.press(9)">9</div>
                <div class="key clear" onclick="Keypad.clear()">CLEAR</div>
                <div class="key" onclick="Keypad.press(0)">0</div>
                <div class="key backspace" onclick="Keypad.backspace()"><span class="material-icons-round">backspace</span></div>
            </div>
            <div class="biometric-btn" onclick="Keypad.useFingerprint()"><span class="material-icons-round">fingerprint</span> Use Fingerprint</div>
            <div style="margin-top: 20px; font-size: 12px; color: var(--text-sec);">
                Forgot PIN? <a href="#" onclick="Keypad.resetPin()" style="color: var(--primary);">Reset</a>
            </div>
        </div>
    </div>

    <!-- AUTH SCREEN -->
    <div id="auth-screen" class="screen">
        <div class="auth-card">
            <h2 style="font-family: 'Outfit'; margin-bottom: 10px; color: var(--text-main);">Welcome Back</h2>
            <p style="color: var(--text-sec); margin-bottom: 30px;">Sign in to access your Google Drive</p>
            <button class="auth-btn" onclick="Auth.signIn()">
                <img src="https://upload.wikimedia.org/wikipedia/commons/5/53/Google_%22G%22_Logo.svg" width="20">
                Sign in with Google
            </button>
            <div style="text-align: center; margin: 20px 0; color: var(--text-sec); font-size: 14px;">
                By signing in, you agree to our Terms of Service
            </div>
        </div>
    </div>

    <!-- APP SCREEN -->
    <div id="app-screen" class="screen">
        <!-- Cancel Upload Button -->
        <div class="cancel-btn" id="cancel-btn" onclick="Upload.cancel()" style="display: none;"><span class="material-icons-round">close</span></div>

        <div class="app-header">
            <span class="material-icons-round" onclick="UI.toggleSidebar()" style="cursor: pointer;">menu</span>
            <div class="search-bar">
                <span class="material-icons-round">search</span>
                <input type="text" class="search-input" placeholder="Search files..." id="search-input" onkeyup="Drive.search(this.value)">
            </div>
            <div style="display: flex; align-items: center; gap: 10px;">
                <span class="material-icons-round" onclick="Drive.refresh()" style="cursor: pointer;" title="Refresh">refresh</span>
                <img id="user-avatar" src="" style="width: 32px; height: 32px; border-radius: 50%; cursor: pointer;" onclick="UI.toggleSidebar()">
            </div>
        </div>

        <div class="toolbar">
            <div class="back-btn" id="back-btn" onclick="Drive.goBack()" style="display: none;"><span class="material-icons-round">arrow_back</span></div>
            <div class="breadcrumb" id="breadcrumb"><span class="crumb-item" onclick="Drive.load('root')">My Drive</span></div>
            <div class="toolbar-actions">
                <span class="material-icons-round" onclick="Drive.sortMenu()" style="cursor: pointer;" title="Sort">sort</span>
                <div class="view-switcher">
                    <div class="view-btn active" onclick="UI.switchView('list')" data-view="list" title="List View"><span class="material-icons-round">view_list</span></div>
                    <div class="view-btn" onclick="UI.switchView('grid')" data-view="grid" title="Grid View"><span class="material-icons-round">grid_view</span></div>
                    <div class="view-btn" onclick="UI.switchView('gallery')" data-view="gallery" title="Gallery View"><span class="material-icons-round">collections</span></div>
                </div>
            </div>
        </div>

        <!-- File Container -->
        <div id="file-container" class="file-viewer file-list-view"></div>

        <!-- FAB -->
        <div class="fab-container">
            <div class="fab-menu" id="fab-menu">
                <label class="fab-item"><span class="material-icons-round">upload_file</span> Upload File<input type="file" hidden multiple onchange="Upload.handleFiles(this.files)"></label>
                <label class="fab-item"><span class="material-icons-round">drive_folder_upload</span> Upload Folder<input type="file" hidden webkitdirectory onchange="Upload.handleFiles(this.files)"></label>
                <div class="fab-item" onclick="Ops.createFolder()"><span class="material-icons-round">create_new_folder</span> New Folder</div>
                <div class="fab-item" onclick="Ops.createDocument()"><span class="material-icons-round">description</span> New Document</div>
            </div>
            <div class="fab-main" onclick="UI.toggleFab()"><span class="material-icons-round">add</span></div>
        </div>

        <!-- Bottom Nav -->
        <div class="bottom-nav">
            <div class="nav-item-b active" onclick="Nav.switchTab('home', this)"><span class="material-icons-round">home</span> Home</div>
            <div class="nav-item-b" onclick="Nav.switchTab('photos', this)"><span class="material-icons-round">photo</span> Photos</div>
            <div class="nav-item-b" onclick="Nav.switchTab('vault', this)"><span class="material-icons-round">lock</span> Vault</div>
            <div class="nav-item-b" onclick="Nav.switchTab('shared', this)"><span class="material-icons-round">share</span> Shared</div>
            <div class="nav-item-b" onclick="Nav.switchTab('recent', this)"><span class="material-icons-round">schedule</span> Recent</div>
        </div>
    </div>

    <!-- MODALS -->
    <!-- Context Menu -->
    <div id="ctx-modal" class="modal-mask" onclick="if(event.target===this) UI.closeModal('ctx-modal')">
        <div class="modal-sheet">
            <div class="sheet-head"><span class="sheet-title" id="ctx-name">Filename</span><span class="material-icons-round" onclick="UI.closeModal('ctx-modal')">close</span></div>
            <div class="action-list">
                <div onclick="Ops.preview()"><span class="material-icons-round">visibility</span> Preview</div>
                <div onclick="Ops.download()"><span class="material-icons-round">download</span> Download</div>
                <div onclick="Ops.share()"><span class="material-icons-round">share</span> Share</div>
                <div onclick="Ops.rename()"><span class="material-icons-round">edit</span> Rename</div>
                <div onclick="Ops.info()"><span class="material-icons-round">info</span> File Info</div>
                <div onclick="Ops.delete()" style="color: #d93025;"><span class="material-icons-round">delete</span> Delete</div>
            </div>
        </div>
    </div>

    <!-- File Info Modal -->
    <div id="info-modal" class="modal-mask" onclick="if(event.target===this) UI.closeModal('info-modal')">
        <div class="modal-sheet">
            <div class="sheet-head"><span class="sheet-title">File Information</span><span class="material-icons-round" onclick="UI.closeModal('info-modal')">close</span></div>
            <div class="file-info">
                <div class="info-row"><span class="info-label">Name:</span><span class="info-value" id="info-name">-</span></div>
                <div class="info-row"><span class="info-label">Type:</span><span class="info-value" id="info-type">-</span></div>
                <div class="info-row"><span class="info-label">Size:</span><span class="info-value" id="info-size">-</span></div>
                <div class="info-row"><span class="info-label">Created:</span><span class="info-value" id="info-created">-</span></div>
                <div class="info-row"><span class="info-label">Modified:</span><span class="info-value" id="info-modified">-</span></div>
                <div class="info-row"><span class="info-label">Location:</span><span class="info-value" id="info-location">-</span></div>
                <div class="info-row"><span class="info-label">ID:</span><span class="info-value" id="info-id" style="font-size:11px;">-</span></div>
            </div>
        </div>
    </div>

    <!-- Sort Modal -->
    <div id="sort-modal" class="modal-mask" onclick="if(event.target===this) UI.closeModal('sort-modal')">
        <div class="modal-sheet">
            <div class="sheet-head"><span class="sheet-title">Sort By</span><span class="material-icons-round" onclick="UI.closeModal('sort-modal')">close</span></div>
            <div class="sort-options">
                <div class="sort-option" onclick="Drive.applySort('name', 'asc')"><span>Name (A to Z)</span><span class="material-icons-round" id="sort-name-asc" style="display:none;">check</span></div>
                <div class="sort-option" onclick="Drive.applySort('name', 'desc')"><span>Name (Z to A)</span><span class="material-icons-round" id="sort-name-desc" style="display:none;">check</span></div>
                <div class="sort-option" onclick="Drive.applySort('size', 'asc')"><span>Size (Small to Large)</span><span class="material-icons-round" id="sort-size-asc" style="display:none;">check</span></div>
                <div class="sort-option" onclick="Drive.applySort('size', 'desc')"><span>Size (Large to Small)</span><span class="material-icons-round" id="sort-size-desc" style="display:none;">check</span></div>
                <div class="sort-option" onclick="Drive.applySort('date', 'desc')"><span>Date (Newest First)</span><span class="material-icons-round" id="sort-date-desc" style="display:none;">check</span></div>
                <div class="sort-option" onclick="Drive.applySort('date', 'asc')"><span>Date (Oldest First)</span><span class="material-icons-round" id="sort-date-asc" style="display:none;">check</span></div>
            </div>
        </div>
    </div>

    <!-- Settings Modal -->
    <div id="settings-modal" class="modal-mask" onclick="if(event.target===this) UI.closeModal('settings-modal')">
        <div class="modal-sheet">
            <div class="sheet-head"><span class="sheet-title">Settings</span></div>
            <div class="action-list">
                <div style="justify-content: space-between; cursor: default;">
                    <div><div>Dark Mode</div><div class="setting-desc">Enable dark theme</div></div>
                    <label class="switch"><input type="checkbox" id="dark-mode" onchange="Settings.toggleDarkMode()"><span class="slider"></span></label>
                </div>
                <div style="justify-content: space-between; cursor: default;">
                    <div><div>External Player</div><div class="setting-desc">Open files in new tab</div></div>
                    <label class="switch"><input type="checkbox" id="ext-player" onchange="Settings.save()"><span class="slider"></span></label>
                </div>
                <div style="justify-content: space-between; cursor: default;">
                    <div><div>Auto-sync</div><div class="setting-desc">Sync files automatically</div></div>
                    <label class="switch"><input type="checkbox" id="auto-sync" onchange="Settings.save()"><span class="slider"></span></label>
                </div>
                <div onclick="Settings.storage()"><span class="material-icons-round">storage</span> Storage Management</div>
                <div onclick="Settings.security()"><span class="material-icons-round">security</span> Security & Privacy</div>
                <div onclick="Settings.about()"><span class="material-icons-round">info</span> About</div>
            </div>
        </div>
    </div>

    <!-- Progress Modal -->
    <div id="progress-modal" class="progress-box">
        <div class="progress-header"><strong id="prog-title">Uploading...</strong><span id="prog-pct">0%</span></div>
        <div class="progress-details"><div id="prog-file">Preparing...</div><div id="prog-size">0 MB / 0 MB</div></div>
        <div class="progress-bar"><div class="progress-fill" id="prog-bar"></div></div>
        <div class="progress-stats"><span id="prog-speed">Speed: 0 KB/s</span><span id="prog-time">Time: --</span></div>
        <div style="margin-top: 15px; display: flex; gap: 10px;">
            <button onclick="Upload.cancel()" style="flex:1; background:transparent; border:1px solid var(--border); color:var(--text-main); padding:8px; border-radius:var(--radius); cursor:pointer;">Cancel</button>
            <button onclick="Upload.pause()" id="pause-btn" style="flex:1; background:var(--primary); border:none; color:white; padding:8px; border-radius:var(--radius); cursor:pointer;">Pause</button>
        </div>
    </div>

    <!-- Media Viewer -->
    <div id="media-view" class="media-viewer">
        <div class="media-header"><span id="media-title">Preview</span><div style="display:flex; gap:15px;"><span class="material-icons-round" onclick="Ops.openExternal()" style="cursor:pointer;">open_in_new</span><span class="material-icons-round" onclick="UI.closeMedia()" style="cursor:pointer;">close</span></div></div>
        <iframe id="media-frame" class="media-iframe" src=""></iframe>
    </div>

    <script>
        const CONFIG = {
            clientId: '318681315152-65e9kofptt4c3bk3kmlj9gmksnasu347.apps.googleusercontent.com',
            scopes: 'https://www.googleapis.com/auth/drive https://www.googleapis.com/auth/userinfo.email',
            vaultId: '1zIyinAqjQv96QBSuanFS2F0USaG66GPn' // Your secret vault folder ID
        };

        const STATE = {
            token: localStorage.getItem('g_token'),
            currFolder: 'root',
            folderStack: [],
            files: [],
            selected: null,
            viewMode: localStorage.getItem('viewMode') || 'list',
            sortBy: localStorage.getItem('sortBy') || 'name',
            sortOrder: localStorage.getItem('sortOrder') || 'asc',
            theme: localStorage.getItem('theme') || 'light',
            settings: JSON.parse(localStorage.getItem('d_settings') || '{"extPlayer":false,"autoSync":true}'),
            uploadQueue: [],
            currentUpload: null,
            uploadCanceled: false
        };

        /* --- PIN SYSTEM (fixed) --- */
        const Keypad = {
            input: "",
            press: (num) => {
                if(Keypad.input.length < 4) {
                    Keypad.input += num;
                    Keypad.updateDots();
                    if(Keypad.input.length === 4) setTimeout(Keypad.check, 200);
                }
            },
            clear: () => { Keypad.input = ""; Keypad.updateDots(); },
            backspace: () => { if(Keypad.input.length > 0) { Keypad.input = Keypad.input.slice(0,-1); Keypad.updateDots(); } },
            updateDots: () => {
                const dots = document.querySelectorAll('#pin-dots .dot');
                dots.forEach((d,i) => d.classList.toggle('filled', i < Keypad.input.length));
            },
            check: () => {
                const stored = localStorage.getItem('app_pin');
                const hash = btoa(Keypad.input);
                if(!stored) {
                    localStorage.setItem('app_pin', hash);
                    alert("PIN set to " + Keypad.input);
                    Auth.check();
                } else if(stored === hash) {
                    Auth.check();
                } else {
                    Keypad.clear();
                    alert("Wrong PIN.");
                }
            },
            useFingerprint: () => alert("Fingerprint simulation (WebAuthn not implemented)"),
            resetPin: () => { if(confirm("Reset PIN?")) { localStorage.removeItem('app_pin'); location.reload(); } }
        };

        /* --- AUTH --- */
        let tokenClient;
        const Auth = {
            init: () => {
                tokenClient = google.accounts.oauth2.initTokenClient({
                    client_id: CONFIG.clientId, scope: CONFIG.scopes,
                    callback: (r) => {
                        if(r.error) return alert("Login failed");
                        STATE.token = r.access_token;
                        localStorage.setItem('g_token', STATE.token);
                        localStorage.setItem('g_exp', Date.now() + 3500*1000);
                        UI.switchScreen('app-screen');
                        Drive.load('root');
                        Auth.loadProfile();
                    }
                });
            },
            check: () => {
                const exp = localStorage.getItem('g_exp');
                if(STATE.token && exp && Date.now() < exp) {
                    UI.switchScreen('app-screen');
                    Drive.load('root');
                    Auth.loadProfile();
                } else UI.switchScreen('auth-screen');
            },
            signIn: () => tokenClient.requestAccessToken(),
            loadProfile: () => {
                fetch('https://www.googleapis.com/oauth2/v3/userinfo', { headers: {'Authorization': `Bearer ${STATE.token}`} })
                    .then(r=>r.json()).then(d => {
                        document.getElementById('user-avatar').src = d.picture;
                        document.getElementById('sidebar-avatar').src = d.picture;
                        document.getElementById('sidebar-name').textContent = d.name || 'User';
                        document.getElementById('sidebar-email').textContent = d.email || 'user@example.com';
                    });
            },
            logout: () => { localStorage.clear(); location.reload(); }
        };

        /* --- DRIVE CORE (with vault support) --- */
        const Drive = {
            load: async (id, name) => {
                const con = document.getElementById('file-container');
                con.innerHTML = '<div class="loading"><span class="material-icons-round">hourglass_empty</span> Loading...</div>';
                STATE.currFolder = id;
                document.getElementById('back-btn').style.display = id !== 'root' ? 'flex' : 'none';
                Drive.updateBreadcrumb(name);

                const q = `'${id}' in parents and trashed = false`;
                const fields = "files(id,name,mimeType,size,iconLink,thumbnailLink,webViewLink,webContentLink,createdTime,modifiedTime,shared)";
                const url = `https://www.googleapis.com/drive/v3/files?q=${encodeURIComponent(q)}&fields=${encodeURIComponent(fields)}&pageSize=1000`;
                try {
                    const res = await fetch(url, { headers: { 'Authorization': `Bearer ${STATE.token}` } });
                    const data = await res.json();
                    STATE.files = data.files || [];
                    Drive.applyCurrentSort();
                    Drive.render(STATE.files);
                } catch(e) { con.innerHTML = '<div class="empty-state">Failed to load</div>'; }
            },
            render: (files) => {
                const con = document.getElementById('file-container');
                con.innerHTML = "";
                if(!files.length) { con.innerHTML = '<div class="empty-state"><span class="material-icons-round empty-icon">folder_open</span>No files</div>'; return; }

                files.forEach(f => {
                    const isDir = f.mimeType === 'application/vnd.google-apps.folder';
                    const el = document.createElement('div');

                    if(STATE.viewMode === 'list') {
                        el.className = 'list-item';
                        let icon = 'insert_drive_file', iconClass = 'item-icon';
                        if(isDir) { icon='folder'; iconClass+=' folder-icon'; }
                        else if(f.mimeType.includes('image')) { icon='image'; iconClass+=' image-icon'; }
                        else if(f.mimeType.includes('video')) { icon='movie'; iconClass+=' video-icon'; }
                        else if(f.mimeType.includes('pdf')) { icon='picture_as_pdf'; iconClass+=' pdf-icon'; }

                        const size = isDir ? 'Folder' : Ops.formatSize(f.size);
                        const date = f.modifiedTime ? new Date(f.modifiedTime).toLocaleDateString() : '';
                        el.innerHTML = `<span class="material-icons-round ${iconClass}">${icon}</span><div class="item-text"><span class="item-name">${f.name}</span><span class="item-meta"><span class="item-size">${size}</span> • <span class="item-date">${date}</span></span></div><div class="file-actions"><div class="action-btn" onclick="event.stopPropagation(); Ops.menu('${f.id}')"><span class="material-icons-round">more_vert</span></div></div>`;
                        el.onclick = () => isDir ? Drive.load(f.id, f.name) : Ops.previewFile(f);
                    } else if(STATE.viewMode === 'grid') {
                        el.className = 'grid-item';
                        let icon = 'insert_drive_file', iconClass = 'item-icon';
                        if(isDir) icon='folder'; else if(f.mimeType.includes('image')) icon='image'; else if(f.mimeType.includes('video')) icon='movie'; else if(f.mimeType.includes('pdf')) icon='picture_as_pdf';
                        const size = isDir ? '' : Ops.formatSize(f.size);
                        el.innerHTML = `<span class="material-icons-round ${iconClass}">${icon}</span><div class="item-text"><span class="item-name">${f.name}</span>${size ? `<span class="item-meta">${size}</span>` : ''}</div>`;
                        el.onclick = () => isDir ? Drive.load(f.id, f.name) : Ops.previewFile(f);
                    } else if(STATE.viewMode === 'gallery' && f.mimeType.includes('image')) {
                        el.className = 'photo-item';
                        const thumb = f.thumbnailLink || `https://drive.google.com/thumbnail?id=${f.id}&sz=w300`;
                        el.innerHTML = `<img src="${thumb}" class="photo-thumb"><div class="photo-overlay">${f.name}</div>`;
                        el.onclick = () => Ops.previewFile(f);
                    }
                    if(el.innerHTML) con.appendChild(el);
                });
            },
            search: (q) => {
                if(!q.trim()) Drive.render(STATE.files);
                else Drive.render(STATE.files.filter(f => f.name.toLowerCase().includes(q.toLowerCase())));
            },
            goBack: () => Drive.load('root'),
            updateBreadcrumb: (name) => {
                const b = document.getElementById('breadcrumb');
                b.innerHTML = STATE.currFolder === 'root' ? '<span class="crumb-item" onclick="Drive.load(\'root\')">My Drive</span>' : `<span class="crumb-item" onclick="Drive.load(\'root\')">My Drive</span><span class="crumb-sep">/</span><span class="crumb-item">${name||'Folder'}</span>`;
            },
            sortMenu: () => { document.getElementById('sort-modal').style.display = 'flex'; Drive.updateSortIcons(); },
            applySort: (by, order) => {
                STATE.sortBy = by; STATE.sortOrder = order;
                localStorage.setItem('sortBy', by); localStorage.setItem('sortOrder', order);
                Drive.applyCurrentSort();
                Drive.render(STATE.files);
                UI.closeModal('sort-modal');
            },
            applyCurrentSort: () => {
                if(!STATE.files.length) return;
                STATE.files.sort((a,b) => {
                    let aVal,bVal;
                    if(STATE.sortBy === 'name') {
                        aVal = a.name.toLowerCase(); bVal = b.name.toLowerCase();
                        return STATE.sortOrder === 'asc' ? aVal.localeCompare(bVal) : bVal.localeCompare(aVal);
                    } else if(STATE.sortBy === 'size') {
                        aVal = a.size || 0; bVal = b.size || 0;
                        return STATE.sortOrder === 'asc' ? aVal - bVal : bVal - aVal;
                    } else if(STATE.sortBy === 'date') {
                        aVal = new Date(a.modifiedTime||0).getTime(); bVal = new Date(b.modifiedTime||0).getTime();
                        return STATE.sortOrder === 'asc' ? aVal - bVal : bVal - aVal;
                    }
                    return 0;
                });
            },
            updateSortIcons: () => {
                document.querySelectorAll('.sort-option .material-icons-round').forEach(i=>i.style.display='none');
                const active = document.getElementById(`sort-${STATE.sortBy}-${STATE.sortOrder}`);
                if(active) active.style.display = 'inline';
            },
            refresh: () => Drive.load(STATE.currFolder),
            sort: (by, order) => Drive.applySort(by, order)
        };

        /* --- UPLOAD with speed --- */
        const Upload = {
            handleFiles: (files) => {
                if(!files.length) return;
                UI.toggleFab();
                document.getElementById('cancel-btn').style.display = 'flex';
                STATE.uploadQueue = Array.from(files);
                Upload.processQueue();
            },
            processQueue: async () => {
                if(STATE.uploadQueue.length === 0) {
                    document.getElementById('progress-modal').style.display = 'none';
                    document.getElementById('cancel-btn').style.display = 'none';
                    Drive.refresh(); return;
                }
                const file = STATE.uploadQueue.shift();
                STATE.currentUpload = file;
                STATE.uploadCanceled = false;
                const modal = document.getElementById('progress-modal');
                const pBar = document.getElementById('prog-bar');
                const pPct = document.getElementById('prog-pct');
                const pFile = document.getElementById('prog-file');
                const pSize = document.getElementById('prog-size');
                const pSpeed = document.getElementById('prog-speed');
                const pTime = document.getElementById('prog-time');
                modal.style.display = 'block';
                pFile.textContent = file.name;
                pSize.textContent = `0 MB / ${(file.size/(1024*1024)).toFixed(2)} MB`;

                const meta = { name: file.name, mimeType: file.type, parents: [STATE.currFolder] };
                try {
                    const init = await fetch('https://www.googleapis.com/upload/drive/v3/files?uploadType=resumable', {
                        method: 'POST', headers: { 'Authorization': `Bearer ${STATE.token}`, 'Content-Type': 'application/json' },
                        body: JSON.stringify(meta)
                    });
                    const location = init.headers.get('Location');
                    await new Promise((resolve, reject) => {
                        const xhr = new XMLHttpRequest();
                        xhr.open('PUT', location, true);
                        xhr.setRequestHeader('Content-Type', file.type);
                        let startTime = Date.now(), lastLoaded = 0, lastTime = startTime, speedSamples = [];
                        xhr.upload.onprogress = (e) => {
                            if(STATE.uploadCanceled) { xhr.abort(); return; }
                            if(e.lengthComputable) {
                                const now = Date.now();
                                const elapsed = (now - startTime)/1000;
                                const timeDiff = (now - lastTime)/1000;
                                if(timeDiff >= 0.5) {
                                    const loadedDiff = e.loaded - lastLoaded;
                                    const speed = loadedDiff / timeDiff;
                                    speedSamples.push(speed);
                                    if(speedSamples.length>5) speedSamples.shift();
                                    const avgSpeed = speedSamples.reduce((a,b)=>a+b,0)/speedSamples.length;
                                    pSpeed.textContent = `Speed: ${Ops.formatSize(avgSpeed)}/s`;
                                    const remaining = e.total - e.loaded;
                                    const timeRemaining = remaining / avgSpeed;
                                    if(timeRemaining > 0 && timeRemaining < 3600) {
                                        const mins = Math.floor(timeRemaining/60);
                                        const secs = Math.floor(timeRemaining%60);
                                        pTime.textContent = `Time: ${mins}m ${secs}s`;
                                    } else pTime.textContent = 'Time: --';
                                    lastLoaded = e.loaded;
                                    lastTime = now;
                                }
                                const percent = (e.loaded/e.total)*100;
                                pBar.style.width = percent+'%';
                                pPct.textContent = Math.floor(percent)+'%';
                                pSize.textContent = `${Ops.formatSize(e.loaded)} / ${Ops.formatSize(e.total)}`;
                            }
                        };
                        xhr.onload = () => { if(xhr.status===200||xhr.status===201) resolve(); else reject(); };
                        xhr.onerror = reject;
                        xhr.send(file);
                    });
                } catch(e) { if(!STATE.uploadCanceled) alert(`Upload failed: ${file.name}`); }
                if(!STATE.uploadCanceled) setTimeout(()=>Upload.processQueue(),500);
                else { modal.style.display='none'; document.getElementById('cancel-btn').style.display='none'; }
            },
            cancel: () => { STATE.uploadCanceled = true; STATE.uploadQueue = []; document.getElementById('progress-modal').style.display='none'; document.getElementById('cancel-btn').style.display='none'; },
            pause: () => alert("Pause/resume not implemented")
        };

        /* --- OPERATIONS --- */
        const Ops = {
            menu: (id) => { STATE.selected = STATE.files.find(f=>f.id===id); document.getElementById('ctx-name').textContent = STATE.selected.name; document.getElementById('ctx-modal').style.display='flex'; },
            previewFile: (f) => { STATE.selected = f; Ops.preview(); },
            preview: () => {
                UI.closeModal('ctx-modal');
                if(STATE.settings.extPlayer) { window.open(STATE.selected.webViewLink, '_blank'); return; }
                document.getElementById('media-title').textContent = STATE.selected.name;
                document.getElementById('media-frame').src = `https://drive.google.com/file/d/${STATE.selected.id}/preview`;
                document.getElementById('media-view').style.display = 'flex';
            },
            openExternal: () => { if(STATE.selected) window.open(STATE.selected.webViewLink, '_blank'); },
            download: () => { if(STATE.selected) window.open(STATE.selected.webContentLink, '_blank'); },
            share: () => { if(STATE.selected) { navigator.clipboard.writeText(STATE.selected.webViewLink); alert("Link copied!"); } },
            rename: async () => {
                const newName = prompt("New name:", STATE.selected.name);
                if(!newName || newName===STATE.selected.name) return;
                try {
                    await fetch(`https://www.googleapis.com/drive/v3/files/${STATE.selected.id}`, {
                        method: 'PATCH', headers: { 'Authorization': `Bearer ${STATE.token}`, 'Content-Type': 'application/json' },
                        body: JSON.stringify({name: newName})
                    });
                    Drive.refresh(); alert("Renamed!");
                } catch { alert("Failed"); }
            },
            info: () => {
                const f = STATE.selected;
                document.getElementById('info-name').textContent = f.name;
                document.getElementById('info-type').textContent = f.mimeType;
                document.getElementById('info-size').textContent = Ops.formatSize(f.size);
                document.getElementById('info-created').textContent = f.createdTime ? new Date(f.createdTime).toLocaleString() : '-';
                document.getElementById('info-modified').textContent = f.modifiedTime ? new Date(f.modifiedTime).toLocaleString() : '-';
                document.getElementById('info-location').textContent = 'My Drive';
                document.getElementById('info-id').textContent = f.id;
                UI.closeModal('ctx-modal');
                document.getElementById('info-modal').style.display = 'flex';
            },
            delete: async () => {
                if(!confirm("Delete?")) return;
                try {
                    await fetch(`https://www.googleapis.com/drive/v3/files/${STATE.selected.id}`, { method: 'DELETE', headers: { 'Authorization': `Bearer ${STATE.token}` } });
                    UI.closeModal('ctx-modal'); Drive.refresh(); alert("Deleted");
                } catch { alert("Failed"); }
            },
            createFolder: async () => {
                const name = prompt("Folder name:");
                if(!name) return;
                try {
                    await fetch('https://www.googleapis.com/drive/v3/files', {
                        method: 'POST', headers: { 'Authorization': `Bearer ${STATE.token}`, 'Content-Type': 'application/json' },
                        body: JSON.stringify({ name, mimeType: 'application/vnd.google-apps.folder', parents: [STATE.currFolder] })
                    });
                    Drive.refresh(); alert("Folder created");
                } catch { alert("Failed"); }
            },
            createDocument: () => window.open('https://docs.google.com/document/create', '_blank'),
            formatSize: (bytes) => {
                if(!bytes || bytes===0) return '0 Bytes';
                const k=1024, sizes=['Bytes','KB','MB','GB','TB'];
                const i = Math.floor(Math.log(bytes)/Math.log(k));
                return parseFloat((bytes/Math.pow(k,i)).toFixed(2))+' '+sizes[i];
            }
        };

        /* --- UI CONTROLLER --- */
        const UI = {
            switchScreen: (id) => {
                document.querySelectorAll('.screen').forEach(s=>s.classList.remove('active'));
                document.getElementById(id).classList.add('active');
                if(id==='app-screen') history.pushState({screen:'app'},'','');
            },
            toggleFab: () => {
                const m = document.getElementById('fab-menu');
                m.style.display = m.style.display==='flex' ? 'none' : 'flex';
            },
            switchView: (mode) => {
                STATE.viewMode = mode;
                localStorage.setItem('viewMode', mode);
                const con = document.getElementById('file-container');
                con.className = `file-viewer file-${mode}-view`;
                document.querySelectorAll('.view-btn').forEach(btn => btn.classList.toggle('active', btn.dataset.view===mode));
                Drive.render(STATE.files);
            },
            toggleSidebar: () => document.getElementById('sidebar').classList.toggle('active'),
            closeModal: (id) => document.getElementById(id).style.display = 'none',
            closeMedia: () => { document.getElementById('media-view').style.display='none'; document.getElementById('media-frame').src=''; }
        };

        /* --- NAVIGATION (VAULT TAB) --- */
        const Nav = {
            switchTab: (tab, el) => {
                document.querySelectorAll('.nav-item-b').forEach(e=>e.classList.remove('active'));
                if(el) el.classList.add('active');
                if(tab === 'home') Drive.load('root');
                else if(tab === 'photos') {
                    const images = STATE.files.filter(f => f.mimeType && f.mimeType.includes('image'));
                    if(images.length) UI.switchView('gallery');
                    else alert("No images in current folder");
                } else if(tab === 'vault') Drive.load(CONFIG.vaultId, 'Vault');
                else if(tab === 'shared') alert("Shared files coming");
                else if(tab === 'recent') { Drive.applySort('date','desc'); Drive.render(STATE.files); }
            }
        };

        /* --- SETTINGS --- */
        const Settings = {
            open: () => {
                document.getElementById('ext-player').checked = STATE.settings.extPlayer;
                document.getElementById('auto-sync').checked = STATE.settings.autoSync;
                document.getElementById('dark-mode').checked = STATE.theme === 'dark';
                document.getElementById('settings-modal').style.display = 'flex';
            },
            save: () => {
                STATE.settings.extPlayer = document.getElementById('ext-player').checked;
                STATE.settings.autoSync = document.getElementById('auto-sync').checked;
                localStorage.setItem('d_settings', JSON.stringify(STATE.settings));
            },
            toggleDarkMode: () => {
                STATE.theme = document.getElementById('dark-mode').checked ? 'dark' : 'light';
                document.body.classList.toggle('dark-theme', STATE.theme==='dark');
                localStorage.setItem('theme', STATE.theme);
                Settings.save();
            },
            storage: () => {
                fetch('https://www.googleapis.com/drive/v3/about?fields=storageQuota', { headers: { 'Authorization': `Bearer ${STATE.token}` } })
                    .then(r=>r.json()).then(d => {
                        const used = Ops.formatSize(d.storageQuota.usage);
                        const limit = Ops.formatSize(d.storageQuota.limit);
                        alert(`Storage: ${used} of ${limit} (${((d.storageQuota.usage/d.storageQuota.limit)*100).toFixed(1)}% used)`);
                    });
            },
            security: () => alert("PIN protection enabled\nAuto-lock: 5 min"),
            about: () => alert("VAULT DRIVE NEBULA\nVersion 3.0\n© 2025")
        };

        // Initialize
        window.onload = () => {
            if(!localStorage.getItem('app_pin')) {
                const pin = prompt("Set a 4-digit PIN (e.g., 1234):");
                if(pin && /^\d{4}$/.test(pin)) localStorage.setItem('app_pin', btoa(pin));
                else localStorage.setItem('app_pin', btoa('1234'));
            }
            const savedSort = localStorage.getItem('sortBy');
            if(savedSort) { STATE.sortBy = savedSort; STATE.sortOrder = localStorage.getItem('sortOrder') || 'asc'; }
            if(STATE.theme === 'dark') document.body.classList.add('dark-theme');
            Auth.init();
            history.replaceState({screen:'lock'},'','');
        };
    </script>
</body>
</html>
