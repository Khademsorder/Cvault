<!DOCTYPE html>
<html lang="en" class="scroll-smooth">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>QUANTUM DRIVE OS | PRO</title>

    <!-- CORE LIBRARIES -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/gsap.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/dompurify/3.0.6/purify.min.js"></script>
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    
    <!-- UI LIBRARIES -->
    <link href="https://cdn.jsdelivr.net/npm/@mdi/font@7.4.47/css/materialdesignicons.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&family=Rajdhani:wght@300;500;700&display=swap" rel="stylesheet">
    
    <!-- TAILWIND CONFIG -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        quantum: {
                            primary: '#00F0FF',
                            secondary: '#FF00E5',
                            accent: '#00FF9D',
                            dark: '#050510',
                            surface: '#0F0F2A'
                        }
                    },
                    fontFamily: {
                        orbitron: ['Orbitron', 'sans-serif'],
                        rajdhani: ['Rajdhani', 'sans-serif']
                    }
                }
            }
        }
    </script>

    <style>
        /* --- ADVANCED ANIMATION CSS (Non-Browser Defaults) --- */
        :root {
            --q-gradient: linear-gradient(135deg, #00F0FF 0%, #FF00E5 50%, #00FF9D 100%);
        }

        body {
            background: #050510;
            font-family: 'Rajdhani', sans-serif;
            overflow: hidden;
        }

        /* Glitch Effect Text */
        .glitch-text {
            position: relative;
            animation: glitch-skew 1s infinite linear alternate-reverse;
        }
        .glitch-text::before, .glitch-text::after {
            content: attr(data-text);
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
        }
        .glitch-text::before {
            left: 2px;
            text-shadow: -2px 0 #FF00E5;
            clip: rect(44px, 450px, 56px, 0);
            animation: glitch-anim 5s infinite linear alternate-reverse;
        }
        .glitch-text::after {
            left: -2px;
            text-shadow: -2px 0 #00F0FF;
            clip: rect(44px, 450px, 56px, 0);
            animation: glitch-anim2 5s infinite linear alternate-reverse;
        }

        /* Holographic Card Hover */
        .holo-card {
            background: rgba(15, 15, 42, 0.6);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            position: relative;
            overflow: hidden;
        }
        .holo-card::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: conic-gradient(from 0deg, transparent, #00F0FF, transparent 30%);
            opacity: 0;
            transition: opacity 0.5s;
            animation: rotate-border 4s linear infinite;
        }
        .holo-card:hover::before { opacity: 1; }
        .holo-card:hover {
            transform: translateY(-10px) scale(1.02);
            box-shadow: 0 20px 50px rgba(0, 240, 255, 0.2);
            border-color: transparent;
        }
        .holo-card-inner {
            background: rgba(5, 5, 16, 0.9);
            height: 100%;
            width: 100%;
            position: relative;
            z-index: 1;
            border-radius: inherit;
            padding: 1.5rem;
        }

        /* Scanning Line Animation */
        .scan-line {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 2px;
            background: rgba(0, 240, 255, 0.5);
            animation: scan 3s cubic-bezier(0.45, 0.05, 0.55, 0.95) infinite;
            opacity: 0.5;
            z-index: 10;
            pointer-events: none;
        }

        /* PIN Dot Pulse */
        .pin-dot-active {
            box-shadow: 0 0 15px #00F0FF, 0 0 30px #00F0FF;
            background: #00F0FF !important;
            animation: pulse-dot 0.3s ease-out;
        }

        /* Animations Keyframes */
        @keyframes glitch-anim {
            0% { clip: rect(31px, 9999px, 94px, 0); transform: skew(0.5deg); }
            5% { clip: rect(70px, 9999px, 71px, 0); transform: skew(0.4deg); }
            10% { clip: rect(29px, 9999px, 24px, 0); transform: skew(0.5deg); }
            15% { clip: rect(69px, 9999px, 65px, 0); transform: skew(0.4deg); }
            20% { clip: rect(32px, 9999px, 95px, 0); transform: skew(0.3deg); }
            100% { clip: rect(58px, 9999px, 78px, 0); transform: skew(0.2deg); }
        }
        @keyframes glitch-anim2 {
            0% { clip: rect(65px, 9999px, 100px, 0); transform: skew(0.3deg); }
            5% { clip: rect(52px, 9999px, 74px, 0); transform: skew(0.2deg); }
            100% { clip: rect(79px, 9999px, 85px, 0); transform: skew(0.1deg); }
        }
        @keyframes glitch-skew { 0% { transform: skew(1deg); } 10% { transform: skew(-1deg); } 20% { transform: skew(0deg); } }
        @keyframes rotate-border { 100% { transform: rotate(360deg); } }
        @keyframes scan { 0% { top: 0%; } 50% { top: 100%; } 100% { top: 0%; } }
        @keyframes pulse-dot { 0% { transform: scale(1); } 50% { transform: scale(1.5); } 100% { transform: scale(1); } }

        /* Scrollbar */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: #050510; }
        ::-webkit-scrollbar-thumb { background: #00F0FF; border-radius: 3px; }
    </style>
</head>
<body class="text-white">

    <!-- 3D BACKGROUND CONTAINER -->
    <div id="bg-container" class="fixed inset-0 z-0"></div>

    <!-- OVERLAY GRADIENT -->
    <div class="fixed inset-0 bg-gradient-to-b from-transparent via-quantum-dark/50 to-quantum-dark z-10 pointer-events-none"></div>

    <!-- BOOT SEQUENCE -->
    <div id="boot-screen" class="screen active z-50 flex flex-col items-center justify-center">
        <div class="scan-line"></div>
        <div class="text-center">
            <h1 class="font-orbitron text-6xl glitch-text font-bold text-transparent bg-clip-text bg-gradient-to-r from-quantum-primary to-quantum-secondary" data-text="QUANTUM OS">
                QUANTUM OS
            </h1>
            <div class="mt-8 w-64 h-1 bg-white/10 rounded-full overflow-hidden mx-auto">
                <div id="boot-progress" class="h-full bg-quantum-primary w-0% transition-all duration-300 shadow-[0_0_15px_#00F0FF]"></div>
            </div>
            <p id="boot-status" class="font-rajdhani text-quantum-primary mt-4 tracking-widest uppercase">Initializing Core...</p>
        </div>
    </div>

    <!-- LOCK SCREEN -->
    <div id="lock-screen" class="screen z-40 flex items-center justify-center p-4">
        <div class="holo-card rounded-3xl w-full max-w-sm">
            <div class="holo-card-inner rounded-3xl flex flex-col items-center justify-center">
                <i class="mdi mdi-fingerprint text-6xl text-quantum-primary drop-shadow-[0_0_10px_rgba(0,240,255,0.5)]"></i>
                <h2 class="font-orbitron text-2xl mt-6 mb-2">SECURE ACCESS</h2>
                <p class="text-white/60 mb-8">Enter Quantum PIN</p>
                
                <div class="flex gap-4 mb-8" id="pin-dots">
                    <div class="w-4 h-4 rounded-full border-2 border-quantum-primary transition-all duration-200"></div>
                    <div class="w-4 h-4 rounded-full border-2 border-quantum-primary transition-all duration-200"></div>
                    <div class="w-4 h-4 rounded-full border-2 border-quantum-primary transition-all duration-200"></div>
                    <div class="w-4 h-4 rounded-full border-2 border-quantum-primary transition-all duration-200"></div>
                </div>

                <div class="grid grid-cols-3 gap-3 w-full">
                    <button onclick="QuantumOS.inputPin('1')" class="keypad-btn">1</button>
                    <button onclick="QuantumOS.inputPin('2')" class="keypad-btn">2</button>
                    <button onclick="QuantumOS.inputPin('3')" class="keypad-btn">3</button>
                    <button onclick="QuantumOS.inputPin('4')" class="keypad-btn">4</button>
                    <button onclick="QuantumOS.inputPin('5')" class="keypad-btn">5</button>
                    <button onclick="QuantumOS.inputPin('6')" class="keypad-btn">6</button>
                    <button onclick="QuantumOS.inputPin('7')" class="keypad-btn">7</button>
                    <button onclick="QuantumOS.inputPin('8')" class="keypad-btn">8</button>
                    <button onclick="QuantumOS.inputPin('9')" class="keypad-btn">9</button>
                    <button onclick="QuantumOS.clearPin()" class="keypad-btn text-quantum-secondary">C</button>
                    <button onclick="QuantumOS.inputPin('0')" class="keypad-btn">0</button>
                    <button onclick="QuantumOS.biometric()" class="keypad-btn text-quantum-accent"><i class="mdi mdi-face-recognition"></i></button>
                </div>
            </div>
        </div>
    </div>

    <!-- AUTH SCREEN -->
    <div id="auth-screen" class="screen z-40 flex items-center justify-center p-4">
        <div class="holo-card rounded-3xl w-full max-w-md p-8 text-center relative overflow-hidden">
            <div class="scan-line delay-1000"></div>
            <div class="relative z-10">
                <div class="w-24 h-24 mx-auto bg-quantum-dark rounded-full flex items-center justify-center border border-quantum-primary mb-6 shadow-[0_0_30px_rgba(0,240,255,0.2)]">
                    <i class="mdi mdi-cloud-outline text-5xl text-quantum-primary"></i>
                </div>
                <h1 class="font-orbitron text-4xl font-bold text-white mb-2">DRIVE OS</h1>
                <p class="text-white/60 mb-8">Quantum Encrypted Storage</p>
                
                <button onclick="QuantumOS.googleSignIn()" class="w-full py-4 rounded-xl bg-white text-black font-bold hover:bg-quantum-primary transition-all duration-300 flex items-center justify-center gap-3 group">
                    <i class="mdi mdi-google text-2xl group-hover:rotate-12 transition-transform"></i>
                    Authenticate with Google
                </button>

                <div class="flex justify-center gap-6 mt-8 text-xs text-white/50">
                    <span><i class="mdi mdi-shield-check text-quantum-accent mr-1"></i> 256-bit AES</span>
                    <span><i class="mdi mdi-nas text-quantum-secondary mr-1"></i> Decentralized</span>
                </div>
            </div>
        </div>
    </div>

    <!-- MAIN DASHBOARD -->
    <div id="app-screen" class="screen z-30 h-screen overflow-hidden flex flex-col">
        <!-- Top Navigation -->
        <header class="h-20 border-b border-white/5 flex items-center px-6 backdrop-blur-xl bg-quantum-dark/30 relative z-20">
            <button onclick="QuantumUI.toggleSidebar()" class="p-2 hover:bg-white/5 rounded-lg transition-colors">
                <i class="mdi mdi-menu text-2xl"></i>
            </button>
            <div class="flex-1 px-8">
                <div class="relative w-full max-w-lg mx-auto">
                    <input type="text" placeholder="Search quantum files..." class="w-full bg-white/5 border border-white/10 rounded-full py-3 px-6 focus:outline-none focus:border-quantum-primary transition-colors">
                    <i class="mdi mdi-magnify absolute right-5 top-1/2 -translate-y-1/2 text-white/50"></i>
                </div>
            </div>
            <div class="flex items-center gap-4">
                <div id="upload-indicator" class="hidden items-center gap-2 px-4 py-2 bg-quantum-primary/20 rounded-full text-quantum-primary text-sm font-bold animate-pulse">
                    <i class="mdi mdi-cloud-upload"></i> <span id="upload-count">0</span>
                </div>
                <button class="p-2 hover:bg-white/5 rounded-full"><i class="mdi mdi-bell-outline text-xl"></i></button>
                <div id="user-avatar-nav" class="w-10 h-10 rounded-full bg-quantum-secondary flex items-center justify-center font-bold cursor-pointer">?</div>
            </div>
        </header>

        <div class="flex flex-1 overflow-hidden relative">
            <!-- Sidebar -->
            <aside id="sidebar" class="w-72 bg-quantum-dark/50 backdrop-blur-lg border-r border-white/5 absolute md:relative h-full -translate-x-full md:translate-x-0 transition-transform duration-300 z-30 flex flex-col">
                <div class="p-6 flex-1">
                    <div class="flex items-center gap-4 mb-8">
                        <div id="user-avatar-side" class="w-16 h-16 rounded-full bg-gradient-to-tr from-quantum-primary to-quantum-secondary p-[2px]">
                            <div class="w-full h-full rounded-full bg-quantum-dark flex items-center justify-center text-2xl font-bold overflow-hidden">
                                <span id="user-initial">U</span>
                            </div>
                        </div>
                        <div>
                            <h3 id="user-name" class="font-bold">User</h3>
                            <p id="user-email" class="text-xs text-white/50">Loading...</p>
                        </div>
                    </div>

                    <nav class="space-y-2">
                        <a href="#" onclick="QuantumUI.setView('dashboard')" class="flex items-center gap-3 p-3 rounded-xl hover:bg-white/5 text-quantum-primary bg-quantum-primary/10 border border-quantum-primary/20">
                            <i class="mdi mdi-view-dashboard"></i> Dashboard
                        </a>
                        <a href="#" onclick="QuantumDrive.loadFiles()" class="flex items-center gap-3 p-3 rounded-xl hover:bg-white/5 text-white/70 hover:text-white transition-colors">
                            <i class="mdi mdi-folder"></i> My Drive
                        </a>
                        <a href="#" class="flex items-center gap-3 p-3 rounded-xl hover:bg-white/5 text-white/70 hover:text-white transition-colors">
                            <i class="mdi mdi-share-variant"></i> Shared
                        </a>
                        <a href="#" class="flex items-center gap-3 p-3 rounded-xl hover:bg-white/5 text-white/70 hover:text-white transition-colors">
                            <i class="mdi mdi-star"></i> Starred
                        </a>
                        <a href="#" class="flex items-center gap-3 p-3 rounded-xl hover:bg-white/5 text-white/70 hover:text-white transition-colors">
                            <i class="mdi mdi-history"></i> Recent
                        </a>
                    </nav>
                </div>
                
                <div class="p-6 border-t border-white/5">
                     <div class="mb-2 flex justify-between text-sm">
                         <span class="text-white/50">Storage</span>
                         <span id="storage-used" class="text-quantum-accent font-bold">0 GB</span>
                     </div>
                     <div class="w-full h-2 bg-white/5 rounded-full overflow-hidden">
                         <div id="storage-bar" class="h-full bg-gradient-to-r from-quantum-primary to-quantum-accent w-0 transition-all duration-1000"></div>
                     </div>
                     <button onclick="QuantumOS.logout()" class="w-full mt-6 py-2 border border-red-500/30 text-red-400 rounded-lg hover:bg-red-500/10 transition-colors text-sm font-bold">
                         <i class="mdi mdi-logout mr-2"></i> Disconnect
                     </button>
                </div>
            </aside>

            <!-- Main Content -->
            <main class="flex-1 overflow-y-auto p-6 relative">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="font-orbitron text-2xl tracking-wide">My Drive</h2>
                    <div class="flex gap-2">
                         <button onclick="QuantumUI.toggleView()" class="p-2 bg-white/5 rounded-lg hover:bg-white/10">
                             <i id="view-icon" class="mdi mdi-view-grid text-xl"></i>
                         </button>
                    </div>
                </div>

                <!-- File Grid -->
                <div id="files-grid" class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 xl:grid-cols-5 gap-6">
                    <!-- Files injected here -->
                </div>
                
                <!-- Empty State -->
                <div id="empty-state" class="hidden flex-col items-center justify-center h-96 text-center opacity-50">
                    <i class="mdi mdi-cloud-off-outline text-6xl text-quantum-primary mb-4"></i>
                    <h3 class="font-orbitron text-xl">No Files Found</h3>
                    <p class="text-sm mt-2">Upload files or sync your drive.</p>
                </div>
            </main>
        </div>
        
        <!-- FAB -->
        <button onclick="QuantumUI.toggleFAB()" class="fixed bottom-8 right-8 w-16 h-16 bg-quantum-primary rounded-2xl shadow-[0_0_30px_rgba(0,240,255,0.4)] flex items-center justify-center text-quantum-dark text-3xl hover:scale-110 transition-transform z-50">
            <i class="mdi mdi-plus font-bold"></i>
        </button>
        
        <!-- FAB Menu -->
        <div id="fab-menu" class="fixed bottom-28 right-8 bg-quantum-surface border border-white/10 rounded-2xl p-4 shadow-2xl z-50 hidden flex-col gap-2 animate-bounce-in">
            <button onclick="QuantumDrive.createFolder()" class="flex items-center gap-3 px-4 py-2 hover:bg-white/5 rounded-lg text-left w-full">
                <i class="mdi mdi-folder-plus text-quantum-accent"></i> New Folder
            </button>
            <button onclick="document.getElementById('file-input').click()" class="flex items-center gap-3 px-4 py-2 hover:bg-white/5 rounded-lg text-left w-full">
                <i class="mdi mdi-file-upload text-quantum-primary"></i> Upload File
            </button>
            <input type="file" id="file-input" class="hidden" multiple onchange="QuantumDrive.handleUpload(this.files)">
        </div>
    </div>

    <!-- TOAST CONTAINER -->
    <div id="toast-container" class="fixed top-24 right-8 z-[100] space-y-3 pointer-events-none"></div>

    <script>
        // ==========================================
        // QUANTUM DRIVE OS - PROFESSIONAL EDITION
        // ==========================================

        // CONFIGURATION
        const CONFIG = {
            clientId: '318681315152-65e9kofptt4c3bk3kmlj9gmksnasu347.apps.googleusercontent.com',
            scopes: 'https://www.googleapis.com/auth/drive https://www.googleapis.com/auth/userinfo.profile https://www.googleapis.com/auth/userinfo.email',
            defaultPin: '1234' // Default PIN for demo
        };

        // UTILITIES
        const $ = (id) => document.getElementById(id);
        const createEl = (tag, cls) => { const el = document.createElement(tag); el.className = cls; return el; };

        // SANITIZER (XSS Protection)
        const sanitize = (str) => DOMPurify.sanitize(str, { ALLOWED_TAGS: [], ALLOWED_ATTR: [] });

        // STATE
        const STATE = {
            token: localStorage.getItem('q_token'),
            user: JSON.parse(localStorage.getItem('q_user') || 'null'),
            pin: '',
            files: [],
            view: 'grid'
        };

        // ==========================================
        // ANIMATION & VISUALS
        // ==========================================
        class QuantumBackground {
            constructor() {
                this.scene = new THREE.Scene();
                this.camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
                this.renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
                this.particles = null;
                this.init();
            }

            init() {
                this.renderer.setSize(window.innerWidth, window.innerHeight);
                this.renderer.setPixelRatio(window.devicePixelRatio);
                $('bg-container').appendChild(this.renderer.domElement);

                // Create Particles
                const geometry = new THREE.BufferGeometry();
                const count = 3000;
                const positions = new Float32Array(count * 3);
                const colors = new Float32Array(count * 3);
                
                const colorPrimary = new THREE.Color(0x00F0FF);
                const colorSecondary = new THREE.Color(0xFF00E5);

                for(let i = 0; i < count * 3; i += 3) {
                    positions[i] = (Math.random() - 0.5) * 10;
                    positions[i+1] = (Math.random() - 0.5) * 10;
                    positions[i+2] = (Math.random() - 0.5) * 10;
                    
                    const mixedColor = Math.random() > 0.5 ? colorPrimary : colorSecondary;
                    colors[i] = mixedColor.r;
                    colors[i+1] = mixedColor.g;
                    colors[i+2] = mixedColor.b;
                }

                geometry.setAttribute('position', new THREE.BufferAttribute(positions, 3));
                geometry.setAttribute('color', new THREE.BufferAttribute(colors, 3));

                const material = new THREE.PointsMaterial({
                    size: 0.02,
                    vertexColors: true,
                    transparent: true,
                    opacity: 0.8,
                    blending: THREE.AdditiveBlending
                });

                this.particles = new THREE.Points(geometry, material);
                this.scene.add(this.particles);
                this.camera.position.z = 3;

                window.addEventListener('resize', () => {
                    this.camera.aspect = window.innerWidth / window.innerHeight;
                    this.camera.updateProjectionMatrix();
                    this.renderer.setSize(window.innerWidth, window.innerHeight);
                });

                this.animate();
            }

            animate() {
                requestAnimationFrame(() => this.animate());
                const time = Date.now() * 0.0005;
                this.particles.rotation.x = time * 0.1;
                this.particles.rotation.y = time * 0.2;
                this.renderer.render(this.scene, this.camera);
            }
        }

        // ==========================================
        // UI CONTROLLER
        // ==========================================
        const QuantumUI = {
            sidebarOpen: false,
            fabOpen: false,

            showScreen(id) {
                document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
                gsap.to(`#${id}`, { opacity: 1, display: 'flex', duration: 0.5, ease: 'power2.out' });
                $(id).classList.add('active');
            },

            toggleSidebar() {
                this.sidebarOpen = !this.sidebarOpen;
                const sidebar = $('sidebar');
                if(this.sidebarOpen) {
                    gsap.to(sidebar, { x: '0%', duration: 0.3, ease: 'power2.out' });
                } else {
                    gsap.to(sidebar, { x: '-100%', duration: 0.3, ease: 'power2.in' });
                }
            },

            toggleFAB() {
                this.fabOpen = !this.fabOpen;
                const menu = $('fab-menu');
                if(this.fabOpen) {
                    menu.classList.remove('hidden');
                    menu.classList.add('flex');
                    gsap.from(menu, { opacity: 0, y: 20, duration: 0.3 });
                } else {
                    gsap.to(menu, { opacity: 0, y: 20, duration: 0.2, onComplete: () => {
                        menu.classList.add('hidden');
                        menu.classList.remove('flex');
                    }});
                }
            },

            toast(message, type = 'info') {
                const container = $('toast-container');
                const colors = { 
                    info: 'bg-blue-500/80 border-blue-400', 
                    success: 'bg-quantum-accent/20 border-quantum-accent text-quantum-accent', 
                    error: 'bg-red-500/20 border-red-400 text-red-400' 
                };
                const el = createEl('div', `p-4 rounded-xl border backdrop-blur-lg pointer-events-auto ${colors[type]}`);
                el.innerHTML = `<i class="mdi mdi-${type === 'success' ? 'check-circle' : type === 'error' ? 'alert-circle' : 'information'} mr-2"></i> ${sanitize(message)}`;
                container.appendChild(el);
                gsap.from(el, { x: 100, opacity: 0, duration: 0.4, ease: 'back.out' });
                setTimeout(() => gsap.to(el, { x: 100, opacity: 0, duration: 0.3, onComplete: () => el.remove() }), 3000);
            },

            updateProfile(user) {
                $('user-name').textContent = sanitize(user.name);
                $('user-email').textContent = sanitize(user.email);
                $('user-initial').textContent = user.name.charAt(0);
                if(user.picture) {
                    $('user-avatar-nav').innerHTML = `<img src="${sanitize(user.picture)}" class="w-full h-full rounded-full object-cover">`;
                    $('user-avatar-side').innerHTML = `<img src="${sanitize(user.picture)}" class="w-full h-full rounded-full object-cover">`;
                }
            }
        };

        // ==========================================
        // AUTH CONTROLLER
        // ==========================================
        const QuantumOS = {
            tokenClient: null,

            init() {
                // Init Google Identity Services
                if (typeof google !== 'undefined') {
                    this.tokenClient = google.accounts.oauth2.initTokenClient({
                        client_id: CONFIG.clientId,
                        scope: CONFIG.scopes,
                        callback: (response) => {
                            if (response.error) return QuantumUI.toast('Auth Failed', 'error');
                            this.handleAuth(response.access_token);
                        }
                    });
                }
            },

            handleAuth(token) {
                STATE.token = token;
                localStorage.setItem('q_token', token);
                this.fetchUser();
            },

            async fetchUser() {
                try {
                    const res = await fetch('https://www.googleapis.com/oauth2/v3/userinfo', {
                        headers: { Authorization: `Bearer ${STATE.token}` }
                    });
                    STATE.user = await res.json();
                    localStorage.setItem('q_user', JSON.stringify(STATE.user));
                    QuantumUI.updateProfile(STATE.user);
                    QuantumUI.showScreen('app-screen');
                    QuantumDrive.init();
                    QuantumUI.toast('Quantum Link Established', 'success');
                } catch (e) {
                    QuantumUI.toast('Connection Failed', 'error');
                }
            },

            inputPin(num) {
                if (STATE.pin.length < 4) {
                    STATE.pin += num;
                    this.updatePinDots();
                    if (STATE.pin.length === 4) setTimeout(() => this.verifyPin(), 300);
                }
            },

            clearPin() {
                STATE.pin = '';
                this.updatePinDots();
            },

            updatePinDots() {
                const dots = $('pin-dots').children;
                for(let i = 0; i < 4; i++) {
                    if(i < STATE.pin.length) dots[i].classList.add('pin-dot-active');
                    else dots[i].classList.remove('pin-dot-active');
                }
            },

            verifyPin() {
                // In production, this should be a hash check or server validation
                const stored = localStorage.getItem('q_pin');
                if (!stored || atob(stored) === STATE.pin) {
                    if(!stored) localStorage.setItem('q_pin', btoa(CONFIG.defaultPin)); // Set default for first time
                    gsap.to('#lock-screen', { scale: 0.9, opacity: 0, duration: 0.3, onComplete: () => {
                        QuantumUI.showScreen('auth-screen');
                    }});
                } else {
                    QuantumUI.toast('Access Denied', 'error');
                    this.clearPin();
                    // Shake animation
                    gsap.fromTo('#lock-screen .holo-card', {x: -10}, {x: 10, duration: 0.1, repeat: 5, yoyo: true, clearProps: 'x'});
                }
            },

            biometric() {
                QuantumUI.toast('Biometrics not supported on web', 'info');
            },

            googleSignIn() {
                if (this.tokenClient) this.tokenClient.requestAccessToken();
                else QuantumUI.toast('Google Services Unavailable', 'error');
            },

            logout() {
                localStorage.clear();
                location.reload();
            }
        };

        // ==========================================
        // DRIVE CONTROLLER
        // ==========================================
        const QuantumDrive = {
            async init() {
                await this.loadFiles();
                await this.getStorageInfo();
            },

            async loadFiles() {
                $('files-grid').innerHTML = '<div class="col-span-full text-center opacity-50"><i class="mdi mdi-loader mdi-spin text-4xl"></i></div>';
                try {
                    const res = await fetch(`https://www.googleapis.com/drive/v3/files?orderBy=modifiedTime desc&pageSize=50&fields=files(id,name,mimeType,size,thumbnailLink,modifiedTime)&q='root' in parents and trashed=false`, {
                        headers: { Authorization: `Bearer ${STATE.token}` }
                    });
                    const data = await res.json();
                    STATE.files = data.files || [];
                    this.renderFiles();
                } catch (e) {
                    QuantumUI.toast('Failed to sync drive', 'error');
                }
            },

            renderFiles() {
                const grid = $('files-grid');
                grid.innerHTML = '';
                if(STATE.files.length === 0) {
                    $('empty-state').classList.remove('hidden');
                    $('empty-state').classList.add('flex');
                    return;
                }
                
                $('empty-state').classList.add('hidden');
                STATE.files.forEach(f => {
                    const isFolder = f.mimeType === 'application/vnd.google-apps.folder';
                    const icon = this.getIcon(f.mimeType);
                    
                    const card = document.createElement('div');
                    card.className = 'holo-card rounded-2xl group cursor-pointer';
                    card.onclick = () => this.openFile(f);
                    
                    card.innerHTML = `
                        <div class="holo-card-inner rounded-2xl flex flex-col justify-between h-full">
                            <div class="h-24 flex items-center justify-center border-b border-white/10">
                                <i class="mdi ${icon} text-4xl ${isFolder ? 'text-quantum-secondary' : 'text-quantum-primary'} group-hover:scale-110 transition-transform duration-300"></i>
                            </div>
                            <div class="pt-2">
                                <h4 class="font-bold truncate text-sm" title="${sanitize(f.name)}">${sanitize(f.name)}</h4>
                                <p class="text-xs text-white/50 mt-1">${isFolder ? 'Folder' : this.formatSize(f.size)}</p>
                            </div>
                        </div>
                    `;
                    grid.appendChild(card);
                });
            },

            getIcon(mime) {
                if (mime.includes('folder')) return 'mdi-folder';
                if (mime.includes('image')) return 'mdi-image';
                if (mime.includes('pdf')) return 'mdi-file-pdf-box';
                if (mime.includes('video')) return 'mdi-video';
                if (mime.includes('audio')) return 'mdi-music';
                return 'mdi-file-outline';
            },

            formatSize(bytes) {
                if(!bytes) return '? KB';
                const i = Math.floor(Math.log(bytes) / Math.log(1024));
                return (bytes / Math.pow(1024, i)).toFixed(1) + ' ' + ['B', 'KB', 'MB', 'GB'][i];
            },

            openFile(f) {
                QuantumUI.toast(`Opening ${sanitize(f.name)}...`, 'info');
                window.open(`https://drive.google.com/file/d/${f.id}/view`, '_blank');
            },

            async getStorageInfo() {
                try {
                    const res = await fetch('https://www.googleapis.com/drive/v3/about?fields=storageQuota', {
                        headers: { Authorization: `Bearer ${STATE.token}` }
                    });
                    const data = await res.json();
                    const used = parseInt(data.storageQuota.usage);
                    const limit = parseInt(data.storageQuota.limit) || 15000000000;
                    const percent = (used / limit) * 100;
                    
                    $('storage-used').textContent = this.formatSize(used);
                    $('storage-bar').style.width = `${percent}%`;
                } catch(e) {}
            },

            createFolder() {
                const name = prompt('New Folder Name:');
                if(!name) return;
                
                fetch('https://www.googleapis.com/drive/v3/files', {
                    method: 'POST',
                    headers: { 
                        Authorization: `Bearer ${STATE.token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        name: name,
                        mimeType: 'application/vnd.google-apps.folder'
                    })
                }).then(() => {
                    QuantumUI.toast('Folder Created', 'success');
                    this.loadFiles();
                });
            },

            handleUpload(files) {
                QuantumUI.toast('Upload simulation started', 'info');
                $('upload-indicator').classList.remove('hidden');
                $('upload-indicator').classList.add('flex');
                
                // Note: Actual Drive upload requires multipart upload logic which is complex.
                // This simulates the UI feedback.
                let count = 0;
                const interval = setInterval(() => {
                    count++;
                    $('upload-count').textContent = count;
                    if(count >= files.length) {
                        clearInterval(interval);
                        setTimeout(() => {
                            $('upload-indicator').classList.add('hidden');
                            $('upload-indicator').classList.remove('flex');
                            QuantumUI.toast('Upload Complete', 'success');
                        }, 1000);
                    }
                }, 500);
            }
        };

        // ==========================================
        // INITIALIZATION
        // ==========================================
        window.onload = () => {
            // Initialize 3D Background
            new QuantumBackground();
            
            // Initialize Auth Client
            QuantumOS.init();

            // Boot Sequence Animation
            const bootProgress = $('boot-progress');
            const bootStatus = $('boot-status');
            const steps = ['Checking Quantum State...', 'Injecting AI Core...', 'Securing Connection...', 'System Ready'];
            
            gsap.to(bootProgress, { width: '100%', duration: 2, ease: 'power1.inOut', onUpdate: function() {
                const p = Math.round(this.progress() * 100);
                bootStatus.textContent = steps[Math.floor(p / 30)];
            }});

            setTimeout(() => {
                gsap.to('#boot-screen', { 
                    opacity: 0, 
                    scale: 0.8, 
                    duration: 0.5, 
                    onComplete: () => {
                        $('boot-screen').classList.remove('active');
                        
                        // Check if PIN is set
                        if(localStorage.getItem('q_pin')) {
                            QuantumUI.showScreen('lock-screen');
                        } else {
                            QuantumUI.showScreen('auth-screen');
                        }
                    }
                });
            }, 2500);
        };
    </script>
</body>
</html>
