<!DOCTYPE html>
<html lang="en" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Drive OS | Ultra</title>
    
    <!-- Google Identity -->
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    
    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@300;400;500;600;700&family=Outfit:wght@300;400;500;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons+Round" rel="stylesheet">

    <!-- Tailwind CSS (Play CDN for standalone usage) -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Outfit', 'sans-serif'],
                        mono: ['Space Grotesk', 'monospace'],
                    },
                    colors: {
                        glass: {
                            100: 'rgba(255, 255, 255, 0.05)',
                            200: 'rgba(255, 255, 255, 0.1)',
                            300: 'rgba(255, 255, 255, 0.2)',
                            border: 'rgba(255, 255, 255, 0.15)',
                        },
                        neon: {
                            blue: '#00f3ff',
                            purple: '#bd00ff',
                            green: '#00ff9d'
                        }
                    },
                    animation: {
                        'pulse-slow': 'pulse 4s cubic-bezier(0.4, 0, 0.6, 1) infinite',
                    }
                }
            }
        }
    </script>

    <!-- GSAP for Extreme Animations -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/gsap.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/Flip.min.js"></script>

    <style>
        /* --- CORE VISUALS --- */
        body {
            background-color: #050505;
            color: #ffffff;
            overflow: hidden;
        }

        /* The "Heavy" Glass Effect */
        .ultra-glass {
            background: rgba(18, 18, 24, 0.65);
            backdrop-filter: blur(24px) saturate(180%);
            -webkit-backdrop-filter: blur(24px) saturate(180%);
            border: 1px solid rgba(255, 255, 255, 0.08);
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
        }

        .card-glass {
            background: linear-gradient(145deg, rgba(255,255,255,0.05) 0%, rgba(255,255,255,0.01) 100%);
            border: 1px solid rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(10px);
            transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
        }

        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.2); border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: rgba(255,255,255,0.4); }

        /* 3D Perspective Container */
        .perspective-container {
            perspective: 1000px;
        }
        
        /* Neon Glows */
        .glow-text { text-shadow: 0 0 20px rgba(0, 243, 255, 0.5); }
        .glow-box:hover { box-shadow: 0 0 30px rgba(0, 243, 255, 0.2), inset 0 0 20px rgba(0, 243, 255, 0.05); border-color: rgba(0, 243, 255, 0.4); }

        /* Canvas Background */
        #bg-canvas {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            z-index: -1; opacity: 0.6; pointer-events: none;
        }

        /* Loaders */
        .loader-ring {
            width: 40px; height: 40px; border-radius: 50%;
            border: 2px solid transparent; border-top-color: #00f3ff;
            animation: spin 1s linear infinite;
        }
        .loader-ring::before {
            content: ''; position: absolute; top: 2px; left: 2px; right: 2px; bottom: 2px;
            border-radius: 50%; border: 2px solid transparent; border-top-color: #bd00ff;
            animation: spin 2s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body class="antialiased selection:bg-neon-blue selection:text-black">

    <!-- Interactive Background -->
    <canvas id="bg-canvas"></canvas>

    <!-- [SCREEN 1] LOCK UI -->
    <div id="lock-screen" class="fixed inset-0 z-50 flex items-center justify-center p-4">
        <div class="relative w-full max-w-md perspective-container">
            <div class="ultra-glass rounded-3xl p-8 transform transition-transform duration-500 hover:scale-[1.02]">
                <div class="text-center mb-8">
                    <div class="inline-flex items-center justify-center w-16 h-16 rounded-2xl bg-gradient-to-br from-neon-blue to-neon-purple mb-4 shadow-lg shadow-neon-blue/20">
                        <span class="material-icons-round text-3xl text-white">lock</span>
                    </div>
                    <h1 class="text-3xl font-bold font-mono tracking-tight text-white mb-2">DRIVE OS <span class="text-neon-blue">ULTRA</span></h1>
                    <p class="text-gray-400 text-sm">Identity Verification Required</p>
                </div>

                <div class="flex justify-center gap-4 mb-8" id="pin-dots">
                    <div class="w-4 h-4 rounded-full border-2 border-white/20 transition-all duration-300"></div>
                    <div class="w-4 h-4 rounded-full border-2 border-white/20 transition-all duration-300"></div>
                    <div class="w-4 h-4 rounded-full border-2 border-white/20 transition-all duration-300"></div>
                    <div class="w-4 h-4 rounded-full border-2 border-white/20 transition-all duration-300"></div>
                </div>

                <div class="grid grid-cols-3 gap-4 px-4 font-mono">
                    <button class="h-16 rounded-2xl bg-white/5 hover:bg-white/10 active:bg-neon-blue/20 border border-white/5 text-xl font-medium transition-all" onclick="Keypad.press(1)">1</button>
                    <button class="h-16 rounded-2xl bg-white/5 hover:bg-white/10 active:bg-neon-blue/20 border border-white/5 text-xl font-medium transition-all" onclick="Keypad.press(2)">2</button>
                    <button class="h-16 rounded-2xl bg-white/5 hover:bg-white/10 active:bg-neon-blue/20 border border-white/5 text-xl font-medium transition-all" onclick="Keypad.press(3)">3</button>
                    <button class="h-16 rounded-2xl bg-white/5 hover:bg-white/10 active:bg-neon-blue/20 border border-white/5 text-xl font-medium transition-all" onclick="Keypad.press(4)">4</button>
                    <button class="h-16 rounded-2xl bg-white/5 hover:bg-white/10 active:bg-neon-blue/20 border border-white/5 text-xl font-medium transition-all" onclick="Keypad.press(5)">5</button>
                    <button class="h-16 rounded-2xl bg-white/5 hover:bg-white/10 active:bg-neon-blue/20 border border-white/5 text-xl font-medium transition-all" onclick="Keypad.press(6)">6</button>
                    <button class="h-16 rounded-2xl bg-white/5 hover:bg-white/10 active:bg-neon-blue/20 border border-white/5 text-xl font-medium transition-all" onclick="Keypad.press(7)">7</button>
                    <button class="h-16 rounded-2xl bg-white/5 hover:bg-white/10 active:bg-neon-blue/20 border border-white/5 text-xl font-medium transition-all" onclick="Keypad.press(8)">8</button>
                    <button class="h-16 rounded-2xl bg-white/5 hover:bg-white/10 active:bg-neon-blue/20 border border-white/5 text-xl font-medium transition-all" onclick="Keypad.press(9)">9</button>
                    <button class="h-16 flex items-center justify-center text-red-400 hover:text-red-300" onclick="Keypad.clear()">CLR</button>
                    <button class="h-16 rounded-2xl bg-white/5 hover:bg-white/10 active:bg-neon-blue/20 border border-white/5 text-xl font-medium transition-all" onclick="Keypad.press(0)">0</button>
                    <button class="h-16 flex items-center justify-center text-neon-blue hover:text-white" onclick="Keypad.backspace()">
                        <span class="material-icons-round">backspace</span>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- [SCREEN 2] AUTH UI -->
    <div id="auth-screen" class="hidden fixed inset-0 z-40 flex items-center justify-center">
        <div class="ultra-glass p-10 rounded-3xl text-center max-w-sm w-full mx-4 border border-neon-purple/30 glow-box">
            <h2 class="text-3xl font-bold mb-2">Connect</h2>
            <p class="text-gray-400 mb-8 text-sm">Initialize secure connection to Google Cloud</p>
            <button onclick="Auth.signIn()" class="w-full py-4 rounded-xl bg-white text-black font-bold flex items-center justify-center gap-3 hover:scale-105 transition-transform duration-200 shadow-[0_0_20px_rgba(255,255,255,0.3)]">
                <img src="https://upload.wikimedia.org/wikipedia/commons/5/53/Google_%22G%22_Logo.svg" width="20">
                <span>Sign in with Google</span>
            </button>
        </div>
    </div>

    <!-- [SCREEN 3] MAIN APP INTERFACE -->
    <div id="app-screen" class="hidden fixed inset-0 flex overflow-hidden">
        
        <!-- SIDEBAR -->
        <aside id="sidebar" class="w-72 h-full ultra-glass border-r border-glass-border transform -translate-x-full md:translate-x-0 transition-transform duration-500 absolute md:relative z-30 flex flex-col">
            <div class="p-6 border-b border-glass-border flex justify-between items-center">
                <div class="flex items-center gap-3">
                    <div class="w-8 h-8 rounded bg-gradient-to-tr from-neon-blue to-neon-purple"></div>
                    <span class="font-mono font-bold text-lg tracking-wider">DRIVE_OS</span>
                </div>
                <button class="md:hidden text-gray-400" onclick="UI.toggleSidebar()"><span class="material-icons-round">close</span></button>
            </div>

            <div class="p-6">
                <div class="bg-white/5 rounded-2xl p-4 border border-white/10 flex items-center gap-3 mb-6">
                    <img id="sidebar-avatar" src="" class="w-10 h-10 rounded-full ring-2 ring-neon-blue/50">
                    <div class="overflow-hidden">
                        <h3 id="sidebar-name" class="font-bold text-sm truncate">User</h3>
                        <p id="sidebar-email" class="text-xs text-gray-400 truncate">...</p>
                    </div>
                </div>

                <nav class="space-y-2 font-mono text-sm">
                    <button class="w-full text-left px-4 py-3 rounded-xl bg-neon-blue/10 text-neon-blue border border-neon-blue/30 flex items-center gap-3">
                        <span class="material-icons-round text-lg">dashboard</span> Dashboard
                    </button>
                    <button onclick="Nav.switchTab('photos')" class="w-full text-left px-4 py-3 rounded-xl hover:bg-white/5 text-gray-300 flex items-center gap-3 transition-colors">
                        <span class="material-icons-round text-lg">photo_library</span> Gallery
                    </button>
                    <button class="w-full text-left px-4 py-3 rounded-xl hover:bg-white/5 text-gray-300 flex items-center gap-3 transition-colors">
                        <span class="material-icons-round text-lg">folder_shared</span> Shared
                    </button>
                </nav>

                <div class="mt-8">
                    <p class="text-xs text-gray-500 uppercase tracking-widest mb-4 font-bold">Storage</p>
                    <div class="relative w-full h-2 bg-gray-800 rounded-full overflow-hidden">
                        <div id="storage-bar" class="absolute left-0 top-0 h-full bg-gradient-to-r from-neon-blue to-neon-purple w-[0%] transition-all duration-1000"></div>
                    </div>
                    <div class="flex justify-between text-xs mt-2 text-gray-400 font-mono">
                        <span id="storage-used">0 GB</span>
                        <span id="storage-total">15 GB</span>
                    </div>
                </div>
            </div>
            
            <div class="mt-auto p-6 border-t border-glass-border">
                <button onclick="Auth.logout()" class="w-full py-2 rounded-lg border border-red-500/30 text-red-400 hover:bg-red-500/10 text-sm font-bold transition-all">TERMINATE SESSION</button>
            </div>
        </aside>

        <!-- MAIN CONTENT -->
        <main class="flex-1 flex flex-col relative bg-transparent z-10 overflow-hidden">
            
            <!-- HEADER -->
            <header class="h-20 px-6 flex items-center justify-between ultra-glass m-4 rounded-2xl border-glass-border z-20">
                <div class="flex items-center gap-4">
                    <button onclick="UI.toggleSidebar()" class="md:hidden text-white"><span class="material-icons-round">menu</span></button>
                    
                    <!-- Search -->
                    <div class="relative group">
                        <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                            <span class="material-icons-round text-gray-500 group-focus-within:text-neon-blue transition-colors">search</span>
                        </div>
                        <input type="text" id="search-input" onkeyup="Drive.search(this.value)" 
                            class="bg-black/20 border border-white/10 text-white rounded-xl pl-10 pr-4 py-2 w-48 focus:w-80 transition-all duration-300 outline-none focus:border-neon-blue/50 focus:shadow-[0_0_15px_rgba(0,243,255,0.1)] placeholder-gray-600 font-mono text-sm" 
                            placeholder="SEARCH DATABASE...">
                    </div>
                </div>

                <div class="flex items-center gap-3">
                     <!-- Sort Button -->
                     <button onclick="Drive.sortMenu()" class="p-2 rounded-lg hover:bg-white/10 transition-colors text-gray-300">
                        <span class="material-icons-round">sort</span>
                    </button>
                    <!-- View Toggle -->
                    <div class="bg-black/30 rounded-lg p-1 flex border border-white/10">
                        <button onclick="UI.switchView('grid')" class="p-2 rounded hover:bg-white/10 text-white transition-colors"><span class="material-icons-round text-sm">grid_view</span></button>
                        <button onclick="UI.switchView('list')" class="p-2 rounded hover:bg-white/10 text-gray-400 transition-colors"><span class="material-icons-round text-sm">view_list</span></button>
                    </div>
                    <button class="bg-neon-blue text-black font-bold px-4 py-2 rounded-lg hover:shadow-[0_0_15px_rgba(0,243,255,0.5)] transition-all flex items-center gap-2" onclick="UI.toggleFab()">
                        <span class="material-icons-round text-sm">add</span> <span class="text-sm">NEW</span>
                    </button>
                </div>
            </header>

            <!-- BREADCRUMB TOOLBAR -->
            <div class="px-8 pb-2 flex items-center text-sm font-mono text-gray-400">
                <span onclick="Drive.goBack()" id="back-btn" class="hidden material-icons-round mr-4 cursor-pointer hover:text-white">arrow_back</span>
                <div id="breadcrumb" class="flex items-center gap-2 overflow-x-auto no-scrollbar">
                    <span class="text-neon-blue cursor-pointer">ROOT</span>
                </div>
            </div>

            <!-- FILE GRID -->
            <div id="file-container" class="flex-1 overflow-y-auto p-4 sm:p-8 grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 xl:grid-cols-5 gap-6 content-start pb-32">
                <!-- Dynamic Content Injected Here -->
            </div>

            <!-- FLOATING ACTION MENU -->
            <div id="fab-menu" class="hidden absolute bottom-24 right-8 ultra-glass rounded-2xl p-2 flex-col gap-1 min-w-[200px] origin-bottom-right shadow-2xl z-50">
                <label class="flex items-center gap-3 p-3 hover:bg-white/10 rounded-xl cursor-pointer transition-colors text-sm">
                    <span class="material-icons-round text-neon-green">upload_file</span> Upload File
                    <input type="file" hidden multiple onchange="Upload.handleFiles(this.files)">
                </label>
                <label class="flex items-center gap-3 p-3 hover:bg-white/10 rounded-xl cursor-pointer transition-colors text-sm">
                    <span class="material-icons-round text-neon-green">drive_folder_upload</span> Upload Folder
                    <input type="file" hidden webkitdirectory onchange="Upload.handleFiles(this.files)">
                </label>
                <div class="h-px bg-white/10 my-1"></div>
                <div class="flex items-center gap-3 p-3 hover:bg-white/10 rounded-xl cursor-pointer transition-colors text-sm" onclick="Ops.createFolder()">
                    <span class="material-icons-round text-neon-blue">create_new_folder</span> New Folder
                </div>
                <div class="flex items-center gap-3 p-3 hover:bg-white/10 rounded-xl cursor-pointer transition-colors text-sm" onclick="Ops.createDocument()">
                    <span class="material-icons-round text-neon-purple">description</span> Google Doc
                </div>
            </div>

        </main>
    </div>

    <!-- [MODALS] -->
    
    <!-- Upload Progress (HUD Style) -->
    <div id="progress-modal" class="hidden fixed bottom-8 left-1/2 transform -translate-x-1/2 w-96 ultra-glass rounded-2xl p-5 border-t-2 border-neon-blue z-50">
        <div class="flex justify-between items-end mb-2">
            <h4 class="font-mono text-neon-blue text-sm font-bold animate-pulse">UPLOADING...</h4>
            <span id="prog-pct" class="font-mono text-2xl font-bold">0%</span>
        </div>
        <div class="relative h-1 bg-gray-800 rounded overflow-hidden mb-3">
            <div id="prog-bar" class="absolute top-0 left-0 h-full bg-neon-blue shadow-[0_0_10px_#00f3ff]" style="width: 0%"></div>
        </div>
        <div class="flex justify-between text-xs font-mono text-gray-400">
            <span id="prog-file" class="truncate max-w-[150px]">filename.ext</span>
            <span id="prog-speed">0 MB/s</span>
        </div>
        <button onclick="Upload.cancel()" class="absolute -top-3 -right-3 w-8 h-8 rounded-full bg-red-500 text-white flex items-center justify-center hover:bg-red-600 shadow-lg">
            <span class="material-icons-round text-sm">close</span>
        </button>
    </div>

    <!-- Generic Modal Wrapper -->
    <div id="ctx-modal" class="hidden fixed inset-0 z-[100] flex items-center justify-center bg-black/80 backdrop-blur-sm" onclick="if(event.target===this)UI.closeModal('ctx-modal')">
        <div class="ultra-glass w-full max-w-sm rounded-2xl overflow-hidden animate-fade-in-up">
            <div class="p-4 border-b border-white/10 bg-white/5 flex justify-between items-center">
                <h3 id="ctx-name" class="font-bold truncate pr-4">Options</h3>
                <span class="material-icons-round cursor-pointer text-gray-400 hover:text-white" onclick="UI.closeModal('ctx-modal')">close</span>
            </div>
            <div class="p-2">
                <button onclick="Ops.preview()" class="w-full text-left p-3 rounded-lg hover:bg-white/10 flex items-center gap-3 transition-colors"><span class="material-icons-round text-gray-400">visibility</span> Preview</button>
                <button onclick="Ops.download()" class="w-full text-left p-3 rounded-lg hover:bg-white/10 flex items-center gap-3 transition-colors"><span class="material-icons-round text-gray-400">download</span> Download</button>
                <button onclick="Ops.rename()" class="w-full text-left p-3 rounded-lg hover:bg-white/10 flex items-center gap-3 transition-colors"><span class="material-icons-round text-gray-400">edit</span> Rename</button>
                <button onclick="Ops.info()" class="w-full text-left p-3 rounded-lg hover:bg-white/10 flex items-center gap-3 transition-colors"><span class="material-icons-round text-gray-400">info</span> Info</button>
                <div class="h-px bg-white/10 my-1"></div>
                <button onclick="Ops.delete()" class="w-full text-left p-3 rounded-lg hover:bg-red-500/20 text-red-400 flex items-center gap-3 transition-colors"><span class="material-icons-round">delete</span> Delete</button>
            </div>
        </div>
    </div>

    <!-- Media Viewer (Immersive) -->
    <div id="media-view" class="hidden fixed inset-0 z-[200] bg-black flex flex-col">
        <div class="h-16 flex items-center justify-between px-6 ultra-glass z-10">
            <span id="media-title" class="font-mono text-sm truncate max-w-md">Preview</span>
            <div class="flex gap-4">
                <button onclick="Ops.openExternal()" class="text-neon-blue hover:text-white"><span class="material-icons-round">open_in_new</span></button>
                <button onclick="UI.closeMedia()" class="text-red-400 hover:text-white"><span class="material-icons-round">close</span></button>
            </div>
        </div>
        <iframe id="media-frame" class="flex-1 w-full border-none bg-black"></iframe>
    </div>

    <script>
        /* 
        ========================================
        1. VISUAL EFFECTS ENGINE (Canvas & Tilt)
        ========================================
        */
        
        // --- Star Warp Background ---
        const canvas = document.getElementById('bg-canvas');
        const ctx = canvas.getContext('2d');
        let width, height;
        const stars = [];

        function resize() {
            width = canvas.width = window.innerWidth;
            height = canvas.height = window.innerHeight;
        }
        window.addEventListener('resize', resize);
        resize();

        class Star {
            constructor() {
                this.x = Math.random() * width - width/2;
                this.y = Math.random() * height - height/2;
                this.z = Math.random() * 2000; // Depth
            }
            update() {
                this.z -= 10; // Speed
                if (this.z <= 0) {
                    this.z = 2000;
                    this.x = Math.random() * width - width/2;
                    this.y = Math.random() * height - height/2;
                }
            }
            draw() {
                const sx = (this.x / this.z) * width + width/2;
                const sy = (this.y / this.z) * height + height/2;
                const radius = (1 - this.z / 2000) * 3;
                
                // Opacity based on depth
                const alpha = (1 - this.z / 2000);
                
                ctx.beginPath();
                ctx.fillStyle = `rgba(180, 220, 255, ${alpha})`;
                ctx.arc(sx, sy, radius, 0, Math.PI * 2);
                ctx.fill();
            }
        }

        // Initialize Stars
        for(let i=0; i<300; i++) stars.push(new Star());

        function animateBg() {
            ctx.fillStyle = "rgba(5, 5, 10, 0.4)"; // Trail effect
            ctx.fillRect(0, 0, width, height);
            
            stars.forEach(star => {
                star.update();
                star.draw();
            });
            requestAnimationFrame(animateBg);
        }
        animateBg();

        // --- 3D Tilt Effect for Cards ---
        function applyTiltEffect() {
            const cards = document.querySelectorAll('.tilt-card');
            cards.forEach(card => {
                card.addEventListener('mousemove', (e) => {
                    const rect = card.getBoundingClientRect();
                    const x = e.clientX - rect.left;
                    const y = e.clientY - rect.top;
                    const centerX = rect.width / 2;
                    const centerY = rect.height / 2;
                    
                    const rotateX = ((y - centerY) / centerY) * -10; // Max 10deg rotation
                    const rotateY = ((x - centerX) / centerX) * 10;

                    gsap.to(card, {
                        duration: 0.5,
                        rotateX: rotateX,
                        rotateY: rotateY,
                        scale: 1.05,
                        boxShadow: '0 20px 40px rgba(0,0,0,0.4)',
                        border: '1px solid rgba(0, 243, 255, 0.5)',
                        ease: "power2.out"
                    });
                });

                card.addEventListener('mouseleave', () => {
                    gsap.to(card, {
                        duration: 0.5,
                        rotateX: 0,
                        rotateY: 0,
                        scale: 1,
                        boxShadow: 'none',
                        border: '1px solid rgba(255, 255, 255, 0.05)',
                        ease: "power2.out"
                    });
                });
            });
        }

        /* 
        ========================================
        2. APPLICATION LOGIC
        ========================================
        */
        const CONFIG = {
            // Replace with your Client ID if needed
            clientId: '318681315152-65e9kofptt4c3bk3kmlj9gmksnasu347.apps.googleusercontent.com', 
            scopes: 'https://www.googleapis.com/auth/drive https://www.googleapis.com/auth/userinfo.email',
        };

        const STATE = {
            token: localStorage.getItem('g_token'),
            currFolder: 'root',
            folderStack: [],
            files: [],
            viewMode: 'grid' // grid or list
        };

        // --- PIN System ---
        const Keypad = {
            input: "",
            press: (n) => {
                if(Keypad.input.length < 4) {
                    Keypad.input += n;
                    Keypad.renderDots();
                    if(Keypad.input.length === 4) setTimeout(Keypad.verify, 200);
                }
            },
            renderDots: () => {
                const dots = document.getElementById('pin-dots').children;
                for(let i=0; i<4; i++) {
                    if(i < Keypad.input.length) {
                        dots[i].classList.add('bg-neon-blue', 'border-neon-blue', 'shadow-[0_0_10px_#00f3ff]');
                        dots[i].classList.remove('bg-transparent', 'border-white/20');
                    } else {
                        dots[i].classList.remove('bg-neon-blue', 'border-neon-blue', 'shadow-[0_0_10px_#00f3ff]');
                        dots[i].classList.add('bg-transparent', 'border-white/20');
                    }
                }
            },
            clear: () => { Keypad.input = ""; Keypad.renderDots(); },
            backspace: () => { Keypad.input = Keypad.input.slice(0,-1); Keypad.renderDots(); },
            verify: () => {
                const stored = localStorage.getItem('app_pin');
                if(!stored) {
                    localStorage.setItem('app_pin', btoa(Keypad.input));
                    alert("SECURITY PIN ESTABLISHED");
                    Auth.check();
                } else if (btoa(Keypad.input) === stored) {
                    Auth.check();
                } else {
                    Keypad.shake();
                    Keypad.clear();
                }
            },
            shake: () => {
                gsap.to('#lock-screen > div', {x: [-10, 10, -10, 10, 0], duration: 0.4});
            }
        };

        // --- AUTH ---
        let tokenClient;
        const Auth = {
            init: () => {
                tokenClient = google.accounts.oauth2.initTokenClient({
                    client_id: CONFIG.clientId, scope: CONFIG.scopes,
                    callback: (r) => {
                        if(r.error) return alert("Auth Error");
                        STATE.token = r.access_token;
                        localStorage.setItem('g_token', STATE.token);
                        localStorage.setItem('g_exp', Date.now() + 3500 * 1000);
                        UI.enterApp();
                    }
                });
            },
            check: () => {
                // Transition Lock -> Auth/App
                const exp = localStorage.getItem('g_exp');
                
                // Visual Transition
                const lock = document.getElementById('lock-screen');
                gsap.to(lock, {opacity: 0, scale: 1.5, duration: 0.5, onComplete: () => {
                    lock.style.display = 'none';
                    if(STATE.token && exp && Date.now() < exp) {
                        UI.enterApp();
                    } else {
                        document.getElementById('auth-screen').style.display = 'flex';
                        gsap.from('#auth-screen > div', {y: 50, opacity: 0, duration: 0.8, ease: "back.out(1.7)"});
                    }
                }});
            },
            signIn: () => tokenClient.requestAccessToken(),
            logout: () => { localStorage.clear(); location.reload(); }
        };

        // --- DRIVE LOGIC ---
        const Drive = {
            load: async (id, name) => {
                STATE.currFolder = id;
                document.getElementById('file-container').innerHTML = `<div class="w-full h-full flex items-center justify-center"><div class="loader-ring"></div></div>`;
                
                // Logic updates for Breadcrumbs and Back button...
                document.getElementById('back-btn').style.display = id === 'root' ? 'none' : 'block';
                const crumb = document.getElementById('breadcrumb');
                crumb.innerHTML = id === 'root' ? 
                    `<span class="text-neon-blue cursor-pointer" onclick="Drive.load('root')">ROOT</span>` : 
                    `<span class="text-gray-500 cursor-pointer" onclick="Drive.load('root')">ROOT</span> <span class="text-gray-600">/</span> <span class="text-neon-blue">${name}</span>`;

                const q = `'${id}' in parents and trashed = false`;
                const fields = "files(id,name,mimeType,size,thumbnailLink,webViewLink,webContentLink,iconLink)";
                
                try {
                    const res = await fetch(`https://www.googleapis.com/drive/v3/files?q=${encodeURIComponent(q)}&fields=${fields}&pageSize=100`, {
                        headers: { 'Authorization': `Bearer ${STATE.token}` }
                    });
                    const data = await res.json();
                    STATE.files = data.files || [];
                    Drive.render();
                } catch(e) {
                    console.error(e);
                    localStorage.removeItem('g_token'); // Likely expired
                    location.reload();
                }
            },
            render: () => {
                const con = document.getElementById('file-container');
                con.innerHTML = "";
                
                if(STATE.files.length === 0) {
                    con.innerHTML = `<div class="col-span-full flex flex-col items-center justify-center text-gray-500 mt-20">
                        <span class="material-icons-round text-6xl mb-4 opacity-20">folder_open</span>
                        <p class="font-mono text-sm tracking-widest">NO DATA FOUND</p>
                    </div>`;
                    return;
                }

                // Staggered Animation Entry
                STATE.files.forEach((f, index) => {
                    const isDir = f.mimeType === 'application/vnd.google-apps.folder';
                    const isImg = f.mimeType.includes('image');
                    const size = isDir ? '' : Ops.fmtSize(f.size);
                    
                    let icon = 'insert_drive_file';
                    let color = 'text-gray-400';
                    if(isDir) { icon = 'folder'; color = 'text-yellow-400'; }
                    else if(isImg) { icon = 'image'; color = 'text-neon-green'; }
                    else if(f.mimeType.includes('pdf')) { icon = 'picture_as_pdf'; color = 'text-red-400'; }
                    
                    const el = document.createElement('div');
                    
                    if(STATE.viewMode === 'grid') {
                        // CARD STYLE
                        el.className = `tilt-card group relative card-glass rounded-xl p-4 flex flex-col items-center justify-center gap-3 cursor-pointer overflow-hidden`;
                        el.style.opacity = '0'; // For GSAP
                        
                        // Image Preview or Icon
                        let visual = `<span class="material-icons-round text-5xl ${color} opacity-80 group-hover:scale-110 transition-transform duration-300">${icon}</span>`;
                        if(isImg && f.thumbnailLink) {
                            visual = `<img src="${f.thumbnailLink.replace('=s220', '=s400')}" class="w-full h-32 object-cover rounded-lg group-hover:scale-105 transition-transform duration-500">`;
                        }

                        el.innerHTML = `
                            ${visual}
                            <div class="w-full text-center z-10">
                                <p class="text-sm font-medium truncate text-gray-200 group-hover:text-neon-blue transition-colors">${f.name}</p>
                                <p class="text-xs text-gray-500 font-mono mt-1">${size}</p>
                            </div>
                            <!-- Menu Button -->
                            <button onclick="event.stopPropagation(); Ops.menu('${f.id}')" class="absolute top-2 right-2 p-1 rounded-full hover:bg-white/10 opacity-0 group-hover:opacity-100 transition-opacity">
                                <span class="material-icons-round text-sm">more_vert</span>
                            </button>
                        `;
                    } else {
                        // LIST STYLE
                        el.className = `w-full flex items-center justify-between p-4 border-b border-white/5 hover:bg-white/5 transition-colors cursor-pointer group`;
                        el.innerHTML = `
                            <div class="flex items-center gap-4">
                                <span class="material-icons-round ${color}">${icon}</span>
                                <span class="text-sm group-hover:text-neon-blue transition-colors truncate w-64 md:w-auto">${f.name}</span>
                            </div>
                            <div class="flex items-center gap-4">
                                <span class="text-xs font-mono text-gray-500">${size}</span>
                                <button onclick="event.stopPropagation(); Ops.menu('${f.id}')" class="p-1 rounded-full hover:bg-white/10">
                                    <span class="material-icons-round text-sm">more_vert</span>
                                </button>
                            </div>
                        `;
                    }

                    el.onclick = () => isDir ? Drive.load(f.id, f.name) : Ops.open(f);
                    con.appendChild(el);
                });

                // Apply Animations
                if(STATE.viewMode === 'grid') {
                    gsap.to(".tilt-card", {
                        y: 0, opacity: 1, duration: 0.5, stagger: 0.05, ease: "power2.out"
                    });
                    setTimeout(applyTiltEffect, 500); // Initialize tilt after render
                }
            },
            goBack: () => {
                if(STATE.folderStack.length) { // Simple stack implementation needed for real history
                   Drive.load('root'); // Fallback for demo
                } else Drive.load('root');
            }
        };

        // --- OPERATIONS & UI HELPERS ---
        const Ops = {
            menu: (id) => {
                STATE.sel = STATE.files.find(f => f.id === id);
                document.getElementById('ctx-name').innerText = STATE.sel.name;
                document.getElementById('ctx-modal').style.display = 'flex';
            },
            open: (f) => {
                STATE.sel = f;
                Ops.preview();
            },
            preview: () => {
                UI.closeModal('ctx-modal');
                const v = document.getElementById('media-view');
                v.style.display = 'flex';
                document.getElementById('media-title').innerText = STATE.sel.name;
                
                // Animation
                gsap.fromTo(v, {opacity: 0, scale: 0.95}, {opacity: 1, scale: 1, duration: 0.3});
                document.getElementById('media-frame').src = STATE.sel.webViewLink.replace('/view', '/preview');
            },
            fmtSize: (b) => {
                if(!b) return '0 B';
                const i = Math.floor(Math.log(b)/Math.log(1024));
                return (b/Math.pow(1024,i)).toFixed(1) + ' ' + ['B','KB','MB','GB'][i];
            }
        };

        // --- UI MANAGER ---
        const UI = {
            enterApp: () => {
                document.getElementById('auth-screen').style.display = 'none';
                const app = document.getElementById('app-screen');
                app.style.display = 'flex';
                
                // Animation Sequence
                const tl = gsap.timeline();
                tl.from("#sidebar", {x: -300, duration: 0.8, ease: "power4.out"})
                  .from("header", {y: -100, opacity: 0, duration: 0.6}, "-=0.4")
                  .from("#file-container", {opacity: 0, duration: 0.6}, "-=0.2");

                // Load User Data
                fetch('https://www.googleapis.com/oauth2/v3/userinfo', { 
                    headers: {'Authorization': `Bearer ${STATE.token}`}
                }).then(r=>r.json()).then(d => {
                    document.getElementById('sidebar-avatar').src = d.picture;
                    document.getElementById('sidebar-name').innerText = d.name;
                    document.getElementById('sidebar-email').innerText = d.email;
                    Drive.load('root');
                });
            },
            switchView: (m) => {
                STATE.viewMode = m;
                Drive.render();
            },
            toggleSidebar: () => {
                const s = document.getElementById('sidebar');
                s.classList.toggle('-translate-x-full');
            },
            toggleFab: () => {
                const m = document.getElementById('fab-menu');
                if(m.classList.contains('hidden')) {
                    m.classList.remove('hidden');
                    m.style.display = 'flex';
                    gsap.fromTo(m, {opacity: 0, scale: 0.8, y: 20}, {opacity: 1, scale: 1, y: 0, duration: 0.3, ease: "back.out(1.7)"});
                } else {
                    gsap.to(m, {opacity: 0, scale: 0.8, y: 20, duration: 0.2, onComplete: () => m.classList.add('hidden')});
                }
            },
            closeModal: (id) => {
                document.getElementById(id).style.display = 'none';
            },
            closeMedia: () => {
                const v = document.getElementById('media-view');
                gsap.to(v, {opacity: 0, scale: 0.95, duration: 0.2, onComplete: () => {
                    v.style.display = 'none';
                    document.getElementById('media-frame').src = "";
                }});
            }
        };

        // --- UPLOAD MOCKUP (Functional Skeleton) ---
        const Upload = {
            handleFiles: (files) => {
                UI.toggleFab();
                const m = document.getElementById('progress-modal');
                m.style.display = 'block';
                gsap.from(m, {y: 100, opacity: 0});
                
                // Simulate Upload
                let prog = 0;
                document.getElementById('prog-file').innerText = files[0].name;
                const int = setInterval(() => {
                    prog += Math.random() * 5;
                    if(prog >= 100) {
                        prog = 100;
                        clearInterval(int);
                        setTimeout(() => {
                            gsap.to(m, {y: 100, opacity: 0, onComplete: () => m.style.display = 'none'});
                            Drive.load(STATE.currFolder); // Refresh
                        }, 1000);
                    }
                    document.getElementById('prog-bar').style.width = prog + '%';
                    document.getElementById('prog-pct').innerText = Math.floor(prog) + '%';
                }, 200);
            },
            cancel: () => {
                document.getElementById('progress-modal').style.display = 'none';
            }
        }

        // --- INIT ---
        window.onload = () => {
            // Check for saved PIN
            if(!localStorage.getItem('app_pin')) {
                // First time setup logic could go here
            }
            Auth.init();
        }

    </script>
</body>
</html>
