<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Drive OS | Pro</title>
    
    <!-- Google Identity & Icons -->
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&family=Google+Sans:wght@400;500&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons+Round" rel="stylesheet">

    <style>
        :root {
            --primary: #1a73e8;
            --surface: #ffffff;
            --bg: #f8f9fa;
            --text-main: #202124;
            --text-sec: #5f6368;
            --border: #dadce0;
            --hover: #f1f3f4;
            --shadow: 0 1px 2px 0 rgba(60,64,67,0.3), 0 1px 3px 1px rgba(60,64,67,0.15);
            --radius: 8px;
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; outline: none; user-select: none; }
        
        body {
            margin: 0; padding: 0;
            font-family: 'Roboto', sans-serif;
            background: var(--bg); color: var(--text-main);
            height: 100vh; display: flex; flex-direction: column; overflow: hidden;
        }

        /* --- SCREENS --- */
        .screen {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            display: none; flex-direction: column; background: var(--bg); z-index: 10;
        }
        .screen.active { display: flex; animation: fade 0.2s ease; }
        @keyframes fade { from { opacity: 0; } to { opacity: 1; } }

        /* --- LOCK SCREEN (Virtual Keypad) --- */
        #lock-screen {
            justify-content: center; align-items: center; background: #fff;
        }
        .pin-container {
            text-align: center; width: 100%; max-width: 320px;
        }
        .logo-area { font-family: 'Google Sans'; font-size: 24px; color: var(--text-sec); margin-bottom: 30px; }
        .pin-dots {
            display: flex; justify-content: center; gap: 15px; margin-bottom: 40px;
        }
        .dot {
            width: 15px; height: 15px; border-radius: 50%;
            border: 2px solid var(--text-sec); transition: 0.2s;
        }
        .dot.filled { background: var(--primary); border-color: var(--primary); }
        .keypad {
            display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px;
            padding: 0 20px;
        }
        .key {
            width: 70px; height: 70px; border-radius: 50%;
            background: var(--hover); color: var(--text-main);
            font-size: 24px; display: flex; align-items: center; justify-content: center;
            margin: auto; cursor: pointer; transition: 0.1s;
        }
        .key:active { background: #dcdcdc; }
        .key.clear { background: transparent; font-size: 14px; color: var(--text-sec); }

        /* --- AUTH SCREEN --- */
        #auth-screen { justify-content: center; align-items: center; text-align: center; }
        .auth-btn {
            background: #fff; border: 1px solid var(--border); padding: 12px 24px;
            border-radius: 24px; font-family: 'Google Sans'; font-weight: 500;
            display: flex; align-items: center; gap: 10px; cursor: pointer;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }

        /* --- MAIN APP UI --- */
        /* Header */
        .app-header {
            background: var(--surface); padding: 10px 15px; height: 60px;
            display: flex; align-items: center; justify-content: space-between;
            box-shadow: 0 1px 0 var(--border); z-index: 20;
        }
        .search-bar {
            flex: 1; background: #f1f3f4; border-radius: 8px; margin: 0 15px;
            padding: 8px 12px; display: flex; align-items: center; color: var(--text-sec);
        }
        .search-input {
            border: none; background: transparent; margin-left: 10px; width: 100%; font-size: 16px;
        }

        /* Toolbar */
        .toolbar {
            padding: 10px 15px; display: flex; justify-content: space-between; align-items: center;
            font-size: 14px; color: var(--text-sec); border-bottom: 1px solid var(--border);
        }
        .breadcrumb { display: flex; align-items: center; overflow: hidden; white-space: nowrap; max-width: 70%; }
        .crumb-item { color: var(--text-main); font-weight: 500; }

        /* File List */
        .file-viewer { flex: 1; overflow-y: auto; padding: 10px; }
        .file-list-view { display: flex; flex-direction: column; }
        .file-grid-view { display: grid; grid-template-columns: repeat(auto-fill, minmax(100px, 1fr)); gap: 10px; }
        
        /* File Item (List) */
        .list-item {
            display: flex; align-items: center; padding: 12px;
            border-bottom: 1px solid #f1f3f4; cursor: pointer;
        }
        .list-item:active { background: #e8f0fe; }
        .grid-item {
            background: #fff; border: 1px solid var(--border); border-radius: 8px;
            padding: 10px; display: flex; flex-direction: column; align-items: center; text-align: center;
        }
        .item-icon { font-size: 28px; color: var(--text-sec); margin-right: 15px; }
        .folder-icon { color: var(--text-sec); } /* Dark gray for folders like Drive */
        .grid-item .item-icon { font-size: 40px; margin: 0 0 10px 0; }
        .item-text { flex: 1; overflow: hidden; }
        .item-name { display: block; font-size: 14px; color: var(--text-main); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .item-meta { display: block; font-size: 12px; color: var(--text-sec); margin-top: 2px; }

        /* FAB */
        .fab-container { position: absolute; bottom: 80px; right: 20px; z-index: 50; }
        .fab-main {
            width: 56px; height: 56px; border-radius: 16px; background: #fff;
            box-shadow: var(--shadow); display: flex; align-items: center; justify-content: center;
            cursor: pointer; color: var(--primary); font-size: 30px;
        }
        .fab-menu {
            position: absolute; bottom: 70px; right: 0; background: #fff;
            border-radius: 8px; box-shadow: var(--shadow); width: 200px;
            display: none; flex-direction: column; overflow: hidden;
        }
        .fab-item { padding: 12px 15px; display: flex; align-items: center; gap: 10px; font-size: 14px; cursor: pointer; }
        .fab-item:active { background: #f1f3f4; }

        /* Bottom Nav */
        .bottom-nav {
            height: 65px; background: var(--surface); border-top: 1px solid var(--border);
            display: flex; justify-content: space-around; align-items: center;
        }
        .nav-item { display: flex; flex-direction: column; align-items: center; color: var(--text-sec); font-size: 12px; padding: 5px; }
        .nav-item.active { color: var(--primary); }
        .nav-item .material-icons-round { background: transparent; padding: 4px 20px; border-radius: 16px; margin-bottom: 4px; transition: 0.2s; }
        .nav-item.active .material-icons-round { background: #e8f0fe; }

        /* --- MODALS --- */
        .modal-mask {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.6); z-index: 1000; display: none;
            justify-content: center; align-items: flex-end; /* Bottom sheet style */
        }
        .modal-sheet {
            background: #fff; width: 100%; max-width: 600px;
            border-radius: 16px 16px 0 0; padding: 20px;
            animation: slideUp 0.2s ease-out; max-height: 80vh; overflow-y: auto;
        }
        @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }
        
        .sheet-head { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .sheet-title { font-family: 'Google Sans'; font-size: 18px; }
        
        .action-list div { padding: 15px 0; display: flex; align-items: center; gap: 15px; border-bottom: 1px solid #f1f3f4; cursor: pointer; }
        .action-list div:last-child { border: none; }

        /* Progress Modal */
        .progress-box {
            background: #fff; padding: 20px; border-radius: 8px; width: 90%; max-width: 400px;
            margin: auto; box-shadow: var(--shadow); display: none;
            position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); z-index: 2000;
        }
        .progress-bar { height: 4px; background: #e0e0e0; border-radius: 2px; margin-top: 10px; overflow: hidden; }
        .progress-fill { height: 100%; background: var(--primary); width: 0%; transition: width 0.2s; }

        /* Media Overlay */
        .media-viewer {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: #000; z-index: 2500; display: none; flex-direction: column;
        }
        .media-header { padding: 15px; color: #fff; display: flex; justify-content: space-between; background: rgba(0,0,0,0.5); }
        .media-iframe { flex: 1; border: none; background: #fff; }

        /* Settings Toggle */
        .switch { position: relative; display: inline-block; width: 40px; height: 20px; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; transition: .4s; border-radius: 20px; }
        .slider:before { position: absolute; content: ""; height: 16px; width: 16px; left: 2px; bottom: 2px; background-color: white; transition: .4s; border-radius: 50%; }
        input:checked + .slider { background-color: var(--primary); }
        input:checked + .slider:before { transform: translateX(20px); }

    </style>
</head>
<body>

    <!-- [SCREEN 1] LOCK (VIRTUAL KEYPAD) -->
    <div id="lock-screen" class="screen active">
        <div class="pin-container">
            <div class="logo-area">Enter PIN</div>
            <div class="pin-dots" id="pin-dots">
                <div class="dot"></div><div class="dot"></div><div class="dot"></div><div class="dot"></div>
            </div>
            <div class="keypad">
                <div class="key" onclick="Keypad.press(1)">1</div>
                <div class="key" onclick="Keypad.press(2)">2</div>
                <div class="key" onclick="Keypad.press(3)">3</div>
                <div class="key" onclick="Keypad.press(4)">4</div>
                <div class="key" onclick="Keypad.press(5)">5</div>
                <div class="key" onclick="Keypad.press(6)">6</div>
                <div class="key" onclick="Keypad.press(7)">7</div>
                <div class="key" onclick="Keypad.press(8)">8</div>
                <div class="key" onclick="Keypad.press(9)">9</div>
                <div class="key clear" onclick="Keypad.reset()">CLEAR</div>
                <div class="key" onclick="Keypad.press(0)">0</div>
                <div class="key clear"></div> 
            </div>
        </div>
    </div>

    <!-- [SCREEN 2] AUTH -->
    <div id="auth-screen" class="screen">
        <div style="width: 80%; max-width: 300px;">
            <h2 style="font-family: 'Google Sans'; margin-bottom: 10px;">Welcome</h2>
            <p style="color: var(--text-sec); margin-bottom: 30px;">Connect your Google Drive</p>
            <button class="auth-btn" onclick="Auth.signIn()" style="width: 100%; justify-content: center;">
                <img src="https://upload.wikimedia.org/wikipedia/commons/5/53/Google_%22G%22_Logo.svg" width="20">
                Sign in with Google
            </button>
        </div>
    </div>

    <!-- [SCREEN 3] APP DASHBOARD -->
    <div id="app-screen" class="screen">
        <div class="app-header">
            <span class="material-icons-round" onclick="Nav.toggleMenu()">menu</span>
            <div class="search-bar">
                <span class="material-icons-round">search</span>
                <input type="text" class="search-input" placeholder="Search Drive" id="search-input" onkeyup="Drive.search(this.value)">
            </div>
            <img id="user-avatar" src="" style="width: 32px; height: 32px; border-radius: 50%; cursor: pointer;" onclick="Settings.open()">
        </div>

        <div class="toolbar">
            <div class="breadcrumb" id="breadcrumb" onclick="Drive.goBack()">My Drive</div>
            <div style="display: flex; gap: 15px;">
                <span class="material-icons-round" id="view-toggle" onclick="UI.toggleView()">grid_view</span>
                <span class="material-icons-round" onclick="Drive.sort()">sort_by_alpha</span>
            </div>
        </div>

        <!-- Files -->
        <div id="file-container" class="file-viewer file-list-view">
            <!-- Dynamic Content -->
        </div>

        <!-- FAB -->
        <div class="fab-container">
            <div class="fab-menu" id="fab-menu">
                <label class="fab-item">
                    <span class="material-icons-round" style="color:var(--text-sec)">upload_file</span> Upload File
                    <input type="file" hidden multiple onchange="Upload.handleFiles(this.files)">
                </label>
                <label class="fab-item">
                    <span class="material-icons-round" style="color:var(--text-sec)">drive_folder_upload</span> Upload Folder
                    <input type="file" hidden webkitdirectory onchange="Upload.handleFiles(this.files)">
                </label>
                <div class="fab-item" onclick="Ops.createFolder()">
                    <span class="material-icons-round" style="color:var(--text-sec)">create_new_folder</span> New Folder
                </div>
            </div>
            <div class="fab-main" onclick="UI.toggleFab()">+</div>
        </div>

        <!-- Bottom Nav -->
        <div class="bottom-nav">
            <div class="nav-item active" onclick="Nav.switchTab('user', this)">
                <span class="material-icons-round">home</span> Home
            </div>
            <div class="nav-item" onclick="Nav.switchTab('vault', this)">
                <span class="material-icons-round">lock</span> Vault
            </div>
            <div class="nav-item" onclick="Nav.switchTab('starred', this)">
                <span class="material-icons-round">star</span> Starred
            </div>
        </div>
    </div>

    <!-- [MODALS] -->
    
    <!-- File Context Menu -->
    <div id="ctx-modal" class="modal-mask" onclick="if(event.target === this) UI.closeModal('ctx-modal')">
        <div class="modal-sheet">
            <div class="sheet-head">
                <span class="sheet-title" id="ctx-name" style="font-size: 16px; overflow:hidden; text-overflow:ellipsis; white-space:nowrap; max-width:80%;">Filename</span>
                <span class="material-icons-round" onclick="UI.closeModal('ctx-modal')">close</span>
            </div>
            <div class="action-list">
                <div onclick="Ops.preview()"><span class="material-icons-round">visibility</span> Preview</div>
                <div onclick="Ops.download()"><span class="material-icons-round">download</span> Download</div>
                <div onclick="Ops.copyLink()"><span class="material-icons-round">link</span> Copy Link</div>
                <div onclick="Ops.info()"><span class="material-icons-round">info</span> File Info</div>
                <div onclick="Ops.delete()" style="color: #d93025;"><span class="material-icons-round">delete</span> Remove</div>
            </div>
        </div>
    </div>

    <!-- Settings Modal -->
    <div id="settings-modal" class="modal-mask" onclick="if(event.target === this) UI.closeModal('settings-modal')">
        <div class="modal-sheet">
            <div class="sheet-head"><span class="sheet-title">Settings</span></div>
            <div class="action-list">
                <div style="justify-content: space-between; cursor: default;">
                    <span>External Player (New Tab)</span>
                    <label class="switch"><input type="checkbox" id="ext-player-toggle" onchange="Settings.save()"><span class="slider"></span></label>
                </div>
                <div onclick="Settings.storageInfo()"><span class="material-icons-round">storage</span> Storage Usage</div>
                <div onclick="Auth.logout()" style="color: #d93025;"><span class="material-icons-round">logout</span> Sign Out</div>
            </div>
        </div>
    </div>

    <!-- Progress Dialog -->
    <div id="progress-modal" class="progress-box">
        <div style="display:flex; justify-content:space-between; margin-bottom:5px;">
            <strong id="prog-title">Uploading...</strong>
            <span id="prog-pct">0%</span>
        </div>
        <div style="font-size:12px; color:var(--text-sec); margin-bottom:10px;" id="prog-details">0MB / 0MB</div>
        <div class="progress-bar"><div class="progress-fill" id="prog-bar"></div></div>
    </div>

    <!-- Media Viewer -->
    <div id="media-view" class="media-viewer">
        <div class="media-header">
            <span id="media-title">Preview</span>
            <div style="display: flex; gap: 15px;">
                <span class="material-icons-round" onclick="Ops.openExternal()">open_in_new</span>
                <span class="material-icons-round" onclick="UI.closeMedia()">close</span>
            </div>
        </div>
        <iframe id="media-frame" class="media-iframe" src=""></iframe>
    </div>

    <!-- Scripts -->
    <script>
        const CONFIG = {
            clientId: '318681315152-65e9kofptt4c3bk3kmlj9gmksnasu347.apps.googleusercontent.com',
            scopes: 'https://www.googleapis.com/auth/drive https://www.googleapis.com/auth/userinfo.email',
            vaultId: '1zIyinAqjQv96QBSuanFS2F0USaG66GPn' // Your Vault Folder ID
        };

        const STATE = {
            token: localStorage.getItem('g_token'),
            currFolder: 'root',
            folderStack: [],
            files: [], // Current file list cache
            selected: null,
            viewMode: 'list', // list or grid
            settings: JSON.parse(localStorage.getItem('d_settings') || '{"extPlayer": false}')
        };

        /* --- [1] VIRTUAL KEYPAD SYSTEM --- */
        const Keypad = {
            input: "",
            press: (num) => {
                if(Keypad.input.length < 4) {
                    Keypad.input += num;
                    Keypad.updateDots();
                    if(Keypad.input.length === 4) setTimeout(Keypad.check, 200);
                }
            },
            updateDots: () => {
                const dots = document.querySelectorAll('.dot');
                dots.forEach((d, i) => {
                    if(i < Keypad.input.length) d.classList.add('filled');
                    else d.classList.remove('filled');
                });
            },
            reset: () => {
                Keypad.input = "";
                Keypad.updateDots();
            },
            check: async () => {
                // Check PIN (Default 1234 if not set, or verify hash)
                const stored = localStorage.getItem('app_pin');
                
                // Simple Hash for demo (In prod use SHA-256)
                const hash = btoa(Keypad.input); 

                if(!stored) {
                    localStorage.setItem('app_pin', hash);
                    alert("PIN Set to " + Keypad.input);
                    Auth.check();
                } else {
                    if(stored === hash) {
                        Auth.check();
                    } else {
                        Keypad.reset();
                        // Shake animation could go here
                        alert("Wrong PIN");
                    }
                }
            }
        };

        /* --- [2] AUTH --- */
        let tokenClient;
        const Auth = {
            init: () => {
                tokenClient = google.accounts.oauth2.initTokenClient({
                    client_id: CONFIG.clientId, scope: CONFIG.scopes,
                    callback: (r) => {
                        if(r.error) return alert("Login Failed");
                        STATE.token = r.access_token;
                        localStorage.setItem('g_token', STATE.token);
                        localStorage.setItem('g_exp', Date.now() + 3500 * 1000);
                        UI.switchScreen('app-screen');
                        Drive.load('root');
                        Auth.loadProfile();
                    }
                });
            },
            check: () => {
                const exp = localStorage.getItem('g_exp');
                if(STATE.token && exp && Date.now() < exp) {
                    UI.switchScreen('app-screen');
                    Drive.load('root');
                    Auth.loadProfile();
                } else {
                    UI.switchScreen('auth-screen');
                }
            },
            signIn: () => tokenClient.requestAccessToken(),
            loadProfile: () => {
                fetch('https://www.googleapis.com/oauth2/v3/userinfo', { 
                    headers: {'Authorization': `Bearer ${STATE.token}`}
                }).then(r=>r.json()).then(d => {
                    document.getElementById('user-avatar').src = d.picture;
                });
            },
            logout: () => {
                localStorage.clear();
                location.reload();
            }
        };

        /* --- [3] DRIVE ENGINE --- */
        const Drive = {
            load: async (id) => {
                document.getElementById('file-container').innerHTML = '<div style="text-align:center; padding:20px; color:#aaa">Loading...</div>';
                STATE.currFolder = id;
                Drive.updateBreadcrumb();
                
                // Back Button Logic
                history.pushState({folderId: id}, null, "");

                const q = `'${id}' in parents and trashed = false`;
                const fields = "files(id,name,mimeType,size,iconLink,thumbnailLink,webViewLink,webContentLink)";
                const url = `https://www.googleapis.com/drive/v3/files?q=${encodeURIComponent(q)}&fields=${encodeURIComponent(fields)}&orderBy=folder,name&pageSize=1000`;

                try {
                    const res = await fetch(url, { headers: { 'Authorization': `Bearer ${STATE.token}` } });
                    const data = await res.json();
                    STATE.files = data.files || [];
                    Drive.render(STATE.files);
                } catch(e) {
                    console.error(e);
                    document.getElementById('file-container').innerHTML = 'Error loading files';
                }
            },
            render: (files) => {
                const con = document.getElementById('file-container');
                con.innerHTML = "";
                
                if(files.length === 0) {
                    con.innerHTML = '<div style="text-align:center; padding:50px; color:#aaa"><span class="material-icons-round" style="font-size:48px; display:block">folder_open</span>Empty</div>';
                    return;
                }

                files.forEach(f => {
                    const isDir = f.mimeType === 'application/vnd.google-apps.folder';
                    const el = document.createElement('div');
                    el.className = STATE.viewMode === 'list' ? 'list-item' : 'grid-item';
                    
                    let icon = isDir ? 'folder' : 'insert_drive_file';
                    if(f.mimeType.includes('image')) icon = 'image';
                    else if(f.mimeType.includes('video')) icon = 'movie';
                    else if(f.mimeType.includes('pdf')) icon = 'picture_as_pdf';

                    // Using thumbnail if available for Grid View images
                    let iconHtml = `<span class="material-icons-round item-icon ${isDir?'folder-icon':''}">${icon}</span>`;
                    if(STATE.viewMode === 'grid' && f.thumbnailLink && !isDir) {
                         iconHtml = `<img src="${f.thumbnailLink}" style="width:100%; height:100px; object-fit:cover; border-radius:4px; margin-bottom:5px;">`;
                    }

                    el.innerHTML = `
                        ${iconHtml}
                        <div class="item-text">
                            <span class="item-name">${f.name}</span>
                            <span class="item-meta">${isDir ? 'Folder' : Ops.fmtSize(f.size)}</span>
                        </div>
                        <span class="material-icons-round" style="color:var(--text-sec); padding:10px;" onclick="event.stopPropagation(); Ops.menu('${f.id}')">more_vert</span>
                    `;
                    el.onclick = () => isDir ? Drive.load(f.id) : Ops.menu(f.id);
                    con.appendChild(el);
                });
            },
            search: (query) => {
                if(!query) { Drive.render(STATE.files); return; }
                const filtered = STATE.files.filter(f => f.name.toLowerCase().includes(query.toLowerCase()));
                Drive.render(filtered);
            },
            sort: () => {
                STATE.files.reverse(); // Simple toggle sort
                Drive.render(STATE.files);
            },
            updateBreadcrumb: () => {
                const b = document.getElementById('breadcrumb');
                if(STATE.currFolder === 'root') b.innerText = "My Drive";
                else if(STATE.currFolder === CONFIG.vaultId) b.innerText = "Vault";
                else b.innerText = "... / Folder";
            },
            goBack: () => {
                // Handled by popstate, but button trigger:
                history.back();
            }
        };

        // Handle Browser Back Button
        window.onpopstate = (e) => {
            if(e.state && e.state.folderId) {
                Drive.load(e.state.folderId);
            } else {
                // If history is empty, exit or stay at root
            }
        };

        /* --- [4] UPLOAD ENGINE (WITH PROGRESS) --- */
        const Upload = {
            handleFiles: (files) => {
                if(!files.length) return;
                UI.toggleFab(); // Close menu
                Upload.processQueue(Array.from(files));
            },
            processQueue: async (files) => {
                const modal = document.getElementById('progress-modal');
                const pTitle = document.getElementById('prog-title');
                const pBar = document.getElementById('prog-bar');
                const pPct = document.getElementById('prog-pct');
                const pDet = document.getElementById('prog-details');
                
                modal.style.display = 'block';

                for (let i = 0; i < files.length; i++) {
                    const file = files[i];
                    pTitle.innerText = `Uploading ${i+1}/${files.length}`;
                    
                    // 1. Metadata
                    const meta = { name: file.name, mimeType: file.type, parents: [STATE.currFolder] };
                    
                    try {
                        const init = await fetch('https://www.googleapis.com/upload/drive/v3/files?uploadType=resumable', {
                            method: 'POST',
                            headers: { 'Authorization': `Bearer ${STATE.token}`, 'Content-Type': 'application/json' },
                            body: JSON.stringify(meta)
                        });
                        const location = init.headers.get('Location');

                        // 2. Upload with XHR for Progress
                        await new Promise((resolve, reject) => {
                            const xhr = new XMLHttpRequest();
                            xhr.open('PUT', location, true);
                            xhr.setRequestHeader('Content-Type', file.type);
                            
                            xhr.upload.onprogress = (e) => {
                                if (e.lengthComputable) {
                                    const percent = (e.loaded / e.total) * 100;
                                    pBar.style.width = percent + '%';
                                    pPct.innerText = Math.floor(percent) + '%';
                                    pDet.innerText = `${Ops.fmtSize(e.loaded)} / ${Ops.fmtSize(e.total)}`;
                                }
                            };
                            
                            xhr.onload = () => { if(xhr.status === 200 || xhr.status === 201) resolve(); else reject(); };
                            xhr.onerror = reject;
                            xhr.send(file);
                        });

                    } catch(e) {
                        console.error("Upload Fail", e);
                        alert(`Failed: ${file.name}`);
                    }
                }
                
                modal.style.display = 'none';
                Drive.load(STATE.currFolder); // Refresh
            }
        };

        /* --- [5] OPERATIONS & PREVIEW --- */
        const Ops = {
            menu: (id) => {
                STATE.selected = STATE.files.find(f => f.id === id);
                document.getElementById('ctx-name').innerText = STATE.selected.name;
                document.getElementById('ctx-modal').style.display = 'flex';
            },
            preview: () => {
                UI.closeModal('ctx-modal');
                const f = STATE.selected;

                // Check Settings for External Player force
                if(STATE.settings.extPlayer) {
                    Ops.openExternal();
                    return;
                }

                // Internal Preview Logic
                // Use Google's Embed URL which supports 90% of file types
                const embedUrl = `https://drive.google.com/file/d/${f.id}/preview`;
                
                document.getElementById('media-title').innerText = f.name;
                document.getElementById('media-frame').src = embedUrl;
                document.getElementById('media-view').style.display = 'flex';
            },
            openExternal: () => {
                window.open(STATE.selected.webViewLink, '_blank');
            },
            download: () => {
                window.open(STATE.selected.webContentLink, '_blank');
            },
            copyLink: () => {
                navigator.clipboard.writeText(STATE.selected.webViewLink);
                UI.closeModal('ctx-modal');
                alert("Link Copied!");
            },
            info: () => {
                const f = STATE.selected;
                alert(`Name: ${f.name}\nSize: ${Ops.fmtSize(f.size)}\nType: ${f.mimeType}\nCreated: ${new Date().toLocaleDateString()}`); // API doesn't send date in default fields, simplified
            },
            delete: async () => {
                if(!confirm("Move to trash?")) return;
                UI.closeModal('ctx-modal');
                await fetch(`https://www.googleapis.com/drive/v3/files/${STATE.selected.id}`, {
                    method: 'PATCH',
                    headers: {'Authorization': `Bearer ${STATE.token}`, 'Content-Type': 'application/json'},
                    body: JSON.stringify({trashed: true})
                });
                Drive.load(STATE.currFolder);
            },
            createFolder: async () => {
                const name = prompt("Folder Name:");
                if(!name) return;
                await fetch('https://www.googleapis.com/drive/v3/files', {
                    method: 'POST',
                    headers: {'Authorization': `Bearer ${STATE.token}`, 'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        name: name,
                        mimeType: 'application/vnd.google-apps.folder',
                        parents: [STATE.currFolder]
                    })
                });
                Drive.load(STATE.currFolder);
                UI.toggleFab();
            },
            fmtSize: (bytes) => {
                if(!bytes || bytes == 0) return '0 B';
                const i = Math.floor(Math.log(bytes) / Math.log(1024));
                return (bytes / Math.pow(1024, i)).toFixed(2) + ' ' + ['B','KB','MB','GB'][i];
            }
        };

        /* --- [6] UI CONTROLLER --- */
        const UI = {
            switchScreen: (id) => {
                document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
                document.getElementById(id).classList.add('active');
            },
            toggleFab: () => {
                const m = document.getElementById('fab-menu');
                m.style.display = m.style.display === 'flex' ? 'none' : 'flex';
            },
            toggleView: () => {
                STATE.viewMode = STATE.viewMode === 'list' ? 'grid' : 'list';
                const c = document.getElementById('file-container');
                c.className = `file-viewer file-${STATE.viewMode}-view`;
                Drive.render(STATE.files);
                document.getElementById('view-toggle').innerText = STATE.viewMode === 'list' ? 'grid_view' : 'view_list';
            },
            closeModal: (id) => document.getElementById(id).style.display = 'none',
            closeMedia: () => {
                document.getElementById('media-view').style.display = 'none';
                document.getElementById('media-frame').src = "";
            }
        };

        const Nav = {
            switchTab: (tab, el) => {
                document.querySelectorAll('.nav-item').forEach(e => e.classList.remove('active'));
                el.classList.add('active');
                if(tab === 'user') Drive.load('root');
                if(tab === 'vault') Drive.load(CONFIG.vaultId);
                // Starred not implemented in this demo, redirect root
                if(tab === 'starred') Drive.load('root'); 
            }
        };

        const Settings = {
            open: () => {
                document.getElementById('ext-player-toggle').checked = STATE.settings.extPlayer;
                document.getElementById('settings-modal').style.display = 'flex';
            },
            save: () => {
                STATE.settings.extPlayer = document.getElementById('ext-player-toggle').checked;
                localStorage.setItem('d_settings', JSON.stringify(STATE.settings));
            },
            storageInfo: async () => {
                const r = await fetch('https://www.googleapis.com/drive/v3/about?fields=storageQuota', {
                    headers: {'Authorization': `Bearer ${STATE.token}`}
                });
                const d = await r.json();
                const u = Ops.fmtSize(d.storageQuota.usage);
                const l = Ops.fmtSize(d.storageQuota.limit);
                alert(`Storage: ${u} used of ${l}`);
            }
        };

        // Init
        window.onload = () => {
            if(!localStorage.getItem('app_pin')) {
                alert("Please Create a PIN");
            }
            Auth.init();
        };

    </script>
</body>
</html>