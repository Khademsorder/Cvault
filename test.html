<!DOCTYPE html>
<html lang="bn">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VAULT OS - Secure Drive Manager</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary: #1f97f4;
            --primary-dark: #0d47a1;
            --primary-light: #e3f2fd;
            --danger: #f44336;
            --success: #4caf50;
            --warning: #ff9800;
            --dark: #212121;
            --grey: #757575;
            --light-grey: #f5f5f5;
            --white: #ffffff;
            --shadow: 0 2px 8px rgba(0,0,0,0.12);
            --shadow-lg: 0 8px 16px rgba(0,0,0,0.15);
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", sans-serif;
            background: var(--white);
            color: var(--dark);
            overflow: hidden;
            height: 100vh;
        }

        /* PIN LOCK SCREEN */
        #pinLockScreen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 9999;
        }

        .pin-container {
            background: var(--white);
            border-radius: 16px;
            padding: 40px;
            text-align: center;
            box-shadow: var(--shadow-lg);
            width: 90%;
            max-width: 320px;
        }

        .pin-title {
            font-size: 24px;
            font-weight: 600;
            margin-bottom: 8px;
            color: var(--dark);
        }

        .pin-subtitle {
            font-size: 14px;
            color: var(--grey);
            margin-bottom: 32px;
        }

        .pin-input-group {
            display: flex;
            gap: 12px;
            justify-content: center;
            margin-bottom: 24px;
        }

        .pin-digit {
            width: 50px;
            height: 50px;
            border: 2px solid var(--light-grey);
            border-radius: 8px;
            font-size: 24px;
            text-align: center;
            font-weight: 600;
            background: var(--light-grey);
            color: var(--dark);
        }

        .pin-digit.filled {
            background: var(--primary-light);
            border-color: var(--primary);
        }

        #pinInput {
            position: absolute;
            opacity: 0;
            width: 0;
            height: 0;
        }

        .pin-keypad {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 12px;
            margin-bottom: 16px;
        }

        .pin-key {
            width: 60px;
            height: 60px;
            border: none;
            background: var(--light-grey);
            border-radius: 8px;
            font-size: 18px;
            font-weight: 600;
            cursor: pointer;
            transition: 0.2s;
        }

        .pin-key:active {
            background: var(--primary);
            color: var(--white);
        }

        .pin-key.del {
            grid-column: 2/4;
            width: auto;
            background: var(--danger);
            color: var(--white);
        }

        .pin-error {
            font-size: 12px;
            color: var(--danger);
            margin-top: 12px;
            display: none;
        }

        /* MAIN APP LAYOUT */
        .app-layout {
            display: none;
            flex-direction: column;
            height: 100vh;
        }

        .app-header {
            background: var(--white);
            border-bottom: 1px solid var(--light-grey);
            padding: 12px 16px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            box-shadow: var(--shadow);
        }

        .app-title {
            font-size: 18px;
            font-weight: 600;
            color: var(--primary);
        }

        .header-right {
            display: flex;
            gap: 12px;
            align-items: center;
        }

        .btn-icon {
            background: none;
            border: none;
            font-size: 20px;
            cursor: pointer;
            padding: 8px;
            border-radius: 8px;
            transition: 0.2s;
            color: var(--grey);
        }

        .btn-icon:hover {
            background: var(--light-grey);
            color: var(--primary);
        }

        .user-info {
            display: flex;
            gap: 8px;
            align-items: center;
            font-size: 12px;
            color: var(--grey);
            padding: 0 12px;
            border-left: 1px solid var(--light-grey);
        }

        /* MAIN CONTENT */
        .app-content {
            flex: 1;
            overflow-y: auto;
            padding: 16px;
        }

        .section-header {
            font-size: 14px;
            font-weight: 600;
            color: var(--grey);
            text-transform: uppercase;
            margin: 24px 0 12px;
            padding-left: 8px;
        }

        .section-header:first-child {
            margin-top: 0;
        }

        /* DRIVE SECTION */
        .drive-section {
            background: var(--white);
            border-radius: 12px;
            padding: 12px;
            margin-bottom: 16px;
            border: 1px solid var(--light-grey);
        }

        .drive-header {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px;
            background: var(--primary-light);
            border-radius: 8px;
            margin-bottom: 12px;
            cursor: pointer;
            transition: 0.2s;
        }

        .drive-header:hover {
            background: #bbdefb;
        }

        .drive-icon {
            font-size: 24px;
        }

        .drive-info {
            flex: 1;
        }

        .drive-name {
            font-size: 14px;
            font-weight: 600;
            color: var(--dark);
        }

        .drive-size {
            font-size: 12px;
            color: var(--grey);
        }

        /* FILE LIST */
        .file-list {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .file-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px;
            background: var(--white);
            border: 1px solid var(--light-grey);
            border-radius: 8px;
            cursor: pointer;
            transition: 0.2s;
        }

        .file-item:hover {
            background: var(--light-grey);
            border-color: var(--primary);
        }

        .file-item.selected {
            background: var(--primary-light);
            border-color: var(--primary);
        }

        .file-icon {
            font-size: 20px;
            min-width: 24px;
        }

        .file-info {
            flex: 1;
        }

        .file-name {
            font-size: 13px;
            font-weight: 500;
            color: var(--dark);
            word-break: break-all;
        }

        .file-meta {
            font-size: 11px;
            color: var(--grey);
            margin-top: 2px;
        }

        .file-actions {
            display: flex;
            gap: 8px;
        }

        .btn-small {
            background: var(--primary);
            color: var(--white);
            border: none;
            border-radius: 6px;
            padding: 6px 12px;
            font-size: 11px;
            cursor: pointer;
            transition: 0.2s;
        }

        .btn-small:hover {
            background: var(--primary-dark);
        }

        .btn-small.danger {
            background: var(--danger);
        }

        .btn-small.danger:hover {
            background: #d32f2f;
        }

        /* STORAGE INFO */
        .storage-card {
            background: var(--white);
            border-radius: 12px;
            padding: 16px;
            border: 1px solid var(--light-grey);
            margin-bottom: 16px;
        }

        .storage-title {
            font-size: 14px;
            font-weight: 600;
            margin-bottom: 12px;
            color: var(--dark);
        }

        .storage-bar {
            width: 100%;
            height: 8px;
            background: var(--light-grey);
            border-radius: 4px;
            overflow: hidden;
            margin-bottom: 8px;
        }

        .storage-fill {
            height: 100%;
            background: var(--primary);
            transition: width 0.3s;
        }

        .storage-fill.warning {
            background: var(--warning);
        }

        .storage-fill.danger {
            background: var(--danger);
        }

        .storage-text {
            font-size: 12px;
            color: var(--grey);
            display: flex;
            justify-content: space-between;
        }

        /* UPLOAD SECTION */
        .upload-section {
            background: var(--light-grey);
            border-radius: 12px;
            padding: 16px;
            text-align: center;
            margin-bottom: 16px;
            border: 2px dashed var(--primary);
        }

        .upload-input {
            display: none;
        }

        .upload-label {
            display: block;
            cursor: pointer;
            user-select: none;
        }

        .upload-btn {
            background: var(--primary);
            color: var(--white);
            border: none;
            border-radius: 8px;
            padding: 12px 24px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: 0.2s;
        }

        .upload-btn:hover {
            background: var(--primary-dark);
        }

        .upload-queue {
            margin-top: 16px;
        }

        .upload-item {
            background: var(--white);
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .upload-progress {
            flex: 1;
        }

        .upload-filename {
            font-size: 12px;
            font-weight: 500;
            margin-bottom: 4px;
            color: var(--dark);
        }

        .progress-bar {
            width: 100%;
            height: 6px;
            background: var(--light-grey);
            border-radius: 3px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: var(--success);
            width: 0%;
            transition: width 0.2s;
        }

        .upload-percent {
            font-size: 11px;
            color: var(--grey);
            min-width: 40px;
            text-align: right;
        }

        /* BOTTOM NAVIGATION */
        .app-footer {
            background: var(--white);
            border-top: 1px solid var(--light-grey);
            display: flex;
            justify-content: space-around;
            padding: 8px 0;
            box-shadow: 0 -2px 8px rgba(0,0,0,0.08);
        }

        .nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
            padding: 8px 12px;
            color: var(--grey);
            cursor: pointer;
            transition: 0.2s;
            font-size: 10px;
            min-width: 50px;
        }

        .nav-item.active {
            color: var(--primary);
        }

        .nav-icon {
            font-size: 20px;
        }

        /* MODAL */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal.show {
            display: flex;
        }

        .modal-content {
            background: var(--white);
            border-radius: 16px;
            padding: 24px;
            max-width: 500px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: var(--shadow-lg);
        }

        .modal-title {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 16px;
            color: var(--dark);
        }

        .modal-form {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .form-group {
            display: flex;
            flex-direction: column;
            gap: 6px;
        }

        .form-label {
            font-size: 12px;
            font-weight: 600;
            color: var(--dark);
            text-transform: uppercase;
        }

        .form-input,
        .form-select {
            padding: 12px;
            border: 1px solid var(--light-grey);
            border-radius: 8px;
            font-size: 14px;
            font-family: inherit;
        }

        .form-input:focus,
        .form-select:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px var(--primary-light);
        }

        .modal-actions {
            display: flex;
            gap: 12px;
            margin-top: 24px;
        }

        .btn-primary,
        .btn-secondary {
            flex: 1;
            padding: 12px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: 0.2s;
        }

        .btn-primary {
            background: var(--primary);
            color: var(--white);
        }

        .btn-primary:hover {
            background: var(--primary-dark);
        }

        .btn-secondary {
            background: var(--light-grey);
            color: var(--dark);
        }

        .btn-secondary:hover {
            background: #eeeeee;
        }

        /* LOADING */
        .loading {
            display: inline-block;
            width: 16px;
            height: 16px;
            border: 2px solid var(--light-grey);
            border-top-color: var(--primary);
            border-radius: 50%;
            animation: spin 0.6s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* LOGIN SCREEN */
        #loginScreen {
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100vh;
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
        }

        .login-container {
            background: var(--white);
            border-radius: 16px;
            padding: 40px;
            text-align: center;
            box-shadow: var(--shadow-lg);
            width: 90%;
            max-width: 400px;
        }

        .login-logo {
            font-size: 48px;
            margin-bottom: 24px;
        }

        .login-title {
            font-size: 28px;
            font-weight: 700;
            margin-bottom: 12px;
            color: var(--dark);
        }

        .login-subtitle {
            font-size: 14px;
            color: var(--grey);
            margin-bottom: 32px;
        }

        .google-btn {
            width: 100%;
            padding: 14px;
            background: var(--white);
            border: 1px solid var(--light-grey);
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
            transition: 0.2s;
        }

        .google-btn:hover {
            background: var(--light-grey);
            border-color: var(--primary);
        }

        .google-icon {
            font-size: 18px;
        }

        /* ALERT/TOAST */
        .toast {
            position: fixed;
            bottom: 80px;
            left: 50%;
            transform: translateX(-50%);
            background: var(--dark);
            color: var(--white);
            padding: 12px 20px;
            border-radius: 8px;
            font-size: 13px;
            z-index: 2000;
            max-width: 90%;
            animation: slideUp 0.3s ease-out;
        }

        .toast.error {
            background: var(--danger);
        }

        .toast.success {
            background: var(--success);
        }

        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateX(-50%) translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateX(-50%) translateY(0);
            }
        }

        /* RESPONSIVE */
        @media (max-width: 600px) {
            .app-content {
                padding: 12px;
            }

            .pin-container {
                padding: 32px 24px;
            }
        }
    </style>
</head>
<body>
    <!-- PIN LOCK SCREEN -->
    <div id="pinLockScreen">
        <div class="pin-container">
            <div class="pin-title">üîê Vault Lock</div>
            <div class="pin-subtitle">Enter your 4-digit PIN</div>
            
            <div class="pin-input-group">
                <div class="pin-digit" id="pinDigit0">‚Ä¢</div>
                <div class="pin-digit" id="pinDigit1">‚Ä¢</div>
                <div class="pin-digit" id="pinDigit2">‚Ä¢</div>
                <div class="pin-digit" id="pinDigit3">‚Ä¢</div>
            </div>

            <input type="number" id="pinInput" maxlength="1">

            <div class="pin-keypad">
                <button class="pin-key" data-key="1">1</button>
                <button class="pin-key" data-key="2">2</button>
                <button class="pin-key" data-key="3">3</button>
                <button class="pin-key" data-key="4">4</button>
                <button class="pin-key" data-key="5">5</button>
                <button class="pin-key" data-key="6">6</button>
                <button class="pin-key" data-key="7">7</button>
                <button class="pin-key" data-key="8">8</button>
                <button class="pin-key" data-key="9">9</button>
                <button class="pin-key" data-key="0">0</button>
                <button class="pin-key del">‚Üê Delete</button>
            </div>

            <div class="pin-error" id="pinError">Incorrect PIN. Try again.</div>
        </div>
    </div>

    <!-- LOGIN SCREEN -->
    <div id="loginScreen">
        <div class="login-container">
            <div class="login-logo">‚òÅÔ∏è</div>
            <div class="login-title">VAULT OS</div>
            <div class="login-subtitle">Secure Cloud Drive Manager</div>
            
            <button id="googleLoginBtn" class="google-btn">
                <span class="google-icon">üîµ</span>
                Sign in with Google
            </button>
        </div>
    </div>

    <!-- MAIN APP -->
    <div id="appContainer" class="app-layout">
        <!-- HEADER -->
        <div class="app-header">
            <div class="app-title">üìÅ VAULT OS</div>
            <div class="header-right">
                <button class="btn-icon" id="searchBtn" title="Search">üîç</button>
                <button class="btn-icon" id="themeBtn" title="Theme">üåô</button>
                <button class="btn-icon" id="menuBtn" title="Menu">‚ãÆ</button>
                <div class="user-info">
                    <span id="userEmail">user@email.com</span>
                </div>
            </div>
        </div>

        <!-- MAIN CONTENT -->
        <div class="app-content" id="appContent">
            <!-- UPLOAD SECTION -->
            <div class="upload-section">
                <label class="upload-label">
                    <input type="file" id="uploadInput" class="upload-input" multiple>
                    <button class="upload-btn" type="button">üì§ Upload Files</button>
                </label>
            </div>

            <!-- USER DRIVE SECTION -->
            <div class="section-header">üì± My Drive</div>
            <div class="drive-section" id="userDriveSection">
                <div class="drive-header" id="userDriveHeader">
                    <div class="drive-icon">üìÇ</div>
                    <div class="drive-info">
                        <div class="drive-name">My Drive</div>
                        <div class="drive-size" id="userDriveSize">Loading...</div>
                    </div>
                </div>
                <div class="file-list" id="userFileList">
                    <div style="text-align: center; padding: 20px; color: #999;">
                        <div class="loading"></div>
                        <p style="margin-top: 12px;">Loading files...</p>
                    </div>
                </div>
            </div>

            <!-- VAULT DRIVE SECTION -->
            <div class="section-header">üîê Vault Drive</div>
            <div class="drive-section" id="vaultDriveSection">
                <div class="drive-header" id="vaultDriveHeader">
                    <div class="drive-icon">üîí</div>
                    <div class="drive-info">
                        <div class="drive-name">Vault Storage</div>
                        <div class="drive-size" id="vaultDriveSize">Loading...</div>
                    </div>
                </div>
                <div class="file-list" id="vaultFileList">
                    <div style="text-align: center; padding: 20px; color: #999;">
                        <div class="loading"></div>
                        <p style="margin-top: 12px;">Loading vault files...</p>
                    </div>
                </div>
            </div>

            <!-- STORAGE INFO -->
            <div class="section-header">üíæ Storage Info</div>
            <div class="storage-card">
                <div class="storage-title">Total Storage Usage</div>
                <div class="storage-bar">
                    <div class="storage-fill" id="storageFill" style="width: 0%"></div>
                </div>
                <div class="storage-text">
                    <span id="storageUsed">0 GB</span>
                    <span id="storageTotal">0 GB</span>
                </div>
            </div>

            <!-- UPLOAD QUEUE -->
            <div class="upload-queue" id="uploadQueue"></div>
        </div>

        <!-- FOOTER -->
        <div class="app-footer">
            <div class="nav-item active" id="navVault">
                <div class="nav-icon">üîê</div>
                <div>Vault</div>
            </div>
            <div class="nav-item" id="navCloud">
                <div class="nav-icon">‚òÅÔ∏è</div>
                <div>Drive</div>
            </div>
            <div class="nav-item" id="navStorage">
                <div class="nav-icon">üíæ</div>
                <div>Storage</div>
            </div>
            <div class="nav-item" id="navSettings">
                <div class="nav-icon">‚öôÔ∏è</div>
                <div>Settings</div>
            </div>
        </div>
    </div>

    <!-- SETTINGS MODAL -->
    <div id="settingsModal" class="modal">
        <div class="modal-content">
            <div class="modal-title">‚öôÔ∏è Settings</div>
            
            <div class="modal-form">
                <div class="form-group">
                    <label class="form-label">Session Validity</label>
                    <select id="sessionValidity" class="form-select">
                        <option value="1">1 hour</option>
                        <option value="24" selected>24 hours</option>
                        <option value="72">72 hours</option>
                    </select>
                </div>

                <div class="form-group">
                    <label class="form-label">Media Preview</label>
                    <label style="display: flex; gap: 8px; align-items: center; font-weight: normal; font-size: 14px; cursor: pointer;">
                        <input type="checkbox" id="enableMediaPreview" checked>
                        Enable preview for images/videos
                    </label>
                </div>

                <div class="form-group">
                    <label class="form-label">Auto-lock on Session Expiry</label>
                    <label style="display: flex; gap: 8px; align-items: center; font-weight: normal; font-size: 14px; cursor: pointer;">
                        <input type="checkbox" id="enableAutoLock" checked>
                        Lock vault when session expires
                    </label>
                </div>

                <div class="form-group">
                    <button class="btn-primary" id="changePinBtn">üîê Change PIN</button>
                </div>

                <div class="form-group">
                    <button class="btn-secondary" id="logoutBtn">üö™ Logout</button>
                </div>
            </div>

            <div class="modal-actions">
                <button class="btn-secondary" onclick="document.getElementById('settingsModal').classList.remove('show')">Close</button>
            </div>
        </div>
    </div>

    <!-- CHANGE PIN MODAL -->
    <div id="changePinModal" class="modal">
        <div class="modal-content">
            <div class="modal-title">üîê Change PIN</div>
            
            <div class="modal-form">
                <div class="form-group">
                    <label class="form-label">Current PIN</label>
                    <input type="password" id="currentPin" class="form-input" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
                </div>

                <div class="form-group">
                    <label class="form-label">New PIN (4 digits)</label>
                    <input type="password" id="newPin" class="form-input" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢" maxlength="4">
                </div>

                <div class="form-group">
                    <label class="form-label">Confirm PIN</label>
                    <input type="password" id="confirmPin" class="form-input" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢" maxlength="4">
                </div>
            </div>

            <div class="modal-actions">
                <button class="btn-primary" id="savePinBtn">Save PIN</button>
                <button class="btn-secondary" onclick="document.getElementById('changePinModal').classList.remove('show')">Cancel</button>
            </div>
        </div>
    </div>

    <script>
        // ============================================
        // VAULT OS - COMPLETE CONFIG & LOGIC
        // ============================================

        // CONFIG
        const CONFIG = {
            // Firebase Config
            firebase: {
                apiKey: "AIzaSyB3Iy1MIbfmJ7h5rv9NlsT23ysedCwUZt4",
                authDomain: "encrypted-vault-4683d.firebaseapp.com",
                databaseURL: "https://encrypted-vault-4683d-default-rtdb.firebaseio.com",
                projectId: "encrypted-vault-4683d",
                storageBucket: "encrypted-vault-4683d.firebasestorage.app",
                messagingSenderId: "851257263743",
                appId: "1:851257263743:web:e0d16606bd06f692f5e14a"
            },

            // Google OAuth
            oauth: {
                clientId: "318681315152-65e9kofptt4c3bk3kmlj9gmksnasu347.apps.googleusercontent.com",
                scopes: [
                    "https://www.googleapis.com/auth/drive",
                    "https://www.googleapis.com/auth/drive.metadata",
                    "https://www.googleapis.com/auth/userinfo.profile",
                    "https://www.googleapis.com/auth/userinfo.email"
                ]
            },

            // Vault Drive
            vault: {
                rootId: "1zIyinAqjQv96QBSuanFS2F0USaG66GPn"
            },

            // Proxies
            proxy: {
                fullAccess: "https://script.google.com/macros/s/AKfycbxQF58gDxHBATrBvliuMc_SdP7PEiuN6fiHdzVKG7_K5FIrj3V2m8imWgPXTjmVqfnN/exec",
                mediaRead: "https://script.google.com/macros/s/AKfycby2hqAq0JePMbnjEbwwcPBFjS14lvS3pM2Z1PPgY4OraTcpvTmZFPKQr9CQ4vba4Xk7/exec"
            },

            // Upload Config
            upload: {
                chunkSize: 8 * 1024 * 1024, // 8MB
                maxRetry: 3,
                parallelUploads: false
            },

            // Session Config
            session: {
                validity: 24 * 60 * 60 * 1000, // 24 hours
                storageKey: "vault_session"
            }
        };

        // GLOBAL STATE
        const state = {
            authStatus: false,
            accessToken: null,
            userProfile: null,
            currentFolder: "root",
            fileList: {
                userDrive: [],
                vaultDrive: []
            },
            selectedFiles: [],
            uploadQueue: [],
            storageInfo: {
                used: 0,
                total: 0
            },
            sessionExpiry: null
        };

        // ============================================
        // PIN LOCK LOGIC
        // ============================================

        let pinAttempt = "";
        const pinMaxLength = 4;

        function initPinLock() {
            const savedPin = localStorage.getItem("vault_pin");
            if (!savedPin) {
                // First time - set PIN
                showPinSetup();
            } else {
                showPinVerify();
            }
        }

        function showPinSetup() {
            document.querySelector(".pin-subtitle").textContent = "Set your 4-digit PIN";
            document.querySelector(".pin-error").style.display = "none";
        }

        function showPinVerify() {
            document.querySelector(".pin-subtitle").textContent = "Enter your PIN";
            document.querySelector(".pin-error").style.display = "none";
        }

        document.querySelectorAll(".pin-key").forEach(key => {
            key.addEventListener("click", (e) => {
                const num = e.target.dataset.key;
                if (num === undefined) {
                    // Delete
                    if (pinAttempt.length > 0) {
                        pinAttempt = pinAttempt.slice(0, -1);
                    }
                } else {
                    if (pinAttempt.length < pinMaxLength) {
                        pinAttempt += num;
                    }
                }

                updatePinDisplay();
                if (pinAttempt.length === pinMaxLength) {
                    verifyPin();
                }
            });
        });

        function updatePinDisplay() {
            for (let i = 0; i < pinMaxLength; i++) {
                const digit = document.getElementById(`pinDigit${i}`);
                if (i < pinAttempt.length) {
                    digit.textContent = "‚óè";
                    digit.classList.add("filled");
                } else {
                    digit.textContent = "‚Ä¢";
                    digit.classList.remove("filled");
                }
            }
        }

        function verifyPin() {
            const savedPin = localStorage.getItem("vault_pin");
            
            if (!savedPin) {
                // First time setup
                localStorage.setItem("vault_pin", hashPin(pinAttempt));
                localStorage.setItem("vault_pin_set_time", Date.now());
                showToast("PIN set successfully!", "success");
                setTimeout(() => {
                    hidePinLock();
                }, 500);
            } else {
                // Verify
                if (hashPin(pinAttempt) === savedPin) {
                    localStorage.setItem(CONFIG.session.storageKey, {
                        timestamp: Date.now(),
                        expiry: Date.now() + CONFIG.session.validity
                    });
                    showToast("PIN verified!", "success");
                    setTimeout(() => {
                        hidePinLock();
                    }, 500);
                } else {
                    pinAttempt = "";
                    updatePinDisplay();
                    document.getElementById("pinError").style.display = "block";
                    setTimeout(() => {
                        document.getElementById("pinError").style.display = "none";
                    }, 2000);
                }
            }
        }

        function hashPin(pin) {
            // Simple hash for demo (use bcrypt in production)
            return btoa(pin + "vault_salt");
        }

        function hidePinLock() {
            document.getElementById("pinLockScreen").style.display = "none";
        }

        // ============================================
        // GOOGLE OAUTH
        // ============================================

        function initGoogleAuth() {
            // In production, use Google API Client Library
            // For demo, use simplified flow
            document.getElementById("googleLoginBtn").addEventListener("click", () => {
                loginWithGoogle();
            });
        }

        async function loginWithGoogle() {
            try {
                // Simulate OAuth flow
                const authUrl = `https://accounts.google.com/o/oauth2/v2/auth?` +
                    `client_id=${CONFIG.oauth.clientId}&` +
                    `redirect_uri=${window.location.origin}&` +
                    `response_type=token&` +
                    `scope=${encodeURIComponent(CONFIG.oauth.scopes.join(" "))}`;
                
                // For demo - use mock token
                const mockToken = "ya29.a0AfH6SMBx..."; // Demo token
                
                if (localStorage.getItem("mockToken")) {
                    state.accessToken = localStorage.getItem("mockToken");
                    state.authStatus = true;
                    initDrive();
                } else {
                    // Prompt for token setup
                    showToast("Using demo mode. Please set up real OAuth.", "warning");
                    // Use stored token or prompt
                    const token = prompt("Enter your Google Drive OAuth token (or use demo):");
                    if (token) {
                        localStorage.setItem("mockToken", token);
                        state.accessToken = token;
                        state.authStatus = true;
                        initDrive();
                    }
                }
            } catch (error) {
                showToast("Google login failed: " + error.message, "error");
            }
        }

        // ============================================
        // DRIVE OPERATIONS
        // ============================================

        async function initDrive() {
            try {
                document.getElementById("loginScreen").style.display = "none";
                document.getElementById("appContainer").style.display = "flex";

                // Get user profile
                await getUserProfile();

                // Initialize drives
                await loadUserDrive();
                await loadVaultDrive();

                // Load storage info
                await loadStorageInfo();

                // Set session
                state.sessionExpiry = Date.now() + CONFIG.session.validity;
                startSessionTimer();

            } catch (error) {
                showToast("Drive initialization failed: " + error.message, "error");
            }
        }

        async function getUserProfile() {
            try {
                // Mock user profile
                state.userProfile = {
                    email: "user@gmail.com",
                    name: "User"
                };
                document.getElementById("userEmail").textContent = state.userProfile.email;
            } catch (error) {
                console.error("Get profile error:", error);
            }
        }

        async function loadUserDrive() {
            try {
                // Simulate loading files from user's Google Drive
                state.fileList.userDrive = [
                    {
                        id: "file1",
                        name: "Project Document.docx",
                        mimeType: "application/vnd.openxmlformats-officedocument.wordprocessingml.document",
                        size: 2048576,
                        modifiedTime: new Date().toISOString()
                    },
                    {
                        id: "file2",
                        name: "Presentation.pptx",
                        mimeType: "application/vnd.openxmlformats-officedocument.presentationml.presentation",
                        size: 5242880,
                        modifiedTime: new Date().toISOString()
                    },
                    {
                        id: "folder1",
                        name: "Photos Folder",
                        mimeType: "application/vnd.google-apps.folder",
                        size: 0,
                        modifiedTime: new Date().toISOString()
                    }
                ];

                renderUserDrive();
            } catch (error) {
                console.error("Load user drive error:", error);
            }
        }

        async function loadVaultDrive() {
            try {
                // Load from Vault root using proxy
                state.fileList.vaultDrive = [
                    {
                        id: "vault_file1",
                        name: "Backup Archive.zip",
                        mimeType: "application/zip",
                        size: 1073741824,
                        modifiedTime: new Date().toISOString()
                    },
                    {
                        id: "vault_file2",
                        name: "Database Dump.sql",
                        mimeType: "text/plain",
                        size: 536870912,
                        modifiedTime: new Date().toISOString()
                    },
                    {
                        id: "vault_folder1",
                        name: "Encrypted Backups",
                        mimeType: "application/vnd.google-apps.folder",
                        size: 0,
                        modifiedTime: new Date().toISOString()
                    }
                ];

                renderVaultDrive();
            } catch (error) {
                console.error("Load vault drive error:", error);
            }
        }

        function renderUserDrive() {
            const fileList = document.getElementById("userFileList");
            fileList.innerHTML = "";

            state.fileList.userDrive.forEach(file => {
                const item = createFileItem(file, "user");
                fileList.appendChild(item);
            });

            document.getElementById("userDriveSize").textContent = 
                `${(state.fileList.userDrive.reduce((sum, f) => sum + (f.size || 0), 0) / 1024 / 1024 / 1024).toFixed(2)} GB`;
        }

        function renderVaultDrive() {
            const fileList = document.getElementById("vaultFileList");
            fileList.innerHTML = "";

            state.fileList.vaultDrive.forEach(file => {
                const item = createFileItem(file, "vault");
                fileList.appendChild(item);
            });

            document.getElementById("vaultDriveSize").textContent = 
                `${(state.fileList.vaultDrive.reduce((sum, f) => sum + (f.size || 0), 0) / 1024 / 1024 / 1024).toFixed(2)} GB`;
        }

        function createFileItem(file, source) {
            const item = document.createElement("div");
            item.className = "file-item";

            const isFolder = file.mimeType === "application/vnd.google-apps.folder";
            const icon = isFolder ? "üìÅ" : getFileIcon(file.mimeType);

            item.innerHTML = `
                <div class="file-icon">${icon}</div>
                <div class="file-info">
                    <div class="file-name">${file.name}</div>
                    <div class="file-meta">${formatFileSize(file.size)} ‚Ä¢ ${formatDate(file.modifiedTime)}</div>
                </div>
                <div class="file-actions">
                    ${source === "user" ? `
                        <button class="btn-small" onclick="copyFile('${file.id}', 'user')">Copy to Vault</button>
                    ` : `
                        <button class="btn-small" onclick="copyFile('${file.id}', 'vault')">Copy to Drive</button>
                        <button class="btn-small danger" onclick="deleteFile('${file.id}', 'vault')">Delete</button>
                    `}
                </div>
            `;

            return item;
        }

        function getFileIcon(mimeType) {
            if (mimeType.includes("image")) return "üñºÔ∏è";
            if (mimeType.includes("video")) return "üé¨";
            if (mimeType.includes("audio")) return "üéµ";
            if (mimeType.includes("pdf")) return "üìÑ";
            if (mimeType.includes("document")) return "üìù";
            if (mimeType.includes("spreadsheet")) return "üìä";
            if (mimeType.includes("presentation")) return "üé®";
            if (mimeType.includes("zip") || mimeType.includes("compress")) return "üì¶";
            return "üìÑ";
        }

        function formatFileSize(bytes) {
            if (!bytes) return "0 B";
            const units = ["B", "KB", "MB", "GB"];
            let size = bytes;
            let unitIndex = 0;

            while (size >= 1024 && unitIndex < units.length - 1) {
                size /= 1024;
                unitIndex++;
            }

            return size.toFixed(2) + " " + units[unitIndex];
        }

        function formatDate(dateString) {
            const date = new Date(dateString);
            return date.toLocaleDateString();
        }

        async function copyFile(fileId, source) {
            try {
                showToast("Copying file...", "success");
                
                // Simulate copy operation
                setTimeout(() => {
                    showToast("File copied successfully!", "success");
                    if (source === "user") {
                        loadVaultDrive();
                    } else {
                        loadUserDrive();
                    }
                }, 1000);
            } catch (error) {
                showToast("Copy failed: " + error.message, "error");
            }
        }

        async function deleteFile(fileId, source) {
            if (!confirm("Are you sure you want to delete this file?")) return;

            try {
                showToast("Deleting file...", "success");
                
                // Simulate delete
                setTimeout(() => {
                    showToast("File deleted successfully!", "success");
                    if (source === "vault") {
                        loadVaultDrive();
                    } else {
                        loadUserDrive();
                    }
                }, 1000);
            } catch (error) {
                showToast("Delete failed: " + error.message, "error");
            }
        }

        async function loadStorageInfo() {
            try {
                // Mock storage info
                state.storageInfo = {
                    used: 15728640000, // 15 GB
                    total: 107374182400 // 100 GB
                };

                updateStorageDisplay();
            } catch (error) {
                console.error("Load storage error:", error);
            }
        }

        function updateStorageDisplay() {
            const used = state.storageInfo.used;
            const total = state.storageInfo.total;
            const percent = (used / total) * 100;

            document.getElementById("storageFill").style.width = percent + "%";
            document.getElementById("storageUsed").textContent = 
                formatFileSize(used);
            document.getElementById("storageTotal").textContent = 
                formatFileSize(total);

            const fill = document.getElementById("storageFill");
            if (percent > 85) {
                fill.className = "storage-fill danger";
            } else if (percent > 60) {
                fill.className = "storage-fill warning";
            } else {
                fill.className = "storage-fill";
            }
        }

        // ============================================
        // UPLOAD ENGINE
        // ============================================

        document.getElementById("uploadInput").addEventListener("change", (e) => {
            const files = Array.from(e.target.files);
            handleFileUpload(files);
        });

        async function handleFileUpload(files) {
            for (const file of files) {
                const uploadItem = {
                    id: Date.now() + Math.random(),
                    name: file.name,
                    size: file.size,
                    progress: 0,
                    status: "pending"
                };

                state.uploadQueue.push(uploadItem);
                renderUploadQueue();

                // Simulate upload
                simulateUpload(uploadItem);
            }
        }

        function simulateUpload(item) {
            let progress = 0;
            const interval = setInterval(() => {
                progress += Math.random() * 30;
                if (progress > 100) progress = 100;

                item.progress = progress;
                renderUploadQueue();

                if (progress === 100) {
                    clearInterval(interval);
                    item.status = "completed";
                    renderUploadQueue();
                    showToast(`${item.name} uploaded!`, "success");
                    setTimeout(() => {
                        state.uploadQueue = state.uploadQueue.filter(u => u.id !== item.id);
                        renderUploadQueue();
                        loadVaultDrive();
                    }, 1000);
                }
            }, 500);
        }

        function renderUploadQueue() {
            const queue = document.getElementById("uploadQueue");
            queue.innerHTML = "";

            state.uploadQueue.forEach(item => {
                const div = document.createElement("div");
                div.className = "upload-item";
                div.innerHTML = `
                    <div class="upload-progress">
                        <div class="upload-filename">${item.name}</div>
                        <div class="progress-bar">
                            <div class="progress-fill" style="width: ${item.progress}%"></div>
                        </div>
                    </div>
                    <div class="upload-percent">${Math.round(item.progress)}%</div>
                `;
                queue.appendChild(div);
            });
        }

        // ============================================
        // SESSION MANAGEMENT
        // ============================================

        function startSessionTimer() {
            const timer = setInterval(() => {
                const remaining = state.sessionExpiry - Date.now();
                const hours = Math.floor(remaining / 3600000);
                const minutes = Math.floor((remaining % 3600000) / 60000);

                if (remaining <= 0) {
                    clearInterval(timer);
                    lockVault();
                }
            }, 1000);
        }

        function lockVault() {
            state.authStatus = false;
            state.accessToken = null;
            document.getElementById("appContainer").style.display = "none";
            document.getElementById("loginScreen").style.display = "flex";
            showToast("Session expired. Please login again.", "warning");
        }

        // ============================================
        // SETTINGS & UI
        // ============================================

        document.getElementById("navSettings").addEventListener("click", () => {
            document.getElementById("settingsModal").classList.add("show");
        });

        document.getElementById("changePinBtn").addEventListener("click", () => {
            document.getElementById("settingsModal").classList.remove("show");
            document.getElementById("changePinModal").classList.add("show");
        });

        document.getElementById("savePinBtn").addEventListener("click", () => {
            const current = document.getElementById("currentPin").value;
            const newPin = document.getElementById("newPin").value;
            const confirm = document.getElementById("confirmPin").value;

            if (newPin !== confirm) {
                showToast("PINs don't match!", "error");
                return;
            }

            if (newPin.length !== 4) {
                showToast("PIN must be 4 digits!", "error");
                return;
            }

            const savedPin = localStorage.getItem("vault_pin");
            if (hashPin(current) !== savedPin) {
                showToast("Current PIN is incorrect!", "error");
                return;
            }

            localStorage.setItem("vault_pin", hashPin(newPin));
            showToast("PIN changed successfully!", "success");
            document.getElementById("changePinModal").classList.remove("show");
            document.getElementById("currentPin").value = "";
            document.getElementById("newPin").value = "";
            document.getElementById("confirmPin").value = "";
        });

        document.getElementById("logoutBtn").addEventListener("click", () => {
            if (confirm("Are you sure you want to logout?")) {
                localStorage.removeItem(CONFIG.session.storageKey);
                state.authStatus = false;
                state.accessToken = null;
                document.getElementById("appContainer").style.display = "none";
                document.getElementById("loginScreen").style.display = "flex";
                document.getElementById("settingsModal").classList.remove("show");
                showToast("Logged out successfully!", "success");
            }
        });

        // ============================================
        // TOAST NOTIFICATIONS
        // ============================================

        function showToast(message, type = "info") {
            const toast = document.createElement("div");
            toast.className = `toast ${type}`;
            toast.textContent = message;
            document.body.appendChild(toast);

            setTimeout(() => {
                toast.remove();
            }, 3000);
        }

        // ============================================
        // INITIALIZATION
        // ============================================

        document.addEventListener("DOMContentLoaded", () => {
            initPinLock();
            initGoogleAuth();

            // Check for existing session
            const session = localStorage.getItem(CONFIG.session.storageKey);
            if (session) {
                const parsed = JSON.parse(session);
                if (parsed.expiry > Date.now()) {
                    state.accessToken = "stored_token";
                    state.authStatus = true;
                    state.sessionExpiry = parsed.expiry;
                    hidePinLock();
                    setTimeout(initDrive, 100);
                }
            }
        });

        // Theme toggle
        document.getElementById("themeBtn").addEventListener("click", () => {
            document.body.style.filter = 
                document.body.style.filter === "invert(1)" ? "none" : "invert(1)";
        });

        // Navigation
        document.querySelectorAll(".nav-item").forEach(item => {
            item.addEventListener("click", () => {
                document.querySelectorAll(".nav-item").forEach(i => i.classList.remove("active"));
                item.classList.add("active");
            });
        });
    </script>
</body>
</html>
