<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VAULT OS | HYBRID TEST</title>
    
    <script src="https://accounts.google.com/gsi/client"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700&family=Inter:wght@400;600&display=swap" rel="stylesheet">

    <style>
        :root {
            --bg: #050505;
            --surface: #121212;
            --surface-hover: #1e1e1e;
            --primary: #00f3ff;
            --text: #ffffff;
            --text-sec: #888888;
            --border: #333333;
        }

        body {
            background-color: var(--bg);
            color: var(--text);
            font-family: 'Inter', sans-serif;
            margin: 0;
            padding-top: 80px; /* Space for fixed header */
        }

        /* HEADER */
        .header {
            position: fixed;
            top: 0; left: 0; right: 0;
            height: 70px;
            background: rgba(5, 5, 5, 0.95);
            backdrop-filter: blur(10px);
            border-bottom: 1px solid var(--border);
            display: flex;
            align-items: center;
            padding: 0 20px;
            gap: 15px;
            z-index: 1000;
        }

        /* BUTTONS */
        .btn {
            padding: 10px 20px;
            border-radius: 8px;
            border: 1px solid var(--border);
            background: var(--surface);
            color: var(--text-sec);
            cursor: pointer;
            font-size: 13px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: all 0.2s;
        }

        .btn:hover {
            background: var(--surface-hover);
            color: var(--text);
            border-color: #555;
        }

        .btn.active {
            background: rgba(0, 243, 255, 0.1);
            color: var(--primary);
            border-color: var(--primary);
        }

        .btn-connect {
            background: var(--primary);
            color: #000;
            border: none;
        }
        .btn-connect:hover {
            box-shadow: 0 0 15px rgba(0, 243, 255, 0.4);
        }

        /* GRID LAYOUT */
        .grid-container {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
            gap: 15px;
            padding: 20px;
        }

        .card {
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 12px;
            overflow: hidden;
            cursor: pointer;
            transition: transform 0.2s, border-color 0.2s;
            position: relative;
        }

        .card:hover {
            transform: translateY(-5px);
            border-color: var(--primary);
        }

        .thumb {
            height: 120px;
            width: 100%;
            background: #000;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
        }

        .thumb img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .thumb i {
            font-size: 40px;
            color: var(--text-sec);
        }

        .meta {
            padding: 12px;
        }

        .filename {
            font-size: 12px;
            font-weight: 500;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            color: #eee;
        }

        .filetype {
            font-size: 10px;
            color: var(--text-sec);
            margin-top: 4px;
            text-transform: uppercase;
        }

        /* STATUS BADGE */
        .status {
            margin-left: auto;
            font-size: 11px;
            font-family: 'JetBrains Mono', monospace;
            padding: 5px 10px;
            border-radius: 4px;
            background: #111;
            border: 1px solid #333;
            color: #555;
        }
        .status.online {
            color: #00ff9d;
            border-color: #00ff9d;
        }

        /* LOADING & EMPTY STATES */
        .msg-box {
            grid-column: 1 / -1;
            text-align: center;
            padding: 50px;
            color: var(--text-sec);
            font-size: 14px;
        }
    </style>
</head>
<body>

    <header class="header">
        <button class="btn btn-connect" onclick="Auth.connect()">
            <i class="fa-solid fa-bolt"></i> CONNECT
        </button>

        <div style="width:1px; height:30px; background:var(--border); margin:0 5px;"></div>

        <button class="btn" id="btn-user" onclick="Drive.switch('user')">
            <i class="fa-solid fa-hard-drive"></i> My Drive
        </button>
        <button class="btn" id="btn-vault" onclick="Drive.switch('vault')">
            <i class="fa-solid fa-server"></i> Vault
        </button>

        <div id="status-badge" class="status">DISCONNECTED</div>
    </header>

    <main id="file-grid" class="grid-container">
        <div class="msg-box">Please Connect to Google Account First</div>
    </main>

    <script>
        // ================= CONFIGURATION =================
        const CONFIG = {
            // Your Client ID
            clientId: "318681315152-65e9kofptt4c3bk3kmlj9gmksnasu347.apps.googleusercontent.com",
            
            // Your Script URL (Admin Access)
            scriptUrl: "https://script.google.com/macros/s/AKfycbxQF58gDxHBATrBvliuMc_SdP7PEiuN6fiHdzVKG7_K5FIrj3V2m8imWgPXTjmVqfnN/exec",
            
            // Scopes
            scopes: "https://www.googleapis.com/auth/drive"
        };
        // =================================================

        // GLOBAL STATE
        let accessToken = null;
        let currentMode = 'user'; // 'user' or 'vault'

        // AUTH MODULE
        const Auth = {
            connect: () => {
                const client = google.accounts.oauth2.initTokenClient({
                    client_id: CONFIG.clientId,
                    scope: CONFIG.scopes,
                    callback: (response) => {
                        if (response.access_token) {
                            accessToken = response.access_token;
                            Auth.updateStatus(true);
                            Drive.switch('user'); // Auto load user drive
                        }
                    }
                });
                client.requestAccessToken();
            },

            updateStatus: (isOnline) => {
                const badge = document.getElementById('status-badge');
                if(isOnline) {
                    badge.innerText = "SYSTEM ONLINE";
                    badge.classList.add('online');
                }
            }
        };

        // DRIVE ENGINE
        const Drive = {
            switch: (mode) => {
                if (!accessToken) return alert("Please Click Connect First!");
                
                currentMode = mode;
                
                // UI Toggle
                document.querySelectorAll('.btn').forEach(b => b.classList.remove('active'));
                document.getElementById(mode === 'user' ? 'btn-user' : 'btn-vault').classList.add('active');

                // Load Data
                if (mode === 'user') {
                    Drive.loadFromAPI('root');
                } else {
                    Drive.loadFromScript();
                }
            },

            // CASE 1: USER DRIVE (Direct Google API)
            loadFromAPI: async (folderId) => {
                UI.loading(`Loading User Drive...`);
                
                const q = `'${folderId}' in parents and trashed=false`;
                const fields = "files(id,name,mimeType,thumbnailLink,iconLink,webViewLink)";
                const url = `https://www.googleapis.com/drive/v3/files?q=${encodeURIComponent(q)}&fields=${fields}&pageSize=100`;

                try {
                    const res = await fetch(url, { headers: { 'Authorization': `Bearer ${accessToken}` } });
                    const data = await res.json();
                    UI.render(data.files || []);
                } catch (e) {
                    UI.error(e.message);
                }
            },

            // CASE 2: VAULT DRIVE (Via Google Apps Script)
            loadFromScript: async () => {
                UI.loading(`Connecting to Secure Vault...`);

                // We send 'action=list' to your script
                const url = `${CONFIG.scriptUrl}?action=list`;

                try {
                    // Script handles the admin auth internally
                    const res = await fetch(url); 
                    const data = await res.json();
                    
                    if (data.error) throw new Error(data.error);
                    UI.render(data.files || []);
                } catch (e) {
                    UI.error("Script Error: " + e.message);
                }
            }
        };

        // UI RENDERER
        const UI = {
            grid: document.getElementById('file-grid'),

            loading: (msg) => {
                UI.grid.innerHTML = `<div class="msg-box"><i class="fa-solid fa-circle-notch fa-spin"></i><br><br>${msg}</div>`;
            },

            error: (msg) => {
                UI.grid.innerHTML = `<div class="msg-box" style="color:#ff4444"><i class="fa-solid fa-triangle-exclamation"></i><br><br>${msg}</div>`;
            },

            render: (files) => {
                UI.grid.innerHTML = '';

                if (files.length === 0) {
                    UI.grid.innerHTML = `<div class="msg-box">Folder is Empty</div>`;
                    return;
                }

                files.forEach(f => {
                    // Helper to get High Res Image
                    const getThumb = () => {
                        if (f.mimeType.includes('image') && f.thumbnailLink) {
                            return `<img src="${f.thumbnailLink.replace('s220', 's800')}" loading="lazy">`;
                        }
                        if (f.mimeType.includes('folder')) return `<i class="fa-solid fa-folder" style="color:#ffcc00"></i>`;
                        if (f.mimeType.includes('video')) return `<i class="fa-solid fa-film" style="color:#ff2a6d"></i>`;
                        if (f.mimeType.includes('pdf')) return `<i class="fa-solid fa-file-pdf" style="color:#ff4d4d"></i>`;
                        return `<i class="fa-solid fa-file" style="color:#888"></i>`;
                    };

                    const card = document.createElement('div');
                    card.className = 'card';
                    card.innerHTML = `
                        <div class="thumb">${getThumb()}</div>
                        <div class="meta">
                            <div class="filename">${f.name}</div>
                            <div class="filetype">${f.mimeType.split('/').pop()}</div>
                        </div>
                    `;

                    // Click Action
                    card.onclick = () => {
                        if (f.mimeType.includes('folder')) {
                            // If user mode, drill down. If vault mode, drill down via script (need id support in script)
                            if (currentMode === 'user') Drive.loadFromAPI(f.id);
                            else alert("Folder navigation in Vault Mode requires script update. Showing root.");
                        } else {
                            window.open(f.webViewLink, '_blank');
                        }
                    };

                    UI.grid.appendChild(card);
                });
            }
        };
    </script>
</body>
</html>
