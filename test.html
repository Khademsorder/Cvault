<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VAULT DIAGNOSTIC | DRIVE PRO</title>
    <script src="https://accounts.google.com/gsi/client"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css" rel="stylesheet">

    <style>
        :root { --bg: #050505; --surface: #121212; --border: #333; --primary: #00f3ff; }
        body { background: var(--bg); color: #fff; font-family: sans-serif; margin: 0; padding-top: 80px; }
        
        /* Fixed Header */
        .top { position: fixed; top: 0; left: 0; right: 0; height: 70px; background: rgba(0,0,0,0.95); border-bottom: 1px solid var(--border); display: flex; align-items: center; padding: 0 20px; gap: 10px; z-index: 100; flex-wrap: wrap; }
        .btn { padding: 8px 15px; border-radius: 6px; border: 1px solid var(--border); background: var(--surface); color: #fff; cursor: pointer; font-size: 12px; font-weight: bold; text-transform: uppercase; }
        .btn:hover { background: #222; border-color: #666; }
        .btn-main { background: var(--primary); color: #000; border: none; }
        .btn-main:hover { background: #00d2df; }
        
        /* Photo Grid Layout */
        .grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); gap: 15px; padding: 20px; }
        .card { background: var(--surface); border: 1px solid var(--border); border-radius: 12px; overflow: hidden; transition: transform 0.2s; position: relative; }
        .card:hover { transform: translateY(-3px); border-color: var(--primary); }
        
        /* Image Preview */
        .preview-box { width: 100%; height: 120px; background: #000; display: flex; align-items: center; justify-content: center; overflow: hidden; }
        .img { width: 100%; height: 100%; object-fit: cover; transition: transform 0.3s; }
        .card:hover .img { transform: scale(1.1); }
        .icon { font-size: 40px; color: #555; }
        
        /* Metadata */
        .meta { padding: 10px; }
        .name { font-size: 11px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; color: #ddd; margin-bottom: 4px; }
        .type { font-size: 9px; color: #777; text-transform: uppercase; }
    </style>
</head>
<body>

    <div class="top">
        <button class="btn btn-main" onclick="connect()">1. FULL AUTH</button>
        <button class="btn" onclick="load('root', 'Root')"><i class="fa-solid fa-hard-drive"></i> User Root</button>
        <button class="btn" onclick="askAndLoad()"><i class="fa-solid fa-vault"></i> Load Vault ID</button>
        
        <div style="margin-left: auto; text-align: right;">
            <div id="status" style="font-size: 10px; color: #666; font-weight: bold;">DISCONNECTED</div>
            <div id="folder-name" style="font-size: 12px; color: var(--primary);">No Folder Loaded</div>
        </div>
    </div>

    <div id="grid" class="grid"></div>

    <script>
        const CLIENT_ID = "318681315152-65e9kofptt4c3bk3kmlj9gmksnasu347.apps.googleusercontent.com";
        
        // ➤ FIXED: Full Scope for accessing all drives/files
        const SCOPES = "https://www.googleapis.com/auth/drive"; 
        
        let token = null;

        function connect() {
            const client = google.accounts.oauth2.initTokenClient({
                client_id: CLIENT_ID,
                scope: SCOPES,
                callback: (r) => {
                    if(r.access_token) {
                        token = r.access_token;
                        document.getElementById('status').innerText = "CONNECTED (FULL ACCESS)";
                        document.getElementById('status').style.color = "#0f0";
                    } else {
                        alert("Auth Failed!");
                    }
                }
            });
            client.requestAccessToken();
        }

        function askAndLoad() {
            // ➤ FIX: Prompt for specific Vault Folder ID
            const vid = prompt("Enter Vault Folder ID / Shared Drive ID:", ""); 
            if(vid && vid.length > 5) {
                load(vid, "Vault Drive");
            }
        }

        async function load(id, label) {
            if(!token) return alert("Please AUTH first!");
            
            const g = document.getElementById('grid');
            const title = document.getElementById('folder-name');
            
            g.innerHTML = '<div style="color:white; padding:20px;">Loading Files...</div>';
            title.innerText = `Loading ${label}...`;
            
            // ➤ FIX: Added 'supportsAllDrives' and 'includeItemsFromAllDrives' for Shared Drive/Vault access
            // ➤ FIX: Increased thumbnail size (s220 -> s800) for better photo view
            const url = `https://www.googleapis.com/drive/v3/files?q='${id}' in parents and trashed=false&fields=files(id,name,mimeType,thumbnailLink)&pageSize=50&orderBy=folder,createdTime desc&supportsAllDrives=true&includeItemsFromAllDrives=true`;

            try {
                const res = await fetch(url, { headers: { 'Authorization': `Bearer ${token}` } });
                const data = await res.json();

                if(data.error) {
                    throw new Error(data.error.message);
                }

                g.innerHTML = '';
                title.innerText = `${label} (${data.files ? data.files.length : 0} items)`;

                if(!data.files || data.files.length === 0) {
                    g.innerHTML = '<div style="color:gray; padding:20px;">Empty Folder</div>';
                    return;
                }

                data.files.forEach(f => {
                    // Photo Logic: Get High Res Thumbnail
                    const isImg = f.mimeType.includes('image') && f.thumbnailLink;
                    let imgUrl = "";
                    if(isImg) {
                        // Requesting larger thumbnail (s800)
                        imgUrl = f.thumbnailLink.replace('s220', 's800'); 
                    }

                    // Icon Logic
                    let iconHtml = '<i class="fa-solid fa-file icon"></i>';
                    if(f.mimeType.includes('folder')) iconHtml = '<i class="fa-solid fa-folder icon" style="color:#ffcc00"></i>';
                    else if(f.mimeType.includes('video')) iconHtml = '<i class="fa-solid fa-film icon" style="color:#ff2a6d"></i>';
                    
                    g.innerHTML += `
                        <div class="card" title="${f.name}">
                            <div class="preview-box">
                                ${isImg ? `<img src="${imgUrl}" class="img" referrerpolicy="no-referrer">` : iconHtml}
                            </div>
                            <div class="meta">
                                <div class="name">${f.name}</div>
                                <div class="type">${f.mimeType.split('/').pop().toUpperCase()}</div>
                            </div>
                        </div>`;
                });
            } catch(e) {
                g.innerHTML = `<div style="color:red; padding:20px;">Error: ${e.message}</div>`;
                title.innerText = "Error Loading";
            }
        }
    </script>
</body>
</html>
