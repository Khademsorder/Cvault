<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vault OS - Production Ready</title>
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    <script src="https://apis.google.com/js/api.js"></script>
    
    <style>
        /* [Source 1] Android-style UI CSS */
        :root {
            --bg-color: #121212;
            --card-color: #1e1e1e;
            --text-primary: #ffffff;
            --text-secondary: #b0b0b0;
            --accent-color: #bb86fc;
            --nav-bg: #2c2c2c;
        }

        body {
            background-color: var(--bg-color);
            color: var(--text-primary);
            font-family: 'Roboto', sans-serif;
            margin: 0;
            padding: 0;
            display: flex;
            flex-direction: column;
            height: 100vh;
            overflow: hidden;
        }

        /* Login Screen */
        #auth-screen {
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            height: 100%;
            z-index: 1000;
            background-color: var(--bg-color);
        }

        .btn-login {
            background-color: #4285F4;
            color: white;
            padding: 12px 24px;
            border: none;
            border-radius: 4px;
            font-size: 16px;
            cursor: pointer;
            font-weight: bold;
        }

        /* Main Dashboard */
        #dashboard {
            display: none; /* Hidden by default */
            flex-direction: column;
            height: 100%;
        }

        header {
            background-color: var(--nav-bg);
            padding: 15px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.5);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        h2 { margin: 0; font-size: 18px; }

        /* File List Area */
        #content-area {
            flex: 1;
            overflow-y: auto;
            padding: 10px;
        }

        .file-card {
            background-color: var(--card-color);
            padding: 15px;
            margin-bottom: 10px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            border-bottom: 1px solid #333;
        }

        .file-icon { font-size: 24px; margin-right: 15px; }
        .file-info { flex: 1; }
        .file-name { font-weight: bold; font-size: 14px; display: block; }
        .file-meta { font-size: 12px; color: var(--text-secondary); }

        /* Bottom Navigation */
        .bottom-nav {
            background-color: var(--nav-bg);
            display: flex;
            justify-content: space-around;
            padding: 10px 0;
            border-top: 1px solid #333;
        }

        .nav-item {
            color: var(--text-secondary);
            text-align: center;
            font-size: 12px;
            cursor: pointer;
            padding: 5px;
        }

        .nav-item.active { color: var(--accent-color); font-weight: bold; }
        .nav-icon { display: block; font-size: 20px; margin-bottom: 4px; }
        
        .loading { text-align: center; color: var(--text-secondary); margin-top: 20px; }
    </style>
</head>
<body>

    <div id="auth-screen">
        <h1>Vault OS</h1>
        <p style="color:#888;">Production Config Ready</p>
        <button class="btn-login" onclick="handleAuthClick()">Sign in with Google</button>
    </div>

    <div id="dashboard">
        <header>
            <span id="view-title">User Drive</span>
            <span id="user-email" style="font-size:12px; color:#aaa;"></span>
        </header>

        <div id="content-area">
            <div class="loading">Select a drive to view files</div>
        </div>

        <div class="bottom-nav">
            <div class="nav-item active" onclick="switchView('user')" id="nav-user">
                <span class="nav-icon">üìÅ</span> My Drive
            </div>
            <div class="nav-item" onclick="switchView('vault')" id="nav-vault">
                <span class="nav-icon">üîê</span> Vault Drive
            </div>
        </div>
    </div>

    <script>
        // ==========================================
        // [Source 7 & 10] REAL PRODUCTION CONFIG
        // ==========================================
        const CONFIG = {
            // [Source 10] Firebase / API Key
            API_KEY: "AIzaSyB3Iy1MIbfmJ7h5rv9NlsT23ysedCwUZt4", 
            
            // [Source 7] Client ID
            CLIENT_ID: "318681315152-65e9kofptt4c3bk3kmlj9gmksnasu347.apps.googleusercontent.com",
            
            // [Source 7] Vault Root ID
            VAULT_FOLDER_ID: "1zIyinAqjQv96QBSuanFS2F0USaG66GPn",
            
            // [Source 7] Scopes
            SCOPES: "https://www.googleapis.com/auth/drive https://www.googleapis.com/auth/userinfo.email",
            
            // [Source 7] Proxy URL (For future upload/move logic)
            PROXY_URL: "https://script.google.com/macros/s/AKfycbxQF58gDxHBATrBvliuMc_SdP7PEiuN6fiHdzVKG7_K5FIrj3V2m8imWgPXTjmVqfnN/exec"
        };

        // GLOBAL STATE
        let tokenClient;
        let gapiInited = false;
        let gisInited = false;
        let accessToken = null;

        // [1] INITIALIZATION
        function gapiLoaded() {
            gapi.load('client', initializeGapiClient);
        }

        async function initializeGapiClient() {
            await gapi.client.init({
                apiKey: CONFIG.API_KEY,
                discoveryDocs: ["https://www.googleapis.com/discovery/v1/apis/drive/v3/rest"],
            });
            gapiInited = true;
            checkAuth();
        }

        function gisLoaded() {
            tokenClient = google.accounts.oauth2.initTokenClient({
                client_id: CONFIG.CLIENT_ID,
                scope: CONFIG.SCOPES,
                callback: '', // defined later
            });
            gisInited = true;
            checkAuth();
        }

        function checkAuth() {
            if (gapiInited && gisInited) {
                // Ready to auth
                console.log("Vault OS System Ready");
            }
        }

        // [2] AUTH LOGIC
        function handleAuthClick() {
            tokenClient.callback = async (resp) => {
                if (resp.error) {
                    throw resp;
                }
                accessToken = resp.access_token;
                document.getElementById('auth-screen').style.display = 'none';
                document.getElementById('dashboard').style.display = 'flex';
                
                // Fetch User Email
                const userInfo = await fetch(`https://www.googleapis.com/oauth2/v3/userinfo?access_token=${accessToken}`);
                const user = await userInfo.json();
                document.getElementById('user-email').innerText = user.email;

                // Load User Drive by default
                switchView('user');
            };

            if (gapi.client.getToken() === null) {
                tokenClient.requestAccessToken({prompt: 'consent'});
            } else {
                tokenClient.requestAccessToken({prompt: ''});
            }
        }

        // [3] DRIVE LOGIC (USER vs VAULT)
        async function listFiles(folderId, isVault) {
            const contentArea = document.getElementById('content-area');
            contentArea.innerHTML = '<div class="loading">Loading files...</div>';

            let query = `'${folderId}' in parents and trashed = false`;
            
            try {
                // Using Standard API for listing (Fastest)
                // Note: For Vault, if you don't have direct permission, 
                // you would need to use the PROXY_URL fetch method here instead.
                // Assuming "Sign in" user has access to Vault Folder or is Admin.
                
                const response = await gapi.client.drive.files.list({
                    'pageSize': 20,
                    'fields': "nextPageToken, files(id, name, mimeType, size, iconLink)",
                    'q': query
                });

                const files = response.result.files;
                renderFiles(files);

            } catch (err) {
                console.error("Drive API Error", err);
                contentArea.innerHTML = `<div class="loading" style="color:red">Error loading files.<br> Check console or permissions.</div>`;
            }
        }

        // [4] RENDER UI
        function renderFiles(files) {
            const contentArea = document.getElementById('content-area');
            contentArea.innerHTML = '';

            if (!files || files.length === 0) {
                contentArea.innerHTML = '<div class="loading">No files found.</div>';
                return;
            }

            files.forEach(file => {
                const size = file.size ? (file.size / 1024 / 1024).toFixed(2) + ' MB' : '';
                const icon = file.mimeType.includes('folder') ? 'üìÅ' : 'üìÑ';
                
                const html = `
                    <div class="file-card">
                        <div class="file-icon">${icon}</div>
                        <div class="file-info">
                            <span class="file-name">${file.name}</span>
                            <span class="file-meta">${file.mimeType} ‚Ä¢ ${size}</span>
                        </div>
                    </div>
                `;
                contentArea.innerHTML += html;
            });
        }

        // [5] VIEW SWITCHER
        function switchView(view) {
            // Update UI
            document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
            document.getElementById(`nav-${view}`).classList.add('active');

            if (view === 'user') {
                document.getElementById('view-title').innerText = "My Drive";
                listFiles('root', false); // 'root' is magic alias for User Drive
            } else {
                document.getElementById('view-title').innerText = "Vault Drive (Admin)";
                // [Source 7] Using Real Vault ID
                listFiles(CONFIG.VAULT_FOLDER_ID, true); 
            }
        }

        // Initialize libraries
        gapiLoaded();
        gisLoaded();

    </script>
</body>
</html>
