<!DOCTYPE html>
<html lang="bn">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Drive Master Pro - Hybrid Manager</title>
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons+Round" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Google+Sans:wght@400;500;700&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --primary: #1a73e8;
            --vault: #6200ee;
            --bg: #f8f9fa;
            --surface: #ffffff;
            --text: #202124;
        }
        body { font-family: 'Google Sans', sans-serif; background: var(--bg); margin: 0; padding: 20px; color: var(--text); }
        
        /* Configuration Section */
        .config-box {
            background: #e8f0fe; padding: 15px; border-radius: 8px; margin-bottom: 20px;
            border: 1px solid #d2e3fc; display: flex; gap: 10px; align-items: center; flex-wrap: wrap;
        }
        input.url-input {
            flex-grow: 1; padding: 10px; border: 1px solid #ccc; border-radius: 4px; font-family: monospace;
        }
        
        /* Layout Grid */
        .dashboard { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        @media (max-width: 768px) { .dashboard { grid-template-columns: 1fr; } }

        /* Drive Panel */
        .panel { background: var(--surface); border-radius: 12px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); overflow: hidden; display: flex; flex-direction: column; height: 80vh; }
        .panel-header { padding: 15px; display: flex; justify-content: space-between; align-items: center; color: white; }
        .user-header { background: var(--primary); }
        .vault-header { background: var(--vault); }
        
        .panel-title { display: flex; align-items: center; gap: 10px; font-weight: 500; }
        .panel-actions button { background: rgba(255,255,255,0.2); border: none; color: white; padding: 5px 10px; border-radius: 4px; cursor: pointer; }
        .panel-actions button:hover { background: rgba(255,255,255,0.3); }

        /* File List */
        .file-list { flex-grow: 1; overflow-y: auto; padding: 10px; }
        .file-item {
            display: flex; align-items: center; padding: 10px; border-bottom: 1px solid #eee;
            transition: 0.2s; background: white; border-radius: 6px; margin-bottom: 5px;
        }
        .file-item:hover { background: #f1f3f4; }
        .file-icon { margin-right: 12px; color: #5f6368; }
        .file-info { flex-grow: 1; overflow: hidden; }
        .file-name { font-size: 14px; font-weight: 500; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .file-meta { font-size: 11px; color: #80868b; }
        
        /* Action Buttons */
        .actions { display: flex; gap: 5px; opacity: 0.5; transition: 0.2s; }
        .file-item:hover .actions { opacity: 1; }
        .btn-icon { cursor: pointer; padding: 4px; border-radius: 50%; border: none; background: none; color: #5f6368; }
        .btn-icon:hover { background: #e8eaed; color: var(--primary); }
        
        /* Loader & Status */
        .loader { text-align: center; padding: 20px; color: #80868b; display: none; }
        .status-bar { position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); background: #323232; color: white; padding: 10px 20px; border-radius: 20px; font-size: 13px; display: none; z-index: 1000; }
    </style>
</head>
<body>

    <div class="config-box">
        <span class="material-icons-round">settings</span>
        <input type="text" id="scriptUrl" class="url-input" placeholder="Paste your Google Script Deployment URL here (ends with /exec)">
        <button onclick="saveConfig()" style="background:#1a73e8; color:white; border:none; padding:10px 20px; border-radius:4px; cursor:pointer;">Save & Connect</button>
    </div>

    <div class="dashboard">
        
        <div class="panel">
            <div class="panel-header user-header">
                <div class="panel-title">
                    <span class="material-icons-round">person</span> My Drive
                </div>
                <div class="panel-actions">
                    <button onclick="createFolder('root', 'user')" title="New Folder">+ Folder</button>
                    <button onclick="loadUserDrive()" title="Refresh"><span class="material-icons-round" style="font-size:16px">refresh</span></button>
                </div>
            </div>
            <div id="loader-user" class="loader">Loading...</div>
            <div id="list-user" class="file-list">
                <div style="text-align:center; margin-top:50px; color:#aaa">Click Connect to load files</div>
            </div>
        </div>

        <div class="panel">
            <div class="panel-header vault-header">
                <div class="panel-title">
                    <span class="material-icons-round">lock</span> Private Vault
                </div>
                <div class="panel-actions">
                    <button onclick="createFolder(vaultId, 'vault')" title="New Folder">+ Folder</button>
                    <button onclick="connectVault()" title="Refresh"><span class="material-icons-round" style="font-size:16px">refresh</span></button>
                </div>
            </div>
            <div id="loader-vault" class="loader">Securely connecting...</div>
            <div id="list-vault" class="file-list">
                <div style="text-align:center; margin-top:50px; color:#aaa">Waiting for connection...</div>
            </div>
        </div>

    </div>

    <div id="status" class="status-bar">Action Completed</div>

    <script>
        // Default Config
        const API_KEY = "AIzaSyDa9xQWqxE71j3ZaI7NI_0hGztmLcx4USo";
        let SCRIPT_URL = localStorage.getItem('dmp_script_url') || "";
        
        // State
        let vaultId = null; // Will be fetched from script
        let userDriveId = 'root'; // Default User Root

        // Initialize
        if(SCRIPT_URL) {
            document.getElementById('scriptUrl').value = SCRIPT_URL;
            loadUserDrive();
            connectVault();
        }

        function saveConfig() {
            const url = document.getElementById('scriptUrl').value.trim();
            if(!url) return alert("Please enter the Script URL!");
            localStorage.setItem('dmp_script_url', url);
            SCRIPT_URL = url;
            loadUserDrive();
            connectVault();
        }

        function showStatus(msg) {
            const el = document.getElementById('status');
            el.innerText = msg;
            el.style.display = 'block';
            setTimeout(() => el.style.display = 'none', 3000);
        }

        // --- Core Functions ---

        async function apiCall(params) {
            const qs = new URLSearchParams({ ...params, apiKey: API_KEY }).toString();
            const res = await fetch(`${SCRIPT_URL}?${qs}`);
            return await res.json();
        }

        // 1. Load User Drive
        async function loadUserDrive() {
            document.getElementById('loader-user').style.display = 'block';
            document.getElementById('list-user').innerHTML = '';
            
            try {
                const data = await apiCall({ action: 'files_list', folderId: 'root' });
                if(data.success) {
                    renderFiles(data.files, 'list-user', 'user');
                }
            } catch(e) { console.error(e); }
            document.getElementById('loader-user').style.display = 'none';
        }

        // 2. Connect & Load Vault
        async function connectVault() {
            document.getElementById('loader-vault').style.display = 'block';
            document.getElementById('list-vault').innerHTML = '';

            try {
                // First get the private folder ID
                if(!vaultId) {
                    const authData = await apiCall({ action: 'get_user_vault' });
                    if(authData.success) {
                        vaultId = authData.folderId;
                        console.log("Vault Connected: ", vaultId);
                    } else {
                        throw new Error(authData.error);
                    }
                }

                // Then load files
                const data = await apiCall({ action: 'files_list', folderId: vaultId });
                if(data.success) {
                    renderFiles(data.files, 'list-vault', 'vault');
                }
            } catch(e) { 
                document.getElementById('list-vault').innerHTML = `<p style="color:red;text-align:center">Connection Failed: ${e.message}</p>`;
            }
            document.getElementById('loader-vault').style.display = 'none';
        }

        // 3. Render Files UI
        function renderFiles(files, containerId, source) {
            const container = document.getElementById(containerId);
            if(!files || files.length === 0) {
                container.innerHTML = '<div style="text-align:center;padding:20px;color:#999">Empty Folder</div>';
                return;
            }

            files.forEach(file => {
                const isFolder = file.mimeType === 'application/vnd.google-apps.folder';
                const icon = isFolder ? 'folder' : 'description';
                const color = isFolder ? '#fbbc04' : '#1a73e8';
                
                // Determine targets for Move/Copy
                const targetName = source === 'user' ? 'Vault' : 'User Drive';
                const targetId = source === 'user' ? vaultId : 'root';

                const div = document.createElement('div');
                div.className = 'file-item';
                div.innerHTML = `
                    <span class="material-icons-round file-icon" style="color:${color}">${icon}</span>
                    <div class="file-info">
                        <div class="file-name">${file.name}</div>
                        <div class="file-meta">${isFolder ? 'Folder' : formatSize(file.size)}</div>
                    </div>
                    <div class="actions">
                        <button class="btn-icon" onclick="transferFile('${file.id}', '${targetId}', 'copy')" title="Copy to ${targetName}">
                            <span class="material-icons-round">content_copy</span>
                        </button>
                        <button class="btn-icon" onclick="transferFile('${file.id}', '${targetId}', 'move')" title="Move to ${targetName}">
                            <span class="material-icons-round">drive_file_move</span>
                        </button>
                        <button class="btn-icon" onclick="renameFile('${file.id}', '${file.name}', '${source}')" title="Rename">
                            <span class="material-icons-round">edit</span>
                        </button>
                        <button class="btn-icon" onclick="deleteFile('${file.id}', '${source}')" title="Delete" style="color:#d93025">
                            <span class="material-icons-round">delete</span>
                        </button>
                    </div>
                `;
                container.appendChild(div);
            });
        }

        // --- Actions ---

        async function transferFile(fileId, destId, mode) {
            showStatus(mode === 'copy' ? 'Copying...' : 'Moving...');
            const action = mode === 'copy' ? 'file_copy' : 'file_move';
            
            const res = await apiCall({ action: action, fileId: fileId, destId: destId });
            
            if(res.success) {
                showStatus('Success!');
                refreshAll();
            } else {
                alert("Error: " + res.error);
            }
        }

        async function renameFile(fileId, oldName, source) {
            const newName = prompt("Rename file:", oldName);
            if(!newName || newName === oldName) return;

            showStatus('Renaming...');
            const res = await apiCall({ action: 'file_rename', fileId: fileId, newName: newName });
            if(res.success) refreshAll();
        }

        async function deleteFile(fileId, source) {
            if(!confirm("Are you sure you want to delete this file?")) return;
            
            showStatus('Deleting...');
            const res = await apiCall({ action: 'file_delete', fileId: fileId });
            if(res.success) refreshAll();
        }

        async function createFolder(parentId, source) {
            const name = prompt("Enter Folder Name:");
            if(!name) return;
            
            showStatus('Creating Folder...');
            const res = await apiCall({ action: 'folder_create', parentId: parentId, name: name });
            if(res.success) refreshAll();
        }

        function refreshAll() {
            loadUserDrive();
            if(vaultId) connectVault(); // Only refresh vault if connected
        }

        function formatSize(bytes) {
            if (!bytes) return '0 B';
            const k = 1024;
            const sizes = ['B', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

    </script>
</body>
</html>
