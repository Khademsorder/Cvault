<!DOCTYPE html>
<html lang="en" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Drive OS Pro+ | AI Powered Cloud</title>
    
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons+Round" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    <script src="https://apis.google.com/js/api.js"></script>
    
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-javascript.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-css.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-json.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism-tomorrow.min.css" />

    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Outfit', 'sans-serif'],
                        mono: ['JetBrains Mono', 'monospace'],
                    },
                    colors: {
                        glass: {
                            100: 'rgba(255, 255, 255, 0.05)',
                            200: 'rgba(255, 255, 255, 0.1)',
                            300: 'rgba(255, 255, 255, 0.15)',
                            border: 'rgba(255, 255, 255, 0.08)',
                        },
                        accent: {
                            primary: '#3b82f6',
                            secondary: '#8b5cf6',
                            danger: '#ef4444',
                            success: '#10b981'
                        }
                    },
                    animation: {
                        'float': 'float 6s ease-in-out infinite',
                        'pulse-slow': 'pulse 4s cubic-bezier(0.4, 0, 0.6, 1) infinite',
                        'slide-up': 'slideUp 0.3s ease-out',
                        'fade-in': 'fadeIn 0.2s ease-out',
                    },
                    keyframes: {
                        float: {
                            '0%, 100%': { transform: 'translateY(0)' },
                            '50%': { transform: 'translateY(-10px)' },
                        },
                        slideUp: {
                            '0%': { transform: 'translateY(20px)', opacity: '0' },
                            '100%': { transform: 'translateY(0)', opacity: '1' },
                        },
                        fadeIn: {
                            '0%': { opacity: '0' },
                            '100%': { opacity: '1' },
                        }
                    }
                }
            }
        }
    </script>

    <style>
        :root {
            --bg-deep: #020617;
            --bg-card: #0f172a;
        }
        
        body {
            background-color: var(--bg-deep);
            color: #e2e8f0;
            overflow: hidden;
        }

        .glass-panel {
            background: rgba(15, 23, 42, 0.65);
            backdrop-filter: blur(16px);
            -webkit-backdrop-filter: blur(16px);
            border: 1px solid rgba(255, 255, 255, 0.08);
            box-shadow: 0 4px 30px rgba(0, 0, 0, 0.1);
        }

        .glass-card:hover {
            background: rgba(30, 41, 59, 0.8);
            border-color: rgba(59, 130, 246, 0.3);
            transform: translateY(-2px);
            box-shadow: 0 10px 40px -10px rgba(59, 130, 246, 0.2);
        }

        .custom-scroll::-webkit-scrollbar {
            width: 6px;
            height: 6px;
        }
        .custom-scroll::-webkit-scrollbar-track {
            background: transparent;
        }
        .custom-scroll::-webkit-scrollbar-thumb {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
        }
        .custom-scroll::-webkit-scrollbar-thumb:hover {
            background: rgba(255, 255, 255, 0.25);
        }

        .text-gradient {
            background: linear-gradient(135deg, #60a5fa 0%, #a78bfa 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        
        .loader-spin {
            animation: spin 1s linear infinite;
        }
        @keyframes spin { 100% { transform: rotate(360deg); } }

        .file-grid-layout {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
            gap: 1rem;
        }
        @media (min-width: 768px) {
            .file-grid-layout { grid-template-columns: repeat(auto-fill, minmax(160px, 1fr)); }
        }

        #context-menu {
            transition: opacity 0.2s, transform 0.2s;
        }
    </style>
</head>
<body class="antialiased selection:bg-blue-500/30">

    <div class="fixed inset-0 z-0 pointer-events-none overflow-hidden">
        <div class="absolute top-[-10%] left-[-10%] w-[40%] h-[40%] bg-blue-600/10 rounded-full blur-[100px] animate-pulse-slow"></div>
        <div class="absolute bottom-[-10%] right-[-10%] w-[40%] h-[40%] bg-purple-600/10 rounded-full blur-[100px] animate-pulse-slow" style="animation-delay: 2s"></div>
        <div class="absolute inset-0 bg-[url('https://grainy-gradients.vercel.app/noise.svg')] opacity-20 brightness-100 contrast-150 mix-blend-overlay"></div>
    </div>

    <div id="auth-screen" class="fixed inset-0 z-50 flex items-center justify-center p-4 transition-all duration-500">
        <div class="relative w-full max-w-md">
            <div class="absolute -inset-1 bg-gradient-to-r from-blue-600 to-purple-600 rounded-2xl blur opacity-30 animate-pulse"></div>
            
            <div class="glass-panel relative rounded-2xl p-8 text-center overflow-hidden">
                <div class="mb-6 flex justify-center">
                    <div class="w-20 h-20 bg-gradient-to-tr from-blue-500/20 to-purple-500/20 rounded-2xl flex items-center justify-center border border-white/10 shadow-inner animate-float">
                        <span class="material-icons-round text-5xl text-gradient">cloud_queue</span>
                    </div>
                </div>
                
                <h1 class="text-3xl font-bold text-white mb-2 tracking-tight">Drive OS <span class="text-blue-400">Pro+</span></h1>
                <p class="text-slate-400 mb-8 text-sm">Next Gen AI-Powered Cloud Management</p>
                
                <div class="space-y-4">
                    <button onclick="App.Auth.signIn()" class="group w-full py-3.5 px-4 bg-white hover:bg-slate-50 text-slate-900 rounded-xl font-semibold transition-all duration-200 flex items-center justify-center gap-3 shadow-lg shadow-blue-900/20 active:scale-95">
                        <img src="https://upload.wikimedia.org/wikipedia/commons/5/53/Google_%22G%22_Logo.svg" class="w-5 h-5 transition-transform group-hover:rotate-12"> 
                        <span>Continue with Google</span>
                    </button>
                    <p class="text-xs text-slate-500">Secure access via Google Identity Services</p>
                </div>
            </div>
        </div>
    </div>

    <div id="app-ui" class="hidden h-screen flex flex-col md:flex-row relative z-10 animate-fade-in">
        
        <aside class="w-full md:w-72 glass-panel border-r-0 md:border-r border-b md:border-b-0 border-glass-border flex flex-col shrink-0 transition-all duration-300 z-40 order-2 md:order-1 h-20 md:h-auto">
            
            <div class="hidden md:flex h-20 items-center px-6 border-b border-white/5">
                <span class="material-icons-round text-blue-500 mr-2 text-3xl">dns</span>
                <div>
                    <h2 class="font-bold text-lg tracking-wide text-white">Drive<span class="text-blue-500">OS</span></h2>
                    <p class="text-[10px] text-slate-400 uppercase tracking-widest">Ultimate Edition</p>
                </div>
            </div>

            <nav class="flex-1 p-2 md:p-4 flex flex-row md:flex-col gap-1 md:gap-2 overflow-x-auto md:overflow-y-auto custom-scroll items-center md:items-stretch justify-around md:justify-start">
                
                <button onclick="App.Drive.loadFiles('root')" id="nav-root" class="nav-btn w-full flex flex-col md:flex-row items-center md:px-4 py-2 md:py-3 rounded-xl text-slate-400 hover:bg-white/5 hover:text-blue-400 transition-all group">
                    <span class="material-icons-round text-2xl md:text-xl md:mr-3 mb-1 md:mb-0 group-hover:scale-110 transition-transform">dashboard</span>
                    <span class="text-[10px] md:text-sm font-medium">My Drive</span>
                </button>

                <button onclick="App.Drive.loadFiles(App.Config.vaultId)" id="nav-vault" class="nav-btn w-full flex flex-col md:flex-row items-center md:px-4 py-2 md:py-3 rounded-xl text-slate-400 hover:bg-white/5 hover:text-purple-400 transition-all group">
                    <span class="material-icons-round text-2xl md:text-xl md:mr-3 mb-1 md:mb-0 group-hover:scale-110 transition-transform">lock</span>
                    <span class="text-[10px] md:text-sm font-medium">Secure Vault</span>
                </button>

                <button onclick="App.Drive.loadFiles('starred')" id="nav-starred" class="nav-btn w-full flex flex-col md:flex-row items-center md:px-4 py-2 md:py-3 rounded-xl text-slate-400 hover:bg-white/5 hover:text-yellow-400 transition-all group">
                    <span class="material-icons-round text-2xl md:text-xl md:mr-3 mb-1 md:mb-0 group-hover:scale-110 transition-transform">star</span>
                    <span class="text-[10px] md:text-sm font-medium">Starred</span>
                </button>
                
                <div class="hidden md:block h-px bg-white/5 my-2"></div>
            </nav>

            <div class="hidden md:block p-5 border-t border-white/5 bg-slate-900/30">
                <div class="flex justify-between items-end mb-2">
                    <span class="text-xs font-medium text-slate-300">Storage</span>
                    <span id="storage-text" class="text-xs text-blue-400 font-mono">-- GB</span>
                </div>
                <div class="w-full h-2 bg-slate-800 rounded-full overflow-hidden shadow-inner">
                    <div id="storage-bar" class="h-full bg-gradient-to-r from-blue-500 to-purple-500 w-0 transition-all duration-1000 ease-out relative">
                        <div class="absolute inset-0 bg-white/20 animate-pulse"></div>
                    </div>
                </div>
                
                <div class="mt-6 flex items-center gap-3">
                    <img id="user-avatar" src="" class="w-9 h-9 rounded-full border border-white/10 bg-slate-800 object-cover" onerror="this.src='https://ui-avatars.com/api/?name=User&background=0D8ABC&color=fff'">
                    <div class="flex-1 min-w-0">
                        <p id="user-name" class="text-sm font-medium text-white truncate">Loading...</p>
                        <button onclick="App.Auth.signOut()" class="text-[10px] text-red-400 hover:text-red-300 flex items-center gap-1 mt-0.5">
                            <span class="material-icons-round text-[10px]">logout</span> Disconnect
                        </button>
                    </div>
                </div>
            </div>
        </aside>
        
        <main class="flex-1 flex flex-col min-w-0 relative h-full overflow-hidden">
            
            <header class="h-20 glass-panel border-b border-glass-border flex items-center justify-between px-6 z-30 shrink-0">
                
                <div class="flex items-center gap-4 flex-1 max-w-2xl">
                    <button id="btn-back" onclick="App.State.goBack()" class="w-10 h-10 rounded-full hover:bg-white/10 flex items-center justify-center text-slate-400 transition disabled:opacity-30 disabled:cursor-not-allowed">
                        <span class="material-icons-round">arrow_back</span>
                    </button>
                    
                    <div class="relative flex-1 group">
                        <span class="material-icons-round absolute left-4 top-1/2 -translate-y-1/2 text-slate-500 group-focus-within:text-blue-400 transition">search</span>
                        <input type="text" id="search-input" placeholder="Search files, content, or commands (Ctrl+K)" 
                            class="w-full bg-slate-800/50 border border-white/10 rounded-xl py-2.5 pl-12 pr-4 text-sm text-white focus:outline-none focus:border-blue-500 focus:bg-slate-800 transition shadow-inner"
                            oninput="App.Utils.debounce(App.Drive.search, 500)(this.value)">
                        <div class="absolute right-3 top-1/2 -translate-y-1/2 flex gap-1">
                            <span class="text-[10px] bg-white/10 px-1.5 rounded text-slate-400 border border-white/5">CTRL</span>
                            <span class="text-[10px] bg-white/10 px-1.5 rounded text-slate-400 border border-white/5">K</span>
                        </div>
                    </div>
                </div>

                <div class="flex items-center gap-3 pl-4">
                    <button onclick="App.Tools.openCleaner()" class="hidden md:flex items-center gap-2 px-3 py-2 bg-red-500/10 text-red-400 border border-red-500/20 rounded-lg hover:bg-red-500 hover:text-white transition group" title="Find Duplicates">
                        <span class="material-icons-round text-lg">delete_sweep</span>
                        <span class="text-xs font-medium">Cleaner</span>
                    </button>

                    <button onclick="App.UI.toggleAIStudio()" class="flex items-center gap-2 px-4 py-2 bg-gradient-to-r from-violet-600 to-indigo-600 text-white rounded-xl shadow-lg hover:shadow-indigo-500/30 hover:scale-105 transition">
                        <span class="material-icons-round text-lg">auto_fix_high</span>
                        <span class="text-sm font-bold hidden sm:inline">AI Studio</span>
                    </button>

                    <button onclick="document.getElementById('file-upload').click()" class="w-10 h-10 bg-blue-600 hover:bg-blue-500 text-white rounded-xl shadow-lg flex items-center justify-center transition hover:rotate-90">
                        <span class="material-icons-round">add</span>
                    </button>
                </div>
            </header>

            <div class="h-12 flex items-center justify-between px-6 bg-slate-900/40 border-b border-white/5 backdrop-blur-sm z-20 shrink-0">
                <div class="flex items-center gap-2 text-sm text-slate-400 overflow-hidden">
                    <span class="material-icons-round text-blue-500">folder_open</span>
                    <span id="folder-path" class="font-medium text-slate-200 truncate">Loading...</span>
                    <span id="item-count" class="text-xs bg-white/10 px-2 py-0.5 rounded-full ml-2">0 items</span>
                </div>
                
                <div class="flex items-center gap-2">
                    <button onclick="App.Drive.toggleView()" class="p-1.5 text-slate-400 hover:text-white hover:bg-white/10 rounded transition">
                        <span class="material-icons-round text-lg" id="view-icon">grid_view</span>
                    </button>
                    <div class="h-4 w-px bg-white/10"></div>
                    <select onchange="App.Drive.sort(this.value)" class="bg-transparent text-xs text-slate-400 border-none focus:ring-0 cursor-pointer outline-none hover:text-white transition">
                        <option value="folder,modifiedTime desc" class="bg-slate-800">Newest First</option>
                        <option value="folder,name" class="bg-slate-800">Name (A-Z)</option>
                        <option value="folder,quotaBytesUsed desc" class="bg-slate-800">Size (Largest)</option>
                    </select>
                </div>
            </div>

            <div id="file-container" class="flex-1 overflow-y-auto p-4 custom-scroll relative bg-gradient-to-b from-transparent to-slate-900/50">
                
                <div id="file-grid" class="file-grid-layout gap-4 pb-24 transition-all"></div>
                
                <div id="empty-state" class="hidden absolute inset-0 flex flex-col items-center justify-center text-slate-500 pointer-events-none">
                    <div class="w-32 h-32 bg-slate-800/50 rounded-full flex items-center justify-center mb-4 animate-pulse">
                        <span class="material-icons-round text-6xl opacity-30">folder_off</span>
                    </div>
                    <p class="text-lg font-medium">This folder is empty</p>
                    <p class="text-sm opacity-60">Upload files or create a new folder</p>
                </div>

                <div id="loader" class="absolute inset-0 flex items-center justify-center bg-slate-900/80 z-50 backdrop-blur-sm hidden">
                    <div class="flex flex-col items-center">
                        <div class="w-12 h-12 border-4 border-blue-500 border-t-transparent rounded-full loader-spin"></div>
                        <span class="mt-4 text-sm font-mono text-blue-400 animate-pulse">Syncing with Drive...</span>
                    </div>
                </div>
            </div>

            <div id="drop-zone" class="absolute inset-0 bg-blue-500/20 border-4 border-blue-500 border-dashed m-4 rounded-3xl z-50 hidden flex items-center justify-center backdrop-blur-sm">
                <div class="text-center text-white pointer-events-none">
                    <span class="material-icons-round text-8xl mb-4 animate-bounce">cloud_upload</span>
                    <h2 class="text-3xl font-bold">Drop files here</h2>
                </div>
            </div>
            
            <input type="file" id="file-upload" class="hidden" multiple onchange="App.Drive.uploadFiles(this.files)">
        </main>
    </div>

    <!-- AI Studio Modal -->
    <div id="ai-studio" class="fixed inset-0 z-[60] bg-black/80 backdrop-blur-xl hidden flex items-center justify-center p-4 animate-fade-in">
        <div class="w-full max-w-5xl h-[85vh] bg-[#0f172a] border border-white/10 rounded-2xl shadow-2xl flex flex-col overflow-hidden relative">
            
            <div class="h-16 border-b border-white/10 flex items-center justify-between px-6 bg-slate-900">
                <div class="flex items-center gap-3">
                    <div class="p-2 bg-gradient-to-br from-indigo-500 to-purple-600 rounded-lg">
                        <span class="material-icons-round text-white">auto_fix_high</span>
                    </div>
                    <h2 class="text-xl font-bold text-white tracking-tight">AI Studio <span class="text-xs px-2 py-0.5 rounded bg-blue-500/20 text-blue-400 border border-blue-500/30">Beta</span></h2>
                </div>
                <button onclick="App.UI.toggleAIStudio()" class="w-8 h-8 rounded-full bg-white/5 hover:bg-white/10 flex items-center justify-center transition"><span class="material-icons-round">close</span></button>
            </div>

            <div class="flex flex-1 overflow-hidden">
                <div class="w-64 border-r border-white/10 bg-slate-900/50 p-4 space-y-2">
                    <button onclick="App.AI.switchTab('ocr')" class="ai-tab active w-full p-3 rounded-xl flex items-center gap-3 hover:bg-white/5 transition text-left text-sm group" data-tab="ocr">
                        <span class="material-icons-round text-yellow-400 group-hover:scale-110 transition">text_snippet</span>
                        <div>
                            <div class="font-medium text-slate-200">Text Extractor</div>
                            <div class="text-[10px] text-slate-500">Bangla & English OCR</div>
                        </div>
                    </button>
                    
                    <button onclick="App.AI.switchTab('bg-remove')" class="ai-tab w-full p-3 rounded-xl flex items-center gap-3 hover:bg-white/5 transition text-left text-sm group" data-tab="bg-remove">
                        <span class="material-icons-round text-pink-400 group-hover:scale-110 transition">image</span>
                        <div>
                            <div class="font-medium text-slate-200">BG Remover</div>
                            <div class="text-[10px] text-slate-500">Transparent Backgrounds</div>
                        </div>
                    </button>

                    <button onclick="App.AI.switchTab('faceswap')" class="ai-tab w-full p-3 rounded-xl flex items-center gap-3 hover:bg-white/5 transition text-left text-sm group" data-tab="faceswap">
                        <span class="material-icons-round text-green-400 group-hover:scale-110 transition">face_retouching_natural</span>
                        <div>
                            <div class="font-medium text-slate-200">Face Swap</div>
                            <div class="text-[10px] text-slate-500">Swap faces in photos</div>
                        </div>
                    </button>
                </div>

                <div class="flex-1 bg-slate-950 relative overflow-y-auto custom-scroll p-6">
                    
                    <!-- OCR Tab -->
                    <div id="tab-ocr" class="ai-view block max-w-3xl mx-auto">
                        <h3 class="text-lg font-bold mb-4">Extract Text (OCR)</h3>
                        <div class="border-2 border-dashed border-white/10 rounded-2xl p-8 text-center hover:border-blue-500/50 transition cursor-pointer bg-slate-900" onclick="document.getElementById('ocr-upload').click()">
                            <input type="file" id="ocr-upload" class="hidden" accept="image/*" onchange="App.AI.handleOCR(this.files[0])">
                            <img id="ocr-preview" class="h-48 mx-auto object-contain mb-4 rounded hidden">
                            <div id="ocr-placeholder">
                                <span class="material-icons-round text-4xl text-slate-600 mb-2">add_photo_alternate</span>
                                <p class="text-slate-400 text-sm">Click to upload image (Bangla/English)</p>
                            </div>
                        </div>
                        <div id="ocr-result-box" class="mt-6 hidden">
                            <div class="flex justify-between items-center mb-2">
                                <span class="text-sm text-slate-400">Extracted Text:</span>
                                <button onclick="App.Utils.copyText('ocr-text')" class="text-xs text-blue-400 hover:text-white flex items-center gap-1"><span class="material-icons-round text-sm">content_copy</span> Copy</button>
                            </div>
                            <textarea id="ocr-text" class="w-full h-48 bg-slate-900 border border-white/10 rounded-xl p-4 text-sm text-slate-300 focus:border-blue-500 focus:outline-none" readonly></textarea>
                        </div>
                    </div>

                    <!-- BG Remove Tab -->
                    <div id="tab-bg-remove" class="ai-view hidden max-w-3xl mx-auto">
                        <h3 class="text-lg font-bold mb-4">Background Remover</h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div class="space-y-2">
                                <p class="text-xs text-slate-400">Original</p>
                                <div class="h-64 bg-slate-900 border border-white/10 rounded-xl flex items-center justify-center overflow-hidden relative group">
                                    <input type="file" id="bg-upload" class="absolute inset-0 opacity-0 cursor-pointer z-10" accept="image/*" onchange="App.AI.handleBGRemove(this.files[0])">
                                    <img id="bg-preview" class="w-full h-full object-contain hidden">
                                    <div id="bg-placeholder" class="text-center p-4">
                                        <span class="material-icons-round text-4xl text-slate-600">upload_file</span>
                                        <p class="text-xs text-slate-400 mt-2">Upload Image</p>
                                    </div>
                                </div>
                            </div>
                            <div class="space-y-2">
                                <p class="text-xs text-slate-400">Result</p>
                                <div class="h-64 bg-[url('https://external-content.duckduckgo.com/iu/?u=https%3A%2F%2Fcdn.dribbble.com%2Fusers%2F22691%2Fscreenshots%2F2128712%2Fcheckers-pattern.png&f=1&nofb=1')] bg-repeat border border-white/10 rounded-xl flex items-center justify-center overflow-hidden relative">
                                    <img id="bg-result" class="w-full h-full object-contain hidden z-10">
                                    <div id="bg-loader" class="hidden absolute inset-0 bg-slate-900/80 flex items-center justify-center z-20">
                                        <div class="spinner w-8 h-8 border-2 border-pink-500 border-t-transparent rounded-full"></div>
                                    </div>
                                    <button id="bg-download" onclick="App.AI.downloadResult('bg-result')" class="absolute bottom-4 right-4 bg-pink-600 text-white px-3 py-1 rounded-lg text-xs shadow-lg hidden z-30 hover:bg-pink-500">Download</button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Face Swap Tab -->
                    <div id="tab-faceswap" class="ai-view hidden max-w-3xl mx-auto">
                        <h3 class="text-lg font-bold mb-4">Face Swap Pro</h3>
                        <div class="grid grid-cols-2 gap-4 mb-6">
                            <div class="border border-white/10 rounded-xl p-4 bg-slate-900 text-center relative">
                                <p class="text-xs text-slate-400 mb-2">Source Face</p>
                                <input type="file" id="fs-source" class="hidden" accept="image/*" onchange="App.AI.loadPreview(this, 'fs-source-img')">
                                <div onclick="document.getElementById('fs-source').click()" class="h-32 border border-dashed border-white/10 rounded flex items-center justify-center cursor-pointer hover:bg-white/5">
                                    <img id="fs-source-img" class="h-full w-full object-contain hidden">
                                    <span class="material-icons-round text-slate-600" id="fs-source-icon">face</span>
                                </div>
                            </div>
                            <div class="border border-white/10 rounded-xl p-4 bg-slate-900 text-center relative">
                                <p class="text-xs text-slate-400 mb-2">Target Image</p>
                                <input type="file" id="fs-target" class="hidden" accept="image/*" onchange="App.AI.loadPreview(this, 'fs-target-img')">
                                <div onclick="document.getElementById('fs-target').click()" class="h-32 border border-dashed border-white/10 rounded flex items-center justify-center cursor-pointer hover:bg-white/5">
                                    <img id="fs-target-img" class="h-full w-full object-contain hidden">
                                    <span class="material-icons-round text-slate-600" id="fs-target-icon">image</span>
                                </div>
                            </div>
                        </div>
                        <button onclick="App.AI.processFaceSwap()" class="w-full py-3 bg-green-600 hover:bg-green-500 text-white rounded-xl font-bold transition flex items-center justify-center gap-2 mb-6">
                            <span class="material-icons-round">swap_horiz</span> Swap Faces Now
                        </button>
                        
                        <div id="fs-result-container" class="hidden border border-white/10 rounded-xl bg-slate-900 p-4">
                             <p class="text-xs text-slate-400 mb-2">Result</p>
                             <div class="relative min-h-[200px] flex items-center justify-center">
                                 <img id="fs-result" class="max-w-full rounded shadow-lg">
                                 <div id="fs-loader" class="absolute inset-0 bg-slate-900/80 flex flex-col items-center justify-center hidden">
                                     <div class="spinner w-8 h-8 border-2 border-green-500 border-t-transparent rounded-full mb-2"></div>
                                     <span class="text-xs text-green-400">Processing AI...</span>
                                 </div>
                             </div>
                             <a id="fs-download" class="mt-4 block text-center w-full bg-slate-800 py-2 rounded text-sm hover:bg-slate-700 transition">Download Result</a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Cleaner Modal -->
    <div id="cleaner-modal" class="fixed inset-0 z-[70] bg-black/90 hidden flex items-center justify-center p-4">
        <div class="w-full max-w-2xl bg-slate-900 border border-white/10 rounded-2xl shadow-2xl overflow-hidden flex flex-col max-h-[80vh]">
            <div class="p-4 border-b border-white/10 flex justify-between items-center bg-slate-800">
                <h3 class="font-bold text-white flex items-center gap-2"><span class="material-icons-round text-red-400">delete_sweep</span> Duplicate Finder</h3>
                <button onclick="document.getElementById('cleaner-modal').classList.add('hidden')" class="text-slate-400 hover:text-white"><span class="material-icons-round">close</span></button>
            </div>
            <div class="p-6 text-center" id="cleaner-start">
                <div class="w-20 h-20 bg-slate-800 rounded-full flex items-center justify-center mx-auto mb-4">
                    <span class="material-icons-round text-4xl text-slate-500">search</span>
                </div>
                <h4 class="text-xl font-bold mb-2">Scan for Duplicates?</h4>
                <p class="text-slate-400 text-sm mb-6">This will scan the current folder for files with identical names and sizes.</p>
                <button onclick="App.Tools.scanDuplicates()" class="px-6 py-2 bg-blue-600 hover:bg-blue-500 text-white rounded-lg font-medium transition">Start Scan</button>
            </div>
            <div class="hidden flex-1 overflow-y-auto p-4 custom-scroll" id="cleaner-results"></div>
            <div class="hidden p-4 border-t border-white/10 bg-slate-800 flex justify-end gap-3" id="cleaner-actions">
                <button onclick="App.Tools.deleteSelected()" class="px-4 py-2 bg-red-500/20 text-red-400 hover:bg-red-500 hover:text-white border border-red-500/30 rounded-lg text-sm transition font-bold">Delete Selected</button>
            </div>
        </div>
    </div>

    <!-- Chat Window -->
    <div class="fixed bottom-6 right-6 z-40 flex flex-col items-end gap-4">
        
        <div id="chat-window" class="w-80 md:w-96 h-[500px] bg-slate-900/95 backdrop-blur-xl border border-white/10 rounded-2xl shadow-2xl flex flex-col transition-all duration-300 transform origin-bottom-right scale-0 opacity-0 overflow-hidden">
            <div class="p-4 bg-gradient-to-r from-blue-600 to-indigo-600 flex justify-between items-center">
                <div class="flex items-center gap-2">
                    <div class="w-2 h-2 rounded-full bg-green-400 animate-pulse"></div>
                    <span class="font-bold text-white text-sm">Gemini Assistant</span>
                </div>
                <button onclick="App.Chat.toggle()" class="text-white/80 hover:text-white"><span class="material-icons-round">expand_more</span></button>
            </div>
            
            <div id="chat-messages" class="flex-1 overflow-y-auto p-4 space-y-4 custom-scroll text-sm bg-slate-900">
                <div class="flex gap-2">
                    <div class="w-8 h-8 rounded-full bg-blue-600/20 flex items-center justify-center shrink-0 border border-blue-500/30">
                        <span class="material-icons-round text-blue-400 text-xs">auto_awesome</span>
                    </div>
                    <div class="bg-slate-800 rounded-2xl rounded-tl-none p-3 border border-white/5 text-slate-300 text-xs leading-relaxed">
                        Hello! I'm your Drive Assistant. I can help you organize files, generate images, or analyze documents. Try asking "Find large files" or "Generate an image of a cyber city".
                    </div>
                </div>
            </div>

            <div class="p-3 bg-slate-800 border-t border-white/10">
                <form onsubmit="event.preventDefault(); App.Chat.send();" class="relative">
                    <input id="chat-input" type="text" placeholder="Ask Gemini..." class="w-full bg-slate-900 border border-white/10 rounded-xl pl-4 pr-12 py-3 text-sm text-white focus:border-blue-500 focus:outline-none transition">
                    <button type="submit" class="absolute right-2 top-1/2 -translate-y-1/2 p-1.5 bg-blue-600 hover:bg-blue-500 text-white rounded-lg transition">
                        <span class="material-icons-round text-sm">send</span>
                    </button>
                </form>
            </div>
        </div>

        <button onclick="App.Chat.toggle()" class="w-14 h-14 rounded-full bg-gradient-to-br from-blue-500 to-purple-600 text-white shadow-lg shadow-blue-600/30 flex items-center justify-center hover:scale-110 transition-transform group">
            <span class="material-icons-round text-3xl group-hover:rotate-12 transition-transform">auto_awesome</span>
        </button>
    </div>

    <!-- Toast Container -->
    <div id="toast-container" class="fixed bottom-24 left-1/2 -translate-x-1/2 z-[100] flex flex-col gap-2 items-center pointer-events-none"></div>

    <!-- Tesseract.js for OCR -->
    <script src='https://unpkg.com/tesseract.js@v2.1.0/dist/tesseract.min.js'></script>

    <!-- Context Menu -->
    <div id="context-menu" class="fixed z-[90] bg-[#1e293b] border border-white/10 rounded-xl shadow-2xl py-1 w-52 hidden backdrop-blur-md transition-all duration-200 origin-top-left transform scale-95 opacity-0">
        <div class="px-3 py-2 border-b border-white/5 mb-1">
            <p id="ctx-filename" class="text-xs text-slate-400 truncate">Filename.ext</p>
        </div>
        <button onclick="App.Actions.preview()" class="w-full text-left px-4 py-2 text-sm text-slate-200 hover:bg-blue-600 hover:text-white flex items-center gap-3 transition">
            <span class="material-icons-round text-lg">visibility</span> Preview
        </button>
        <button onclick="App.Actions.rename()" class="w-full text-left px-4 py-2 text-sm text-slate-200 hover:bg-blue-600 hover:text-white flex items-center gap-3 transition">
            <span class="material-icons-round text-lg">edit</span> Rename
        </button>
        <button onclick="App.Actions.download()" class="w-full text-left px-4 py-2 text-sm text-slate-200 hover:bg-green-600 hover:text-white flex items-center gap-3 transition">
            <span class="material-icons-round text-lg">download</span> Download
        </button>
        <button onclick="App.Actions.share()" class="w-full text-left px-4 py-2 text-sm text-slate-200 hover:bg-yellow-600 hover:text-white flex items-center gap-3 transition">
            <span class="material-icons-round text-lg">share</span> Get Link
        </button>
        <div class="h-px bg-white/10 my-1"></div>
        <button onclick="App.Actions.delete()" class="w-full text-left px-4 py-2 text-sm text-red-400 hover:bg-red-600 hover:text-white flex items-center gap-3 transition">
            <span class="material-icons-round text-lg">delete</span> Delete
        </button>
    </div>

    <script>
        const App = {
            Config: {
                // ðŸ”‘ YOUR GOOGLE DRIVE CLIENT ID (from earlier)
                clientId: '318681315152-65e9kofptt4c3bk3kmlj9gmksnasu347.apps.googleusercontent.com',
                // ðŸ”— YOUR APPS SCRIPT WEB APP URL
                scriptUrl: 'https://script.google.com/macros/s/AKfycbzhAYKHdInMJlKcoldrB05LBY-sCy7at-HHuEwR1QhMyxx3FbaDTIJBcOEEqeKjDYM/exec',
                vaultId: '1zIyinAqjQv96QBSuanFS2F0USaG66GPn'
            },

            State: {
                token: null,
                tokenExpiry: null,
                currentFolder: 'root',
                folderName: 'My Drive',
                files: [],
                history: [],
                activeFile: null,
                viewMode: 'grid',
                user: null
            },

            // ================= 1. AUTHENTICATION & STARTUP =================
            Auth: {
                tokenClient: null,
                
                init: () => {
                    if (typeof google === 'undefined' || !google.accounts) {
                        console.error('Google Identity Services not loaded');
                        App.UI.toast('Failed to load Google API. Refresh.', 'error');
                        return;
                    }
                    
                    App.Auth.tokenClient = google.accounts.oauth2.initTokenClient({
                        client_id: App.Config.clientId,
                        scope: 'https://www.googleapis.com/auth/drive',
                        callback: (resp) => {
                            if (resp.error) {
                                App.UI.toast('Login Failed: ' + resp.error, 'error');
                                return;
                            }
                            App.State.token = resp.access_token;
                            App.State.tokenExpiry = Date.now() + 3600 * 1000;
                            localStorage.setItem('g_token', resp.access_token);
                            localStorage.setItem('token_expiry', App.State.tokenExpiry);
                            App.Auth.onSuccess();
                        }
                    });

                    gapi.load('client', async () => {
                        await gapi.client.init({ 
                            discoveryDocs: ['https://www.googleapis.com/discovery/v1/apis/drive/v3/rest'] 
                        });
                        
                        const savedToken = localStorage.getItem('g_token');
                        const savedExpiry = localStorage.getItem('token_expiry');
                        
                        if (savedToken && savedExpiry && parseInt(savedExpiry) > Date.now()) {
                            App.State.token = savedToken;
                            App.State.tokenExpiry = parseInt(savedExpiry);
                            gapi.client.setToken({ access_token: savedToken });
                            
                            try {
                                await gapi.client.drive.about.get({ fields: 'user' });
                                App.Auth.onSuccess();
                            } catch (e) {
                                localStorage.removeItem('g_token');
                                localStorage.removeItem('token_expiry');
                                App.UI.toast('Session expired. Please login.', 'info');
                            }
                        }
                    });
                },

                signIn: () => App.Auth.tokenClient.requestAccessToken(),
                
                signOut: () => {
                    const token = gapi.client.getToken();
                    if (token !== null) {
                        google.accounts.oauth2.revoke(token.access_token);
                        gapi.client.setToken('');
                        localStorage.removeItem('g_token');
                        localStorage.removeItem('token_expiry');
                        location.reload();
                    }
                },

                onSuccess: async () => {
                    document.getElementById('auth-screen').classList.add('opacity-0');
                    setTimeout(() => document.getElementById('auth-screen').style.display = 'none', 500);
                    document.getElementById('app-ui').classList.remove('hidden');

                    try {
                        const res = await gapi.client.drive.about.get({ fields: 'user, storageQuota' });
                        App.State.user = res.result.user;
                        
                        document.getElementById('user-name').innerText = App.State.user.displayName;
                        document.getElementById('user-avatar').src = App.State.user.photoLink;
                        App.Drive.updateStorage(res.result.storageQuota);
                        
                        App.Drive.loadFiles('root');
                    } catch (e) {
                        App.UI.toast('Failed to load user info', 'error');
                    }
                }
            },

            // ================= 2. DRIVE OPERATIONS =================
            Drive: {
                loadFiles: async (folderId, pushHistory = true) => {
                    if (!App.State.token || App.State.tokenExpiry < Date.now()) {
                        App.UI.toast('Session expired. Please login again.', 'error');
                        App.Auth.signIn();
                        return;
                    }
                    
                    if (pushHistory && folderId !== App.State.currentFolder) {
                        App.State.history.push({id: App.State.currentFolder, name: App.State.folderName});
                        document.getElementById('btn-back').disabled = false;
                    }

                    App.State.currentFolder = folderId;
                    document.getElementById('loader').classList.remove('hidden');
                    document.getElementById('file-grid').innerHTML = '';

                    let query = `'${folderId}' in parents and trashed = false`;
                    if (folderId === 'root') App.State.folderName = "My Drive";
                    else if (folderId === 'starred') { 
                        query = "starred = true and trashed = false"; 
                        App.State.folderName = "Starred"; 
                    }
                    else if (folderId === App.Config.vaultId) App.State.folderName = "Secure Vault";
                    else {
                        try {
                            const meta = await gapi.client.drive.files.get({ fileId: folderId, fields: 'name' });
                            App.State.folderName = meta.result.name;
                        } catch(e) {
                            App.State.folderName = "Unknown";
                        }
                    }

                    document.getElementById('folder-path').innerText = App.State.folderName;
                    
                    try {
                        const sort = document.querySelector('select')?.value || 'folder,modifiedTime desc';
                        const res = await gapi.client.drive.files.list({
                            q: query,
                            pageSize: 100,
                            fields: 'nextPageToken, files(id, name, mimeType, iconLink, thumbnailLink, size, modifiedTime, webContentLink, webViewLink)',
                            orderBy: sort
                        });

                        App.State.files = res.result.files;
                        document.getElementById('item-count').innerText = `${App.State.files.length} Items`;
                        App.UI.renderFiles(App.State.files);
                    } catch (e) {
                        if (e.status === 401) {
                            App.UI.toast('Token expired, re-authenticating...', 'info');
                            App.Auth.signIn();
                        } else {
                            App.UI.toast('Error loading files: ' + e.message, 'error');
                        }
                    } finally {
                        document.getElementById('loader').classList.add('hidden');
                    }
                },

                search: async (term) => {
                    if (!term) return App.Drive.loadFiles(App.State.currentFolder, false);
                    
                    document.getElementById('loader').classList.remove('hidden');
                    try {
                        const q = `name contains '${term}' and trashed = false`;
                        const res = await gapi.client.drive.files.list({ 
                            q: q, 
                            fields: 'files(id, name, mimeType, iconLink, thumbnailLink, size, modifiedTime, webContentLink)' 
                        });
                        App.UI.renderFiles(res.result.files);
                        document.getElementById('folder-path').innerText = `Search: "${term}"`;
                    } catch (e) {
                        App.UI.toast('Search failed', 'error');
                    } finally {
                        document.getElementById('loader').classList.add('hidden');
                    }
                },

                uploadFiles: (files) => {
                    if (!files.length) return;
                    
                    Array.from(files).forEach(async (file, i) => {
                        App.UI.toast(`Uploading ${file.name}...`, 'info');
                        
                        const metadata = { name: file.name, parents: [App.State.currentFolder] };
                        const form = new FormData();
                        form.append('metadata', new Blob([JSON.stringify(metadata)], { type: 'application/json' }));
                        form.append('file', file);

                        try {
                            const response = await fetch('https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart', {
                                method: 'POST',
                                headers: new Headers({ 'Authorization': 'Bearer ' + App.State.token }),
                                body: form
                            });
                            
                            if (!response.ok) throw new Error('Upload failed');
                            App.UI.toast(`${file.name} Uploaded`, 'success');
                            if (i === files.length - 1) App.Drive.loadFiles(App.State.currentFolder, false);
                        } catch(e) {
                            App.UI.toast('Upload Failed: ' + e.message, 'error');
                        }
                    });
                },

                updateStorage: (quota) => {
                    if(!quota) return;
                    const used = (quota.usage / 1024 / 1024 / 1024).toFixed(2);
                    const total = (quota.limit / 1024 / 1024 / 1024).toFixed(0);
                    const percent = (quota.usage / quota.limit) * 100;
                    
                    document.getElementById('storage-text').innerText = `${used} GB / ${total} GB`;
                    document.getElementById('storage-bar').style.width = `${percent}%`;
                    if(percent > 85) document.getElementById('storage-bar').classList.add('bg-red-500');
                },

                sort: (val) => App.Drive.loadFiles(App.State.currentFolder, false),
                
                toggleView: () => {
                    App.State.viewMode = App.State.viewMode === 'grid' ? 'list' : 'grid';
                    document.getElementById('view-icon').innerText = App.State.viewMode === 'grid' ? 'grid_view' : 'list';
                    
                    const grid = document.getElementById('file-grid');
                    if(App.State.viewMode === 'list') {
                        grid.classList.remove('file-grid-layout');
                        grid.classList.add('flex', 'flex-col');
                    } else {
                        grid.classList.add('file-grid-layout');
                        grid.classList.remove('flex', 'flex-col');
                    }
                    App.UI.renderFiles(App.State.files);
                }
            },

            // ================= 3. AI STUDIO (via Apps Script) =================
            AI: {
                switchTab: (tab) => {
                    document.querySelectorAll('.ai-view').forEach(e => e.classList.add('hidden'));
                    document.querySelectorAll('.ai-tab').forEach(e => e.classList.remove('bg-white/10', 'border-l-2', 'border-blue-500'));
                    document.getElementById(`tab-${tab}`).classList.remove('hidden');
                    document.querySelector(`[data-tab="${tab}"]`).classList.add('bg-white/10', 'border-l-2', 'border-blue-500');
                },

                // --- OCR (Tesseract) remains client-side ---
                handleOCR: async (file) => {
                    if(!file) return;
                    
                    const img = document.getElementById('ocr-preview');
                    img.src = URL.createObjectURL(file);
                    img.classList.remove('hidden');
                    document.getElementById('ocr-placeholder').classList.add('hidden');
                    
                    const box = document.getElementById('ocr-text');
                    box.value = "ðŸ¤– Analyzing text (Bangla + English)...";
                    document.getElementById('ocr-result-box').classList.remove('hidden');

                    try {
                        if (typeof Tesseract === 'undefined') {
                            throw new Error('Tesseract library not loaded');
                        }
                        
                        const worker = await Tesseract.createWorker({
                            logger: m => console.log(m)
                        });
                        await worker.load();
                        await worker.loadLanguage('eng+ben');
                        await worker.initialize('eng+ben');
                        const { data: { text } } = await worker.recognize(file);
                        box.value = text || "No text found.";
                        await worker.terminate();
                    } catch (e) {
                        box.value = "Error: " + e.message;
                        App.UI.toast('OCR failed: ' + e.message, 'error');
                    }
                },

                // --- BG Remove via Apps Script ---
                handleBGRemove: async (file) => {
                    if(!file) return;
                    
                    const preview = document.getElementById('bg-preview');
                    preview.src = URL.createObjectURL(file);
                    preview.classList.remove('hidden');
                    document.getElementById('bg-placeholder').classList.add('hidden');
                    document.getElementById('bg-loader').classList.remove('hidden');

                    try {
                        // Convert file to base64
                        const base64 = await App.Utils.fileToBase64(file);
                        
                        const response = await fetch(App.Config.scriptUrl, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                type: 'bgremove',
                                image: base64
                            })
                        });
                        
                        const data = await response.json();
                        
                        if (data.error) throw new Error(data.error);
                        
                        if (data.image) {
                            const resultImg = document.getElementById('bg-result');
                            resultImg.src = 'data:image/png;base64,' + data.image;
                            resultImg.classList.remove('hidden');
                            document.getElementById('bg-download').classList.remove('hidden');
                            App.UI.toast('Background Removed!', 'success');
                        }
                    } catch(e) {
                        App.UI.toast('BG Remove failed: ' + e.message, 'error');
                        console.error(e);
                    } finally {
                        document.getElementById('bg-loader').classList.add('hidden');
                    }
                },

                downloadResult: (imgId) => {
                    const img = document.getElementById(imgId);
                    if (!img.src) return;
                    
                    const a = document.createElement('a');
                    a.href = img.src;
                    a.download = `ai-edited-${Date.now()}.png`;
                    a.click();
                },

                loadPreview: (input, imgId) => {
                    if(input.files && input.files[0]) {
                        const reader = new FileReader();
                        reader.onload = (e) => {
                            document.getElementById(imgId).src = e.target.result;
                            document.getElementById(imgId).classList.remove('hidden');
                            document.getElementById(imgId.replace('img', 'icon')).classList.add('hidden');
                        }
                        reader.readAsDataURL(input.files[0]);
                    }
                },

                // --- Face Swap via Apps Script ---
                processFaceSwap: async () => {
                    const source = document.getElementById('fs-source').files[0];
                    const target = document.getElementById('fs-target').files[0];

                    if(!source || !target) {
                        App.UI.toast('Please select both images', 'error');
                        return;
                    }

                    document.getElementById('fs-result-container').classList.remove('hidden');
                    document.getElementById('fs-loader').classList.remove('hidden');

                    try {
                        const sourceB64 = await App.Utils.fileToBase64(source);
                        const targetB64 = await App.Utils.fileToBase64(target);

                        const response = await fetch(App.Config.scriptUrl, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                type: 'faceswap',
                                source: sourceB64,
                                target: targetB64
                            })
                        });
                        
                        const data = await response.json();
                        
                        if (data.error) throw new Error(data.error);
                        
                        if (data.image) {
                            const resultImg = document.getElementById('fs-result');
                            resultImg.src = 'data:image/png;base64,' + data.image;
                            document.getElementById('fs-download').href = resultImg.src;
                            document.getElementById('fs-download').download = 'faceswap.png';
                            App.UI.toast('Face Swap Complete!', 'success');
                        }
                    } catch(e) {
                        console.error(e);
                        App.UI.toast('Face Swap failed: ' + e.message, 'error');
                    } finally {
                        document.getElementById('fs-loader').classList.add('hidden');
                    }
                }
            },

            // ================= 4. GEMINI CHAT via Apps Script =================
            Chat: {
                toggle: () => {
                    const win = document.getElementById('chat-window');
                    if(win.classList.contains('scale-0')) {
                        win.classList.remove('scale-0', 'opacity-0');
                    } else {
                        win.classList.add('scale-0', 'opacity-0');
                    }
                },

                send: async () => {
                    const input = document.getElementById('chat-input');
                    const msg = input.value.trim();
                    if(!msg) return;

                    const box = document.getElementById('chat-messages');
                    
                    // User message
                    box.innerHTML += `<div class="text-right animate-slide-up"><span class="bg-blue-600 text-white px-3 py-2 rounded-xl rounded-br-none inline-block shadow-lg text-sm">${msg.replace(/</g, '&lt;')}</span></div>`;
                    input.value = '';
                    box.scrollTop = box.scrollHeight;

                    // Loader
                    const loadId = 'loader-' + Date.now();
                    box.innerHTML += `<div id="${loadId}" class="text-left"><span class="bg-slate-800 text-slate-400 px-3 py-2 rounded-xl inline-block text-xs animate-pulse">Gemini is thinking...</span></div>`;

                    try {
                        const response = await fetch(App.Config.scriptUrl, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                type: 'gemini',
                                prompt: msg
                            })
                        });
                        
                        if (!response.ok) throw new Error(`HTTP ${response.status}`);
                        
                        const data = await response.json();
                        
                        // The backend returns the full Gemini response
                        const reply = data.candidates?.[0]?.content?.parts?.[0]?.text || "No response from Gemini.";
                        
                        document.getElementById(loadId).remove();
                        box.innerHTML += `<div class="text-left animate-slide-up"><div class="bg-slate-800 border border-white/10 text-slate-200 px-3 py-2 rounded-xl rounded-bl-none inline-block text-sm prose prose-invert max-w-none shadow">${marked.parse(reply)}</div></div>`;
                    } catch(e) {
                        document.getElementById(loadId).innerHTML = `<span class="bg-slate-800 text-red-400 px-3 py-2 rounded-xl inline-block text-xs">Error: ${e.message}</span>`;
                    }
                    box.scrollTop = box.scrollHeight;
                }
            },

            // ================= 5. TOOLS & UTILITIES =================
            Tools: {
                openCleaner: () => {
                    document.getElementById('cleaner-modal').classList.remove('hidden');
                    document.getElementById('cleaner-start').classList.remove('hidden');
                    document.getElementById('cleaner-results').classList.add('hidden');
                },

                scanDuplicates: () => {
                    const container = document.getElementById('cleaner-results');
                    document.getElementById('cleaner-start').classList.add('hidden');
                    container.classList.remove('hidden');
                    container.innerHTML = '<div class="text-center p-8"><div class="spinner w-8 h-8 border-2 border-blue-500 border-t-transparent rounded-full mx-auto animate-spin"></div><p class="mt-4 text-slate-400">Scanning metadata...</p></div>';

                    setTimeout(() => {
                        const files = App.State.files;
                        const map = new Map();
                        const duplicates = [];

                        files.forEach(f => {
                            const key = `${f.name}_${f.size}`;
                            if(map.has(key)) duplicates.push(f);
                            else map.set(key, f);
                        });

                        if(duplicates.length === 0) {
                            container.innerHTML = '<div class="text-center p-10"><span class="material-icons-round text-green-400 text-5xl">check_circle</span><p class="mt-2 text-white">No duplicates found!</p></div>';
                        } else {
                            let html = `<div class="flex justify-between mb-2"><span class="text-slate-400 text-xs">${duplicates.length} duplicates found</span></div>`;
                            duplicates.forEach(d => {
                                html += `
                                <div class="flex justify-between items-center p-3 bg-slate-800 mb-2 rounded-lg border border-white/5 hover:border-red-500/30 transition">
                                    <div class="flex items-center gap-2 overflow-hidden">
                                        <span class="material-icons-round text-red-400 text-lg">description</span>
                                        <div class="truncate">
                                            <div class="text-sm text-slate-200 truncate w-48">${d.name}</div>
                                            <div class="text-[10px] text-slate-500">${App.Utils.formatBytes(d.size)}</div>
                                        </div>
                                    </div>
                                    <button class="p-2 bg-red-500/10 text-red-400 rounded hover:bg-red-500 hover:text-white transition" onclick="App.Actions.deleteFileById('${d.id}')">
                                        <span class="material-icons-round text-sm">delete</span>
                                    </button>
                                </div>`;
                            });
                            container.innerHTML = html;
                        }
                    }, 800);
                },

                deleteSelected: () => {
                    App.UI.toast('Batch delete not implemented in demo', 'info');
                }
            },

            // ================= 6. UI RENDERER & HELPERS =================
            UI: {
                renderFiles: (files) => {
                    const grid = document.getElementById('file-grid');
                    grid.innerHTML = '';
                    const empty = document.getElementById('empty-state');
                    
                    if (!files || files.length === 0) {
                        empty.classList.remove('hidden');
                        return;
                    }
                    empty.classList.add('hidden');

                    files.forEach((f) => {
                        const isFolder = f.mimeType.includes('folder');
                        const card = document.createElement('div');
                        
                        if(App.State.viewMode === 'grid') {
                            card.className = 'glass-card p-3 rounded-xl cursor-pointer flex flex-col group animate-fade-in relative transition-all duration-200 hover:bg-white/5 border border-transparent hover:border-white/10';
                            let thumb = '';
                            if (f.thumbnailLink && !isFolder) {
                                const hdThumb = f.thumbnailLink.replace('=s220', '=s400');
                                thumb = `<div class="h-28 rounded-lg bg-slate-900 mb-2 overflow-hidden relative"><img src="${hdThumb}" class="w-full h-full object-cover opacity-80 group-hover:opacity-100 transition duration-300" loading="lazy"></div>`;
                            } else {
                                const icon = isFolder ? 'folder' : App.Utils.getFileIcon(f.mimeType);
                                const color = isFolder ? 'text-yellow-400' : 'text-blue-400';
                                thumb = `<div class="h-28 rounded-lg bg-slate-800/50 mb-2 flex items-center justify-center border border-white/5"><span class="material-icons-round ${color} text-5xl group-hover:scale-110 transition-transform">${icon}</span></div>`;
                            }
                            card.innerHTML = `${thumb}<div class="min-w-0"><p class="text-xs font-medium text-slate-200 truncate">${f.name}</p><p class="text-[10px] text-slate-500 mt-0.5">${App.Utils.formatBytes(f.size)}</p></div>`;
                        } else {
                            card.className = 'glass-card p-3 rounded-xl cursor-pointer flex items-center gap-4 group animate-fade-in relative transition-all duration-200 hover:bg-white/5 border border-transparent hover:border-white/10 w-full';
                            const icon = isFolder ? 'folder' : App.Utils.getFileIcon(f.mimeType);
                            const color = isFolder ? 'text-yellow-400' : 'text-blue-400';
                            card.innerHTML = `
                                <div class="w-10 h-10 rounded-full bg-slate-800 flex items-center justify-center shrink-0"><span class="material-icons-round ${color} text-xl">${icon}</span></div>
                                <div class="flex-1 min-w-0">
                                    <p class="text-sm font-medium text-slate-200 truncate">${f.name}</p>
                                    <p class="text-[10px] text-slate-500">${App.Utils.formatBytes(f.size)} â€¢ ${new Date(f.modifiedTime).toLocaleDateString()}</p>
                                </div>
                            `;
                        }

                        card.onclick = () => { isFolder ? App.Drive.loadFiles(f.id) : window.open(f.webViewLink, '_blank'); };
                        card.oncontextmenu = (e) => {
                            e.preventDefault();
                            App.State.activeFile = f;
                            App.UI.showContextMenu(e, f);
                        };

                        grid.appendChild(card);
                    });
                },

                showContextMenu: (e, file) => {
                    const menu = document.getElementById('context-menu');
                    document.getElementById('ctx-filename').innerText = file.name;
                    
                    let x = e.clientX;
                    let y = e.clientY;
                    if(x + 200 > window.innerWidth) x = window.innerWidth - 210;
                    if(y + 250 > window.innerHeight) y = window.innerHeight - 260;

                    menu.style.left = `${x}px`;
                    menu.style.top = `${y}px`;
                    menu.classList.remove('hidden');
                    setTimeout(() => {
                        menu.classList.remove('scale-95', 'opacity-0');
                    }, 10);
                },

                hideContextMenu: () => {
                    const menu = document.getElementById('context-menu');
                    menu.classList.add('scale-95', 'opacity-0');
                    setTimeout(() => menu.classList.add('hidden'), 200);
                },

                toast: (msg, type='info') => {
                    const box = document.getElementById('toast-container');
                    const t = document.createElement('div');
                    const bg = type === 'error' ? 'bg-red-600' : (type === 'success' ? 'bg-emerald-600' : 'bg-blue-600');
                    const icon = type === 'error' ? 'error' : (type === 'success' ? 'check_circle' : 'info');
                    
                    t.className = `${bg} text-white px-4 py-3 rounded-xl shadow-lg flex items-center gap-3 min-w-[280px] animate-slide-up backdrop-blur-md bg-opacity-95 border border-white/10`;
                    t.innerHTML = `<span class="material-icons-round">${icon}</span><span class="text-sm font-medium">${msg}</span>`;
                    
                    box.appendChild(t);
                    setTimeout(() => t.remove(), 3500);
                },

                toggleAIStudio: () => document.getElementById('ai-studio').classList.toggle('hidden')
            },

            // ================= 7. CONTEXT MENU ACTIONS =================
            Actions: {
                preview: () => {
                    App.UI.hideContextMenu();
                    if(App.State.activeFile) window.open(App.State.activeFile.webViewLink, '_blank');
                },
                
                share: async () => {
                    App.UI.hideContextMenu();
                    if(App.State.activeFile) {
                        await navigator.clipboard.writeText(App.State.activeFile.webViewLink);
                        App.UI.toast('Link copied to clipboard!', 'success');
                    }
                },

                download: () => {
                    App.UI.hideContextMenu();
                    const f = App.State.activeFile;
                    if(!f) return;
                    App.UI.toast('Starting Download...', 'info');
                    
                    const a = document.createElement('a');
                    a.href = f.webContentLink;
                    a.target = '_blank';
                    a.click();
                },

                rename: async () => {
                    App.UI.hideContextMenu();
                    const f = App.State.activeFile;
                    const { value: newName } = await Swal.fire({
                        title: 'Rename File',
                        input: 'text',
                        inputValue: f.name,
                        background: '#1e293b',
                        color: '#fff',
                        showCancelButton: true
                    });

                    if (newName && newName !== f.name) {
                        try {
                            await gapi.client.drive.files.update({
                                fileId: f.id,
                                resource: { name: newName }
                            });
                            App.Drive.loadFiles(App.State.currentFolder, false);
                            App.UI.toast('Renamed successfully', 'success');
                        } catch (e) {
                            App.UI.toast('Rename failed', 'error');
                        }
                    }
                },

                delete: async () => {
                    App.UI.hideContextMenu();
                    App.Actions.deleteFileById(App.State.activeFile.id);
                },

                deleteFileById: async (id) => {
                    const result = await Swal.fire({
                        title: 'Delete file?',
                        text: "Move to trash?",
                        icon: 'warning',
                        showCancelButton: true,
                        background: '#1e293b',
                        color: '#fff',
                        confirmButtonColor: '#ef4444',
                        confirmButtonText: 'Delete'
                    });

                    if (result.isConfirmed) {
                        try {
                            await gapi.client.drive.files.update({
                                fileId: id,
                                resource: { trashed: true }
                            });
                            App.Drive.loadFiles(App.State.currentFolder, false);
                            App.UI.toast('File moved to trash', 'success');
                            
                            const btn = document.querySelector(`button[onclick*="'${id}'"]`);
                            if(btn) btn.closest('.flex').remove();
                        } catch(e) {
                            App.UI.toast('Delete failed', 'error');
                        }
                    }
                }
            },

            Utils: {
                debounce: (func, wait) => {
                    let timeout;
                    return function(...args) {
                        clearTimeout(timeout);
                        timeout = setTimeout(() => func.apply(this, args), wait);
                    };
                },
                
                formatBytes: (bytes) => {
                    if (!bytes || bytes === '0') return '0 B';
                    const k = 1024;
                    const sizes = ['B', 'KB', 'MB', 'GB', 'TB'];
                    const i = Math.floor(Math.log(bytes) / Math.log(k));
                    return `${parseFloat((bytes / Math.pow(k, i)).toFixed(2))} ${sizes[i]}`;
                },
                
                getFileIcon: (mime) => {
                    if(!mime) return 'description';
                    if(mime.includes('image')) return 'image';
                    if(mime.includes('video')) return 'movie';
                    if(mime.includes('audio')) return 'audiotrack';
                    if(mime.includes('pdf')) return 'picture_as_pdf';
                    if(mime.includes('zip') || mime.includes('rar')) return 'folder_zip';
                    if(mime.includes('spreadsheet') || mime.includes('excel')) return 'table_view';
                    if(mime.includes('presentation')) return 'slideshow';
                    return 'description';
                },
                
                copyText: (elementId) => {
                    const text = document.getElementById(elementId).value;
                    navigator.clipboard.writeText(text).then(() => {
                        App.UI.toast('Copied to clipboard!', 'success');
                    }).catch(() => {
                        App.UI.toast('Copy failed', 'error');
                    });
                },

                // Convert file to base64 string
                fileToBase64: (file) => {
                    return new Promise((resolve, reject) => {
                        const reader = new FileReader();
                        reader.readAsDataURL(file);
                        reader.onload = () => resolve(reader.result.split(',')[1]); // remove data:image/png;base64,
                        reader.onerror = reject;
                    });
                }
            }
        };

        // Global listeners
        document.addEventListener('click', (e) => {
            if (!e.target.closest('#context-menu')) App.UI.hideContextMenu();
        });

        App.State.goBack = () => {
            if (App.State.history.length > 0) {
                const prev = App.State.history.pop();
                App.Drive.loadFiles(prev.id, false);
                if(App.State.history.length === 0) document.getElementById('btn-back').disabled = true;
            }
        };

        window.onload = () => {
            if (typeof google === 'undefined') {
                App.UI.toast('Google API failed to load. Refresh.', 'error');
                return;
            }
            App.Auth.init();
        };
    </script>
</body>
</html>
