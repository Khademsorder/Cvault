<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Drive OS | Pro+ Enterprise</title>
    
    <!-- Google Identity & Icons -->
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&family=Google+Sans:wght@400;500&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons+Round" rel="stylesheet">

    <!-- PHASE 2: Tailwind Safe Integration -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    backdropBlur: { xs: '2px' },
                    boxShadow: {
                        mac: '0 10px 30px rgba(0,0,0,0.12)',
                        macHover: '0 20px 40px rgba(0,0,0,0.18)'
                    }
                }
            }
        }
    </script>

    <style>
        :root {
            --primary: #1a73e8;
            --primary-dark: #0d47a1;
            --secondary: #34a853;
            --surface: #ffffff;
            --bg: #f8f9fa;
            --text-main: #202124;
            --text-sec: #5f6368;
            --border: #dadce0;
            --hover: #f1f3f4;
            --shadow: 0 1px 2px 0 rgba(60,64,67,0.3), 0 1px 3px 1px rgba(60,64,67,0.15);
            --radius: 8px;
            --radius-lg: 12px;
            --radius-xl: 16px;
        }

        .dark-theme {
            --primary: #8ab4f8;
            --primary-dark: #669df6;
            --secondary: #81c995;
            --surface: #202124;
            --bg: #121212;
            --text-main: #e8eaed;
            --text-sec: #9aa0a6;
            --border: #3c4043;
            --hover: #2d2e30;
            --shadow: 0 1px 2px 0 rgba(0,0,0,0.6), 0 1px 3px 1px rgba(0,0,0,0.302);
        }

        * { 
            box-sizing: border-box; 
            -webkit-tap-highlight-color: transparent; 
            outline: none; 
            user-select: none; 
        }
        
        body {
            margin: 0; padding: 0;
            font-family: 'Roboto', sans-serif;
            background: var(--bg); color: var(--text-main);
            height: 100vh; display: flex; flex-direction: column; overflow: hidden;
            transition: background-color 0.3s, color 0.3s;
        }

        /* PHASE 3: MacOS Glass Base Layout */
        #driveos-root {
            height: 100vh;
            width: 100%;
            display: flex;
            flex-direction: column;
        }

        .mac-glass {
            background: rgba(255,255,255,0.6);
            backdrop-filter: blur(20px);
            border-radius: 16px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        }

        .dark-theme .mac-glass {
            background: rgba(32,33,36,0.7);
            backdrop-filter: blur(20px);
        }

        /* --- SCREENS --- */
        .screen {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            display: none; flex-direction: column; background: var(--bg); z-index: 10;
        }
        .screen.active { display: flex; animation: fade 0.2s ease; }
        @keyframes fade { from { opacity: 0; } to { opacity: 1; } }

        /* --- LOCK SCREEN --- */
        #lock-screen {
            justify-content: center; align-items: center; background: var(--surface);
        }
        .pin-container {
            text-align: center; width: 100%; max-width: 320px; padding: 20px;
        }
        .logo-area { 
            font-family: 'Google Sans'; 
            font-size: 24px; 
            color: var(--text-main); 
            margin-bottom: 10px; 
        }
        .logo-subtitle {
            font-size: 14px; color: var(--text-sec); margin-bottom: 30px;
        }
        .pin-dots {
            display: flex; justify-content: center; gap: 15px; margin-bottom: 40px;
        }
        .dot {
            width: 15px; height: 15px; border-radius: 50%;
            border: 2px solid var(--text-sec); transition: 0.2s;
        }
        .dot.filled { background: var(--primary); border-color: var(--primary); }
        .keypad {
            display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px;
            padding: 0 20px;
        }
        .key {
            width: 65px; height: 65px; border-radius: 50%;
            background: var(--hover); color: var(--text-main);
            font-size: 22px; display: flex; align-items: center; justify-content: center;
            margin: auto; cursor: pointer; transition: 0.1s;
            border: 1px solid var(--border);
            touch-action: manipulation;
        }
        .key:active { background: var(--border); transform: scale(0.95); }
        .key.clear { 
            background: transparent; 
            font-size: 13px; 
            color: var(--text-sec); 
            border: none; 
        }
        .key.backspace {
            font-size: 18px;
        }
        .biometric-btn {
            margin-top: 20px; padding: 10px 20px;
            background: transparent; border: 1px solid var(--border);
            border-radius: 20px; color: var(--text-sec); cursor: pointer;
            display: flex; align-items: center; gap: 8px; justify-content: center;
            font-size: 14px;
        }

        /* --- AUTH SCREEN --- */
        #auth-screen { 
            justify-content: center; 
            align-items: center; 
            text-align: center; 
            background: var(--surface); 
        }
        .auth-card {
            background: var(--surface); padding: 30px; border-radius: var(--radius-xl);
            box-shadow: var(--shadow); width: 90%; max-width: 400px;
            border: 1px solid var(--border);
        }
        .auth-btn {
            background: var(--surface); border: 1px solid var(--border); padding: 12px 24px;
            border-radius: 24px; font-family: 'Google Sans'; font-weight: 500;
            display: flex; align-items: center; gap: 10px; cursor: pointer;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1); margin-bottom: 15px;
            width: 100%; justify-content: center; transition: 0.2s;
        }
        .auth-btn:hover { background: var(--hover); }

        /* --- MAIN APP UI --- */
        /* Header */
        .app-header {
            background: var(--surface); padding: 10px 15px; height: 60px;
            display: flex; align-items: center; justify-content: space-between;
            box-shadow: 0 1px 0 var(--border); z-index: 20;
            position: relative;
            flex-shrink: 0;
        }
        .search-bar {
            flex: 1; background: var(--hover); border-radius: var(--radius-lg); margin: 0 15px;
            padding: 8px 12px; display: flex; align-items: center; color: var(--text-sec);
            border: 1px solid transparent; transition: 0.2s;
            min-width: 0; /* Prevent overflow */
        }
        .search-bar:focus-within { border-color: var(--primary); background: var(--surface); }
        .search-input {
            border: none; background: transparent; margin-left: 10px; width: 100%; font-size: 16px;
            color: var(--text-main);
        }

        /* Toolbar with Back Button */
        .toolbar {
            padding: 10px 15px; display: flex; justify-content: space-between; align-items: center;
            font-size: 14px; color: var(--text-sec); border-bottom: 1px solid var(--border);
            background: var(--surface);
            flex-shrink: 0;
        }
        .breadcrumb { 
            display: flex; 
            align-items: center; 
            overflow-x: auto; 
            white-space: nowrap; 
            flex: 1;
            min-width: 0;
            scrollbar-width: none; 
            -ms-overflow-style: none;
        }
        .breadcrumb::-webkit-scrollbar { display: none; }
        .back-btn {
            background: var(--hover); border: 1px solid var(--border); border-radius: var(--radius);
            width: 36px; height: 36px; display: flex; align-items: center; justify-content: center;
            cursor: pointer; margin-right: 10px; flex-shrink: 0;
        }
        .crumb-item { 
            color: var(--text-main); 
            font-weight: 500; 
            padding: 4px 8px; 
            border-radius: var(--radius);
            cursor: pointer; 
            transition: 0.2s;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 200px;
        }
        .crumb-item:hover { background: var(--hover); }
        .crumb-sep { margin: 0 5px; color: var(--text-sec); flex-shrink: 0; }
        .toolbar-actions {
            display: flex; gap: 10px; align-items: center;
            flex-shrink: 0;
        }
        
        /* View Switcher */
        .view-switcher {
            display: flex; background: var(--hover); border-radius: var(--radius);
            padding: 2px; border: 1px solid var(--border);
        }
        .view-btn {
            padding: 6px 10px; border-radius: 6px; cursor: pointer; font-size: 13px;
            display: flex; align-items: center; gap: 4px;
            min-width: 36px; justify-content: center;
        }
        .view-btn.active { background: var(--surface); }

        /* File List Container */
        .file-viewer { 
            flex: 1; 
            overflow-y: auto; 
            padding: 10px; 
            position: relative;
            min-height: 0; /* Fix for flex overflow */
        }
        .file-list-view { display: flex; flex-direction: column; gap: 2px; }
        .file-grid-view { 
            display: grid; 
            grid-template-columns: repeat(auto-fill, minmax(120px, 1fr)); 
            gap: 12px; 
        }
        .file-gallery-view {
            display: grid; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 15px;
        }
        
        /* File Items - FIXED OVERLAP */
        .list-item {
            display: flex; align-items: center; padding: 12px 15px;
            border-bottom: 1px solid var(--border); cursor: pointer;
            border-radius: var(--radius); margin-bottom: 2px;
            background: var(--surface); transition: 0.2s;
            min-height: 64px;
            box-sizing: border-box;
            position: relative;
            overflow: hidden;
        }
        .list-item:hover { background: var(--hover); }
        
        .grid-item {
            background: var(--surface); border: 1px solid var(--border); border-radius: var(--radius);
            padding: 12px; display: flex; flex-direction: column; align-items: center; 
            text-align: center; cursor: pointer; transition: 0.2s;
            height: 140px; /* Fixed height */
            overflow: hidden;
            position: relative;
        }
        .grid-item:hover { transform: translateY(-2px); box-shadow: var(--shadow); }
        
        .gallery-item {
            background: var(--surface); border: 1px solid var(--border); border-radius: var(--radius);
            overflow: hidden; cursor: pointer; transition: 0.2s;
            height: 180px; /* Fixed height */
        }
        .gallery-item:hover { transform: scale(1.02); box-shadow: var(--shadow); }
        .gallery-thumb {
            width: 100%; height: 120px; object-fit: cover; background: var(--hover);
        }
        .gallery-info { padding: 10px; }
        
        /* File Icons */
        .item-icon { 
            font-size: 24px; 
            color: var(--text-sec); 
            margin-right: 15px; 
            flex-shrink: 0;
        }
        .folder-icon { color: #fbbc04; }
        .pdf-icon { color: #d93025; }
        .image-icon { color: #34a853; }
        .video-icon { color: #ea4335; }
        .audio-icon { color: #9c27b0; }
        .doc-icon { color: #1a73e8; }
        
        .grid-item .item-icon { font-size: 40px; margin: 0 0 8px 0; }
        
        /* File Text - FIXED OVERLAP */
        .item-text { 
            flex: 1; 
            overflow: hidden;
            min-width: 0; /* Crucial for text ellipsis */
            position: relative;
        }
        .item-name { 
            display: block; 
            font-size: 14px; 
            color: var(--text-main); 
            white-space: nowrap; 
            overflow: hidden; 
            text-overflow: ellipsis; 
            font-weight: 500;
            line-height: 1.4;
            margin-bottom: 2px;
        }
        .item-meta { 
            display: block; 
            font-size: 11px; 
            color: var(--text-sec); 
            line-height: 1.3;
        }
        .item-size {
            font-weight: 500;
        }
        .item-date {
            font-size: 10px;
            opacity: 0.8;
        }

        /* File Actions */
        .file-actions {
            display: flex; gap: 5px; flex-shrink: 0;
        }
        .action-btn {
            width: 32px; height: 32px; border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            cursor: pointer; color: var(--text-sec); transition: 0.2s;
        }
        .action-btn:hover { background: var(--hover); }

        /* PHASE 4: Enterprise Sidebar Safe Rebuild */
        .sidebar {
            position: fixed; top: 0; left: -280px; width: 280px; height: 100%;
            background: var(--surface); box-shadow: 2px 0 10px rgba(0,0,0,0.1);
            z-index: 1000; transition: left 0.3s ease;
            display: flex; flex-direction: column;
            border-right: 1px solid var(--border);
        }
        .sidebar.active { left: 0; }
        .sidebar-header {
            padding: 20px; border-bottom: 1px solid var(--border);
            display: flex; justify-content: space-between; align-items: center;
        }
        .sidebar-user {
            display: flex; align-items: center; gap: 10px;
            padding: 15px 20px; border-bottom: 1px solid var(--border);
        }
        .user-avatar {
            width: 40px; height: 40px; border-radius: 50%;
        }
        .user-info h3 { margin: 0; font-size: 16px; }
        .user-info p { margin: 2px 0 0; font-size: 12px; color: var(--text-sec); }
        
        .sidebar-nav {
            flex: 1; padding: 15px 0; overflow-y: auto;
        }
        .nav-section {
            padding: 10px 0;
        }
        .nav-title {
            padding: 0 20px; font-size: 12px; color: var(--text-sec); 
            text-transform: uppercase; letter-spacing: 1px; margin-bottom: 10px;
        }
        .nav-item {
            display: flex; align-items: center; gap: 15px; padding: 12px 20px;
            color: var(--text-main); text-decoration: none; transition: 0.2s;
            cursor: pointer;
        }
        .nav-item:hover { background: var(--hover); }
        .nav-item.active { 
            background: #e8f0fe; 
            color: var(--primary);
            border-left: 3px solid var(--primary);
        }
        .nav-badge {
            margin-left: auto; background: var(--primary); color: white;
            font-size: 11px; padding: 2px 6px; border-radius: 10px;
        }

        /* Settings Panel */
        .settings-panel {
            padding: 20px;
        }
        .setting-item {
            display: flex; justify-content: space-between; align-items: center;
            padding: 12px 0; border-bottom: 1px solid var(--border);
        }
        .setting-label { flex: 1; }
        .setting-desc { 
            font-size: 12px; 
            color: var(--text-sec); 
            margin-top: 4px; 
        }

        /* FAB */
        .fab-container { position: fixed; bottom: 80px; right: 20px; z-index: 50; }
        .fab-main {
            width: 56px; height: 56px; border-radius: 50%; background: var(--primary);
            box-shadow: var(--shadow); display: flex; align-items: center; justify-content: center;
            cursor: pointer; color: white; font-size: 28px; transition: 0.2s;
        }
        .fab-main:hover { background: var(--primary-dark); }
        .fab-menu {
            position: absolute; bottom: 70px; right: 0; background: var(--surface);
            border-radius: var(--radius-lg); box-shadow: var(--shadow); width: 200px;
            display: none; flex-direction: column; overflow: hidden; border: 1px solid var(--border);
        }
        .fab-item { 
            padding: 12px 15px; 
            display: flex; 
            align-items: center; 
            gap: 10px; 
            font-size: 14px; 
            cursor: pointer; 
            color: var(--text-main);
            transition: 0.2s;
        }
        .fab-item:hover { background: var(--hover); }

        /* Bottom Nav */
        .bottom-nav {
            height: 60px; background: var(--surface); border-top: 1px solid var(--border);
            display: flex; justify-content: space-around; align-items: center;
            position: relative; z-index: 20;
            flex-shrink: 0;
        }
        .nav-item-b { 
            display: flex; 
            flex-direction: column; 
            align-items: center; 
            color: var(--text-sec); 
            font-size: 11px; 
            padding: 5px; 
            cursor: pointer;
            transition: 0.2s;
            flex: 1;
            min-width: 0;
        }
        .nav-item-b.active { color: var(--primary); }
        .nav-item-b .material-icons-round { 
            font-size: 20px; 
            margin-bottom: 2px; 
            transition: 0.2s; 
        }
        .nav-item-b.active .material-icons-round { 
            background: #e8f0fe; 
            padding: 6px; 
            border-radius: 50%; 
        }

        /* --- MODALS --- */
        .modal-mask {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.6); z-index: 1000; display: none;
            justify-content: center; align-items: flex-end;
            backdrop-filter: blur(5px);
        }
        .modal-sheet {
            background: var(--surface); width: 100%; max-width: 600px;
            border-radius: 16px 16px 0 0; padding: 20px;
            animation: slideUp 0.2s ease-out; max-height: 80vh; overflow-y: auto;
            color: var(--text-main);
        }
        @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }
        
        .sheet-head { 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            margin-bottom: 20px; 
            padding-bottom: 15px;
            border-bottom: 1px solid var(--border);
        }
        .sheet-title { font-family: 'Google Sans'; font-size: 18px; font-weight: 500; }
        
        .action-list div { 
            padding: 15px 0; 
            display: flex; 
            align-items: center; 
            gap: 15px; 
            border-bottom: 1px solid var(--border); 
            cursor: pointer; 
            color: var(--text-main);
        }
        .action-list div:last-child { border: none; }
        .action-list div:hover { background: var(--hover); }

        /* PHASE 6: Enterprise Progress System */
        .progress-box {
            background: var(--surface); padding: 20px; border-radius: var(--radius-lg); 
            width: 90%; max-width: 400px; margin: auto; box-shadow: var(--shadow); 
            display: none; position: fixed; top: 50%; left: 50%; 
            transform: translate(-50%, -50%); z-index: 2000; border: 1px solid var(--border);
        }
        .progress-header {
            display:flex; justify-content:space-between; margin-bottom:5px;
        }
        .progress-details {
            font-size:12px; color:var(--text-sec); margin-bottom:10px;
        }
        .progress-bar { 
            height: 6px; 
            background: var(--hover); 
            border-radius: 3px; 
            margin-top: 10px; 
            overflow: hidden; 
        }
        .progress-fill { 
            height: 100%; 
            background: linear-gradient(90deg, var(--primary), var(--secondary)); 
            width: 0%; 
            transition: width 0.3s; 
            border-radius: 3px;
        }
        .progress-stats {
            display: flex; justify-content: space-between; margin-top: 8px;
            font-size: 11px; color: var(--text-sec);
        }

        /* Media Viewer */
        .media-viewer {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: #000; z-index: 2500; display: none; flex-direction: column;
        }
        .media-header { 
            padding: 15px; 
            color: #fff; 
            display: flex; 
            justify-content: space-between; 
            align-items: center;
            background: rgba(0,0,0,0.7); 
            backdrop-filter: blur(10px);
            flex-shrink: 0;
        }
        .media-iframe { 
            flex: 1; 
            border: none; 
            background: #fff; 
            min-height: 0;
        }

        /* Settings */
        .switch { position: relative; display: inline-block; width: 44px; height: 24px; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider { 
            position: absolute; 
            cursor: pointer; 
            top: 0; left: 0; right: 0; bottom: 0; 
            background-color: #ccc; 
            transition: .4s; 
            border-radius: 24px; 
        }
        .slider:before { 
            position: absolute; 
            content: ""; 
            height: 18px; 
            width: 18px; 
            left: 3px; 
            bottom: 3px; 
            background-color: white; 
            transition: .4s; 
            border-radius: 50%; 
        }
        input:checked + .slider { background-color: var(--primary); }
        input:checked + .slider:before { transform: translateX(20px); }

        /* Sort Options */
        .sort-options {
            display: flex; flex-direction: column; gap: 10px;
            padding: 15px 0;
        }
        .sort-option {
            display: flex; justify-content: space-between; align-items: center;
            padding: 12px 0; border-bottom: 1px solid var(--border);
            cursor: pointer;
        }
        .sort-option.active { color: var(--primary); }
        .sort-option:hover { background: var(--hover); }

        /* File Info Modal */
        .file-info {
            padding: 15px 0;
        }
        .info-row {
            display: flex; justify-content: space-between; padding: 8px 0;
            border-bottom: 1px solid var(--border);
        }
        .info-label { color: var(--text-sec); }
        .info-value { font-weight: 500; }

        /* Photo Gallery Specific */
        .photo-grid {
            display: grid; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 10px; padding: 10px;
        }
        .photo-item {
            position: relative; cursor: pointer;
        }
        .photo-thumb {
            width: 100%; height: 150px; object-fit: cover; border-radius: var(--radius);
        }
        .photo-overlay {
            position: absolute; bottom: 0; left: 0; right: 0;
            background: linear-gradient(transparent, rgba(0,0,0,0.7));
            color: white; padding: 10px; font-size: 12px;
            border-radius: 0 0 var(--radius) var(--radius);
        }

        /* Cancel Button */
        .cancel-btn {
            position: absolute; top: 15px; right: 15px; z-index: 3000;
            background: rgba(0,0,0,0.5); color: white; border: none;
            width: 40px; height: 40px; border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            cursor: pointer; font-size: 20px;
        }

        /* Empty State */
        .empty-state {
            text-align: center; padding: 50px 20px; color: var(--text-sec);
        }
        .empty-icon { font-size: 64px; margin-bottom: 20px; opacity: 0.5; }

        /* Loading */
        .loading {
            display: flex; justify-content: center; align-items: center;
            height: 100%; color: var(--text-sec);
        }

        /* PHASE 8: Gallery Grid Engine */
        #gallery-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 1rem;
            padding: 1rem;
        }

        /* PHASE 10: Media Navigator */
        #media-viewer {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.9);
            backdrop-filter: blur(10px);
            display: none;
            z-index: 5000;
            align-items: center;
            justify-content: center;
        }

        #media-viewer.active {
            display: flex;
        }

        .media-nav-btn {
            position: absolute;
            background: rgba(255,255,255,0.2);
            color: white;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 24px;
            transition: 0.2s;
            backdrop-filter: blur(5px);
            border: 1px solid rgba(255,255,255,0.3);
            z-index: 10;
        }

        .media-nav-btn:hover {
            background: rgba(255,255,255,0.3);
            transform: scale(1.1);
        }

        #media-content {
            max-width: 90vw;
            max-height: 90vh;
        }

        #media-content img,
        #media-content video {
            max-width: 100%;
            max-height: 90vh;
            object-fit: contain;
            border-radius: 8px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.4);
        }

        /* PHASE 11: Zoom Container */
        #image-wrapper {
            overflow: hidden;
            cursor: grab;
        }

        #image-wrapper:active {
            cursor: grabbing;
        }

        #zoom-image {
            transition: transform 0.2s;
            max-height: 90vh;
            max-width: 90vw;
        }

        /* PHASE 12: Context Menu */
        #file-context-menu {
            position: fixed;
            background: rgba(255,255,255,0.9);
            backdrop-filter: blur(20px);
            border-radius: 12px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            padding: 8px 0;
            min-width: 180px;
            z-index: 10000;
            border: 1px solid rgba(0,0,0,0.1);
        }

        .dark-theme #file-context-menu {
            background: rgba(32,33,36,0.9);
            border-color: rgba(255,255,255,0.1);
        }

        #file-context-menu div {
            padding: 10px 20px;
            cursor: pointer;
            transition: 0.2s;
            color: var(--text-main);
        }

        #file-context-menu div:hover {
            background: rgba(0,0,0,0.05);
        }

        .dark-theme #file-context-menu div:hover {
            background: rgba(255,255,255,0.1);
        }

        /* PHASE 16: PDF Viewer */
        #pdf-viewer {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.95);
            backdrop-filter: blur(10px);
            z-index: 5500;
            display: none;
            flex-direction: column;
        }

        #pdf-viewer.active {
            display: flex;
        }

        #pdf-container {
            flex: 1;
            overflow: auto;
            padding: 20px;
            background: #525659;
        }

        #pdf-canvas {
            margin: 0 auto;
            display: block;
            box-shadow: 0 5px 20px rgba(0,0,0,0.3);
        }

        .pdf-toolbar {
            background: rgba(0,0,0,0.8);
            backdrop-filter: blur(10px);
            color: white;
            padding: 10px 20px;
            display: flex;
            align-items: center;
            gap: 20px;
        }

        .pdf-toolbar button {
            background: rgba(255,255,255,0.2);
            border: none;
            color: white;
            padding: 8px 15px;
            border-radius: 6px;
            cursor: pointer;
        }

        /* PHASE 17: Search Snippet */
        .search-snippet {
            font-size: 12px;
            color: var(--text-sec);
            margin-top: 4px;
            padding: 4px 8px;
            background: rgba(0,0,0,0.03);
            border-radius: 4px;
            max-width: 100%;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .highlight {
            background: rgba(255,255,0,0.3);
            font-weight: bold;
        }

        /* PHASE 18: Virtual Scroll */
        .virtual-scroll-container {
            height: 100%;
            overflow-y: auto;
            position: relative;
        }

        .virtual-scroll-phantom {
            position: absolute;
            left: 0;
            top: 0;
            right: 0;
            z-index: -1;
        }

        /* PHASE 19: Performance Monitor */
        #perf-monitor {
            position: fixed;
            bottom: 10px;
            left: 10px;
            background: rgba(0,0,0,0.7);
            color: #0f0;
            padding: 5px 10px;
            border-radius: 4px;
            font-family: monospace;
            font-size: 11px;
            z-index: 10001;
            display: none;
        }

        /* PHASE 20: Slideshow Mode */
        #slideshow-mode {
            position: fixed;
            inset: 0;
            background: black;
            z-index: 6000;
            display: none;
            flex-direction: column;
        }

        #slideshow-mode.active {
            display: flex;
        }

        #slideshow-content {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        #slideshow-content img,
        #slideshow-content video {
            max-width: 100vw;
            max-height: 100vh;
            object-fit: contain;
        }

        .slideshow-controls {
            position: absolute;
            bottom: 30px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0,0,0,0.5);
            backdrop-filter: blur(10px);
            padding: 10px 20px;
            border-radius: 40px;
            display: flex;
            gap: 20px;
            color: white;
        }

        .slideshow-controls span {
            cursor: pointer;
            padding: 10px;
            border-radius: 50%;
            background: rgba(255,255,255,0.2);
        }
    </style>
</head>
<body>

<!-- PHASE 1: Safe Structure Wrapper -->
<div id="driveos-root">
    <div id="driveos-app" class="app-shell">

    <!-- Sidebar Menu -->
    <div class="sidebar mac-glass transition-all duration-300" id="sidebar">
        <div class="sidebar-header">
            <h3 style="margin: 0;">Drive OS</h3>
            <span class="material-icons-round" onclick="UI.toggleSidebar()" style="cursor: pointer;">close</span>
        </div>
        
        <div class="sidebar-user">
            <img id="sidebar-avatar" class="user-avatar" src="" alt="User">
            <div class="user-info">
                <h3 id="sidebar-name">User</h3>
                <p id="sidebar-email">user@example.com</p>
            </div>
        </div>
        
        <div class="sidebar-nav">
            <div class="nav-section">
                <div class="nav-title">Storage</div>
                <div class="nav-item" onclick="Nav.switchTab('storage', this)">
                    <span class="material-icons-round">storage</span>
                    Storage Usage
                    <span class="nav-badge" id="storage-badge">15 GB</span>
                </div>
            </div>
            
            <div class="nav-section">
                <div class="nav-title">Views</div>
                <div class="nav-item" onclick="UI.switchView('list')">
                    <span class="material-icons-round">view_list</span>
                    List View
                </div>
                <div class="nav-item" onclick="UI.switchView('grid')">
                    <span class="material-icons-round">grid_view</span>
                    Grid View
                </div>
                <div class="nav-item" onclick="UI.switchView('gallery')">
                    <span class="material-icons-round">collections</span>
                    Gallery View
                </div>
            </div>
            
            <div class="nav-section">
                <div class="nav-title">Sort By</div>
                <div class="nav-item" onclick="Drive.sort('name', 'asc')">
                    <span class="material-icons-round">sort_by_alpha</span>
                    Name (A-Z)
                </div>
                <div class="nav-item" onclick="Drive.sort('name', 'desc')">
                    <span class="material-icons-round">sort_by_alpha</span>
                    Name (Z-A)
                </div>
                <div class="nav-item" onclick="Drive.sort('size', 'asc')">
                    <span class="material-icons-round">arrow_upward</span>
                    Size (Small to Large)
                </div>
                <div class="nav-item" onclick="Drive.sort('size', 'desc')">
                    <span class="material-icons-round">arrow_downward</span>
                    Size (Large to Small)
                </div>
                <div class="nav-item" onclick="Drive.sort('date', 'desc')">
                    <span class="material-icons-round">schedule</span>
                    Date (Newest)
                </div>
                <div class="nav-item" onclick="Drive.sort('date', 'asc')">
                    <span class="material-icons-round">schedule</span>
                    Date (Oldest)
                </div>
            </div>
            
            <div class="nav-section">
                <div class="nav-title">Settings</div>
                <div class="nav-item" onclick="Settings.open()">
                    <span class="material-icons-round">settings</span>
                    App Settings
                </div>
                <div class="nav-item" onclick="Settings.security()">
                    <span class="material-icons-round">security</span>
                    Security
                </div>
                <div class="nav-item" onclick="Settings.notifications()">
                    <span class="material-icons-round">notifications</span>
                    Notifications
                </div>
            </div>
        </div>
        
        <div style="padding: 20px; border-top: 1px solid var(--border);">
            <button onclick="Auth.logout()" style="
                background: transparent; border: 1px solid var(--border); color: var(--text-main);
                padding: 10px; border-radius: var(--radius); width: 100%; cursor: pointer;
                display: flex; align-items: center; justify-content: center; gap: 10px;
            ">
                <span class="material-icons-round">logout</span>
                Sign Out
            </button>
        </div>
    </div>

    <!-- [SCREEN 1] LOCK (VIRTUAL KEYPAD) -->
    <div id="lock-screen" class="screen active">
        <div class="pin-container">
            <div class="logo-area">Drive OS Pro+</div>
            <div class="logo-subtitle">Enter your PIN to continue</div>
            <div class="pin-dots" id="pin-dots">
                <div class="dot"></div><div class="dot"></div><div class="dot"></div><div class="dot"></div>
            </div>
            <div class="keypad">
                <div class="key" onclick="Keypad.press(1)">1</div>
                <div class="key" onclick="Keypad.press(2)">2</div>
                <div class="key" onclick="Keypad.press(3)">3</div>
                <div class="key" onclick="Keypad.press(4)">4</div>
                <div class="key" onclick="Keypad.press(5)">5</div>
                <div class="key" onclick="Keypad.press(6)">6</div>
                <div class="key" onclick="Keypad.press(7)">7</div>
                <div class="key" onclick="Keypad.press(8)">8</div>
                <div class="key" onclick="Keypad.press(9)">9</div>
                <div class="key clear" onclick="Keypad.clear()">CLEAR</div>
                <div class="key" onclick="Keypad.press(0)">0</div>
                <div class="key backspace" onclick="Keypad.backspace()">
                    <span class="material-icons-round">backspace</span>
                </div>
            </div>
            <div class="biometric-btn" onclick="Keypad.useFingerprint()">
                <span class="material-icons-round">fingerprint</span>
                Use Fingerprint
            </div>
            <div style="margin-top: 20px; font-size: 12px; color: var(--text-sec);">
                Forgot PIN? <a href="#" onclick="Keypad.resetPin()" style="color: var(--primary);">Reset</a>
            </div>
        </div>
    </div>

    <!-- [SCREEN 2] AUTH -->
    <div id="auth-screen" class="screen">
        <div class="auth-card">
            <h2 style="font-family: 'Google Sans'; margin-bottom: 10px; color: var(--text-main);">Welcome Back</h2>
            <p style="color: var(--text-sec); margin-bottom: 30px;">Sign in to access your Google Drive</p>
            <button class="auth-btn" onclick="Auth.signIn()">
                <img src="https://upload.wikimedia.org/wikipedia/commons/5/53/Google_%22G%22_Logo.svg" width="20">
                Sign in with Google
            </button>
            <div style="text-align: center; margin: 20px 0; color: var(--text-sec); font-size: 14px;">
                By signing in, you agree to our Terms of Service
            </div>
        </div>
    </div>

    <!-- [SCREEN 3] APP DASHBOARD -->
    <div id="app-screen" class="screen">
        <!-- Cancel Button for Upload -->
        <div class="cancel-btn" id="cancel-btn" onclick="Upload.cancel()" style="display: none;">
            <span class="material-icons-round">close</span>
        </div>

        <div class="app-header">
            <span class="material-icons-round" onclick="UI.toggleSidebar()" style="cursor: pointer;">menu</span>
            <div class="search-bar">
                <span class="material-icons-round">search</span>
                <input type="text" class="search-input" placeholder="Search files..." id="search-input" 
                       onkeyup="Drive.search(this.value)">
            </div>
            <div style="display: flex; align-items: center; gap: 10px;">
                <span class="material-icons-round" onclick="Drive.refresh()" style="cursor: pointer;" title="Refresh">refresh</span>
                <img id="user-avatar" src="" style="width: 32px; height: 32px; border-radius: 50%; cursor: pointer;" onclick="UI.toggleSidebar()">
            </div>
        </div>

        <div class="toolbar">
            <div class="back-btn" id="back-btn" onclick="Drive.goBack()" style="display: none;">
                <span class="material-icons-round">arrow_back</span>
            </div>
            <div class="breadcrumb" id="breadcrumb">
                <span class="crumb-item" onclick="Drive.load('root')">My Drive</span>
            </div>
            <div class="toolbar-actions">
                <span class="material-icons-round" onclick="Drive.sortMenu()" style="cursor: pointer;" title="Sort">sort</span>
                <div class="view-switcher">
                    <div class="view-btn active" onclick="UI.switchView('list')" data-view="list" title="List View">
                        <span class="material-icons-round">view_list</span>
                    </div>
                    <div class="view-btn" onclick="UI.switchView('grid')" data-view="grid" title="Grid View">
                        <span class="material-icons-round">grid_view</span>
                    </div>
                    <div class="view-btn" onclick="UI.switchView('gallery')" data-view="gallery" title="Gallery View">
                        <span class="material-icons-round">collections</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Files Container -->
        <div id="file-container" class="file-viewer file-list-view">
            <!-- Dynamic Content -->
        </div>

        <!-- PHASE 8: Gallery Grid (hidden by default) -->
        <div id="gallery-grid" class="hidden"></div>

        <!-- FAB -->
        <div class="fab-container">
            <div class="fab-menu" id="fab-menu">
                <label class="fab-item">
                    <span class="material-icons-round" style="color:var(--text-sec)">upload_file</span> 
                    Upload File
                    <input type="file" hidden multiple onchange="Upload.handleFiles(this.files)">
                </label>
                <label class="fab-item">
                    <span class="material-icons-round" style="color:var(--text-sec)">drive_folder_upload</span> 
                    Upload Folder
                    <input type="file" hidden webkitdirectory onchange="Upload.handleFiles(this.files)">
                </label>
                <div class="fab-item" onclick="Ops.createFolder()">
                    <span class="material-icons-round" style="color:var(--text-sec)">create_new_folder</span> 
                    New Folder
                </div>
                <div class="fab-item" onclick="Ops.createDocument()">
                    <span class="material-icons-round" style="color:var(--text-sec)">description</span> 
                    New Document
                </div>
            </div>
            <div class="fab-main" onclick="UI.toggleFab()">
                <span class="material-icons-round">add</span>
            </div>
        </div>

        <!-- Bottom Nav -->
        <div class="bottom-nav">
            <div class="nav-item-b active" onclick="Nav.switchTab('home', this)">
                <span class="material-icons-round">home</span> 
                Home
            </div>
            <div class="nav-item-b" onclick="Nav.switchTab('photos', this)">
                <span class="material-icons-round">photo</span> 
                Photos
            </div>
            <div class="nav-item-b" onclick="Nav.switchTab('vault', this)">
                <span class="material-icons-round">lock</span> 
                Vault
            </div>
            <div class="nav-item-b" onclick="Nav.switchTab('shared', this)">
                <span class="material-icons-round">share</span> 
                Shared
            </div>
            <div class="nav-item-b" onclick="Nav.switchTab('recent', this)">
                <span class="material-icons-round">schedule</span> 
                Recent
            </div>
        </div>
    </div>

    <!-- [MODALS] -->
    
    <!-- File Context Menu -->
    <div id="ctx-modal" class="modal-mask" onclick="if(event.target === this) UI.closeModal('ctx-modal')">
        <div class="modal-sheet">
            <div class="sheet-head">
                <span class="sheet-title" id="ctx-name">Filename</span>
                <span class="material-icons-round" onclick="UI.closeModal('ctx-modal')" style="cursor: pointer;">close</span>
            </div>
            <div class="action-list">
                <div onclick="Ops.preview()"><span class="material-icons-round">visibility</span> Preview</div>
                <div onclick="Ops.download()"><span class="material-icons-round">download</span> Download</div>
                <div onclick="Ops.share()"><span class="material-icons-round">share</span> Share</div>
                <div onclick="Ops.rename()"><span class="material-icons-round">edit</span> Rename</div>
                <div onclick="Ops.info()"><span class="material-icons-round">info</span> File Info</div>
                <div onclick="Ops.delete()" style="color: #d93025;"><span class="material-icons-round">delete</span> Delete</div>
            </div>
        </div>
    </div>

    <!-- File Info Modal -->
    <div id="info-modal" class="modal-mask" onclick="if(event.target === this) UI.closeModal('info-modal')">
        <div class="modal-sheet">
            <div class="sheet-head">
                <span class="sheet-title">File Information</span>
                <span class="material-icons-round" onclick="UI.closeModal('info-modal')" style="cursor: pointer;">close</span>
            </div>
            <div class="file-info">
                <div class="info-row">
                    <span class="info-label">Name:</span>
                    <span class="info-value" id="info-name">-</span>
                </div>
                <div class="info-row">
                    <span class="info-label">Type:</span>
                    <span class="info-value" id="info-type">-</span>
                </div>
                <div class="info-row">
                    <span class="info-label">Size:</span>
                    <span class="info-value" id="info-size">-</span>
                </div>
                <div class="info-row">
                    <span class="info-label">Created:</span>
                    <span class="info-value" id="info-created">-</span>
                </div>
                <div class="info-row">
                    <span class="info-label">Modified:</span>
                    <span class="info-value" id="info-modified">-</span>
                </div>
                <div class="info-row">
                    <span class="info-label">Location:</span>
                    <span class="info-value" id="info-location">-</span>
                </div>
                <div class="info-row">
                    <span class="info-label">ID:</span>
                    <span class="info-value" id="info-id" style="font-size: 11px;">-</span>
                </div>
            </div>
        </div>
    </div>

    <!-- Sort Modal -->
    <div id="sort-modal" class="modal-mask" onclick="if(event.target === this) UI.closeModal('sort-modal')">
        <div class="modal-sheet">
            <div class="sheet-head">
                <span class="sheet-title">Sort By</span>
                <span class="material-icons-round" onclick="UI.closeModal('sort-modal')" style="cursor: pointer;">close</span>
            </div>
            <div class="sort-options">
                <div class="sort-option" onclick="Drive.applySort('name', 'asc')">
                    <span>Name (A to Z)</span>
                    <span class="material-icons-round" id="sort-name-asc" style="display: none;">check</span>
                </div>
                <div class="sort-option" onclick="Drive.applySort('name', 'desc')">
                    <span>Name (Z to A)</span>
                    <span class="material-icons-round" id="sort-name-desc" style="display: none;">check</span>
                </div>
                <div class="sort-option" onclick="Drive.applySort('size', 'asc')">
                    <span>Size (Small to Large)</span>
                    <span class="material-icons-round" id="sort-size-asc" style="display: none;">check</span>
                </div>
                <div class="sort-option" onclick="Drive.applySort('size', 'desc')">
                    <span>Size (Large to Small)</span>
                    <span class="material-icons-round" id="sort-size-desc" style="display: none;">check</span>
                </div>
                <div class="sort-option" onclick="Drive.applySort('date', 'desc')">
                    <span>Date (Newest First)</span>
                    <span class="material-icons-round" id="sort-date-desc" style="display: none;">check</span>
                </div>
                <div class="sort-option" onclick="Drive.applySort('date', 'asc')">
                    <span>Date (Oldest First)</span>
                    <span class="material-icons-round" id="sort-date-asc" style="display: none;">check</span>
                </div>
            </div>
        </div>
    </div>

    <!-- Settings Modal -->
    <div id="settings-modal" class="modal-mask" onclick="if(event.target === this) UI.closeModal('settings-modal')">
        <div class="modal-sheet">
            <div class="sheet-head"><span class="sheet-title">Settings</span></div>
            <div class="action-list">
                <div style="justify-content: space-between; cursor: default;">
                    <div>
                        <div>Dark Mode</div>
                        <div class="setting-desc">Enable dark theme</div>
                    </div>
                    <label class="switch">
                        <input type="checkbox" id="dark-mode" onchange="Settings.toggleDarkMode()">
                        <span class="slider"></span>
                    </label>
                </div>
                <div style="justify-content: space-between; cursor: default;">
                    <div>
                        <div>External Player</div>
                        <div class="setting-desc">Open files in new tab</div>
                    </div>
                    <label class="switch">
                        <input type="checkbox" id="ext-player" onchange="Settings.save()">
                        <span class="slider"></span>
                    </label>
                </div>
                <div style="justify-content: space-between; cursor: default;">
                    <div>
                        <div>Auto-sync</div>
                        <div class="setting-desc">Sync files automatically</div>
                    </div>
                    <label class="switch">
                        <input type="checkbox" id="auto-sync" onchange="Settings.save()">
                        <span class="slider"></span>
                    </label>
                </div>
                <div onclick="Settings.storage()">
                    <span class="material-icons-round">storage</span> 
                    Storage Management
                </div>
                <div onclick="Settings.security()">
                    <span class="material-icons-round">security</span> 
                    Security & Privacy
                </div>
                <div onclick="Settings.about()">
                    <span class="material-icons-round">info</span> 
                    About
                </div>
            </div>
        </div>
    </div>

    <!-- PHASE 5: Floating Enterprise Upload Panel -->
    <div id="upload-floating-panel" class="fixed bottom-24 right-6 w-80 hidden mac-glass p-4 z-50">
        <div class="flex justify-between items-center mb-2">
            <span class="font-medium">Uploads</span>
            <button onclick="DriveOS.UI.toggleUploadPanel()" class="text-gray-600 dark:text-gray-300"></button>
        </div>
        <div id="upload-queue-list" class="text-sm"></div>
        
        <!-- PHASE 6: Gradient Progress -->
        <div class="mt-2">
            <div class="relative w-full h-2 bg-gray-200 rounded-full overflow-hidden">
                <div id="upload-progress-bar" class="absolute left-0 top-0 h-full bg-gradient-to-r from-blue-500 via-purple-500 to-pink-500 transition-all duration-300" style="width:0%"></div>
            </div>
            <div class="flex justify-between text-xs mt-1">
                <span id="upload-speed">0 KB/s</span>
                <span id="upload-eta">ETA: --</span>
            </div>
        </div>
    </div>

    <!-- Progress Dialog (Legacy - Keep for compatibility) -->
    <div id="progress-modal" class="progress-box">
        <div class="progress-header">
            <strong id="prog-title">Uploading...</strong>
            <span id="prog-pct">0%</span>
        </div>
        <div class="progress-details">
            <div id="prog-file">Preparing...</div>
            <div id="prog-size">0 MB / 0 MB</div>
        </div>
        <div class="progress-bar"><div class="progress-fill" id="prog-bar"></div></div>
        <div class="progress-stats">
            <span id="prog-speed">Speed: 0 KB/s</span>
            <span id="prog-time">Time: --</span>
        </div>
        <div style="margin-top: 15px; display: flex; gap: 10px;">
            <button onclick="Upload.cancel()" style="
                flex: 1; background: transparent; border: 1px solid var(--border); 
                color: var(--text-main); padding: 8px; border-radius: var(--radius); cursor: pointer;
            ">
                Cancel
            </button>
            <button onclick="Upload.pause()" id="pause-btn" style="
                flex: 1; background: var(--primary); border: none; color: white; 
                padding: 8px; border-radius: var(--radius); cursor: pointer;
            ">
                Pause
            </button>
        </div>
    </div>

    <!-- PHASE 10: Media Navigator -->
    <div id="media-viewer" class="fixed inset-0 bg-black/80 hidden z-50 flex items-center justify-center">
        <button onclick="DriveOS.Media.prev()" class="media-nav-btn" style="left: 20px;"></button>
        <div id="media-content"></div>
        <button onclick="DriveOS.Media.next()" class="media-nav-btn" style="right: 20px;"></button>
        <button onclick="document.getElementById('media-viewer').classList.add('hidden')" 
                class="absolute top-4 right-4 text-white text-2xl bg-black/50 w-10 h-10 rounded-full flex items-center justify-center"></button>
    </div>

    <!-- PHASE 12: Context Menu -->
    <div id="file-context-menu" class="hidden fixed z-50"></div>

    <!-- PHASE 16: PDF Viewer -->
    <div id="pdf-viewer">
        <div class="pdf-toolbar">
            <button onclick="document.getElementById('pdf-viewer').classList.remove('active')"> Back</button>
            <span id="pdf-title"></span>
            <button onclick="PDFViewer.prevPage()">Previous</button>
            <span id="pdf-page-num">Page 1 / 1</span>
            <button onclick="PDFViewer.nextPage()">Next</button>
            <button onclick="PDFViewer.download()">Download</button>
        </div>
        <div id="pdf-container">
            <canvas id="pdf-canvas"></canvas>
        </div>
    </div>

    <!-- PHASE 20: Slideshow Mode -->
    <div id="slideshow-mode">
        <div class="slideshow-controls">
            <span class="material-icons-round" onclick="Slideshow.prev()">skip_previous</span>
            <span class="material-icons-round" onclick="Slideshow.toggle()" id="slideshow-play">pause</span>
            <span class="material-icons-round" onclick="Slideshow.next()">skip_next</span>
            <span class="material-icons-round" onclick="Slideshow.exit()">close</span>
        </div>
        <div id="slideshow-content"></div>
    </div>

    <!-- PHASE 19: Performance Monitor -->
    <div id="perf-monitor">FPS: -- | Memory: --</div>

    <!-- End of app content -->

    </div> <!-- close driveos-app -->
</div> <!-- close driveos-root -->

<!-- PHASE 1: Namespace Declaration -->
<script>
window.DriveOS = {
    UI: {
        uploadPanelState: { collapsed: false },
        toggleUploadPanel: function(){
            const panel = document.getElementById("upload-floating-panel");
            DriveOS.UI.uploadPanelState.collapsed = !DriveOS.UI.uploadPanelState.collapsed;
            panel.style.height = DriveOS.UI.uploadPanelState.collapsed ? "40px" : "auto";
        },
        animateSidebar: function(el){
            if(el) el.style.transition = "transform 0.3s ease";
        },
        openContextMenu: function(e, file){
            e.preventDefault();
            const menu = document.getElementById("file-context-menu");
            menu.innerHTML = `
                <div onclick="Ops.download()"> Download</div>
                <div onclick="Ops.rename()"> Rename</div>
                <div onclick="Ops.delete()"> Delete</div>
                <div onclick="Ops.star('${file.id}')"> Star</div>
                <div onclick="Ops.share()"> Share</div>
            `;
            menu.style.left = e.pageX + "px";
            menu.style.top = e.pageY + "px";
            menu.classList.remove("hidden");
        }
    },
    Gallery: {
        thumbnailCache: {},
        render: function(){
            const container = document.getElementById("gallery-grid");
            if(!container) return;
            container.innerHTML = "";
            if(!STATE.mediaIndex || STATE.mediaIndex.length === 0){
                container.innerHTML = '<div class="empty-state">No media found</div>';
                container.classList.remove("hidden");
                return;
            }
            STATE.mediaIndex.forEach((file, index)=>{
                const item = document.createElement("div");
                item.className = "relative group cursor-pointer rounded-xl overflow-hidden shadow-mac hover:shadow-macHover transition";
                const thumb = file.thumbnailLink || `https://drive.google.com/thumbnail?id=${file.id}&sz=w300`;
                item.innerHTML = `
                    <img src="${thumb}" class="w-full h-32 object-cover" loading="lazy" onerror="this.src='https://via.placeholder.com/150?text=No+Thumb'">
                    <div class="absolute inset-0 bg-black/30 opacity-0 group-hover:opacity-100 transition flex items-center justify-center text-white text-sm p-2 text-center">
                        ${file.name}
                    </div>
                `;
                item.onclick = ()=> DriveOS.Media.open(index);
                container.appendChild(item);
            });
            container.classList.remove("hidden");
        },
        generateVideoThumb: function(url, fileId){
            return new Promise(resolve=>{
                const video = document.createElement("video");
                video.src = url;
                video.crossOrigin = "anonymous";
                video.currentTime = 2;
                video.onloadeddata = function(){
                    const canvas = document.createElement("canvas");
                    canvas.width = video.videoWidth;
                    canvas.height = video.videoHeight;
                    canvas.getContext("2d").drawImage(video, 0, 0);
                    const dataURL = canvas.toDataURL("image/png");
                    DriveOS.Gallery.thumbnailCache[fileId] = dataURL;
                    resolve(dataURL);
                };
                video.onerror = ()=> resolve(null);
            });
        }
    },
    Search: {
        run: function(query){
            query = query.toLowerCase();
            let results = [];
            for(const file of STATE.files){
                let score = 0;
                if(file.name.toLowerCase().includes(query)) score += 5;
                const indexed = STATE.fileTextIndex[file.id];
                if(indexed && indexed.toLowerCase().includes(query)) score += 4;
                const lang = STATE.fileLanguageMap[file.id];
                if(query === "bangla" && lang === "bangla") score += 2;
                if(query === "english" && lang === "english") score += 2;
                if(score > 0) results.push({file, score});
            }
            results.sort((a,b)=> b.score - a.score);
            DriveOS.Search.render(results.map(r=> r.file));
        },
        render: function(files){
            Drive.render(files);
        }
    },
    Index: {
        indexFile: async function(file){
            if(file.size > 5 * 1024 * 1024) return;
            try{
                const res = await fetch(file.webContentLink);
                const text = await res.text();
                STATE.fileTextIndex[file.id] = text.slice(0, 2000000);
            } catch(err){
                console.warn("Index failed:", file.name);
            }
        },
        extractPDF: async function(file){
            // PDF.js would be loaded separately for actual extraction
            console.log("PDF extraction placeholder for:", file.name);
        },
        extractDOC: async function(file){
            console.log("DOC extraction placeholder for:", file.name);
        }
    },
    Language: {
        detect: function(text){
            const bangla = /[\u0980-\u09FF]/;
            const english = /[A-Za-z]/;
            const hasBn = bangla.test(text);
            const hasEn = english.test(text);
            if(hasBn && hasEn) return "mixed";
            if(hasBn) return "bangla";
            if(hasEn) return "english";
            return "unknown";
        }
    },
    Media: {
        open: function(index){
            STATE.currentMediaIndex = index;
            DriveOS.Media.render();
            document.getElementById("media-viewer").classList.remove("hidden");
        },
        render: function(){
            const file = STATE.mediaIndex[STATE.currentMediaIndex];
            const container = document.getElementById("media-content");
            if(!file) return;
            if(file.mimeType.includes("image")){
                container.innerHTML = `
                    <div id="image-wrapper" class="overflow-hidden cursor-grab">
                        <img id="zoom-image" src="${file.webContentLink || `https://drive.google.com/uc?id=${file.id}`}" class="max-h-screen object-contain transition-transform duration-200">
                    </div>
                `;
                DriveOS.Media.enableZoom();
            } else if(file.mimeType.includes("video")){
                container.innerHTML = `<video src="${file.webContentLink || `https://drive.google.com/uc?id=${file.id}`}" controls class="max-h-screen"></video>`;
            } else {
                container.innerHTML = `<div class="text-white">Preview not available</div>`;
            }
        },
        next: function(){
            STATE.currentMediaIndex = (STATE.currentMediaIndex + 1) % STATE.mediaIndex.length;
            DriveOS.Media.render();
        },
        prev: function(){
            STATE.currentMediaIndex = (STATE.currentMediaIndex - 1 + STATE.mediaIndex.length) % STATE.mediaIndex.length;
            DriveOS.Media.render();
        },
        enableZoom: function(){
            const img = document.getElementById("zoom-image");
            if(!img) return;
            let scale = 1;
            img.addEventListener("wheel", e=>{
                e.preventDefault();
                scale += e.deltaY * -0.001;
                scale = Math.min(Math.max(.5, scale), 4);
                img.style.transform = `scale(${scale})`;
            });
        }
    },
    Performance: {
        uploadTracker: { startTime: null },
        monitor: {
            frames: 0,
            lastTime: performance.now(),
            fps: 0
        },
        startMonitoring: function(){
            const updatePerf = () => {
                const now = performance.now();
                DriveOS.Performance.monitor.frames++;
                const delta = now - DriveOS.Performance.monitor.lastTime;
                if(delta >= 1000){
                    DriveOS.Performance.monitor.fps = DriveOS.Performance.monitor.frames;
                    DriveOS.Performance.monitor.frames = 0;
                    DriveOS.Performance.monitor.lastTime = now;
                    
                    if(performance.memory){
                        const mem = (performance.memory.usedJSHeapSize / 1048576).toFixed(1);
                        document.getElementById("perf-monitor").textContent = 
                            `FPS: ${DriveOS.Performance.monitor.fps} | Memory: ${mem} MB`;
                    } else {
                        document.getElementById("perf-monitor").textContent = 
                            `FPS: ${DriveOS.Performance.monitor.fps}`;
                    }
                }
                requestAnimationFrame(updatePerf);
            };
            requestAnimationFrame(updatePerf);
            document.getElementById("perf-monitor").style.display = "block";
        }
    },
    Security: {
        encrypt: function(data){
            // Placeholder for encryption
            return btoa(data);
        },
        decrypt: function(data){
            // Placeholder for decryption
            return atob(data);
        }
    }
};
</script>

<!-- PDF.js Library for Phase 16 -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.min.js"></script>
<script>
// PDF.js worker setup
pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.worker.min.js';

// PDF Viewer
const PDFViewer = {
    pdfDoc: null,
    pageNum: 1,
    pageRendering: false,
    pageNumPending: null,
    scale: 1.5,
    
    open: async function(file){
        document.getElementById("pdf-title").textContent = file.name;
        document.getElementById("pdf-viewer").classList.add("active");
        
        try{
            const res = await fetch(file.webContentLink);
            const blob = await res.blob();
            const url = URL.createObjectURL(blob);
            
            const loadingTask = pdfjsLib.getDocument(url);
            this.pdfDoc = await loadingTask.promise;
            this.pageNum = 1;
            this.renderPage(this.pageNum);
        } catch(err){
            console.error("PDF load error:", err);
            alert("Failed to load PDF");
        }
    },
    
    renderPage: function(num){
        this.pageRendering = true;
        this.pdfDoc.getPage(num).then(page => {
            const canvas = document.getElementById("pdf-canvas");
            const ctx = canvas.getContext("2d");
            const viewport = page.getViewport({scale: this.scale});
            canvas.height = viewport.height;
            canvas.width = viewport.width;
            
            const renderContext = {
                canvasContext: ctx,
                viewport: viewport
            };
            
            const renderTask = page.render(renderContext);
            renderTask.promise.then(() => {
                this.pageRendering = false;
                document.getElementById("pdf-page-num").textContent = `Page ${num} / ${this.pdfDoc.numPages}`;
                if(this.pageNumPending !== null){
                    this.renderPage(this.pageNumPending);
                    this.pageNumPending = null;
                }
            });
        });
    },
    
    queueRenderPage: function(num){
        if(this.pageRendering){
            this.pageNumPending = num;
        } else {
            this.renderPage(num);
        }
    },
    
    prevPage: function(){
        if(this.pageNum <= 1) return;
        this.pageNum--;
        this.queueRenderPage(this.pageNum);
    },
    
    nextPage: function(){
        if(this.pageNum >= this.pdfDoc.numPages) return;
        this.pageNum++;
        this.queueRenderPage(this.pageNum);
    },
    
    download: function(){
        window.open(STATE.selected.webContentLink, '_blank');
    }
};

// Slideshow
const Slideshow = {
    interval: null,
    playing: false,
    
    start: function(){
        document.getElementById("slideshow-mode").classList.add("active");
        this.playing = true;
        this.showCurrent();
        this.interval = setInterval(()=> this.next(), 3000);
    },
    
    showCurrent: function(){
        const file = STATE.mediaIndex[STATE.currentMediaIndex];
        const container = document.getElementById("slideshow-content");
        if(file.mimeType.includes("image")){
            container.innerHTML = `<img src="${file.webContentLink || `https://drive.google.com/uc?id=${file.id}`}">`;
        } else {
            container.innerHTML = `<video src="${file.webContentLink || `https://drive.google.com/uc?id=${file.id}`}" autoplay loop></video>`;
        }
    },
    
    next: function(){
        STATE.currentMediaIndex = (STATE.currentMediaIndex + 1) % STATE.mediaIndex.length;
        this.showCurrent();
    },
    
    prev: function(){
        STATE.currentMediaIndex = (STATE.currentMediaIndex - 1 + STATE.mediaIndex.length) % STATE.mediaIndex.length;
        this.showCurrent();
    },
    
    toggle: function(){
        if(this.playing){
            clearInterval(this.interval);
            document.getElementById("slideshow-play").textContent = "play_arrow";
        } else {
            this.interval = setInterval(()=> this.next(), 3000);
            document.getElementById("slideshow-play").textContent = "pause";
        }
        this.playing = !this.playing;
    },
    
    exit: function(){
        clearInterval(this.interval);
        document.getElementById("slideshow-mode").classList.remove("active");
    }
};

// Virtual Scroll (simplified implementation)
const VirtualScroll = {
    init: function(container, items, renderItem, itemHeight){
        // This would be a full implementation in production
        console.log("Virtual scroll initialized");
    }
};

// Debounce utility for search
function debounce(fn, delay){
    let t;
    return (...args)=>{
        clearTimeout(t);
        t = setTimeout(()=> fn(...args), delay);
    };
}

// Override search input
document.addEventListener("DOMContentLoaded", ()=>{
    const searchInput = document.getElementById("search-input");
    if(searchInput){
        const originalHandler = searchInput.onkeyup;
        searchInput.addEventListener("input", debounce((e)=>{
            if(originalHandler) originalHandler.call(searchInput, e);
            DriveOS.Search.run(e.target.value);
        }, 300));
    }
});

// Update upload metrics function
function updateUploadMetrics(loaded, total){
    if(!DriveOS.Performance.uploadTracker.startTime){
        DriveOS.Performance.uploadTracker.startTime = Date.now();
    }
    const elapsed = (Date.now() - DriveOS.Performance.uploadTracker.startTime) / 1000;
    const speed = loaded / elapsed; // bytes per second
    const remaining = total - loaded;
    const eta = remaining / speed;
    
    document.getElementById("upload-speed").textContent = (speed/1024).toFixed(1) + " KB/s";
    document.getElementById("upload-eta").textContent = "ETA: " + (eta > 0 ? eta.toFixed(1) + "s" : "--");
    document.getElementById("upload-progress-bar").style.width = ((loaded/total)*100) + "%";
}

// Add star method to Ops
Ops.star = function(id){
    alert(`Starred file: ${id} (feature coming soon)`);
};

// Keyboard support for media viewer
document.addEventListener("keydown", e=>{
    if(document.getElementById("media-viewer").classList.contains("hidden")) return;
    if(e.key === "ArrowRight") DriveOS.Media.next();
    if(e.key === "ArrowLeft") DriveOS.Media.prev();
    if(e.key === "Escape") document.getElementById("media-viewer").classList.add("hidden");
});

// Initialize performance monitoring
setTimeout(()=> DriveOS.Performance.startMonitoring(), 1000);

// Extend existing functions to use new features

// Extend file render to add context menu
const originalRender = Drive.render;
Drive.render = function(files){
    originalRender.call(this, files);
    
    // Add context menu to file items
    setTimeout(()=>{
        document.querySelectorAll(".list-item, .grid-item, .photo-item").forEach((item, idx)=>{
            const file = files[idx];
            if(file){
                item.oncontextmenu = (e)=> DriveOS.UI.openContextMenu(e, file);
                
                // Add language detection
                STATE.fileLanguageMap = STATE.fileLanguageMap || {};
                STATE.fileLanguageMap[file.id] = DriveOS.Language.detect(file.name);
                
                // Add search snippet if indexed
                if(STATE.fileTextIndex && STATE.fileTextIndex[file.id]){
                    const snippet = document.createElement("div");
                    snippet.className = "search-snippet";
                    snippet.textContent = STATE.fileTextIndex[file.id].substring(0, 60) + "...";
                    item.querySelector(".item-text")?.appendChild(snippet);
                }
            }
        });
    }, 100);
};

// Extend file load to create media index
const originalLoad = Drive.load;
Drive.load = async function(id, name){
    await originalLoad.call(this, id, name);
    
    // Create media index
    STATE.mediaIndex = STATE.files.filter(f => 
        f.mimeType?.includes("image") || f.mimeType?.includes("video")
    );
    
    // Auto-index small text files
    STATE.files.filter(f => 
        f.mimeType?.includes("text") || 
        f.mimeType?.includes("application/json") ||
        f.name.endsWith(".txt")
    ).slice(0, 10).forEach(f => DriveOS.Index.indexFile(f));
};

// Extend upload to show floating panel
const originalHandleFiles = Upload.handleFiles;
Upload.handleFiles = function(files){
    originalHandleFiles.call(this, files);
    document.getElementById("upload-floating-panel").classList.remove("hidden");
    
    // Update queue list
    const list = document.getElementById("upload-queue-list");
    list.innerHTML = "";
    Array.from(files).slice(0, 3).forEach(f => {
        list.innerHTML += `<div class="truncate"> ${f.name}</div>`;
    });
    if(files.length > 3){
        list.innerHTML += `<div class="text-gray-500">+${files.length-3} more</div>`;
    }
};

// Add gallery button to toolbar
const galleryBtn = document.createElement("div");
galleryBtn.className = "view-btn";
galleryBtn.innerHTML = '<span class="material-icons-round">photo_library</span>';
galleryBtn.title = "Gallery Grid";
galleryBtn.onclick = ()=>{
    document.querySelectorAll(".view-btn").forEach(b => b.classList.remove("active"));
    galleryBtn.classList.add("active");
    document.getElementById("file-container").style.display = "none";
    document.getElementById("gallery-grid").classList.remove("hidden");
    DriveOS.Gallery.render();
};
document.querySelector(".view-switcher").appendChild(galleryBtn);

// Add slideshow button to media viewer
const slideshowBtn = document.createElement("button");
slideshowBtn.className = "media-nav-btn";
slideshowBtn.style.right = "80px";
slideshowBtn.innerHTML = "";
slideshowBtn.onclick = ()=> Slideshow.start();
document.getElementById("media-viewer").appendChild(slideshowBtn);

// Add star to Ops if not exists
if(!Ops.star) Ops.star = function(id){ alert("Starred"); };

console.log(" Drive OS Pro+ Phase 1-20 Enterprise Build Complete");
</script>

    <!-- Original Script (kept intact) -->
    <script>
        const CONFIG = {
            clientId: '318681315152-65e9kofptt4c3bk3kmlj9gmksnasu347.apps.googleusercontent.com',
            scopes: 'https://www.googleapis.com/auth/drive https://www.googleapis.com/auth/userinfo.email',
            vaultId: '1zIyinAqjQv96QBSuanFS2F0USaG66GPn'
        };

        const STATE = {
            token: localStorage.getItem('g_token'),
            currFolder: 'root',
            folderStack: [],
            files: [],
            selected: null,
            viewMode: 'list',
            sortBy: 'name',
            sortOrder: 'asc',
            theme: localStorage.getItem('theme') || 'light',
            settings: JSON.parse(localStorage.getItem('d_settings') || '{"extPlayer": false, "autoSync": true}'),
            uploadQueue: [],
            currentUpload: null,
            uploadCanceled: false,
            // New state properties
            mediaIndex: [],
            currentMediaIndex: 0,
            fileLanguageMap: {},
            fileTextIndex: {}
        };

        /* --- [1] PIN SYSTEM WITH BACKSPACE --- */
        const Keypad = {
            input: "",
            press: (num) => {
                if(Keypad.input.length < 4) {
                    Keypad.input += num;
                    Keypad.updateDots();
                    if(Keypad.input.length === 4) {
                        setTimeout(Keypad.check, 200);
                    }
                }
            },
            clear: () => {
                Keypad.input = "";
                Keypad.updateDots();
            },
            backspace: () => {
                if(Keypad.input.length > 0) {
                    Keypad.input = Keypad.input.slice(0, -1);
                    Keypad.updateDots();
                }
            },
            updateDots: () => {
                const dots = document.querySelectorAll('.dot');
                dots.forEach((d, i) => {
                    if(i < Keypad.input.length) {
                        d.classList.add('filled');
                    } else {
                        d.classList.remove('filled');
                    }
                });
            },
            check: () => {
                const stored = localStorage.getItem('app_pin');
                const hash = btoa(Keypad.input);

                if(!stored) {
                    localStorage.setItem('app_pin', hash);
                    alert("PIN set to " + Keypad.input);
                    Auth.check();
                } else {
                    if(stored === hash) {
                        Auth.check();
                    } else {
                        Keypad.clear();
                        alert("Wrong PIN. Try again.");
                    }
                }
            },
            useFingerprint: () => {
                if(window.PublicKeyCredential) {
                    alert("Fingerprint authentication would be used here in a real app.");
                } else {
                    alert("Fingerprint not supported on this device.");
                }
            },
            resetPin: () => {
                if(confirm("Reset PIN? You'll need to sign in again.")) {
                    localStorage.removeItem('app_pin');
                    localStorage.removeItem('g_token');
                    location.reload();
                }
            }
        };

        /* --- [2] AUTH --- */
        let tokenClient;
        const Auth = {
            init: () => {
                tokenClient = google.accounts.oauth2.initTokenClient({
                    client_id: CONFIG.clientId, 
                    scope: CONFIG.scopes,
                    callback: (r) => {
                        if(r.error) {
                            alert("Login failed: " + r.error);
                            return;
                        }
                        STATE.token = r.access_token;
                        localStorage.setItem('g_token', STATE.token);
                        localStorage.setItem('g_exp', Date.now() + 3500 * 1000);
                        UI.switchScreen('app-screen');
                        Drive.load('root');
                        Auth.loadProfile();
                    }
                });
            },
            check: () => {
                const exp = localStorage.getItem('g_exp');
                if(STATE.token && exp && Date.now() < exp) {
                    UI.switchScreen('app-screen');
                    Drive.load('root');
                    Auth.loadProfile();
                } else {
                    UI.switchScreen('auth-screen');
                }
            },
            signIn: () => tokenClient.requestAccessToken(),
            loadProfile: () => {
                fetch('https://www.googleapis.com/oauth2/v3/userinfo', { 
                    headers: {'Authorization': `Bearer ${STATE.token}`}
                }).then(r=>r.json()).then(d => {
                    document.getElementById('user-avatar').src = d.picture;
                    document.getElementById('sidebar-avatar').src = d.picture;
                    document.getElementById('sidebar-name').textContent = d.name || 'User';
                    document.getElementById('sidebar-email').textContent = d.email || 'user@example.com';
                }).catch(e => {
                    console.error("Failed to load profile:", e);
                });
            },
            logout: () => {
                if(confirm('Sign out?')) {
                    localStorage.clear();
                    location.reload();
                }
            }
        };

        /* --- [3] DRIVE ENGINE WITH PROPER SORTING --- */
        const Drive = {
            load: async (id, name) => {
                const con = document.getElementById('file-container');
                con.innerHTML = '<div class="loading"><span class="material-icons-round">hourglass_empty</span> Loading...</div>';
                
                if(id !== 'root' && !STATE.folderStack.find(f => f.id === STATE.currFolder)){
                    STATE.folderStack.push({id: STATE.currFolder, name: 'Folder'});
                }
                STATE.currFolder = id;
                
                const backBtn = document.getElementById('back-btn');
                if(id !== 'root') {
                    backBtn.style.display = 'flex';
                } else {
                    backBtn.style.display = 'none';
                }
                
                Drive.updateBreadcrumb(name);
                
                const q = `'${id}' in parents and trashed = false`;
                const fields = "files(id,name,mimeType,size,iconLink,thumbnailLink,webViewLink,webContentLink,createdTime,modifiedTime,shared)";
                const url = `https://www.googleapis.com/drive/v3/files?q=${encodeURIComponent(q)}&fields=${encodeURIComponent(fields)}&pageSize=1000`;

                try {
                    const res = await fetch(url, { headers: { 'Authorization': `Bearer ${STATE.token}` } });
                    const data = await res.json();
                    STATE.files = data.files || [];
                    
                    // Update media index
                    STATE.mediaIndex = STATE.files.filter(f => 
                        f.mimeType?.includes("image") || f.mimeType?.includes("video")
                    );
                    
                    Drive.applyCurrentSort();
                    Drive.render(STATE.files);
                    
                    // Hide gallery grid if visible
                    document.getElementById("gallery-grid").classList.add("hidden");
                    document.getElementById("file-container").style.display = "block";
                } catch(e) {
                    console.error("Load error:", e);
                    con.innerHTML = '<div class="empty-state"><span class="material-icons-round empty-icon">error</span>Failed to load files</div>';
                }
            },
            render: (files) => {
                const con = document.getElementById('file-container');
                con.innerHTML = "";
                
                if(files.length === 0) {
                    con.innerHTML = '<div class="empty-state"><span class="material-icons-round empty-icon">folder_open</span>No files found</div>';
                    return;
                }

                files.forEach(f => {
                    const isDir = f.mimeType === 'application/vnd.google-apps.folder';
                    const el = document.createElement('div');
                    
                    if(STATE.viewMode === 'list') {
                        el.className = 'list-item';
                        
                        let icon = 'insert_drive_file';
                        let iconClass = 'item-icon';
                        
                        if(isDir) {
                            icon = 'folder';
                            iconClass += ' folder-icon';
                        } else if(f.mimeType.includes('image')) {
                            icon = 'image';
                            iconClass += ' image-icon';
                        } else if(f.mimeType.includes('video')) {
                            icon = 'movie';
                            iconClass += ' video-icon';
                        } else if(f.mimeType.includes('pdf')) {
                            icon = 'picture_as_pdf';
                            iconClass += ' pdf-icon';
                        }
                        
                        const size = isDir ? 'Folder' : Ops.formatSize(f.size);
                        const date = new Date(f.modifiedTime).toLocaleDateString();
                        
                        el.innerHTML = `
                            <span class="material-icons-round ${iconClass}">${icon}</span>
                            <div class="item-text">
                                <span class="item-name">${f.name}</span>
                                <span class="item-meta">
                                    <span class="item-size">${size}</span>  
                                    <span class="item-date">${date}</span>
                                </span>
                            </div>
                            <div class="file-actions">
                                <div class="action-btn" onclick="event.stopPropagation(); Ops.menu('${f.id}')">
                                    <span class="material-icons-round">more_vert</span>
                                </div>
                            </div>
                        `;
                        
                        el.onclick = () => isDir ? Drive.load(f.id, f.name) : Ops.previewFile(f);
                        
                    } else if(STATE.viewMode === 'grid') {
                        el.className = 'grid-item';
                        
                        let icon = 'insert_drive_file';
                        let iconClass = 'item-icon';
                        
                        if(isDir) icon = 'folder';
                        else if(f.mimeType.includes('image')) icon = 'image';
                        else if(f.mimeType.includes('video')) icon = 'movie';
                        else if(f.mimeType.includes('pdf')) icon = 'picture_as_pdf';
                        
                        const size = isDir ? '' : Ops.formatSize(f.size);
                        
                        el.innerHTML = `
                            <span class="material-icons-round ${iconClass}">${icon}</span>
                            <div class="item-text">
                                <span class="item-name">${f.name}</span>
                                ${size ? `<span class="item-meta">${size}</span>` : ''}
                            </div>
                        `;
                        
                        el.onclick = () => isDir ? Drive.load(f.id, f.name) : Ops.previewFile(f);
                        
                    } else if(STATE.viewMode === 'gallery') {
                        el.className = 'photo-item';
                        
                        const thumb = f.thumbnailLink || (f.mimeType.includes('image') ? 
                            `https://drive.google.com/thumbnail?id=${f.id}&sz=w300` : '');
                        
                        if(thumb && f.mimeType.includes('image')) {
                            el.innerHTML = `
                                <img src="${thumb}" class="photo-thumb" alt="${f.name}">
                                <div class="photo-overlay">${f.name}</div>
                            `;
                            el.onclick = () => Ops.previewFile(f);
                        } else {
                            el.style.display = 'none';
                        }
                    }
                    
                    if(el.style.display !== 'none') {
                        con.appendChild(el);
                    }
                });
            },
            search: (query) => {
                if(!query.trim()) {
                    Drive.render(STATE.files);
                    return;
                }
                
                const filtered = STATE.files.filter(f => 
                    f.name.toLowerCase().includes(query.toLowerCase())
                );
                Drive.render(filtered);
            },
            goBack: () => {
                if(STATE.folderStack.length > 0) {
                    const prev = STATE.folderStack.pop();
                    Drive.load(prev.id, prev.name);
                } else {
                    Drive.load('root');
                }
            },
            updateBreadcrumb: (name) => {
                const b = document.getElementById('breadcrumb');
                if(STATE.currFolder === 'root') {
                    b.innerHTML = `<span class="crumb-item" onclick="Drive.load('root')">My Drive</span>`;
                } else {
                    b.innerHTML = `
                        <span class="crumb-item" onclick="Drive.load('root')">My Drive</span>
                        <span class="crumb-sep">/</span>
                        <span class="crumb-item">${name || 'Folder'}</span>
                    `;
                }
            },
            sortMenu: () => {
                document.getElementById('sort-modal').style.display = 'flex';
                Drive.updateSortIcons();
            },
            applySort: (by, order) => {
                STATE.sortBy = by;
                STATE.sortOrder = order;
                
                Drive.applyCurrentSort();
                Drive.render(STATE.files);
                UI.closeModal('sort-modal');
                
                localStorage.setItem('sort_pref', JSON.stringify({by, order}));
            },
            applyCurrentSort: () => {
                if(!STATE.files.length) return;
                
                STATE.files.sort((a, b) => {
                    let aVal, bVal;
                    
                    if(STATE.sortBy === 'name') {
                        aVal = a.name.toLowerCase();
                        bVal = b.name.toLowerCase();
                        return STATE.sortOrder === 'asc' ? 
                            aVal.localeCompare(bVal) : bVal.localeCompare(aVal);
                            
                    } else if(STATE.sortBy === 'size') {
                        aVal = a.size || 0;
                        bVal = b.size || 0;
                        return STATE.sortOrder === 'asc' ? aVal - bVal : bVal - aVal;
                        
                    } else if(STATE.sortBy === 'date') {
                        aVal = new Date(a.modifiedTime).getTime();
                        bVal = new Date(b.modifiedTime).getTime();
                        return STATE.sortOrder === 'asc' ? aVal - bVal : bVal - aVal;
                    }
                    
                    return 0;
                });
            },
            updateSortIcons: () => {
                document.querySelectorAll('.sort-option .material-icons-round').forEach(icon => {
                    icon.style.display = 'none';
                });
                
                const activeIcon = document.getElementById(`sort-${STATE.sortBy}-${STATE.sortOrder}`);
                if(activeIcon) {
                    activeIcon.style.display = 'inline';
                }
            },
            refresh: () => {
                Drive.load(STATE.currFolder);
            }
        };

        /* --- [4] UPLOAD WITH REAL SPEED --- */
        const Upload = {
            handleFiles: (files) => {
                if(!files.length) return;
                UI.toggleFab();
                
                document.getElementById('cancel-btn').style.display = 'flex';
                document.getElementById('upload-floating-panel').classList.remove('hidden');
                
                const list = document.getElementById('upload-queue-list');
                list.innerHTML = "";
                Array.from(files).slice(0, 3).forEach(f => {
                    list.innerHTML += `<div class="truncate"> ${f.name}</div>`;
                });
                if(files.length > 3){
                    list.innerHTML += `<div class="text-gray-500">+${files.length-3} more</div>`;
                }
                
                STATE.uploadQueue = Array.from(files);
                Upload.processQueue();
            },
            processQueue: async () => {
                if(STATE.uploadQueue.length === 0) {
                    document.getElementById('progress-modal').style.display = 'none';
                    document.getElementById('cancel-btn').style.display = 'none';
                    setTimeout(()=> document.getElementById('upload-floating-panel').classList.add('hidden'), 2000);
                    Drive.refresh();
                    return;
                }
                
                const file = STATE.uploadQueue.shift();
                STATE.currentUpload = file;
                STATE.uploadCanceled = false;
                DriveOS.Performance.uploadTracker.startTime = null;
                
                const modal = document.getElementById('progress-modal');
                const pTitle = document.getElementById('prog-title');
                const pBar = document.getElementById('prog-bar');
                const pPct = document.getElementById('prog-pct');
                const pFile = document.getElementById('prog-file');
                const pSize = document.getElementById('prog-size');
                const pSpeed = document.getElementById('prog-speed');
                const pTime = document.getElementById('prog-time');
                
                modal.style.display = 'block';
                pTitle.textContent = 'Uploading...';
                pFile.textContent = file.name;
                pSize.textContent = `0 MB / ${(file.size / (1024*1024)).toFixed(2)} MB`;
                
                const meta = { 
                    name: file.name, 
                    mimeType: file.type, 
                    parents: [STATE.currFolder] 
                };
                
                try {
                    const init = await fetch('https://www.googleapis.com/upload/drive/v3/files?uploadType=resumable', {
                        method: 'POST',
                        headers: { 
                            'Authorization': `Bearer ${STATE.token}`, 
                            'Content-Type': 'application/json' 
                        },
                        body: JSON.stringify(meta)
                    });
                    
                    const location = init.headers.get('Location');
                    
                    await new Promise((resolve, reject) => {
                        const xhr = new XMLHttpRequest();
                        xhr.open('PUT', location, true);
                        xhr.setRequestHeader('Content-Type', file.type);
                        
                        let startTime = Date.now();
                        let lastLoaded = 0;
                        let lastTime = startTime;
                        let loadedPerSecond = 0;
                        let speedSamples = [];
                        
                        xhr.upload.onprogress = (e) => {
                            if(STATE.uploadCanceled) {
                                xhr.abort();
                                return;
                            }
                            
                            if (e.lengthComputable) {
                                const currentTime = Date.now();
                                const elapsed = (currentTime - startTime) / 1000;
                                
                                const timeDiff = (currentTime - lastTime) / 1000;
                                if(timeDiff >= 0.5) {
                                    const loadedDiff = e.loaded - lastLoaded;
                                    loadedPerSecond = loadedDiff / timeDiff;
                                    
                                    speedSamples.push(loadedPerSecond);
                                    if(speedSamples.length > 5) speedSamples.shift();
                                    
                                    const avgSpeed = speedSamples.reduce((a,b) => a+b, 0) / speedSamples.length;
                                    pSpeed.textContent = `Speed: ${Ops.formatSize(avgSpeed)}/s`;
                                    
                                    const remaining = e.total - e.loaded;
                                    const timeRemaining = remaining / avgSpeed;
                                    
                                    if(timeRemaining > 0 && timeRemaining < 3600) {
                                        const mins = Math.floor(timeRemaining / 60);
                                        const secs = Math.floor(timeRemaining % 60);
                                        pTime.textContent = `Time: ${mins}m ${secs}s`;
                                    } else {
                                        pTime.textContent = 'Time: --';
                                    }
                                    
                                    lastLoaded = e.loaded;
                                    lastTime = currentTime;
                                }
                                
                                const percent = (e.loaded / e.total) * 100;
                                pBar.style.width = percent + '%';
                                pPct.textContent = Math.floor(percent) + '%';
                                pSize.textContent = `${Ops.formatSize(e.loaded)} / ${Ops.formatSize(e.total)}`;
                                
                                // Call our new metrics function
                                updateUploadMetrics(e.loaded, e.total);
                            }
                        };
                        
                        xhr.onload = () => { 
                            if(xhr.status === 200 || xhr.status === 201) {
                                resolve();
                            } else {
                                reject();
                            }
                        };
                        xhr.onerror = reject;
                        xhr.send(file);
                    });
                    
                } catch(e) {
                    if(!STATE.uploadCanceled) {
                        alert(`Failed to upload: ${file.name}`);
                    }
                }
                
                if(!STATE.uploadCanceled) {
                    setTimeout(() => Upload.processQueue(), 500);
                } else {
                    modal.style.display = 'none';
                    document.getElementById('cancel-btn').style.display = 'none';
                    document.getElementById('upload-floating-panel').classList.add('hidden');
                }
            },
            cancel: () => {
                STATE.uploadCanceled = true;
                STATE.uploadQueue = [];
                document.getElementById('progress-modal').style.display = 'none';
                document.getElementById('cancel-btn').style.display = 'none';
                document.getElementById('upload-floating-panel').classList.add('hidden');
            },
            pause: () => {
                alert("Pause/resume not implemented in this demo");
            }
        };

        /* --- [5] OPERATIONS --- */
        const Ops = {
            menu: (id) => {
                STATE.selected = STATE.files.find(f => f.id === id);
                document.getElementById('ctx-name').textContent = STATE.selected.name;
                document.getElementById('ctx-modal').style.display = 'flex';
            },
            previewFile: (file) => {
                STATE.selected = file;
                Ops.preview();
            },
            preview: () => {
                UI.closeModal('ctx-modal');
                const f = STATE.selected;

                // Check if PDF for special handling
                if(f.mimeType === 'application/pdf'){
                    PDFViewer.open(f);
                    return;
                }

                if(STATE.settings.extPlayer) {
                    window.open(f.webViewLink, '_blank');
                    return;
                }

                const embedUrl = `https://drive.google.com/file/d/${f.id}/preview`;
                document.getElementById('media-title').textContent = f.name;
                document.getElementById('media-frame').src = embedUrl;
                document.getElementById('media-view').style.display = 'flex';
            },
            openExternal: () => {
                if(STATE.selected) {
                    window.open(STATE.selected.webViewLink, '_blank');
                }
            },
            download: () => {
                if(STATE.selected) {
                    window.open(STATE.selected.webContentLink, '_blank');
                }
            },
            share: () => {
                if(STATE.selected) {
                    const link = STATE.selected.webViewLink;
                    navigator.clipboard.writeText(link);
                    alert("Link copied to clipboard!");
                }
            },
            rename: async () => {
                const newName = prompt("Enter new name:", STATE.selected.name);
                if(!newName || newName === STATE.selected.name) return;
                
                try {
                    await fetch(`https://www.googleapis.com/drive/v3/files/${STATE.selected.id}`, {
                        method: 'PATCH',
                        headers: {
                            'Authorization': `Bearer ${STATE.token}`,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({name: newName})
                    });
                    
                    Drive.refresh();
                    alert("File renamed successfully!");
                } catch(e) {
                    alert("Failed to rename file");
                }
            },
            info: () => {
                const f = STATE.selected;
                document.getElementById('info-name').textContent = f.name;
                document.getElementById('info-type').textContent = f.mimeType;
                document.getElementById('info-size').textContent = Ops.formatSize(f.size);
                document.getElementById('info-created').textContent = new Date(f.createdTime).toLocaleString();
                document.getElementById('info-modified').textContent = new Date(f.modifiedTime).toLocaleString();
                document.getElementById('info-location').textContent = 'My Drive';
                document.getElementById('info-id').textContent = f.id;
                
                UI.closeModal('ctx-modal');
                document.getElementById('info-modal').style.display = 'flex';
            },
            delete: async () => {
                if(!confirm("Are you sure you want to delete this file?")) return;
                
                try {
                    await fetch(`https://www.googleapis.com/drive/v3/files/${STATE.selected.id}`, {
                        method: 'DELETE',
                        headers: {'Authorization': `Bearer ${STATE.token}`}
                    });
                    
                    UI.closeModal('ctx-modal');
                    Drive.refresh();
                    alert("File deleted successfully!");
                } catch(e) {
                    alert("Failed to delete file");
                }
            },
            createFolder: async () => {
                const name = prompt("Enter folder name:");
                if(!name) return;
                
                try {
                    await fetch('https://www.googleapis.com/drive/v3/files', {
                        method: 'POST',
                        headers: {
                            'Authorization': `Bearer ${STATE.token}`,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            name: name,
                            mimeType: 'application/vnd.google-apps.folder',
                            parents: [STATE.currFolder]
                        })
                    });
                    
                    Drive.refresh();
                    alert("Folder created successfully!");
                } catch(e) {
                    alert("Failed to create folder");
                }
            },
            createDocument: () => {
                window.open('https://docs.google.com/document/create', '_blank');
            },
            formatSize: (bytes) => {
                if(!bytes || bytes == 0) return '0 Bytes';
                const k = 1024;
                const sizes = ['Bytes', 'KB', 'MB', 'GB', 'TB'];
                const i = Math.floor(Math.log(bytes) / Math.log(k));
                return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
            },
            star: (id) => {
                alert(`Starred file: ${id} (feature coming soon)`);
            }
        };

        /* --- [6] UI CONTROLLER --- */
        const UI = {
            switchScreen: (id) => {
                document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
                document.getElementById(id).classList.add('active');
                
                if(id === 'app-screen') {
                    history.pushState({screen: 'app'}, '', '');
                }
            },
            toggleFab: () => {
                const m = document.getElementById('fab-menu');
                m.style.display = m.style.display === 'flex' ? 'none' : 'flex';
            },
            switchView: (mode) => {
                STATE.viewMode = mode;
                const c = document.getElementById('file-container');
                c.className = `file-viewer file-${mode}-view`;
                
                document.querySelectorAll('.view-btn').forEach(btn => {
                    btn.classList.toggle('active', btn.dataset.view === mode);
                });
                
                if(mode === 'gallery') {
                    const images = STATE.files.filter(f => f.mimeType && f.mimeType.includes('image'));
                    if(images.length > 0) {
                        const con = document.getElementById('file-container');
                        con.innerHTML = '';
                        con.className = 'file-viewer';
                        con.style.display = 'grid';
                        con.style.gridTemplateColumns = 'repeat(auto-fill, minmax(150px, 1fr))';
                        con.style.gap = '10px';
                        con.style.padding = '10px';
                        
                        images.forEach(f => {
                            const el = document.createElement('div');
                            el.className = 'photo-item';
                            const thumb = f.thumbnailLink || `https://drive.google.com/thumbnail?id=${f.id}&sz=w300`;
                            el.innerHTML = `
                                <img src="${thumb}" class="photo-thumb" alt="${f.name}">
                                <div class="photo-overlay">${f.name}</div>
                            `;
                            el.onclick = () => Ops.previewFile(f);
                            con.appendChild(el);
                        });
                    } else {
                        c.innerHTML = '<div class="empty-state"><span class="material-icons-round empty-icon">photo</span>No images found</div>';
                    }
                } else {
                    Drive.render(STATE.files);
                }
            },
            toggleSidebar: () => {
                const sidebar = document.getElementById('sidebar');
                sidebar.classList.toggle('active');
                DriveOS.UI.animateSidebar(sidebar);
            },
            closeModal: (id) => {
                document.getElementById(id).style.display = 'none';
            },
            closeMedia: () => {
                document.getElementById('media-view').style.display = 'none';
                document.getElementById('media-frame').src = "";
            }
        };

        /* --- [7] NAVIGATION --- */
        const Nav = {
            switchTab: (tab, el) => {
                document.querySelectorAll('.nav-item-b').forEach(e => e.classList.remove('active'));
                el.classList.add('active');
                
                if(tab === 'home') {
                    Drive.load('root');
                } else if(tab === 'photos') {
                    const images = STATE.files.filter(f => f.mimeType && f.mimeType.includes('image'));
                    if(images.length > 0) {
                        UI.switchView('gallery');
                    } else {
                        alert("No photos found in current folder");
                    }
                } else if(tab === 'vault') {
                    Drive.load(CONFIG.vaultId, 'Vault');
                } else if(tab === 'shared') {
                    alert("Shared files feature coming soon");
                } else if(tab === 'recent') {
                    Drive.applySort('date', 'desc');
                    Drive.render(STATE.files);
                }
            }
        };

        /* --- [8] SETTINGS --- */
        const Settings = {
            open: () => {
                document.getElementById('ext-player').checked = STATE.settings.extPlayer;
                document.getElementById('auto-sync').checked = STATE.settings.autoSync;
                document.getElementById('dark-mode').checked = STATE.theme === 'dark';
                document.getElementById('settings-modal').style.display = 'flex';
            },
            save: () => {
                STATE.settings.extPlayer = document.getElementById('ext-player').checked;
                STATE.settings.autoSync = document.getElementById('auto-sync').checked;
                localStorage.setItem('d_settings', JSON.stringify(STATE.settings));
            },
            toggleDarkMode: () => {
                if(document.getElementById('dark-mode').checked) {
                    STATE.theme = 'dark';
                    document.body.classList.add('dark-theme');
                } else {
                    STATE.theme = 'light';
                    document.body.classList.remove('dark-theme');
                }
                localStorage.setItem('theme', STATE.theme);
                Settings.save();
            },
            storage: () => {
                fetch('https://www.googleapis.com/drive/v3/about?fields=storageQuota', {
                    headers: {'Authorization': `Bearer ${STATE.token}`}
                }).then(r=>r.json()).then(d => {
                    const used = Ops.formatSize(d.storageQuota.usage);
                    const limit = Ops.formatSize(d.storageQuota.limit);
                    const percent = (d.storageQuota.usage / d.storageQuota.limit * 100).toFixed(1);
                    
                    alert(`Storage Usage:\n${used} of ${limit} (${percent}% used)`);
                });
            },
            security: () => {
                alert("Security settings:\n- PIN Protection: Enabled\n- Auto-lock: 5 minutes\n- Biometric: Not configured");
            },
            about: () => {
                alert("Drive OS Pro+\nVersion 2.0\n 2024 All rights reserved");
            }
        };

        /* --- [9] INITIALIZATION --- */
        window.onload = () => {
            if(!localStorage.getItem('app_pin')) {
                const pin = prompt("Set a 4-digit PIN for security (e.g., 1234):");
                if(pin && pin.length === 4 && /^\d+$/.test(pin)) {
                    localStorage.setItem('app_pin', btoa(pin));
                } else {
                    localStorage.setItem('app_pin', btoa('1234'));
                }
            }
            
            const savedSort = localStorage.getItem('sort_pref');
            if(savedSort) {
                const {by, order} = JSON.parse(savedSort);
                STATE.sortBy = by;
                STATE.sortOrder = order;
            }
            
            if(STATE.theme === 'dark') {
                document.body.classList.add('dark-theme');
            }
            
            Auth.init();
            
            window.onpopstate = (e) => {
                if(e.state && e.state.screen === 'app') {
                } else {
                    if(document.getElementById('app-screen').classList.contains('active')) {
                        history.pushState({screen: 'app'}, '', '');
                    }
                }
            };
            
            history.replaceState({screen: 'lock'}, '', '');
        };
    </script>
</body>
</html>
